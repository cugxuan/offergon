---
title: Redux çš„ä¸­é—´ä»¶æœºåˆ¶å’Œ redux-saga åŸç†
tags:
  - å‰ç«¯React
status: robot
class: å‰ç«¯React
slug: redux-middleware-saga-principle
ref:
---

## æ ¸å¿ƒè¦ç‚¹

**Redux ä¸­é—´ä»¶æ˜¯æ‹¦æˆª Action åˆ°è¾¾ Reducer ä¹‹é—´çš„å¢å¼ºå™¨ï¼Œredux-saga é€šè¿‡ Generator å‡½æ•°å’Œ Effects ç³»ç»Ÿå®ç°äº†ä¼˜é›…çš„å‰¯ä½œç”¨ç®¡ç†ï¼Œå°†å¤æ‚å¼‚æ­¥é€»è¾‘ä»ç»„ä»¶ä¸­è§£è€¦ã€‚**

å…³é”®æ¦‚å¿µï¼š
- ğŸ”Œ **ä¸­é—´ä»¶æœºåˆ¶**ï¼šæ´‹è‘±æ¨¡å‹ï¼Œ`dispatch â†’ M1 â†’ M2 â†’ reducer â†’ M2 â†’ M1`
- ğŸŒŠ **redux-saga**ï¼šåŸºäº Generator çš„å‰¯ä½œç”¨ç®¡ç†åº“
- âš¡ **Effects**ï¼šå£°æ˜å¼çš„å‰¯ä½œç”¨æè¿°ï¼ˆcallã€putã€selectã€take ç­‰ï¼‰
- ğŸ¯ **å¯æµ‹è¯•æ€§**ï¼šçº¯å‡½æ•° + Effect æè¿°ç¬¦ = æ˜“æµ‹è¯•

---

## è¯¦ç»†è§£ç­”

### ä¸€ã€Redux ä¸­é—´ä»¶æœºåˆ¶

#### 1. ä»€ä¹ˆæ˜¯ä¸­é—´ä»¶

ä¸­é—´ä»¶æ˜¯ Redux çš„æ’ä»¶ç³»ç»Ÿï¼Œå…è®¸åœ¨ **Action è¢«æ´¾å‘** å’Œ **åˆ°è¾¾ Reducer** ä¹‹é—´æ’å…¥è‡ªå®šä¹‰é€»è¾‘ã€‚

```
Dispatch Action â†’ Middleware 1 â†’ Middleware 2 â†’ Middleware N â†’ Reducer
```

**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
- æ—¥å¿—è®°å½•ï¼ˆè®°å½•æ¯ä¸ª Action å’ŒçŠ¶æ€å˜åŒ–ï¼‰
- å¼‚æ­¥å¤„ç†ï¼ˆredux-thunkã€redux-sagaï¼‰
- é”™è¯¯ç›‘æ§ï¼ˆæ•è·å¼‚å¸¸å¹¶ä¸ŠæŠ¥ï¼‰
- è·¯ç”±åŒæ­¥ï¼ˆreact-router-reduxï¼‰
- æ€§èƒ½åˆ†æï¼ˆåŸ‹ç‚¹ç»Ÿè®¡ï¼‰

#### 2. ä¸­é—´ä»¶çš„æ´‹è‘±æ¨¡å‹

```javascript
// å‡è®¾æœ‰ 3 ä¸ªä¸­é—´ä»¶
const store = createStore(
  reducer,
  applyMiddleware(logger, thunk, crashReporter)
)

// æ‰§è¡Œæµç¨‹ï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰ï¼š
dispatch(action)
  â†’ loggerï¼ˆå‰ï¼‰
    â†’ thunkï¼ˆå‰ï¼‰
      â†’ crashReporterï¼ˆå‰ï¼‰
        â†’ Reducer å¤„ç†
      â†’ crashReporterï¼ˆåï¼‰
    â†’ thunkï¼ˆåï¼‰
  â†’ loggerï¼ˆåï¼‰
â†’ é€šçŸ¥è®¢é˜…è€…
```

å¯è§†åŒ–ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ logger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ before                                 after â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ thunk â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ before                         after â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€ crashReporter â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚  â”‚ before           after     â”‚      â”‚   â”‚
â”‚  â”‚  â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚      â”‚   â”‚
â”‚  â”‚  â”‚        â”‚Reducer â”‚         â”‚      â”‚   â”‚
â”‚  â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. ä¸­é—´ä»¶çš„å®ç°åŸç†

**3.1 ä¸­é—´ä»¶ç­¾å**

```javascript
// æ ‡å‡†çš„ Redux ä¸­é—´ä»¶ç­¾å
const middleware = (store) => (next) => (action) => {
  // store: { getState, dispatch }
  // next: ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ– reducer
  // action: è¢«æ´¾å‘çš„ action

  // å‰ç½®å¤„ç†
  console.log('dispatching', action)

  // è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼ˆå¿…é¡»è°ƒç”¨ï¼ï¼‰
  const result = next(action)

  // åç½®å¤„ç†
  console.log('next state', store.getState())

  return result
}
```

**3.2 æ‰‹å†™ç®€å•ä¸­é—´ä»¶**

```javascript
// ========== æ—¥å¿—ä¸­é—´ä»¶ ==========
const logger = (store) => (next) => (action) => {
  console.group(action.type)
  console.log('prev state:', store.getState())
  console.log('action:', action)

  const result = next(action)

  console.log('next state:', store.getState())
  console.groupEnd()

  return result
}

// ========== æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶ ==========
const performanceMonitor = (store) => (next) => (action) => {
  const start = performance.now()

  const result = next(action)

  const end = performance.now()
  console.log(`Action ${action.type} took ${end - start}ms`)

  return result
}

// ========== é”™è¯¯æ•è·ä¸­é—´ä»¶ ==========
const crashReporter = (store) => (next) => (action) => {
  try {
    return next(action)
  } catch (err) {
    console.error('Caught an exception!', err)
    // å‘é€é”™è¯¯åˆ°ç›‘æ§æœåŠ¡
    Sentry.captureException(err, {
      extra: {
        action,
        state: store.getState()
      }
    })
    throw err
  }
}
```

**3.3 å¼‚æ­¥ä¸­é—´ä»¶ï¼šredux-thunk**

```javascript
// redux-thunk æºç ï¼ˆç®€åŒ–ç‰ˆï¼‰
const thunk = (store) => (next) => (action) => {
  // å¦‚æœ action æ˜¯å‡½æ•°ï¼Œåˆ™æ‰§è¡Œå®ƒ
  if (typeof action === 'function') {
    return action(store.dispatch, store.getState)
  }

  // å¦åˆ™ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
  return next(action)
}

// ä½¿ç”¨ç¤ºä¾‹
const fetchUser = (userId) => {
  return async (dispatch, getState) => {
    dispatch({ type: 'FETCH_USER_REQUEST' })

    try {
      const response = await fetch(`/api/users/${userId}`)
      const user = await response.json()
      dispatch({ type: 'FETCH_USER_SUCCESS', payload: user })
    } catch (error) {
      dispatch({ type: 'FETCH_USER_FAILURE', error })
    }
  }
}

// ç»„ä»¶ä¸­
dispatch(fetchUser(123)) // æ´¾å‘å‡½æ•°è€Œéå¯¹è±¡ï¼
```

#### 4. applyMiddleware çš„å®ç°åŸç†

```javascript
// Redux applyMiddleware ç®€åŒ–å®ç°
function applyMiddleware(...middlewares) {
  return (createStore) => (reducer, preloadedState) => {
    const store = createStore(reducer, preloadedState)

    let dispatch = store.dispatch

    // æä¾›ç»™ä¸­é—´ä»¶çš„ API
    const middlewareAPI = {
      getState: store.getState,
      dispatch: (action) => dispatch(action) // é—­åŒ…å¼•ç”¨ï¼Œç¡®ä¿å§‹ç»ˆæ˜¯æœ€æ–°çš„ dispatch
    }

    // æ‰§è¡Œæ‰€æœ‰ä¸­é—´ä»¶ï¼Œå¾—åˆ°åŒ…è£…åçš„ dispatch é“¾
    const chain = middlewares.map(middleware => middleware(middlewareAPI))

    // ä»å³åˆ°å·¦ç»„åˆä¸­é—´ä»¶
    // compose([f, g, h]) => f(g(h(x)))
    dispatch = compose(...chain)(store.dispatch)

    return {
      ...store,
      dispatch // è¿”å›å¢å¼ºåçš„ dispatch
    }
  }
}

// compose å·¥å…·å‡½æ•°
function compose(...funcs) {
  if (funcs.length === 0) return (arg) => arg
  if (funcs.length === 1) return funcs[0]

  return funcs.reduce((a, b) => (...args) => a(b(...args)))
}
```

**æ‰§è¡Œè¿‡ç¨‹åˆ†æ**ï¼š

```javascript
const middlewares = [logger, thunk, crashReporter]

// 1. æ‰€æœ‰ä¸­é—´ä»¶æ¥æ”¶ store API
const chain = [
  logger({ getState, dispatch }),
  thunk({ getState, dispatch }),
  crashReporter({ getState, dispatch })
]
// chain = [(next) => (action) => {...}, (next) => (action) => {...}, ...]

// 2. compose ä»å³åˆ°å·¦ç»„åˆ
// compose(logger, thunk, crashReporter)(store.dispatch)
// = logger(thunk(crashReporter(store.dispatch)))

// 3. æœ€ç»ˆçš„ dispatch è°ƒç”¨é“¾
dispatch(action)
  â†’ logger's (action) => {}
    â†’ thunk's (action) => {}
      â†’ crashReporter's (action) => {}
        â†’ store.dispatch(action) // åŸå§‹ dispatch
```

---

### äºŒã€redux-saga æ ¸å¿ƒåŸç†

#### 1. ä¸ºä»€ä¹ˆéœ€è¦ redux-saga

**redux-thunk çš„å±€é™æ€§**ï¼š

```javascript
// âŒ å¤æ‚å¼‚æ­¥é€»è¾‘éš¾ä»¥ç®¡ç†
const complexFlow = () => async (dispatch, getState) => {
  dispatch({ type: 'START' })

  // é€»è¾‘ 1ï¼šè½®è¯¢ç­‰å¾…æŸä¸ªæ¡ä»¶
  while (!getState().ready) {
    await delay(1000)
  }

  // é€»è¾‘ 2ï¼šå¹¶å‘è¯·æ±‚
  const [users, posts] = await Promise.all([
    fetch('/api/users').then(r => r.json()),
    fetch('/api/posts').then(r => r.json())
  ])

  // é€»è¾‘ 3ï¼šç«æ€æ¡ä»¶ï¼ˆåªå–æœ€å¿«çš„ï¼‰
  const fastestData = await Promise.race([
    fetch('/api/fast').then(r => r.json()),
    fetch('/api/slow').then(r => r.json())
  ])

  dispatch({ type: 'COMPLETE', payload: { users, posts, fastestData } })
}

// é—®é¢˜ï¼š
// 1. æ— æ³•å–æ¶ˆï¼ˆç”¨æˆ·å¿«é€Ÿåˆ‡æ¢é¡µé¢æ—¶äº§ç”Ÿå†—ä½™è¯·æ±‚ï¼‰
// 2. éš¾ä»¥æµ‹è¯•ï¼ˆéœ€è¦ mock fetchã€delayï¼‰
// 3. é€»è¾‘æ··ä¹±ï¼ˆä¸šåŠ¡é€»è¾‘å’Œå‰¯ä½œç”¨è€¦åˆï¼‰
```

**redux-saga çš„ä¼˜åŠ¿**ï¼š

```javascript
// âœ… redux-sagaï¼šå£°æ˜å¼ã€å¯æµ‹è¯•ã€å¯å–æ¶ˆ
import { call, put, race, select, delay } from 'redux-saga/effects'

function* complexFlow() {
  yield put({ type: 'START' })

  // é€»è¾‘ 1ï¼šè½®è¯¢ç­‰å¾…
  while (!(yield select(state => state.ready))) {
    yield delay(1000)
  }

  // é€»è¾‘ 2ï¼šå¹¶å‘è¯·æ±‚
  const [users, posts] = yield all([
    call(fetch, '/api/users'),
    call(fetch, '/api/posts')
  ])

  // é€»è¾‘ 3ï¼šç«æ€æ¡ä»¶
  const { fast } = yield race({
    fast: call(fetch, '/api/fast'),
    slow: call(fetch, '/api/slow')
  })

  yield put({ type: 'COMPLETE', payload: { users, posts, fastestData: fast } })
}

// ä¼˜åŠ¿ï¼š
// 1. å¯å–æ¶ˆï¼ˆtask.cancel()ï¼‰
// 2. æ˜“æµ‹è¯•ï¼ˆEffects æ˜¯çº¯å¯¹è±¡ï¼‰
// 3. æ¸…æ™°ï¼ˆGenerator çº¿æ€§æµç¨‹ï¼‰
```

#### 2. Generator åŸºç¡€å›é¡¾

```javascript
// Generator å‡½æ•°ï¼ˆå¸¦ * å·ï¼‰
function* countGenerator() {
  console.log('Start')
  yield 1          // æš‚åœç‚¹ 1
  console.log('Middle')
  yield 2          // æš‚åœç‚¹ 2
  console.log('End')
  return 3         // ç»“æŸ
}

const gen = countGenerator()

console.log(gen.next()) // { value: 1, done: false } + æ‰“å° 'Start'
console.log(gen.next()) // { value: 2, done: false } + æ‰“å° 'Middle'
console.log(gen.next()) // { value: 3, done: true }  + æ‰“å° 'End'

// Generator çš„åŒå‘é€šä¿¡
function* dataGenerator() {
  const a = yield 'Give me A'
  console.log('Got A:', a)

  const b = yield 'Give me B'
  console.log('Got B:', b)

  return a + b
}

const gen2 = dataGenerator()
console.log(gen2.next())      // { value: 'Give me A', done: false }
console.log(gen2.next(10))    // ä¼ å…¥ 10 ä½œä¸ºç¬¬ä¸€ä¸ª yield çš„è¿”å›å€¼
                               // æ‰“å° 'Got A: 10'
                               // { value: 'Give me B', done: false }
console.log(gen2.next(20))    // ä¼ å…¥ 20
                               // æ‰“å° 'Got B: 20'
                               // { value: 30, done: true }
```

#### 3. redux-saga çš„ Effects ç³»ç»Ÿ

Effects æ˜¯**æè¿°å‰¯ä½œç”¨çš„çº¯å¯¹è±¡**ï¼Œç”± saga middleware æ‰§è¡Œã€‚

```javascript
// ========== æ ¸å¿ƒ Effects ==========

// 1. call - è°ƒç”¨å‡½æ•°ï¼ˆåŒæ­¥æˆ–å¼‚æ­¥ï¼‰
yield call(fetch, '/api/users')
// è¿”å› { type: 'CALL', fn: fetch, args: ['/api/users'] }

// 2. put - æ´¾å‘ Action
yield put({ type: 'USER_LOADED', payload: user })
// è¿”å› { type: 'PUT', action: { type: 'USER_LOADED', ... } }

// 3. select - è¯»å– Redux state
const userId = yield select(state => state.user.id)
// è¿”å› { type: 'SELECT', selector: (state) => state.user.id }

// 4. take - ç­‰å¾…ç‰¹å®š Actionï¼ˆé˜»å¡ï¼‰
const action = yield take('BUTTON_CLICKED')
console.log('Button was clicked with payload:', action.payload)

// 5. takeEvery - ç›‘å¬æ¯ä¸ª Actionï¼ˆéé˜»å¡ï¼‰
yield takeEvery('FETCH_USER', fetchUserSaga)
// æ¯æ¬¡ FETCH_USER æ—¶éƒ½å¯åŠ¨æ–°çš„ fetchUserSaga

// 6. takeLatest - åªä¿ç•™æœ€æ–°çš„ï¼ˆè‡ªåŠ¨å–æ¶ˆæ—§ä»»åŠ¡ï¼‰
yield takeLatest('SEARCH_INPUT', searchSaga)
// ç”¨æˆ·å¿«é€Ÿè¾“å…¥æ—¶ï¼Œåªæ‰§è¡Œæœ€åä¸€æ¬¡æœç´¢

// 7. fork - éé˜»å¡è°ƒç”¨
const task = yield fork(backgroundTask)
// ç»§ç»­æ‰§è¡Œï¼Œä¸ç­‰å¾… backgroundTask å®Œæˆ

// 8. cancel - å–æ¶ˆä»»åŠ¡
yield cancel(task)

// 9. all - å¹¶å‘æ‰§è¡Œï¼ˆç±»ä¼¼ Promise.allï¼‰
const [users, posts] = yield all([
  call(fetchUsers),
  call(fetchPosts)
])

// 10. race - ç«æ€ï¼ˆç±»ä¼¼ Promise.raceï¼‰
const { data, timeout } = yield race({
  data: call(fetchData),
  timeout: delay(5000)
})

if (timeout) {
  console.log('Request timeout!')
}
```

#### 4. redux-saga åŸºæœ¬ç”¨æ³•

**4.1 ç®€å•å¼‚æ­¥è¯·æ±‚**

```javascript
// sagas/userSaga.js
import { call, put, takeEvery } from 'redux-saga/effects'
import * as api from '../api'

// Worker Sagaï¼šå¤„ç†å…·ä½“é€»è¾‘
function* fetchUserSaga(action) {
  try {
    const userId = action.payload

    // å‘èµ· loading çŠ¶æ€
    yield put({ type: 'FETCH_USER_REQUEST' })

    // è°ƒç”¨ APIï¼ˆé˜»å¡ï¼Œç­‰å¾…å®Œæˆï¼‰
    const user = yield call(api.fetchUser, userId)

    // æˆåŠŸ
    yield put({ type: 'FETCH_USER_SUCCESS', payload: user })
  } catch (error) {
    // å¤±è´¥
    yield put({ type: 'FETCH_USER_FAILURE', error })
  }
}

// Watcher Sagaï¼šç›‘å¬ Action
function* watchFetchUser() {
  yield takeEvery('FETCH_USER', fetchUserSaga)
}

// Root Saga
export default function* rootSaga() {
  yield all([
    watchFetchUser(),
    // å…¶ä»– watcher sagas...
  ])
}

// store.js
import createSagaMiddleware from 'redux-saga'
import rootSaga from './sagas'

const sagaMiddleware = createSagaMiddleware()
const store = createStore(
  reducer,
  applyMiddleware(sagaMiddleware)
)

sagaMiddleware.run(rootSaga) // å¯åŠ¨ saga
```

**4.2 å¤æ‚æµç¨‹æ§åˆ¶**

```javascript
// ========== ç™»å½•æµç¨‹ç¤ºä¾‹ ==========
function* loginFlow() {
  while (true) {
    // 1. ç­‰å¾…ç™»å½•è¯·æ±‚
    const { payload } = yield take('LOGIN_REQUEST')

    // 2. å‘èµ·ç™»å½• API è°ƒç”¨
    const { user, error } = yield call(loginApi, payload)

    if (user) {
      yield put({ type: 'LOGIN_SUCCESS', user })

      // 3. ç™»å½•æˆåŠŸåï¼Œå¯åŠ¨åå°ä»»åŠ¡
      const bgTask = yield fork(fetchUserDataInBackground, user.id)

      // 4. ç­‰å¾…ç™»å‡ºæˆ–ä¼šè¯è¿‡æœŸ
      const action = yield take(['LOGOUT', 'SESSION_EXPIRED'])

      if (action.type === 'LOGOUT') {
        yield call(logoutApi)
        yield cancel(bgTask) // å–æ¶ˆåå°ä»»åŠ¡
      }

      yield put({ type: 'LOGOUT_SUCCESS' })
    } else {
      yield put({ type: 'LOGIN_FAILURE', error })
    }
  }
}

// åå°ä»»åŠ¡
function* fetchUserDataInBackground(userId) {
  while (true) {
    yield call(syncUserData, userId)
    yield delay(60000) // æ¯åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
  }
}
```

**4.3 é˜²æŠ–å’ŒèŠ‚æµ**

```javascript
import { debounce, throttle } from 'redux-saga/effects'

// é˜²æŠ–ï¼šç”¨æˆ·åœæ­¢è¾“å…¥ 500ms åæ‰æ‰§è¡Œ
function* watchSearchInput() {
  yield debounce(500, 'SEARCH_INPUT', searchSaga)
}

// èŠ‚æµï¼š1ç§’å†…æœ€å¤šæ‰§è¡Œä¸€æ¬¡
function* watchScroll() {
  yield throttle(1000, 'WINDOW_SCROLL', handleScrollSaga)
}
```

**4.4 é‡è¯•æœºåˆ¶**

```javascript
import { retry, delay } from 'redux-saga/effects'

function* fetchWithRetry() {
  try {
    // æœ€å¤šé‡è¯• 3 æ¬¡ï¼Œé—´éš” 2 ç§’
    const data = yield retry(3, 2000, fetchApi)
    yield put({ type: 'FETCH_SUCCESS', data })
  } catch (error) {
    yield put({ type: 'FETCH_FAILED', error })
  }
}

// è‡ªå®šä¹‰é‡è¯•é€»è¾‘
function* customRetry() {
  let retries = 0
  const maxRetries = 3

  while (retries < maxRetries) {
    try {
      const data = yield call(fetchApi)
      yield put({ type: 'SUCCESS', data })
      return
    } catch (error) {
      retries++
      if (retries >= maxRetries) {
        yield put({ type: 'FAILED', error })
      } else {
        yield delay(Math.pow(2, retries) * 1000) // æŒ‡æ•°é€€é¿
      }
    }
  }
}
```

#### 5. é«˜çº§æ¨¡å¼

**5.1 è¯·æ±‚ç«æ€å¤„ç†ï¼ˆæœ€æ–°è¯·æ±‚ä¼˜å…ˆï¼‰**

```javascript
// åœºæ™¯ï¼šç”¨æˆ·å¿«é€Ÿè¾“å…¥æœç´¢å…³é”®è¯
function* watchSearch() {
  yield takeLatest('SEARCH', searchSaga)
  // è‡ªåŠ¨å–æ¶ˆæ—§çš„ searchSagaï¼Œåªä¿ç•™æœ€æ–°çš„
}

function* searchSaga(action) {
  const { query } = action.payload
  const results = yield call(searchApi, query)
  yield put({ type: 'SEARCH_SUCCESS', results })
}
```

**5.2 ä¹è§‚æ›´æ–° + å›æ»š**

```javascript
function* updateUserSaga(action) {
  const { userId, updates } = action.payload

  // 1. ä¿å­˜æ—§çŠ¶æ€
  const oldUser = yield select(state => state.users[userId])

  // 2. ä¹è§‚æ›´æ–° UI
  yield put({ type: 'UPDATE_USER_OPTIMISTIC', userId, updates })

  try {
    // 3. å‘é€è¯·æ±‚
    yield call(updateUserApi, userId, updates)
    yield put({ type: 'UPDATE_USER_SUCCESS' })
  } catch (error) {
    // 4. å¤±è´¥æ—¶å›æ»š
    yield put({ type: 'UPDATE_USER_ROLLBACK', userId, oldUser })
    yield put({ type: 'SHOW_ERROR', message: 'Update failed' })
  }
}
```

**5.3 Channel é€šä¿¡**

```javascript
import { channel } from 'redux-saga'
import { take, put, fork } from 'redux-saga/effects'

// åˆ›å»ºäº‹ä»¶é€šé“ï¼ˆç±»ä¼¼ EventEmitterï¼‰
function* watchMessages() {
  const chan = yield call(channel)

  // å¯åŠ¨æ¶ˆè´¹è€…
  yield fork(messageConsumer, chan)

  // å¯åŠ¨ç”Ÿäº§è€…
  yield fork(messageProducer, chan)
}

function* messageProducer(chan) {
  while (true) {
    const action = yield take('SEND_MESSAGE')
    yield put(chan, action.payload) // å‘é€åˆ° channel
  }
}

function* messageConsumer(chan) {
  while (true) {
    const message = yield take(chan) // ä» channel æ¥æ”¶
    yield call(processMessage, message)
  }
}
```

#### 6. æµ‹è¯• sagaï¼ˆæ ¸å¿ƒä¼˜åŠ¿ï¼‰

```javascript
// saga
function* fetchUserSaga(action) {
  const userId = action.payload
  const user = yield call(api.fetchUser, userId)
  yield put({ type: 'FETCH_USER_SUCCESS', payload: user })
}

// æµ‹è¯•ï¼ˆæ— éœ€ mock fetchï¼ï¼‰
import { call, put } from 'redux-saga/effects'

test('fetchUserSaga', () => {
  const action = { type: 'FETCH_USER', payload: 123 }
  const gen = fetchUserSaga(action)

  // ç¬¬ 1 æ­¥ï¼šéªŒè¯ call effect
  expect(gen.next().value).toEqual(
    call(api.fetchUser, 123)
  )

  // ç¬¬ 2 æ­¥ï¼šæ³¨å…¥ mock æ•°æ®
  const mockUser = { id: 123, name: 'Alice' }
  expect(gen.next(mockUser).value).toEqual(
    put({ type: 'FETCH_USER_SUCCESS', payload: mockUser })
  )

  // ç¬¬ 3 æ­¥ï¼šéªŒè¯å®Œæˆ
  expect(gen.next().done).toBe(true)
})

// æµ‹è¯•é”™è¯¯æµç¨‹
test('fetchUserSaga error handling', () => {
  const gen = fetchUserSaga({ payload: 123 })

  gen.next() // call effect

  // æ³¨å…¥é”™è¯¯
  const error = new Error('Network error')
  expect(gen.throw(error).value).toEqual(
    put({ type: 'FETCH_USER_FAILURE', error })
  )
})
```

#### 7. redux-saga å®ç°åŸç†ï¼ˆç®€åŒ–ç‰ˆï¼‰

```javascript
// ç®€åŒ–çš„ saga middleware å®ç°
function createSagaMiddleware() {
  const sagaTasks = []

  const middleware = (store) => (next) => (action) => {
    // 1. å…ˆè®© action åˆ°è¾¾ reducer
    const result = next(action)

    // 2. é€šçŸ¥æ‰€æœ‰ saga æœ‰æ–° action
    sagaTasks.forEach(task => task.next(action))

    return result
  }

  // run æ–¹æ³•ï¼šå¯åŠ¨ root saga
  middleware.run = (rootSaga) => {
    const task = runSaga(rootSaga, store)
    sagaTasks.push(task)
  }

  return middleware
}

// æ‰§è¡Œ saga generator
function runSaga(saga, store) {
  const gen = saga()

  function processNext(arg) {
    const { value: effect, done } = gen.next(arg)

    if (done) return

    // è§£æ effect å¹¶æ‰§è¡Œ
    if (effect.type === 'CALL') {
      const result = effect.fn(...effect.args)

      if (result.then) {
        // å¼‚æ­¥å‡½æ•°
        result.then(processNext)
      } else {
        // åŒæ­¥å‡½æ•°
        processNext(result)
      }
    } else if (effect.type === 'PUT') {
      store.dispatch(effect.action)
      processNext()
    } else if (effect.type === 'SELECT') {
      const result = effect.selector(store.getState())
      processNext(result)
    } else if (effect.type === 'TAKE') {
      // ç­‰å¾…ç‰¹å®š actionï¼ˆç®€åŒ–å®ç°ï¼‰
      const unsubscribe = store.subscribe(() => {
        const state = store.getState()
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç›®æ ‡ action...
        unsubscribe()
        processNext(action)
      })
    }
  }

  processNext()

  return gen
}
```

---

### ä¸‰ã€redux-saga vs redux-thunk

| ç»´åº¦ | redux-thunk | redux-saga |
|------|-------------|------------|
| **å­¦ä¹ æ›²çº¿** | ç®€å•ï¼ˆå°±æ˜¯å‡½æ•°ï¼‰ | é™¡å³­ï¼ˆGenerator + Effectsï¼‰ |
| **ä»£ç é‡** | å°‘ | å¤š |
| **å¯æµ‹è¯•æ€§** | å›°éš¾ï¼ˆéœ€ mock å‰¯ä½œç”¨ï¼‰ | å®¹æ˜“ï¼ˆEffect æ˜¯çº¯å¯¹è±¡ï¼‰ |
| **æµç¨‹æ§åˆ¶** | åŸºç¡€ï¼ˆasync/awaitï¼‰ | å¼ºå¤§ï¼ˆtakeã€raceã€fork ç­‰ï¼‰ |
| **å–æ¶ˆè¯·æ±‚** | æ‰‹åŠ¨å®ç° | å†…ç½®æ”¯æŒ |
| **å¤æ‚å¼‚æ­¥** | éš¾ä»¥ç»´æŠ¤ | å£°æ˜å¼ï¼Œæ¸…æ™° |
| **é€‚ç”¨åœºæ™¯** | ç®€å•å¼‚æ­¥è¯·æ±‚ | å¤æ‚ä¸šåŠ¡æµç¨‹ã€WebSocketã€è½®è¯¢ |

**ç¤ºä¾‹å¯¹æ¯”**ï¼š

```javascript
// ========== redux-thunk ==========
const fetchUser = (userId) => async (dispatch) => {
  dispatch({ type: 'LOADING' })

  try {
    const user = await fetch(`/api/users/${userId}`).then(r => r.json())
    dispatch({ type: 'SUCCESS', user })
  } catch (error) {
    dispatch({ type: 'ERROR', error })
  }
}

// ========== redux-saga ==========
function* fetchUserSaga(action) {
  yield put({ type: 'LOADING' })

  try {
    const user = yield call(fetch, `/api/users/${action.payload}`)
    yield put({ type: 'SUCCESS', user })
  } catch (error) {
    yield put({ type: 'ERROR', error })
  }
}

function* watchFetchUser() {
  yield takeLatest('FETCH_USER', fetchUserSaga)
}
```

---

### å››ã€å®æˆ˜æœ€ä½³å®è·µ

#### 1. ç»„ç»‡ç»“æ„

```
src/
  store/
    sagas/
      index.js           # Root saga
      userSaga.js        # ç”¨æˆ·ç›¸å…³ saga
      orderSaga.js       # è®¢å•ç›¸å…³ saga
      authSaga.js        # è®¤è¯ç›¸å…³ saga
    slices/
      userSlice.js       # Redux Toolkit slice
    index.js             # Store é…ç½®
```

#### 2. ä¸ Redux Toolkit ç»“åˆ

```javascript
// userSlice.js (RTK)
import { createSlice } from '@reduxjs/toolkit'

const userSlice = createSlice({
  name: 'user',
  initialState: { data: null, loading: false },
  reducers: {
    fetchUserRequest: (state) => { state.loading = true },
    fetchUserSuccess: (state, action) => {
      state.data = action.payload
      state.loading = false
    },
    fetchUserFailure: (state) => { state.loading = false }
  }
})

export const { fetchUserRequest, fetchUserSuccess, fetchUserFailure } = userSlice.actions
export default userSlice.reducer

// userSaga.js
import { call, put, takeLatest } from 'redux-saga/effects'
import { fetchUserRequest, fetchUserSuccess, fetchUserFailure } from './userSlice'

function* fetchUserSaga(action) {
  try {
    const user = yield call(api.fetchUser, action.payload)
    yield put(fetchUserSuccess(user))
  } catch (error) {
    yield put(fetchUserFailure())
  }
}

export default function* userSagaWatcher() {
  yield takeLatest(fetchUserRequest.type, fetchUserSaga)
}
```

#### 3. é”™è¯¯å¤„ç†ç»Ÿä¸€åŒ–

```javascript
// å…¨å±€é”™è¯¯å¤„ç† saga
function* globalErrorHandler() {
  yield takeEvery('*', function* (action) {
    if (action.type.endsWith('_FAILURE')) {
      yield put({ type: 'SHOW_TOAST', message: action.error.message })
      yield call(logErrorToServer, action.error)
    }
  })
}
```

#### 4. æ€§èƒ½ä¼˜åŒ–

```javascript
// ä½¿ç”¨ channel æ‰¹é‡å¤„ç†
import { actionChannel, take, call } from 'redux-saga/effects'

function* watchRequests() {
  // åˆ›å»ºç¼“å†²é€šé“
  const requestChan = yield actionChannel('API_REQUEST')

  while (true) {
    // ä»é€šé“ä¸­å–å‡º actionï¼ˆæ’é˜Ÿå¤„ç†ï¼Œé¿å…å¹¶å‘è¿‡å¤šï¼‰
    const action = yield take(requestChan)
    yield call(handleRequest, action)
  }
}
```

---

## æ€»ç»“

### ä¸­é—´ä»¶æœºåˆ¶
- Redux ä¸­é—´ä»¶åŸºäº**æ´‹è‘±æ¨¡å‹**ï¼Œé€šè¿‡å‡½æ•°ç»„åˆå¢å¼º dispatch
- `applyMiddleware` é€šè¿‡ compose ä»å³åˆ°å·¦ç»„åˆä¸­é—´ä»¶
- ä¸­é—´ä»¶å¯ä»¥æ‹¦æˆªã€ä¿®æ”¹ã€å»¶è¿Ÿç”šè‡³é˜»æ­¢ Action

### redux-saga
- åŸºäº **Generator** å’Œ **Effects** å®ç°å£°æ˜å¼å‰¯ä½œç”¨ç®¡ç†
- æ ¸å¿ƒä¼˜åŠ¿ï¼š**å¯æµ‹è¯•**ï¼ˆEffects æ˜¯çº¯å¯¹è±¡ï¼‰ã€**å¯å–æ¶ˆ**ã€**å¼ºå¤§çš„æµç¨‹æ§åˆ¶**
- é€‚åˆå¤æ‚å¼‚æ­¥åœºæ™¯ï¼šè½®è¯¢ã€WebSocketã€å¤šæ­¥éª¤æµç¨‹ã€ç«æ€å¤„ç†

### é€‰æ‹©å»ºè®®
- **ç®€å•å¼‚æ­¥**ï¼šredux-thunkï¼ˆæˆ– RTK createAsyncThunkï¼‰
- **å¤æ‚ä¸šåŠ¡æµç¨‹**ï¼šredux-saga
- **ç°ä»£é¡¹ç›®**ï¼šè€ƒè™‘ RTK Queryï¼ˆå†…ç½®ç¼“å­˜ã€è‡ªåŠ¨é‡è¯•ï¼‰

æŒæ¡ redux-saga èƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†å¤æ‚å¼‚æ­¥é€»è¾‘ï¼Œæ˜¯é«˜çº§ React å¼€å‘è€…çš„å¿…å¤‡æŠ€èƒ½ã€‚
