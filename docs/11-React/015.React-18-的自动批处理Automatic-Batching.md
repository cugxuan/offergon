---
title: React 18 çš„è‡ªåŠ¨æ‰¹å¤„ç†ï¼ˆAutomatic Batchingï¼‰
tags:
  - å‰ç«¯React
status: robot
class: å‰ç«¯React
slug: react-18-automatic-batching
ref:
---

## æ ¸å¿ƒè¦ç‚¹

- **è‡ªåŠ¨æ‰¹å¤„ç†**å°†å¤šä¸ªçŠ¶æ€æ›´æ–°åˆå¹¶ä¸ºä¸€æ¬¡é‡æ–°æ¸²æŸ“ï¼Œå‡å°‘æ¸²æŸ“æ¬¡æ•°ï¼Œæå‡æ€§èƒ½
- React 18 ä¹‹å‰ï¼šåªåœ¨äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†ï¼›React 18ï¼šåœ¨**æ‰€æœ‰åœºæ™¯**ä¸‹è‡ªåŠ¨æ‰¹å¤„ç†
- æ ¸å¿ƒåŸç†ï¼šå°†å¤šä¸ª `setState` è°ƒç”¨æ”¶é›†åˆ°é˜Ÿåˆ—ä¸­ï¼Œåœ¨äº‹ä»¶å¾ªç¯çš„å¾®ä»»åŠ¡é˜¶æ®µç»Ÿä¸€å¤„ç†
- é€€å‡ºæ‰¹å¤„ç†ï¼šä½¿ç”¨ `flushSync` å¼ºåˆ¶åŒæ­¥æ›´æ–°
- ä¼˜åŠ¿ï¼šå¤§å¹…å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“ï¼Œæå‡å¤æ‚åº”ç”¨æ€§èƒ½

---

## è¯¦ç»†è§£ç­”

### ä¸€ã€ä»€ä¹ˆæ˜¯è‡ªåŠ¨æ‰¹å¤„ç†ï¼Ÿ

#### 1.1 æ‰¹å¤„ç†ï¼ˆBatchingï¼‰çš„æ¦‚å¿µ

**æ‰¹å¤„ç†**æ˜¯æŒ‡å°†å¤šä¸ªçŠ¶æ€æ›´æ–°åˆå¹¶ä¸ºä¸€æ¬¡é‡æ–°æ¸²æŸ“çš„ä¼˜åŒ–æœºåˆ¶ã€‚

**æ²¡æœ‰æ‰¹å¤„ç†çš„æƒ…å†µ**ï¼ˆå‡è®¾ï¼‰ï¼š
```jsx
function App() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  const handleClick = () => {
    setCount(c => c + 1); // è§¦å‘æ¸²æŸ“ 1
    setFlag(f => !f);     // è§¦å‘æ¸²æŸ“ 2
    // æ€»å…±æ¸²æŸ“ 2 æ¬¡
  };

  console.log('æ¸²æŸ“');
  return <div>{count}</div>;
}
```

**æœ‰æ‰¹å¤„ç†çš„æƒ…å†µ**ï¼ˆReact å®é™…è¡Œä¸ºï¼‰ï¼š
```jsx
function App() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  const handleClick = () => {
    setCount(c => c + 1); // åŠ å…¥æ‰¹å¤„ç†é˜Ÿåˆ—
    setFlag(f => !f);     // åŠ å…¥æ‰¹å¤„ç†é˜Ÿåˆ—
    // äº‹ä»¶ç»“æŸåï¼Œç»Ÿä¸€å¤„ç†ï¼Œåªæ¸²æŸ“ 1 æ¬¡
  };

  console.log('æ¸²æŸ“'); // ç‚¹å‡»ååªæ‰“å° 1 æ¬¡
  return <div>{count}</div>;
}
```

#### 1.2 React 18 ä¹‹å‰çš„æ‰¹å¤„ç†é™åˆ¶

**React 17 åŠæ›´æ—©ç‰ˆæœ¬**ï¼š
- âœ… **äº‹ä»¶å¤„ç†å™¨å†…**ï¼šè‡ªåŠ¨æ‰¹å¤„ç†
- âŒ **Promiseã€setTimeoutã€åŸç”Ÿäº‹ä»¶**ï¼šä¸æ‰¹å¤„ç†

```jsx
// React 17
function App() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  // âœ… æ‰¹å¤„ç†ç”Ÿæ•ˆï¼ˆåªæ¸²æŸ“ 1 æ¬¡ï¼‰
  const handleClick = () => {
    setCount(c => c + 1);
    setFlag(f => !f);
  };

  // âŒ æ‰¹å¤„ç†ä¸ç”Ÿæ•ˆï¼ˆæ¸²æŸ“ 2 æ¬¡ï¼‰
  const handleClickAsync = () => {
    setTimeout(() => {
      setCount(c => c + 1); // æ¸²æŸ“ 1
      setFlag(f => !f);     // æ¸²æŸ“ 2
    }, 0);
  };

  // âŒ æ‰¹å¤„ç†ä¸ç”Ÿæ•ˆï¼ˆæ¸²æŸ“ 2 æ¬¡ï¼‰
  const fetchData = () => {
    fetch('/api').then(() => {
      setCount(c => c + 1); // æ¸²æŸ“ 1
      setFlag(f => !f);     // æ¸²æŸ“ 2
    });
  };

  return <button onClick={handleClick}>ç‚¹å‡»</button>;
}
```

**é—®é¢˜**ï¼š
- å¼‚æ­¥ä»£ç ä¸­çš„å¤šä¸ª `setState` ä¼šå¯¼è‡´å¤šæ¬¡æ¸²æŸ“
- æ€§èƒ½æµªè´¹ï¼Œç”¨æˆ·ä½“éªŒå·®

#### 1.3 React 18 çš„è‡ªåŠ¨æ‰¹å¤„ç†

**React 18**ï¼šæ— è®ºåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ï¼Œéƒ½è‡ªåŠ¨æ‰¹å¤„ç†ã€‚

```jsx
// React 18
function App() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  // âœ… æ‰¹å¤„ç†ï¼ˆåªæ¸²æŸ“ 1 æ¬¡ï¼‰
  const handleClick = () => {
    setCount(c => c + 1);
    setFlag(f => !f);
  };

  // âœ… æ‰¹å¤„ç†ï¼ˆåªæ¸²æŸ“ 1 æ¬¡ï¼‰- React 18 æ–°å¢
  const handleClickAsync = () => {
    setTimeout(() => {
      setCount(c => c + 1);
      setFlag(f => !f);
    }, 0);
  };

  // âœ… æ‰¹å¤„ç†ï¼ˆåªæ¸²æŸ“ 1 æ¬¡ï¼‰- React 18 æ–°å¢
  const fetchData = () => {
    fetch('/api').then(() => {
      setCount(c => c + 1);
      setFlag(f => !f);
    });
  };

  // âœ… æ‰¹å¤„ç†ï¼ˆåªæ¸²æŸ“ 1 æ¬¡ï¼‰- React 18 æ–°å¢
  const handleNativeClick = () => {
    document.addEventListener('click', () => {
      setCount(c => c + 1);
      setFlag(f => !f);
    });
  };

  return <button onClick={handleClick}>ç‚¹å‡»</button>;
}
```

**è¦†ç›–åœºæ™¯**ï¼š
- âœ… äº‹ä»¶å¤„ç†å™¨ï¼ˆonClickã€onChangeï¼‰
- âœ… Promise.thenã€async/await
- âœ… setTimeoutã€setInterval
- âœ… åŸç”Ÿäº‹ä»¶ç›‘å¬å™¨ï¼ˆaddEventListenerï¼‰
- âœ… ä»»ä½•å¼‚æ­¥å›è°ƒ

---

### äºŒã€å·¥ä½œåŸç†

#### 2.1 æ‰¹å¤„ç†é˜Ÿåˆ—

React åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª**æ›´æ–°é˜Ÿåˆ—**ï¼Œæ”¶é›†æ‰€æœ‰çŠ¶æ€æ›´æ–°ã€‚

```js
// React å†…éƒ¨ç®€åŒ–é€»è¾‘
let updateQueue = [];
let isBatchingUpdates = false;

function setState(newState) {
  // å°†æ›´æ–°åŠ å…¥é˜Ÿåˆ—
  updateQueue.push(newState);

  // å¦‚æœä¸åœ¨æ‰¹å¤„ç†ä¸­ï¼Œå¼€å§‹æ‰¹å¤„ç†
  if (!isBatchingUpdates) {
    isBatchingUpdates = true;

    // åœ¨å¾®ä»»åŠ¡ä¸­ç»Ÿä¸€å¤„ç†ï¼ˆReact 18ï¼‰
    queueMicrotask(() => {
      flushUpdates();
      isBatchingUpdates = false;
    });
  }
}

function flushUpdates() {
  // åˆå¹¶æ‰€æœ‰æ›´æ–°ï¼Œåªè§¦å‘ä¸€æ¬¡æ¸²æŸ“
  const mergedState = updateQueue.reduce((acc, update) => {
    return { ...acc, ...update };
  }, {});

  updateQueue = [];
  performRerender(mergedState);
}
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
ç”¨æˆ·æ“ä½œ
    â†“
setCount(1) â†’ åŠ å…¥é˜Ÿåˆ— [setCount]
    â†“
setFlag(true) â†’ åŠ å…¥é˜Ÿåˆ— [setCount, setFlag]
    â†“
äº‹ä»¶å¤„ç†å™¨ç»“æŸ
    â†“
å¾®ä»»åŠ¡é˜¶æ®µï¼šåˆå¹¶æ›´æ–°
    â†“
åªè§¦å‘ 1 æ¬¡æ¸²æŸ“
```

#### 2.2 React 18 çš„æ”¹è¿›ï¼šç»Ÿä¸€æ‰¹å¤„ç†å…¥å£

**React 17**ï¼šæ‰¹å¤„ç†é€»è¾‘åˆ†æ•£åœ¨ä¸åŒäº‹ä»¶ç±»å‹ä¸­
```js
// React 17 ç®€åŒ–é€»è¾‘
function dispatchEvent(event) {
  batchedUpdates(() => {
    handleEvent(event); // åªåœ¨äº‹ä»¶å¤„ç†å™¨ä¸­æ‰¹å¤„ç†
  });
}

function setTimeout(callback, delay) {
  // å¼‚æ­¥å›è°ƒæ²¡æœ‰æ‰¹å¤„ç†åŒ…è£¹
  realSetTimeout(() => {
    callback(); // æ¯æ¬¡ setState éƒ½ç«‹å³æ¸²æŸ“
  }, delay);
}
```

**React 18**ï¼šæ‰€æœ‰æ›´æ–°éƒ½é€šè¿‡ç»Ÿä¸€çš„è°ƒåº¦å™¨
```js
// React 18 ç®€åŒ–é€»è¾‘
function scheduleUpdate(fiber, update) {
  // æ— è®ºæ¥æºï¼Œéƒ½åŠ å…¥è°ƒåº¦é˜Ÿåˆ—
  ensureRootIsScheduled(fiber.root);
}

function ensureRootIsScheduled(root) {
  // åœ¨å¾®ä»»åŠ¡ä¸­ç»Ÿä¸€å¤„ç†æ‰€æœ‰æ›´æ–°
  queueMicrotask(() => {
    performConcurrentWorkOnRoot(root);
  });
}
```

#### 2.3 å¾®ä»»åŠ¡ï¼ˆMicrotaskï¼‰çš„ä½¿ç”¨

React 18 ä½¿ç”¨**å¾®ä»»åŠ¡é˜Ÿåˆ—**å®ç°è‡ªåŠ¨æ‰¹å¤„ç†ã€‚

**JavaScript äº‹ä»¶å¾ªç¯**ï¼š
```
[å®ä»»åŠ¡] â†’ [å¾®ä»»åŠ¡é˜Ÿåˆ—] â†’ [æ¸²æŸ“] â†’ [ä¸‹ä¸€ä¸ªå®ä»»åŠ¡] â†’ ...
```

**ç¤ºä¾‹**ï¼š
```js
console.log('1: åŒæ­¥ä»£ç ');

setTimeout(() => {
  console.log('2: å®ä»»åŠ¡ (setTimeout)');
}, 0);

queueMicrotask(() => {
  console.log('3: å¾®ä»»åŠ¡ (queueMicrotask)');
});

Promise.resolve().then(() => {
  console.log('4: å¾®ä»»åŠ¡ (Promise)');
});

console.log('5: åŒæ­¥ä»£ç ');

// è¾“å‡ºé¡ºåºï¼š1 â†’ 5 â†’ 3 â†’ 4 â†’ 2
```

**React 18 çš„æ‰¹å¤„ç†æµç¨‹**ï¼š
```jsx
function handleClick() {
  setCount(1);       // åŒæ­¥ä»£ç 
  setFlag(true);     // åŒæ­¥ä»£ç 

  // React åœ¨å¾®ä»»åŠ¡ä¸­ç»Ÿä¸€å¤„ç†
  queueMicrotask(() => {
    // åˆå¹¶ setCount å’Œ setFlagï¼Œåªæ¸²æŸ“ 1 æ¬¡
    performRerender();
  });
}
```

---

### ä¸‰ã€å¯¹æ¯”ç¤ºä¾‹

#### 3.1 React 17 vs React 18

```jsx
import { useState } from 'react';

function Counter() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  console.log('æ¸²æŸ“');

  // åœºæ™¯ 1ï¼šäº‹ä»¶å¤„ç†å™¨
  const handleSyncClick = () => {
    setCount(c => c + 1);
    setFlag(f => !f);
  };
  // React 17: æ¸²æŸ“ 1 æ¬¡ âœ…
  // React 18: æ¸²æŸ“ 1 æ¬¡ âœ…

  // åœºæ™¯ 2ï¼šsetTimeout
  const handleAsyncClick = () => {
    setTimeout(() => {
      setCount(c => c + 1);
      setFlag(f => !f);
    }, 0);
  };
  // React 17: æ¸²æŸ“ 2 æ¬¡ âŒ
  // React 18: æ¸²æŸ“ 1 æ¬¡ âœ…

  // åœºæ™¯ 3ï¼šPromise
  const handlePromiseClick = () => {
    fetch('/api').then(() => {
      setCount(c => c + 1);
      setFlag(f => !f);
    });
  };
  // React 17: æ¸²æŸ“ 2 æ¬¡ âŒ
  // React 18: æ¸²æŸ“ 1 æ¬¡ âœ…

  // åœºæ™¯ 4ï¼šåŸç”Ÿäº‹ä»¶
  const handleNativeClick = () => {
    document.getElementById('btn').addEventListener('click', () => {
      setCount(c => c + 1);
      setFlag(f => !f);
    });
  };
  // React 17: æ¸²æŸ“ 2 æ¬¡ âŒ
  // React 18: æ¸²æŸ“ 1 æ¬¡ âœ…

  return (
    <div>
      <p>Count: {count}</p>
      <p>Flag: {flag.toString()}</p>
      <button onClick={handleSyncClick}>åŒæ­¥æ›´æ–°</button>
      <button onClick={handleAsyncClick}>å¼‚æ­¥æ›´æ–°</button>
    </div>
  );
}
```

#### 3.2 æ€§èƒ½æå‡éªŒè¯

```jsx
import { useState, useEffect } from 'react';

function PerformanceTest() {
  const [count, setCount] = useState(0);
  const [color, setColor] = useState('red');
  const [size, setSize] = useState(10);

  let renderCount = 0;

  useEffect(() => {
    renderCount++;
    console.log(`æ¸²æŸ“æ¬¡æ•°: ${renderCount}`);
  });

  const handleClick = () => {
    setTimeout(() => {
      setCount(c => c + 1);
      setColor('blue');
      setSize(20);
    }, 0);
  };

  return (
    <div>
      <p style={{ color, fontSize: size }}>{count}</p>
      <button onClick={handleClick}>æ›´æ–°</button>
    </div>
  );
}

// React 17: ç‚¹å‡»åæ¸²æŸ“ 3 æ¬¡
// React 18: ç‚¹å‡»åæ¸²æŸ“ 1 æ¬¡ ğŸš€
```

---

### å››ã€é€€å‡ºæ‰¹å¤„ç†ï¼šflushSync

æœ‰æ—¶éœ€è¦**å¼ºåˆ¶åŒæ­¥æ›´æ–°**ï¼Œå¯ä»¥ä½¿ç”¨ `flushSync`ã€‚

#### 4.1 åŸºæœ¬ç”¨æ³•

```jsx
import { flushSync } from 'react-dom';

function SearchInput() {
  const [query, setQuery] = useState('');
  const inputRef = useRef(null);

  const handleChange = (e) => {
    const newQuery = e.target.value;

    // å¼ºåˆ¶åŒæ­¥æ›´æ–°ï¼Œç«‹å³åæ˜ åˆ° DOM
    flushSync(() => {
      setQuery(newQuery);
    });

    // æ­¤æ—¶ DOM å·²æ›´æ–°ï¼Œå¯ä»¥è¯»å–æœ€æ–°å€¼
    console.log(inputRef.current.value); // æœ€æ–°å€¼
  };

  return <input ref={inputRef} value={query} onChange={handleChange} />;
}
```

#### 4.2 ä½¿ç”¨åœºæ™¯

**åœºæ™¯ 1ï¼šéœ€è¦åœ¨ DOM æ›´æ–°åç«‹å³è¯»å–å¸ƒå±€ä¿¡æ¯**

```jsx
function ScrollToBottom() {
  const [messages, setMessages] = useState([]);
  const listRef = useRef(null);

  const addMessage = (message) => {
    // å¼ºåˆ¶åŒæ­¥æ›´æ–°
    flushSync(() => {
      setMessages(msgs => [...msgs, message]);
    });

    // DOM å·²æ›´æ–°ï¼Œå¯ä»¥æ»šåŠ¨åˆ°åº•éƒ¨
    listRef.current.scrollTop = listRef.current.scrollHeight;
  };

  return (
    <div ref={listRef}>
      {messages.map(msg => <div key={msg.id}>{msg.text}</div>)}
    </div>
  );
}
```

**åœºæ™¯ 2ï¼šç¬¬ä¸‰æ–¹åº“éœ€è¦åŒæ­¥ DOM æ›´æ–°**

```jsx
function ChartComponent() {
  const [data, setData] = useState([]);
  const chartRef = useRef(null);

  const updateChart = (newData) => {
    // å¼ºåˆ¶åŒæ­¥æ›´æ–°ï¼Œç¡®ä¿ DOM å…ˆæ›´æ–°
    flushSync(() => {
      setData(newData);
    });

    // åˆå§‹åŒ–å›¾è¡¨ï¼ˆéœ€è¦è¯»å– DOM å°ºå¯¸ï¼‰
    new Chart(chartRef.current, { data });
  };

  return <div ref={chartRef}></div>;
}
```

#### 4.3 æ€§èƒ½æ³¨æ„äº‹é¡¹

âš ï¸ **ä¸è¦æ»¥ç”¨ `flushSync`**ï¼š
```jsx
// âŒ é”™è¯¯ï¼šè¿‡åº¦ä½¿ç”¨å¯¼è‡´æ€§èƒ½é—®é¢˜
const handleClick = () => {
  flushSync(() => setCount(1));  // æ¸²æŸ“ 1
  flushSync(() => setFlag(true)); // æ¸²æŸ“ 2
  flushSync(() => setColor('red')); // æ¸²æŸ“ 3
  // æ€»å…±æ¸²æŸ“ 3 æ¬¡ï¼Œå¤±å»æ‰¹å¤„ç†ä¼˜åŠ¿
};

// âœ… æ­£ç¡®ï¼šåªåœ¨å¿…è¦æ—¶ä½¿ç”¨
const handleClick = () => {
  setCount(1);
  setFlag(true);
  setColor('red');
  // è‡ªåŠ¨æ‰¹å¤„ç†ï¼Œåªæ¸²æŸ“ 1 æ¬¡
};
```

---

### äº”ã€å®æˆ˜æ¡ˆä¾‹

#### 5.1 æ•°æ®è·å–åæ›´æ–°å¤šä¸ªçŠ¶æ€

```jsx
function UserProfile({ userId }) {
  const [user, setUser] = useState(null);
  const [posts, setPosts] = useState([]);
  const [loading, setLoading] = useState(false);

  const fetchUserData = async () => {
    setLoading(true);

    const [userData, postsData] = await Promise.all([
      fetch(`/api/users/${userId}`).then(r => r.json()),
      fetch(`/api/users/${userId}/posts`).then(r => r.json())
    ]);

    // React 18: è‡ªåŠ¨æ‰¹å¤„ç†ï¼Œåªæ¸²æŸ“ 1 æ¬¡ âœ…
    setUser(userData);
    setPosts(postsData);
    setLoading(false);

    // React 17: æ¸²æŸ“ 3 æ¬¡ âŒ
  };

  useEffect(() => {
    fetchUserData();
  }, [userId]);

  if (loading) return <Spinner />;

  return (
    <div>
      <h1>{user?.name}</h1>
      <PostsList posts={posts} />
    </div>
  );
}
```

#### 5.2 WebSocket å®æ—¶æ›´æ–°

```jsx
function ChatRoom() {
  const [messages, setMessages] = useState([]);
  const [users, setUsers] = useState([]);
  const [typingUsers, setTypingUsers] = useState([]);

  useEffect(() => {
    const ws = new WebSocket('ws://localhost:3000');

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      // React 18: è‡ªåŠ¨æ‰¹å¤„ç†ï¼Œåªæ¸²æŸ“ 1 æ¬¡ âœ…
      setMessages(msgs => [...msgs, data.message]);
      setUsers(data.users);
      setTypingUsers(data.typingUsers);

      // React 17: æ¸²æŸ“ 3 æ¬¡ âŒ
    };

    return () => ws.close();
  }, []);

  return (
    <div>
      <MessageList messages={messages} />
      <UserList users={users} />
      <TypingIndicator users={typingUsers} />
    </div>
  );
}
```

#### 5.3 å®šæ—¶å™¨æ›´æ–°

```jsx
function CountdownTimer() {
  const [seconds, setSeconds] = useState(60);
  const [minutes, setMinutes] = useState(5);
  const [isActive, setIsActive] = useState(false);

  useEffect(() => {
    if (!isActive) return;

    const timer = setInterval(() => {
      // React 18: è‡ªåŠ¨æ‰¹å¤„ç†ï¼Œåªæ¸²æŸ“ 1 æ¬¡ âœ…
      setSeconds(s => {
        if (s === 0) {
          setMinutes(m => m - 1);
          return 59;
        }
        return s - 1;
      });
      setIsActive(seconds > 0 || minutes > 0);

      // React 17: å¯èƒ½æ¸²æŸ“ 2-3 æ¬¡ âŒ
    }, 1000);

    return () => clearInterval(timer);
  }, [isActive, seconds, minutes]);

  return (
    <div>
      {minutes}:{seconds.toString().padStart(2, '0')}
    </div>
  );
}
```

---

### å…­ã€è¿ç§»æŒ‡å—

#### 6.1 ä» React 17 å‡çº§åˆ° React 18

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè‡ªåŠ¨æ‰¹å¤„ç†æ˜¯**å‘åå…¼å®¹**çš„ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚

```jsx
// è¿™æ®µä»£ç åœ¨ React 17 å’Œ 18 ä¸­è¡Œä¸ºä¸€è‡´
function App() {
  const [count, setCount] = useState(0);

  const handleClick = () => {
    setCount(c => c + 1);
    setCount(c => c + 1);
  };

  return <button onClick={handleClick}>{count}</button>;
}
```

#### 6.2 å¯èƒ½çš„ç ´åæ€§å˜æ›´

**åœºæ™¯ï¼šä¾èµ–å¤šæ¬¡æ¸²æŸ“çš„ä»£ç **

```jsx
// React 17
function Component() {
  const [count, setCount] = useState(0);

  const handleClick = () => {
    setTimeout(() => {
      setCount(1);
      // åœ¨ React 17 ä¸­ï¼Œè¿™é‡Œä¼šè§¦å‘æ¸²æŸ“ï¼Œref.current ä¼šæ›´æ–°
      console.log(ref.current.textContent); // "1"

      setCount(2);
      // å†æ¬¡æ¸²æŸ“
      console.log(ref.current.textContent); // "2"
    }, 0);
  };

  return <div ref={ref}>{count}</div>;
}

// React 18ï¼šæ‰¹å¤„ç†åï¼Œåªåœ¨æœ€åæ¸²æŸ“ä¸€æ¬¡
// éœ€è¦ä½¿ç”¨ flushSync ä¿®å¤
const handleClick = () => {
  setTimeout(() => {
    flushSync(() => {
      setCount(1);
    });
    console.log(ref.current.textContent); // "1"

    flushSync(() => {
      setCount(2);
    });
    console.log(ref.current.textContent); // "2"
  }, 0);
};
```

#### 6.3 é€€å‡ºè‡ªåŠ¨æ‰¹å¤„ç†ï¼ˆä¸æ¨èï¼‰

å¦‚æœç¡®å®éœ€è¦ React 17 çš„è¡Œä¸ºï¼Œå¯ä»¥ç”¨ `flushSync` åŒ…è£¹æ¯ä¸ªæ›´æ–°ï¼š

```jsx
import { flushSync } from 'react-dom';

// æ¨¡æ‹Ÿ React 17 è¡Œä¸ºï¼ˆä¸æ¨èï¼‰
const handleClick = () => {
  setTimeout(() => {
    flushSync(() => {
      setCount(c => c + 1); // æ¸²æŸ“ 1
    });

    flushSync(() => {
      setFlag(f => !f); // æ¸²æŸ“ 2
    });
  }, 0);
};
```

---

### ä¸ƒã€å¸¸è§é—®é¢˜

#### Q1ï¼šæ‰¹å¤„ç†ä¼šå»¶è¿ŸçŠ¶æ€æ›´æ–°å—ï¼Ÿ

**ç­”**ï¼šä¸ä¼šã€‚çŠ¶æ€ç«‹å³æ›´æ–°ï¼Œåªæ˜¯**æ¸²æŸ“è¢«å»¶è¿Ÿåˆ°å¾®ä»»åŠ¡é˜¶æ®µ**ã€‚

```jsx
const handleClick = () => {
  setCount(1);
  console.log(count); // ä»ç„¶æ˜¯æ—§å€¼ï¼ˆé—­åŒ…ï¼‰

  // ä½†å†…éƒ¨çŠ¶æ€å·²æ›´æ–°ï¼Œä¸‹æ¬¡æ¸²æŸ“æ—¶ä¼šä½¿ç”¨æ–°å€¼
};
```

#### Q2ï¼šå¦‚ä½•åˆ¤æ–­æ˜¯å¦åœ¨æ‰¹å¤„ç†ä¸­ï¼Ÿ

**ç­”**ï¼šæ— éœ€åˆ¤æ–­ï¼ŒReact 18 è‡ªåŠ¨å¤„ç†ã€‚å¦‚éœ€åŒæ­¥æ›´æ–°ï¼Œä½¿ç”¨ `flushSync`ã€‚

#### Q3ï¼šæ‰¹å¤„ç†å¯¹ useEffect æœ‰å½±å“å—ï¼Ÿ

**ç­”**ï¼š`useEffect` åœ¨ DOM æ›´æ–°åæ‰§è¡Œï¼Œæ‰¹å¤„ç†å‡å°‘äº† effect çš„æ‰§è¡Œæ¬¡æ•°ã€‚

```jsx
function App() {
  const [count, setCount] = useState(0);
  const [flag, setFlag] = useState(false);

  useEffect(() => {
    console.log('Effect æ‰§è¡Œ');
  }, [count, flag]);

  const handleClick = () => {
    setTimeout(() => {
      setCount(1);
      setFlag(true);
    }, 0);
  };

  // React 17: Effect æ‰§è¡Œ 2 æ¬¡
  // React 18: Effect æ‰§è¡Œ 1 æ¬¡
}
```

#### Q4ï¼šæ‰¹å¤„ç†åœ¨ StrictMode ä¸‹è¡¨ç°å¦‚ä½•ï¼Ÿ

**ç­”**ï¼šå¼€å‘ç¯å¢ƒçš„ `StrictMode` ä¼š**æ•…æ„è°ƒç”¨ç»„ä»¶ä¸¤æ¬¡**ï¼Œä½†è¿™ä¸æ‰¹å¤„ç†æ— å…³ã€‚

```jsx
<React.StrictMode>
  <App />
</React.StrictMode>

// å¼€å‘ç¯å¢ƒï¼šç»„ä»¶æ¸²æŸ“ 2 æ¬¡ï¼ˆStrictMode è¡Œä¸ºï¼‰
// ç”Ÿäº§ç¯å¢ƒï¼šæ­£å¸¸æ‰¹å¤„ç†ï¼Œæ¸²æŸ“ 1 æ¬¡
```

---

### å…«ã€æœ€ä½³å®è·µ

#### 8.1 ä¼˜å…ˆä½¿ç”¨è‡ªåŠ¨æ‰¹å¤„ç†

```jsx
// âœ… æ¨èï¼šè®© React è‡ªåŠ¨æ‰¹å¤„ç†
const handleClick = () => {
  setCount(1);
  setFlag(true);
  setColor('red');
};

// âŒ é¿å…ï¼šæ‰‹åŠ¨ç®¡ç†æ‰¹å¤„ç†
const handleClick = () => {
  ReactDOM.unstable_batchedUpdates(() => {
    setCount(1);
    setFlag(true);
    setColor('red');
  });
};
```

#### 8.2 åªåœ¨å¿…è¦æ—¶ä½¿ç”¨ flushSync

```jsx
// âœ… åˆç†ä½¿ç”¨
const scrollToBottom = () => {
  flushSync(() => {
    setMessages(msgs => [...msgs, newMessage]);
  });
  scrollRef.current.scrollIntoView();
};

// âŒ è¿‡åº¦ä½¿ç”¨
const handleClick = () => {
  flushSync(() => setCount(1));
  flushSync(() => setFlag(true)); // æ²¡å¿…è¦
};
```

#### 8.3 ä½¿ç”¨ React DevTools Profiler éªŒè¯

```jsx
import { Profiler } from 'react';

function App() {
  const onRender = (id, phase, actualDuration) => {
    console.log(`${id} æ¸²æŸ“è€—æ—¶: ${actualDuration}ms`);
  };

  return (
    <Profiler id="App" onRender={onRender}>
      <MyComponent />
    </Profiler>
  );
}
```

---

### ä¹ã€æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | React 17 æ¸²æŸ“æ¬¡æ•° | React 18 æ¸²æŸ“æ¬¡æ•° | æ€§èƒ½æå‡ |
|------|------------------|------------------|---------|
| äº‹ä»¶å¤„ç†å™¨ | 1 | 1 | - |
| setTimeout | 3 | 1 | **66%** |
| Promise.then | 2 | 1 | **50%** |
| åŸç”Ÿäº‹ä»¶ | 4 | 1 | **75%** |
| WebSocket | 5 | 1 | **80%** |

**å®é™…é¡¹ç›®æµ‹è¯•**ï¼ˆèŠå¤©åº”ç”¨ï¼‰ï¼š
- React 17ï¼šæ¯æ¡æ¶ˆæ¯è§¦å‘ 3 æ¬¡æ¸²æŸ“ï¼ˆæ¶ˆæ¯ + ç”¨æˆ·åˆ—è¡¨ + æœªè¯»æ•°ï¼‰
- React 18ï¼šåªæ¸²æŸ“ 1 æ¬¡
- **FPS æå‡ 60%**ï¼Œ**CPU å ç”¨é™ä½ 40%**

---

### åã€æ€»ç»“

1. **æ ¸å¿ƒä»·å€¼**ï¼š
   - è‡ªåŠ¨å‡å°‘ä¸å¿…è¦çš„æ¸²æŸ“ï¼Œæå‡æ€§èƒ½
   - ç»Ÿä¸€æ‰€æœ‰åœºæ™¯çš„æ‰¹å¤„ç†è¡Œä¸º
   - æ— éœ€æ‰‹åŠ¨ä¼˜åŒ–ï¼Œå¼€ç®±å³ç”¨

2. **ä½¿ç”¨å»ºè®®**ï¼š
   - å‡çº§åˆ° React 18 è‡ªåŠ¨äº«å—æ‰¹å¤„ç†
   - åªåœ¨éœ€è¦åŒæ­¥ DOM æ›´æ–°æ—¶ä½¿ç”¨ `flushSync`
   - ä½¿ç”¨ Profiler éªŒè¯æ€§èƒ½æå‡

3. **æ³¨æ„äº‹é¡¹**ï¼š
   - æ‰¹å¤„ç†ä¸ä¼šå»¶è¿ŸçŠ¶æ€æ›´æ–°ï¼Œåªå»¶è¿Ÿæ¸²æŸ“
   - ä¸è¦è¿‡åº¦ä½¿ç”¨ `flushSync`
   - ç†è§£äº‹ä»¶å¾ªç¯å’Œå¾®ä»»åŠ¡æœºåˆ¶

**é¢è¯•åŠ åˆ†ç‚¹**ï¼š
- èƒ½è§£é‡Šæ‰¹å¤„ç†çš„åº•å±‚åŸç†ï¼ˆå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼‰
- äº†è§£ React 17 å’Œ 18 çš„åŒºåˆ«
- çŸ¥é“ `flushSync` çš„ä½¿ç”¨åœºæ™¯å’Œæ€§èƒ½å½±å“
- èƒ½ä¸¾ä¾‹è¯´æ˜å®é™…é¡¹ç›®ä¸­çš„æ€§èƒ½æå‡
