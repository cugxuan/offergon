---
title: React Router çš„å®ç°åŸç†å’Œè·¯ç”±å®ˆå«
tags:
  - å‰ç«¯React
status: robot
class: å‰ç«¯React
slug: react-router-implementation-route-guards
ref:
---

## æ ¸å¿ƒè¦ç‚¹

**React Router é€šè¿‡ History API å’Œ Context æœºåˆ¶å®ç°å£°æ˜å¼è·¯ç”±ï¼Œè·¯ç”±å®ˆå«åˆ™é€šè¿‡ç»„ä»¶æ‹¦æˆªã€Loader/Actionï¼ˆv6.4+ï¼‰å’Œè‡ªå®šä¹‰ Hook æ¥å®ç°æƒé™æ§åˆ¶å’Œå¯¼èˆªæ‹¦æˆªã€‚**

å…³é”®æŠ€æœ¯ï¼š
- ğŸ§­ **è·¯ç”±åŒ¹é…**ï¼šåŸºäº `path-to-regexp` çš„åŠ¨æ€è·¯ç”±åŒ¹é…
- ğŸ“ **History ç®¡ç†**ï¼šBrowser/Hash/Memory History ä¸‰ç§æ¨¡å¼
- ğŸ¯ **åµŒå¥—è·¯ç”±**ï¼šé€šè¿‡ `<Outlet>` å®ç°å¸ƒå±€å¤ç”¨
- ğŸ›¡ï¸ **è·¯ç”±å®ˆå«**ï¼šLoaderã€Protected Routeã€å¯¼èˆªæ‹¦æˆª

---

## è¯¦ç»†è§£ç­”

### ä¸€ã€React Router çš„æ ¸å¿ƒåŸç†

#### 1. History ç®¡ç†

React Router åŸºäº `history` åº“å®ç°è·¯ç”±çŠ¶æ€ç®¡ç†ï¼Œæ”¯æŒä¸‰ç§æ¨¡å¼ï¼š

**1.1 Browser Historyï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰**

```javascript
// ä½¿ç”¨ HTML5 History API
import { createBrowserRouter } from 'react-router-dom'

// URL ç¤ºä¾‹ï¼šhttps://example.com/products/123
const router = createBrowserRouter([
  { path: '/products/:id', element: <Product /> }
])

// åº•å±‚å®ç°
const history = {
  push: (path) => window.history.pushState(null, '', path),
  replace: (path) => window.history.replaceState(null, '', path),
  go: (n) => window.history.go(n),
  listen: (callback) => {
    window.addEventListener('popstate', callback)
    return () => window.removeEventListener('popstate', callback)
  }
}
```

**å…³é”® API**ï¼š
- `pushState(state, title, url)` - æ·»åŠ å†å²è®°å½•
- `replaceState(state, title, url)` - æ›¿æ¢å½“å‰è®°å½•
- `popstate` äº‹ä»¶ - ç›‘å¬å‰è¿›/åé€€

**1.2 Hash Historyï¼ˆå…¼å®¹è€æµè§ˆå™¨ï¼‰**

```javascript
import { createHashRouter } from 'react-router-dom'

// URL ç¤ºä¾‹ï¼šhttps://example.com/#/products/123
const router = createHashRouter([
  { path: '/products/:id', element: <Product /> }
])

// åº•å±‚å®ç°
const hashHistory = {
  push: (path) => { window.location.hash = path },
  replace: (path) => {
    const url = window.location.href.replace(/#.*$/, '') + '#' + path
    window.location.replace(url)
  },
  listen: (callback) => {
    window.addEventListener('hashchange', callback)
  }
}
```

**1.3 Memory Historyï¼ˆæµ‹è¯•/SSRï¼‰**

```javascript
import { createMemoryRouter } from 'react-router-dom'

// ä¸ä¾èµ–æµè§ˆå™¨ APIï¼Œå†å²è®°å½•å­˜å‚¨åœ¨å†…å­˜ä¸­
const router = createMemoryRouter([...], {
  initialEntries: ['/products/123']
})
```

#### 2. è·¯ç”±åŒ¹é…ç®—æ³•

**2.1 è·¯å¾„åŒ¹é…åŸç†**

```javascript
// React Router ä½¿ç”¨ path-to-regexp è¿›è¡Œè·¯å¾„åŒ¹é…
import { pathToRegexp } from 'path-to-regexp'

// é™æ€è·¯ç”±
const pattern1 = '/products'
pathToRegexp(pattern1).test('/products') // true

// åŠ¨æ€å‚æ•°
const pattern2 = '/products/:id'
const regex2 = pathToRegexp(pattern2) // /^\/products\/([^\/]+?)\/?$/
regex2.test('/products/123') // true

// æå–å‚æ•°
const keys = []
const regex3 = pathToRegexp('/products/:category/:id', keys)
const match = regex3.exec('/products/books/123')
// match = ['/products/books/123', 'books', '123']
// keys = [{ name: 'category', ... }, { name: 'id', ... }]

// å¯é€‰å‚æ•°
pathToRegexp('/products/:id?') // åŒ¹é… /products å’Œ /products/123

// é€šé…ç¬¦
pathToRegexp('/docs/*') // åŒ¹é… /docs/a, /docs/a/b, /docs/a/b/c
```

**2.2 è·¯ç”±ä¼˜å…ˆçº§**

```javascript
// React Router v6 çš„åŒ¹é…è§„åˆ™
const routes = [
  { path: '/products', element: <List /> },           // ä¼˜å…ˆçº§ 3
  { path: '/products/:id', element: <Detail /> },     // ä¼˜å…ˆçº§ 2
  { path: '/products/*', element: <NotFound /> }      // ä¼˜å…ˆçº§ 1
]

// åŒ¹é…ç®—æ³•ï¼ˆç®€åŒ–ç‰ˆï¼‰
function matchRoutes(routes, pathname) {
  const matches = []

  for (const route of routes) {
    const regex = pathToRegexp(route.path)
    const match = regex.exec(pathname)

    if (match) {
      matches.push({
        route,
        params: extractParams(match, route.path),
        score: calculateScore(route.path) // é™æ€è·¯å¾„ > åŠ¨æ€å‚æ•° > é€šé…ç¬¦
      })
    }
  }

  // æŒ‰å¾—åˆ†æ’åºï¼Œè¿”å›æœ€ä½³åŒ¹é…
  return matches.sort((a, b) => b.score - a.score)[0]
}

// è¯„åˆ†è§„åˆ™
function calculateScore(path) {
  let score = 0
  const segments = path.split('/')

  for (const segment of segments) {
    if (segment === '') continue
    if (segment.startsWith(':')) score += 1  // åŠ¨æ€å‚æ•°
    else if (segment === '*') score += 0.5   // é€šé…ç¬¦
    else score += 3                           // é™æ€æ®µ
  }

  return score
}

// ç¤ºä¾‹
calculateScore('/products')         // 3
calculateScore('/products/:id')     // 4 (3 + 1)
calculateScore('/products/*')       // 3.5 (3 + 0.5)
```

#### 3. Context é©±åŠ¨çš„ç»„ä»¶é€šä¿¡

React Router v6 ä½¿ç”¨ Context å®ç°è·¯ç”±çŠ¶æ€å…±äº«ï¼š

```javascript
// React Router å†…éƒ¨ç®€åŒ–å®ç°
import { createContext, useContext, useState } from 'react'

// è·¯ç”±ä¸Šä¸‹æ–‡
const RouterContext = createContext(null)
const LocationContext = createContext(null)

// Router ç»„ä»¶
function BrowserRouter({ children }) {
  const [location, setLocation] = useState({
    pathname: window.location.pathname,
    search: window.location.search,
    hash: window.location.hash
  })

  useEffect(() => {
    const handlePopState = () => {
      setLocation({
        pathname: window.location.pathname,
        search: window.location.search,
        hash: window.location.hash
      })
    }

    window.addEventListener('popstate', handlePopState)
    return () => window.removeEventListener('popstate', handlePopState)
  }, [])

  const navigate = (to) => {
    window.history.pushState(null, '', to)
    setLocation({
      pathname: to.split('?')[0],
      search: to.includes('?') ? '?' + to.split('?')[1] : '',
      hash: ''
    })
  }

  return (
    <RouterContext.Provider value={{ navigate }}>
      <LocationContext.Provider value={location}>
        {children}
      </LocationContext.Provider>
    </RouterContext.Provider>
  )
}

// useNavigate Hook
function useNavigate() {
  const context = useContext(RouterContext)
  if (!context) throw new Error('useNavigate must be used within Router')
  return context.navigate
}

// useLocation Hook
function useLocation() {
  const context = useContext(LocationContext)
  if (!context) throw new Error('useLocation must be used within Router')
  return context
}

// Link ç»„ä»¶
function Link({ to, children }) {
  const navigate = useNavigate()

  const handleClick = (e) => {
    e.preventDefault()
    navigate(to)
  }

  return <a href={to} onClick={handleClick}>{children}</a>
}
```

#### 4. åµŒå¥—è·¯ç”±ä¸ `<Outlet>`

```javascript
// è·¯ç”±é…ç½®
const routes = [
  {
    path: '/',
    element: <Layout />,
    children: [
      { path: 'dashboard', element: <Dashboard /> },
      { path: 'products', element: <Products /> }
    ]
  }
]

// Layout ç»„ä»¶
function Layout() {
  return (
    <div>
      <nav>
        <Link to="/dashboard">Dashboard</Link>
        <Link to="/products">Products</Link>
      </nav>
      <main>
        <Outlet /> {/* å­è·¯ç”±æ¸²æŸ“ä½ç½® */}
      </main>
    </div>
  )
}

// Outlet å®ç°åŸç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
function Outlet() {
  const { matches } = useContext(RouteContext)

  // matches = [
  //   { route: Layout, params: {} },
  //   { route: Dashboard, params: {} }
  // ]

  // æ¸²æŸ“ä¸‹ä¸€å±‚åŒ¹é…çš„è·¯ç”±
  const nextMatch = matches[matches.length - 1]
  return nextMatch ? <RouteRenderer match={nextMatch} /> : null
}
```

---

### äºŒã€è·¯ç”±å®ˆå«å®ç°

#### 1. åŸºäºç»„ä»¶çš„è·¯ç”±å®ˆå«ï¼ˆæœ€å¸¸ç”¨ï¼‰

**1.1 Protected Route æ¨¡å¼**

```javascript
// ========== åŸºç¡€ç‰ˆæœ¬ ==========
function ProtectedRoute({ children }) {
  const { user } = useAuth() // è‡ªå®šä¹‰è®¤è¯ Hook
  const location = useLocation()

  if (!user) {
    // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µï¼Œå¹¶ä¿å­˜åŸå§‹è·¯å¾„
    return <Navigate to="/login" state={{ from: location }} replace />
  }

  return children
}

// ä½¿ç”¨
const routes = [
  {
    path: '/dashboard',
    element: (
      <ProtectedRoute>
        <Dashboard />
      </ProtectedRoute>
    )
  }
]

// ========== åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ ==========
function RoleBasedRoute({ children, allowedRoles }) {
  const { user } = useAuth()

  if (!user) {
    return <Navigate to="/login" replace />
  }

  if (!allowedRoles.includes(user.role)) {
    return <Navigate to="/403" replace /> // æ— æƒé™
  }

  return children
}

// ä½¿ç”¨
<RoleBasedRoute allowedRoles={['admin', 'editor']}>
  <AdminPanel />
</RoleBasedRoute>

// ========== å¤šæ¡ä»¶å®ˆå« ==========
function GuardedRoute({ children, guards = [] }) {
  const location = useLocation()

  for (const guard of guards) {
    const result = guard()

    if (result === false) {
      return <Navigate to="/login" state={{ from: location }} replace />
    }

    if (typeof result === 'string') {
      return <Navigate to={result} replace />
    }
  }

  return children
}

// ä½¿ç”¨
const isAuthenticated = () => {
  const token = localStorage.getItem('token')
  return token ? true : '/login'
}

const hasPermission = () => {
  const user = JSON.parse(localStorage.getItem('user'))
  return user?.role === 'admin' ? true : '/403'
}

<GuardedRoute guards={[isAuthenticated, hasPermission]}>
  <SecretPage />
</GuardedRoute>
```

**1.2 ç™»å½•åè¿”å›åŸé¡µé¢**

```javascript
// Login ç»„ä»¶
function Login() {
  const navigate = useNavigate()
  const location = useLocation()

  // ä» location.state è·å–åŸå§‹è·¯å¾„
  const from = location.state?.from?.pathname || '/dashboard'

  const handleLogin = async (credentials) => {
    await authService.login(credentials)
    navigate(from, { replace: true }) // ç™»å½•æˆåŠŸåè·³è½¬å›åŸé¡µé¢
  }

  return (
    <form onSubmit={handleLogin}>
      {/* ç™»å½•è¡¨å• */}
    </form>
  )
}
```

#### 2. React Router v6.4+ Loader å®ˆå«

**2.1 Loader æ•°æ®é¢„åŠ è½½ + æƒé™æ ¡éªŒ**

```javascript
import { redirect } from 'react-router-dom'

// è·¯ç”±é…ç½®
const routes = [
  {
    path: '/dashboard',
    element: <Dashboard />,
    loader: dashboardLoader // æ•°æ®åŠ è½½å™¨
  }
]

// Loader å‡½æ•°ï¼ˆåœ¨æ¸²æŸ“å‰æ‰§è¡Œï¼‰
async function dashboardLoader({ request, params }) {
  // 1. æƒé™æ ¡éªŒ
  const user = await getCurrentUser()
  if (!user) {
    // é‡å®šå‘åˆ°ç™»å½•é¡µ
    return redirect('/login')
  }

  // 2. æ•°æ®é¢„åŠ è½½
  const data = await fetch('/api/dashboard').then(r => r.json())

  // 3. è¿”å›æ•°æ®
  return { user, data }
}

// ç»„ä»¶ä¸­ä½¿ç”¨
import { useLoaderData } from 'react-router-dom'

function Dashboard() {
  const { user, data } = useLoaderData() // è·å– loader è¿”å›çš„æ•°æ®

  return (
    <div>
      <h1>Welcome, {user.name}</h1>
      <Stats data={data} />
    </div>
  )
}
```

**2.2 å¤šå±‚åµŒå¥— Loader**

```javascript
const routes = [
  {
    path: '/',
    element: <Root />,
    loader: rootLoader, // çˆ¶çº§ loader
    children: [
      {
        path: 'users/:userId',
        element: <User />,
        loader: userLoader // å­çº§ loaderï¼ˆå¹¶è¡ŒåŠ è½½ï¼‰
      }
    ]
  }
]

// çˆ¶çº§ Loader
async function rootLoader() {
  const currentUser = await getCurrentUser()
  if (!currentUser) return redirect('/login')
  return { currentUser }
}

// å­çº§ Loader
async function userLoader({ params }) {
  const user = await fetch(`/api/users/${params.userId}`).then(r => r.json())
  return { user }
}

// ç»„ä»¶ä¸­è®¿é—®
function User() {
  const { user } = useLoaderData()          // å½“å‰è·¯ç”±çš„æ•°æ®
  const { currentUser } = useMatches()[0]   // çˆ¶è·¯ç”±çš„æ•°æ®

  return <div>{user.name}</div>
}
```

**2.3 Loader é”™è¯¯å¤„ç†**

```javascript
async function protectedLoader() {
  const response = await fetch('/api/data')

  if (response.status === 401) {
    throw new Response('Unauthorized', { status: 401 })
  }

  if (!response.ok) {
    throw new Response('Not Found', { status: 404 })
  }

  return response.json()
}

// è·¯ç”±é…ç½®
const routes = [
  {
    path: '/protected',
    element: <Protected />,
    loader: protectedLoader,
    errorElement: <ErrorBoundary /> // é”™è¯¯å¤„ç†ç»„ä»¶
  }
]

// ErrorBoundary ç»„ä»¶
import { useRouteError } from 'react-router-dom'

function ErrorBoundary() {
  const error = useRouteError()

  if (error.status === 401) {
    return <Navigate to="/login" />
  }

  if (error.status === 404) {
    return <h1>Page Not Found</h1>
  }

  return <h1>Something went wrong!</h1>
}
```

#### 3. å¯¼èˆªæ‹¦æˆªï¼ˆNavigation Blockerï¼‰

**3.1 é˜»æ­¢æœªä¿å­˜çš„æ›´æ”¹ä¸¢å¤±**

```javascript
import { useBlocker } from 'react-router-dom'

function FormPage() {
  const [formData, setFormData] = useState({})
  const [isDirty, setIsDirty] = useState(false)

  // è¡¨å•æœªä¿å­˜æ—¶é˜»æ­¢å¯¼èˆª
  const blocker = useBlocker(
    ({ currentLocation, nextLocation }) =>
      isDirty && currentLocation.pathname !== nextLocation.pathname
  )

  return (
    <div>
      <form onChange={() => setIsDirty(true)}>
        {/* è¡¨å•å­—æ®µ */}
      </form>

      {blocker.state === 'blocked' && (
        <Modal>
          <p>ä½ æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ</p>
          <button onClick={() => blocker.proceed()}>ç¦»å¼€</button>
          <button onClick={() => blocker.reset()}>å–æ¶ˆ</button>
        </Modal>
      )}
    </div>
  )
}
```

**3.2 è‡ªå®šä¹‰ usePrompt Hook**

```javascript
// hooks/usePrompt.js
import { useEffect } from 'react'
import { useBeforeUnload, useBlocker } from 'react-router-dom'

export function usePrompt(message, when = true) {
  // é˜»æ­¢æµè§ˆå™¨åˆ·æ–°/å…³é—­
  useBeforeUnload(
    (event) => {
      if (when) {
        event.preventDefault()
        event.returnValue = message
      }
    },
    { capture: true }
  )

  // é˜»æ­¢è·¯ç”±è·³è½¬
  const blocker = useBlocker(when)

  useEffect(() => {
    if (blocker.state === 'blocked' && !window.confirm(message)) {
      blocker.reset()
    } else if (blocker.state === 'blocked') {
      blocker.proceed()
    }
  }, [blocker, message])
}

// ä½¿ç”¨
function EditPage() {
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false)

  usePrompt('ä½ æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ', hasUnsavedChanges)

  return <form>{/* ... */}</form>
}
```

#### 4. å…¨å±€å¯¼èˆªå®ˆå«

**4.1 ç›‘å¬æ‰€æœ‰è·¯ç”±å˜åŒ–**

```javascript
import { useEffect } from 'react'
import { useLocation, useNavigate } from 'react-router-dom'

function App() {
  const location = useLocation()
  const navigate = useNavigate()

  useEffect(() => {
    // è·¯ç”±å˜åŒ–æ—¶æ‰§è¡Œçš„é€»è¾‘
    console.log('Route changed to:', location.pathname)

    // æƒé™æ ¡éªŒ
    const token = localStorage.getItem('token')
    const protectedRoutes = ['/dashboard', '/profile', '/settings']

    if (protectedRoutes.some(route => location.pathname.startsWith(route))) {
      if (!token) {
        navigate('/login', { replace: true })
      }
    }

    // é¡µé¢è®¿é—®ç»Ÿè®¡
    analytics.track('page_view', {
      path: location.pathname,
      search: location.search
    })
  }, [location, navigate])

  return <RouterProvider router={router} />
}
```

**4.2 è·¯ç”±ä¸­é—´ä»¶æ¨¡å¼**

```javascript
// routeMiddleware.js
export const middlewares = {
  auth: (context) => {
    const token = localStorage.getItem('token')
    if (!token) {
      return { redirect: '/login' }
    }
  },

  admin: (context) => {
    const user = JSON.parse(localStorage.getItem('user') || '{}')
    if (user.role !== 'admin') {
      return { redirect: '/403' }
    }
  },

  logging: (context) => {
    console.log(`Navigating to ${context.pathname}`)
  }
}

// åº”ç”¨ä¸­é—´ä»¶
function applyMiddlewares(middlewares, context) {
  for (const middleware of middlewares) {
    const result = middleware(context)
    if (result?.redirect) {
      return result.redirect
    }
  }
  return null
}

// è·¯ç”±é…ç½®
const routes = [
  {
    path: '/admin',
    element: <Admin />,
    meta: { middlewares: [middlewares.auth, middlewares.admin, middlewares.logging] }
  }
]

// è·¯ç”±å®ˆå«ç»„ä»¶
function RouteGuard({ children, meta }) {
  const location = useLocation()
  const navigate = useNavigate()

  useEffect(() => {
    if (meta?.middlewares) {
      const redirect = applyMiddlewares(meta.middlewares, location)
      if (redirect) {
        navigate(redirect, { replace: true })
      }
    }
  }, [location, meta, navigate])

  return children
}
```

---

### ä¸‰ã€é«˜çº§è·¯ç”±æ¨¡å¼

#### 1. æ‡’åŠ è½½è·¯ç”±

```javascript
import { lazy, Suspense } from 'react'

const Dashboard = lazy(() => import('./pages/Dashboard'))
const Products = lazy(() => import('./pages/Products'))

const routes = [
  {
    path: '/dashboard',
    element: (
      <Suspense fallback={<Loading />}>
        <Dashboard />
      </Suspense>
    )
  }
]

// æ›´ä¼˜é›…çš„å°è£…
function LazyRoute({ importFunc }) {
  const Component = lazy(importFunc)

  return (
    <Suspense fallback={<Loading />}>
      <Component />
    </Suspense>
  )
}

// ä½¿ç”¨
{
  path: '/products',
  element: <LazyRoute importFunc={() => import('./pages/Products')} />
}
```

#### 2. åŠ¨æ€è·¯ç”±ï¼ˆæƒé™è·¯ç”±ï¼‰

```javascript
// æ ¹æ®ç”¨æˆ·è§’è‰²ç”Ÿæˆè·¯ç”±
function generateRoutes(userRole) {
  const baseRoutes = [
    { path: '/', element: <Home /> },
    { path: '/about', element: <About /> }
  ]

  const roleRoutes = {
    admin: [
      { path: '/admin', element: <Admin /> },
      { path: '/users', element: <Users /> }
    ],
    editor: [
      { path: '/editor', element: <Editor /> }
    ],
    viewer: []
  }

  return [...baseRoutes, ...(roleRoutes[userRole] || [])]
}

// App ç»„ä»¶
function App() {
  const { user } = useAuth()
  const [routes, setRoutes] = useState([])

  useEffect(() => {
    if (user) {
      const dynamicRoutes = generateRoutes(user.role)
      setRoutes(dynamicRoutes)
    }
  }, [user])

  const router = createBrowserRouter(routes)

  return <RouterProvider router={router} />
}
```

#### 3. é¢åŒ…å±‘å¯¼èˆª

```javascript
import { useMatches } from 'react-router-dom'

// è·¯ç”±é…ç½®ï¼ˆæ·»åŠ  handle å…ƒæ•°æ®ï¼‰
const routes = [
  {
    path: '/',
    element: <Root />,
    handle: { crumb: () => 'Home' },
    children: [
      {
        path: 'products',
        element: <Products />,
        handle: { crumb: () => 'Products' },
        children: [
          {
            path: ':id',
            element: <ProductDetail />,
            loader: productLoader,
            handle: {
              crumb: (data) => data.product.name
            }
          }
        ]
      }
    ]
  }
]

// Breadcrumbs ç»„ä»¶
function Breadcrumbs() {
  const matches = useMatches()

  const crumbs = matches
    .filter(match => match.handle?.crumb)
    .map(match => ({
      label: match.handle.crumb(match.data),
      path: match.pathname
    }))

  return (
    <nav>
      {crumbs.map((crumb, index) => (
        <span key={index}>
          {index > 0 && ' / '}
          <Link to={crumb.path}>{crumb.label}</Link>
        </span>
      ))}
    </nav>
  )
}
```

---

### å››ã€æ€§èƒ½ä¼˜åŒ–

#### 1. è·¯ç”±é¢„åŠ è½½

```javascript
// é¼ æ ‡æ‚¬åœæ—¶é¢„åŠ è½½
function PreloadLink({ to, children }) {
  const preload = () => {
    // é¢„åŠ è½½ç»„ä»¶
    import(`./pages${to}`)
  }

  return (
    <Link to={to} onMouseEnter={preload}>
      {children}
    </Link>
  )
}

// æå‰é¢„åŠ è½½å…³é”®è·¯ç”±
function App() {
  useEffect(() => {
    // é¢„åŠ è½½å¸¸ç”¨é¡µé¢
    const preloadRoutes = ['/dashboard', '/products']

    preloadRoutes.forEach(route => {
      import(`./pages${route}`)
    })
  }, [])

  return <RouterProvider router={router} />
}
```

#### 2. è·¯ç”±çº§ä»£ç åˆ†å‰²

```javascript
// vite.config.js / webpack.config.js
export default {
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor': ['react', 'react-dom', 'react-router-dom'],
          'admin': ['./src/pages/Admin', './src/pages/Users'],
          'public': ['./src/pages/Home', './src/pages/About']
        }
      }
    }
  }
}
```

---

## æ€»ç»“

### æ ¸å¿ƒåŸç†
1. **History ç®¡ç†**ï¼šåŸºäº `pushState`/`replaceState` + `popstate` äº‹ä»¶
2. **è·¯ç”±åŒ¹é…**ï¼šä½¿ç”¨ `path-to-regexp` è¿›è¡Œè·¯å¾„åŒ¹é…å’Œå‚æ•°æå–
3. **Context é©±åŠ¨**ï¼šé€šè¿‡ Context å®ç°è·¯ç”±çŠ¶æ€çš„å…¨å±€å…±äº«
4. **åµŒå¥—è·¯ç”±**ï¼š`<Outlet>` ç»„ä»¶å®ç°å­è·¯ç”±æ¸²æŸ“

### è·¯ç”±å®ˆå«æ–¹æ¡ˆ
| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|---------|------|------|
| **ProtectedRoute ç»„ä»¶** | ç®€å•æƒé™æ§åˆ¶ | çµæ´»ã€æ˜“ç†è§£ | ç»„ä»¶å±‚çº§å¤š |
| **Loader å‡½æ•°** | æ•°æ®é¢„åŠ è½½ + æƒé™ | å£°æ˜å¼ã€æ€§èƒ½å¥½ | ä»…é™ v6.4+ |
| **useBlocker** | è¡¨å•æœªä¿å­˜æé†’ | å®˜æ–¹æ”¯æŒ | ä»…é™å¯¼èˆªæ‹¦æˆª |
| **å…¨å±€ç›‘å¬** | ç»Ÿä¸€å¤„ç†é€»è¾‘ | é›†ä¸­ç®¡ç† | è€¦åˆåº¦é«˜ |

### æœ€ä½³å®è·µ
1. âœ… ä½¿ç”¨ `<ProtectedRoute>` åŒ…è£¹éœ€è¦æƒé™çš„è·¯ç”±
2. âœ… Loader ä¸­å¤„ç†æ•°æ®è·å–å’Œæƒé™æ ¡éªŒï¼ˆv6.4+ï¼‰
3. âœ… ä½¿ç”¨ `useBlocker` é˜²æ­¢æœªä¿å­˜æ•°æ®ä¸¢å¤±
4. âœ… æ‡’åŠ è½½ + ä»£ç åˆ†å‰²ä¼˜åŒ–æ€§èƒ½
5. âœ… åŠ¨æ€è·¯ç”±é…åˆæƒé™ç³»ç»Ÿå®ç°çµæ´»çš„è®¿é—®æ§åˆ¶

æŒæ¡ React Router çš„å®ç°åŸç†å’Œè·¯ç”±å®ˆå«æŠ€æœ¯ï¼Œæ˜¯æ„å»ºå¤æ‚å•é¡µåº”ç”¨çš„åŸºç¡€èƒ½åŠ›ã€‚
