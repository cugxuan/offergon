---
title: 设计一个图片存储和CDN系统
tags:
  - 系统设计
status: robot
class: 系统设计
slug: image-storage-and-cdn-system-design
ref:
---

## 核心要点

图片存储和CDN系统的核心是**分层架构**和**就近访问**。关键要素包括：
- 上传层：客户端直传对象存储，减轻服务器压力
- 存储层：对象存储（OSS）提供海量、高可用的图片存储
- 加速层：CDN边缘节点缓存热点图片，就近返回用户
- 处理层：实时图片裁剪、压缩、格式转换（按需处理）
- 安全层：防盗链、访问鉴权、恶意图片检测

## 详细回答

### 一、系统架构设计

整个系统采用**读写分离**的架构思想，上传和下载走不同的链路：

**上传链路（写）：**
1. 客户端向业务服务器请求上传凭证（包含临时签名token）
2. 业务服务器生成上传凭证（验证用户权限、分配存储路径）
3. 客户端拿到凭证后，直接上传到对象存储（OSS/S3）
4. OSS返回图片访问URL
5. 客户端将URL回传给业务服务器，保存到数据库

这种**客户端直传**的好处是：
- 业务服务器不经手文件流，节省带宽和CPU
- 上传成功率更高（OSS有多节点容灾）
- 可并行上传多张图片

**下载链路（读）：**
1. 用户请求图片URL（通常是CDN域名）
2. CDN边缘节点检查缓存：命中则直接返回（缓存命中率可达90%+）
3. 缓存未命中时，CDN回源到OSS获取原图
4. 根据URL参数进行实时处理（如缩略图：`?w=200&h=200`）
5. CDN缓存处理后的图片，返回给用户

### 二、核心模块设计

#### 1. 对象存储层（OSS）

对象存储是整个系统的**数据底座**，需要具备：

**存储结构设计：**
- 按业务分桶（Bucket）：用户头像、商品图、内容图等
- 按时间分目录：`/2025/01/09/uuid.jpg` （便于数据迁移和清理）
- 文件名规则：UUID或雪花ID，避免重名冲突

**关键特性：**
- 多副本存储（通常3副本，99.9999999%可靠性）
- 支持跨地域同步（异地容灾）
- 提供RESTful API（S3协议兼容性好）
- 冷热数据分层：访问频率低的图片自动降级到低成本存储

**成本优化：**
- 原图存储在标准存储
- 30天未访问的自动转为低频存储
- 1年未访问的归档存储（访问延迟分钟级，但成本极低）

#### 2. CDN加速层

CDN通过**就近访问**大幅提升用户体验：

**工作原理：**
- 全球部署数百个边缘节点（PoP）
- 用户请求通过DNS解析到最近的CDN节点
- CDN节点缓存热点图片（通常缓存命中率90%+）
- 未命中时回源到OSS，同时缓存该图片

**缓存策略设计：**
- 静态图片（商品图）：缓存7-30天
- 动态图片（用户上传）：缓存1-3天
- 使用HTTP头控制：`Cache-Control: max-age=86400`
- 支持缓存刷新：发布新图片时主动刷新CDN

**智能调度：**
- 基于用户IP和运营商选择最优节点
- 节点故障时自动切换到备用节点
- 监控各节点负载，动态调整流量分配

#### 3. 图片处理服务

实时图片处理是提升用户体验的关键，但也是性能瓶颈：

**按需处理模式：**
用户请求时通过URL参数指定处理规则：
```
https://cdn.example.com/image.jpg?w=200&h=200&format=webp&quality=80
```

处理流程：
1. CDN收到请求后检查是否已缓存该规格的图片
2. 未缓存则将请求转发到图片处理服务器
3. 处理服务器从OSS获取原图，进行裁剪、压缩、格式转换
4. 返回处理后的图片，CDN缓存该结果
5. 相同规格的后续请求直接命中CDN缓存

**处理能力设计：**
- 支持常见操作：缩放、裁剪、旋转、水印、格式转换
- 自动选择最优格式（WebP比JPEG小30%，但需要浏览器支持）
- 智能压缩：根据图片内容自适应质量参数
- 防滥用：限制处理参数范围（如宽高不超过4096px）

**性能优化：**
- 使用高性能图片库（如libvips，比ImageMagick快5倍）
- 处理服务器水平扩展，前置负载均衡
- 预热热门规格（如商品主图的200x200缩略图）

#### 4. 上传服务

**客户端直传流程：**
1. 客户端调用 `POST /api/upload/token` 获取上传凭证
2. 服务端生成临时签名（如STS Token，有效期1小时）
3. 签名包含：允许的上传路径、文件大小限制、过期时间
4. 客户端使用凭证直接POST到OSS
5. 上传完成后回调业务服务器（可选）

**安全控制：**
- 限制上传文件类型（MIME type白名单）
- 限制单个文件大小（如10MB）
- 限制用户上传频率（防刷）
- 图片安全检测（鉴黄、鉴暴）

**大文件优化：**
- 分片上传：文件超过5MB自动切片
- 断点续传：记录已上传的分片，失败后续传
- 秒传功能：计算文件MD5，重复文件直接返回已有URL

### 三、关键技术问题

#### 问题1：如何防止图片盗链？

**解决方案：**

1. **Referer白名单**：检查HTTP Referer头，只允许自己的域名访问
   - 简单但容易被伪造

2. **时间戳+签名**：URL带时效性签名
   ```
   https://cdn.example.com/image.jpg?t=1704787200&sign=abc123
   ```
   - sign = MD5(图片路径 + 时间戳 + 密钥)
   - 验证时间戳是否过期（如5分钟内有效）
   - 验证签名是否匹配

3. **Token鉴权**：用户登录后获取临时访问token
   - Token存储在CDN节点配置中心
   - 请求时携带token，CDN验证合法性

#### 问题2：如何处理海量小文件存储？

海量小图片（如用户头像）存储会遇到：
- 文件系统inode耗尽
- 目录层级过深影响查找性能
- 大量小文件占用的元数据开销大

**解决方案：**

1. **小文件合并存储**：
   - 多个小图片打包成一个大文件
   - 维护索引表记录每个图片在大文件中的偏移量
   - 读取时根据偏移量快速定位

2. **对象存储天然适合**：
   - OSS按对象存储，没有文件系统限制
   - 自动分片和分布式存储
   - 按存储量和请求次数计费，不担心小文件问题

3. **分层存储**：
   - 热数据（近期上传）：SSD存储，快速访问
   - 温数据（偶尔访问）：HDD存储
   - 冷数据（很少访问）：归档存储

#### 问题3：如何保证高可用？

**多层容灾：**

1. **存储层**：
   - OSS多副本存储（通常3副本在不同机房）
   - 跨地域同步（异地容灾）
   - 自动故障转移

2. **CDN层**：
   - 节点冗余（每个地区多个节点）
   - 节点健康检查（心跳探测）
   - 故障节点自动摘除，流量切到健康节点

3. **处理层**：
   - 处理服务器集群部署
   - 负载均衡分发请求
   - 熔断机制：处理超时则返回原图

4. **监控告警**：
   - 实时监控：上传成功率、下载延迟、CDN命中率
   - 异常告警：错误率超过阈值立即通知
   - 日志分析：追踪异常请求链路

#### 问题4：如何应对突发流量（热点图片）？

某张图片突然爆火（如热门事件配图），访问量短时间暴增：

**应对策略：**

1. **CDN自动扩容**：
   - 热点图片自动分发到更多节点
   - 增加缓存副本数

2. **限流降级**：
   - 对单个IP限流（如1秒10次请求）
   - 极端情况返回降级图片（低分辨率版本）

3. **预热机制**：
   - 对预期的热点内容提前推送到CDN
   - 大促活动前预热商品主图

4. **分布式缓存**：
   - 业务层增加Redis缓存图片元数据
   - 减少对OSS的元数据查询压力

### 四、性能指标

一个优秀的图片CDN系统应达到：

- **上传成功率**：> 99.9%
- **下载成功率**：> 99.99%
- **CDN缓存命中率**：> 90%
- **首字节时间（TTFB）**：< 100ms（国内）
- **图片加载完成时间**：< 500ms（1MB图片）
- **可用性**：99.95%（年停机时间< 4小时）

### 五、总结

设计图片存储和CDN系统的核心思想是：
1. **职责分离**：存储、加速、处理各司其职
2. **就近服务**：CDN边缘节点就近响应用户
3. **按需处理**：请求时动态生成不同规格，避免预生成浪费存储
4. **多层缓存**：CDN缓存 + 浏览器缓存，减少回源
5. **安全可靠**：防盗链、多副本、容灾，保证数据安全和服务稳定

这样的架构既能支撑海量图片存储，又能提供毫秒级的访问速度，同时保持成本可控。
