---
title: 设计一个推荐系统架构
tags:
  - 系统设计
status: robot
class: 系统设计
slug: recommendation-system-architecture-design
ref:
---

## 核心要点

推荐系统的核心是**预测用户兴趣**和**实时响应**。关键要素包括：
- 召回层：从海量内容中快速筛选出候选集（多路召回策略）
- 排序层：精排候选内容，预测用户点击/购买概率（机器学习模型）
- 重排层：业务规则调整、去重、多样性保证
- 实时反馈：用户行为实时更新模型，形成闭环
- 冷启动：新用户/新内容的推荐策略

## 详细回答

### 一、推荐系统整体架构

推荐系统是一个**漏斗式**的多层架构，层层过滤，最终返回最优结果。

**三层架构：**

```
海量内容池（百万-亿级）
        ↓
[召回层] 多路召回策略（协同过滤、内容画像、热门等）
        ↓ 缩小到千-万级
[粗排层] 简单模型快速打分（可选）
        ↓ 缩小到百-千级
[精排层] 复杂模型精准预测（深度学习）
        ↓ 缩小到几十-百级
[重排层] 业务规则调整（去重、多样性、广告插入）
        ↓
最终推荐结果（10-20条）
```

**为什么要分层？**
- 直接对亿级内容精排，计算量太大（单次推荐耗时秒级，无法接受）
- 分层过滤，用简单快速的方法先筛掉大部分不相关内容
- 对少量候选内容使用复杂模型精排，保证准确性和实时性

### 二、召回层设计

召回层的目标：**快速**从海量内容中找出**可能感兴趣**的候选集。

#### 1. 多路召回策略

单一召回方法容易遗漏，需要**多路召回并行**，最后合并：

**（1）协同过滤召回（基于行为相似性）**

核心思想：喜欢相似内容的用户，可能喜欢彼此看过的其他内容。

**User-based协同过滤：**
- 找到与目标用户相似的用户群
- 推荐这些相似用户喜欢但目标用户未见过的内容
- 计算用户相似度：余弦相似度、皮尔逊相关系数

例如：
- 用户A喜欢：[视频1, 视频2, 视频3]
- 用户B喜欢：[视频1, 视频2, 视频5]
- A和B相似度高，推荐视频5给用户A

**Item-based协同过滤：**
- 找到与用户历史喜欢内容相似的其他内容
- 计算内容相似度：共同喜欢的用户数、Jaccard相似度

例如：
- 用户喜欢《流浪地球》
- 找到与《流浪地球》相似的电影（如《星际穿越》）
- 推荐《星际穿越》

**实现方式：**
- 离线计算：每天批量计算用户/物品相似度矩阵
- 存储：Redis/HBase存储相似度Top N
- 查询：根据用户历史行为，查询相似内容

**（2）内容画像召回（基于内容特征）**

根据内容的**标签/属性**进行匹配：

用户画像：
- 兴趣标签：科技、电影、旅游
- 人口属性：年龄、性别、地域
- 行为特征：活跃时段、设备类型

内容画像：
- 分类标签：科技、娱乐、体育
- 内容属性：时长、难度、发布时间
- 质量分：点击率、完播率、点赞率

匹配策略：
- 标签匹配：用户喜欢"科技"，召回标签包含"科技"的内容
- 向量匹配：用户画像向量 × 内容向量，计算相似度（Embedding）

**（3）热门召回**

推荐当前热门/trending的内容：
- 全站热门：今日播放量Top 100
- 分类热门：科技类今日Top 50
- 实时热点：突然爆火的内容（如热搜事件）

热门计算：
- 简单版：按播放量/点赞数排序
- 进阶版：威尔逊区间算法（考虑样本量，避免新内容样本少但比例高）
- 时效性加权：最近24小时数据权重更高

**（4）新内容召回**

给新发布的内容曝光机会（冷启动）：
- 随机抽取一定比例的新内容
- 根据内容标签匹配用户兴趣
- 探索策略：一定比例推荐用户未接触的领域（打破信息茧房）

**（5）个性化召回（深度学习）**

使用深度学习模型直接预测用户对内容的兴趣：

双塔模型（Two-Tower Model）：
- 用户塔：用户特征 → Embedding向量
- 物品塔：内容特征 → Embedding向量
- 相似度：两个向量的内积或余弦相似度

优势：
- 离线预计算所有物品的Embedding
- 在线时只需计算用户Embedding，然后向量检索（ANN近似最近邻）
- 检索速度快（毫秒级）

向量检索工具：
- Faiss（Facebook开源）
- Milvus（专为向量检索设计）
- Elasticsearch的向量搜索插件

#### 2. 召回合并与去重

多路召回后，需要合并结果：
- 每路召回取Top N（如每路200个）
- 合并后去重（同一内容可能被多路召回）
- 总候选集：1000-2000个内容

### 三、排序层设计

排序层的目标：对召回的候选内容**精准打分**，预测用户真正感兴趣的内容。

#### 1. 粗排（可选）

如果召回候选太多（如1万个），可以先用简单模型粗排：
- 轻量级模型：逻辑回归、GBDT
- 简单特征：用户历史CTR、内容历史CTR、标签匹配度
- 快速筛选到几百个，再进行精排

#### 2. 精排（核心）

使用复杂模型预测用户行为概率：

**预测目标：**
- CTR（点击率）：用户是否会点击
- CVR（转化率）：用户是否会购买/完播
- 时长（视频）：用户会看多久
- 综合得分：CTR × CVR × 时长权重

**特征工程：**

用户特征：
- 基础：年龄、性别、地域
- 行为：历史点击/购买/观看内容
- 统计：平均使用时长、活跃度
- 实时：当前session已看内容

内容特征：
- 基础：分类、标签、时长
- 质量：历史CTR、完播率、点赞率
- 创作者：粉丝数、内容质量分

交叉特征：
- 用户-内容匹配：标签重合度
- 用户-创作者：是否关注
- 时间：发布时间与用户活跃时间匹配度

**模型选择：**

传统模型：
- **逻辑回归（LR）**：简单可解释
- **GBDT**：特征组合能力强

深度学习模型：
- **Wide & Deep**：结合记忆（LR）和泛化（DNN）
- **DeepFM**：自动学习特征交叉
- **DIN（Deep Interest Network）**：关注用户兴趣演化
- **DIEN**：建模用户兴趣随时间变化

**模型训练：**
- 训练样本：用户曝光日志（点击为正样本，未点击为负样本）
- 负采样：负样本太多，采样一部分（如正负样本1:10）
- 离线训练：每天全量训练
- 在线学习（可选）：实时更新模型参数

**模型服务：**
- 模型部署：TensorFlow Serving、TorchServe
- 批量预测：候选内容批量打分（降低网络开销）
- 超时保护：预测超时返回默认排序

### 四、重排层设计

精排后的结果还需要根据业务规则调整：

#### 1. 多样性保证

避免推荐结果过于单一：
- 打散相似内容：连续两个不能是同一创作者/同一分类
- 类目平衡：确保多个类目都有内容（不能全是科技类）
- 新老平衡：既有热门内容，也有新内容

**实现方式：**
- 滑动窗口：检查最近N个推荐的多样性
- MMR算法（最大边际相关性）：平衡相关性和多样性

#### 2. 去重与去已读

- 去重：同一内容不重复推荐
- 去已读：用户已看过的内容不再推荐
- Bloom Filter：快速判断用户是否看过某内容

#### 3. 业务规则

- 广告插入：每隔N条插入一条广告
- 运营位：置顶运营推荐的内容
- 政策合规：过滤低质、违规内容
- 安全审核：敏感内容降权或下架

### 五、实时反馈与更新

推荐系统是一个**闭环系统**，用户行为实时影响推荐结果。

#### 1. 实时特征更新

用户行为实时写入特征库：
- 点击：更新用户兴趣标签权重
- 跳过：降低该类内容权重
- 点赞/收藏：强化兴趣信号
- 观看时长：衡量内容质量

存储：
- Redis：实时特征（如当前session已看内容）
- HBase：用户画像（累计行为）

#### 2. 探索与利用（Exploration vs Exploitation）

- **利用（Exploit）**：推荐用户已知喜欢的内容（高CTR）
- **探索（Explore）**：推荐用户未接触的内容（发现新兴趣）

平衡策略：
- **ε-greedy**：90%推荐高分内容，10%随机推荐
- **Thompson Sampling**：基于贝叶斯推断的探索策略
- **LinUCB**：多臂老虎机算法，平衡探索和利用

#### 3. AB测试

持续优化推荐策略：
- 新算法上线前AB测试
- 对比指标：CTR、用户停留时长、DAU
- 灰度发布：5% → 20% → 100%

### 六、冷启动问题

新用户/新内容如何推荐？

#### 1. 新用户冷启动

没有历史行为数据的新用户：

**策略1：人口统计学推荐**
- 根据年龄、性别、地域推荐
- 例如：年轻男性推荐游戏、科技类内容

**策略2：热门推荐**
- 推荐全站热门内容
- 快速收集用户反馈

**策略3：引导用户选择兴趣**
- 注册时让用户选择感兴趣的标签
- 根据标签推荐

**策略4：快速学习**
- 前几次推荐尽量多样化（探索）
- 根据点击快速更新用户画像
- 10次点击后就能形成初步画像

#### 2. 新内容冷启动

新发布的内容没有历史数据：

**策略1：基于内容特征**
- 根据标签、分类匹配用户兴趣
- 不依赖历史行为数据

**策略2：小流量测试**
- 随机推荐给一部分用户
- 快速积累点击数据
- 根据初期表现决定是否加大曝光

**策略3：创作者质量分**
- 优质创作者的新内容给予更多曝光
- 根据创作者历史内容表现打分

**策略4：相似内容迁移**
- 找到相似的成熟内容
- 将其用户群推荐给新内容

### 七、系统架构与性能优化

#### 1. 整体架构

**离线部分（T+1处理）：**
- 日志收集：用户行为日志（点击、播放、购买）
- 特征工程：计算用户/内容画像
- 模型训练：训练推荐模型
- 相似度计算：计算用户/内容相似度矩阵

**近线部分（小时级/分钟级）：**
- 增量特征更新：热点内容特征
- 实时热榜计算

**在线部分（毫秒级）：**
- 接收推荐请求
- 召回 → 粗排 → 精排 → 重排
- 返回推荐结果

#### 2. 性能优化

**召回优化：**
- 预计算：离线计算相似度、Embedding
- 索引：建立倒排索引、向量索引（HNSW）
- 并行：多路召回并行执行

**排序优化：**
- 批量预测：候选内容批量输入模型
- GPU加速：深度学习模型GPU推理
- 模型压缩：量化、蒸馏，降低模型大小

**缓存：**
- 用户画像缓存（Redis）：避免每次查数据库
- 热门内容缓存：热门内容推荐结果预计算
- 模型缓存：模型加载到内存

**降级策略：**
- 服务超时：返回默认推荐（热门内容）
- 模型挂掉：降级到简单规则推荐
- 流量过大：限流，部分请求返回缓存结果

#### 3. 关键指标

**业务指标：**
- CTR（点击率）：推荐内容被点击的比例
- CVR（转化率）：点击后转化（购买/完播）的比例
- 人均时长：用户停留时长
- DAU/MAU：日活/月活用户数

**技术指标：**
- 推荐延迟：P99 < 100ms
- 召回覆盖率：能召回的内容占比
- 模型AUC：离线评估模型准确性
- 缓存命中率：> 80%

**生态指标：**
- 多样性：推荐结果的类目分布
- 公平性：新内容/小创作者的曝光机会
- 用户满意度：问卷调查、负反馈率

### 八、典型推荐系统案例

**抖音/快手（短视频推荐）：**
- 召回：协同过滤 + 内容标签 + 热门 + 关注
- 排序：预测完播率、点赞率、评论率
- 特色：快速反馈，实时调整推荐
- 冷启动：新用户前几个视频多样化探索

**淘宝/京东（电商推荐）：**
- 召回：浏览/购买历史 + 相似商品 + 热卖
- 排序：预测购买概率（CTR × CVR）
- 特色：考虑价格、库存、物流
- 重排：分类打散、品牌多样性

**Netflix（视频推荐）：**
- 召回：协同过滤 + 内容相似 + 续看
- 排序：预测评分、完播率
- 特色：个性化封面图（不同用户看到不同封面）
- AB测试：所有策略上线前AB测试

**今日头条（新闻推荐）：**
- 召回：兴趣标签 + 热点 + 关注媒体
- 排序：预测点击率、阅读时长
- 特色：实时热点捕捉、地域化推荐
- 多样性：避免信息茧房，推荐不同观点

### 九、总结

设计推荐系统的核心思路：

1. **漏斗架构**：召回 → 粗排 → 精排 → 重排，层层过滤
2. **多路召回**：协同过滤 + 内容画像 + 热门 + 深度学习，提高覆盖率
3. **机器学习排序**：深度学习模型预测用户兴趣，精准推荐
4. **实时反馈**：用户行为实时更新特征，形成闭环
5. **冷启动**：新用户用人口统计学+热门，新内容用标签匹配+小流量测试
6. **多样性**：打散相似内容，避免信息茧房
7. **探索利用平衡**：既推荐已知喜欢的，也探索新领域

工程实践建议：
- 先实现基础版本（协同过滤 + 热门推荐），再逐步迭代
- 重视数据质量：日志完整性、标签准确性
- AB测试驱动优化：所有改进都需要数据验证
- 关注用户体验：推荐准不准，用户说了算（停留时长、负反馈率）
- 平衡多方利益：用户体验 + 内容生态 + 商业变现
