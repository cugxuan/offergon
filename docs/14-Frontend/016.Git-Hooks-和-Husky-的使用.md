---
title: Git Hooks 和 Husky 的使用
tags:
  - 前端工程化
status: robot
class: 前端工程化
slug: git-hooks-and-husky-usage
ref:
---

## 核心要点

**Git Hooks** 是 Git 在特定事件时自动执行的脚本机制,**Husky** 是简化 Git Hooks 配置和管理的工具,主要用于在提交前执行代码检查、格式化等操作,确保代码质量。核心价值:自动化质量把关、统一团队规范、减少 CR 成本。

---

## 详细回答

### 一、Git Hooks 原理

Git Hooks 是 Git 在执行特定操作时触发的钩子脚本,存放在 `.git/hooks/` 目录下。

**常用 Hooks 类型:**

| Hook 名称 | 触发时机 | 典型用途 |
|----------|---------|---------|
| pre-commit | `git commit` 执行前 | 代码检查(ESLint)、格式化(Prettier)、单元测试 |
| commit-msg | 提交信息写入后、commit 完成前 | 校验 commit message 格式(Conventional Commits) |
| pre-push | `git push` 执行前 | 运行完整测试套件、构建检查 |
| post-merge | `git merge` 完成后 | 自动安装依赖(`npm install`) |

**原生使用方式:**

```bash
# 在 .git/hooks/pre-commit 创建可执行脚本
#!/bin/sh
npm run lint
npm run test
```

**痛点:**
- `.git/hooks/` 不被 Git 追踪,无法与团队共享
- 需要手动配置可执行权限
- 跨平台兼容性差(Windows/Linux 脚本差异)

---

### 二、Husky 解决方案

Husky 通过在项目中维护 Hooks 配置,自动安装到 `.git/hooks/` 并处理跨平台问题。

#### 1. 安装与配置(v8.x 现代版本)

```bash
# 安装 Husky
npm install --save-dev husky

# 初始化(会创建 .husky/ 目录)
npx husky init
```

**项目结构:**

```
project/
├── .husky/
│   ├── pre-commit       # 提交前钩子
│   ├── commit-msg       # 提交信息钩子
│   └── _/               # Husky 内部文件
├── package.json
```

#### 2. 配置 pre-commit Hook

```bash
# .husky/pre-commit
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# 运行 ESLint 检查暂存区文件
npm run lint-staged
```

**配合 lint-staged 实现增量检查:**

```json
// package.json
{
  "scripts": {
    "prepare": "husky install"  // npm install 后自动安装 Hooks
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",           // 自动修复
      "prettier --write"        // 格式化
    ],
    "*.css": "stylelint --fix"
  }
}
```

```bash
# 安装 lint-staged
npm install --save-dev lint-staged
```

**工作流程:**
1. 执行 `git commit`
2. Husky 触发 `pre-commit` 脚本
3. `lint-staged` 只检查 `git add` 的文件(非全量)
4. 检查通过则提交,否则阻止并提示错误

---

#### 3. 配置 commit-msg Hook(规范提交信息)

```bash
# .husky/commit-msg
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# 使用 commitlint 校验提交信息
npx --no -- commitlint --edit $1
```

**commitlint 配置:**

```bash
npm install --save-dev @commitlint/{config-conventional,cli}
```

```js
// commitlint.config.js
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [2, 'always', [
      'feat',     // 新功能
      'fix',      // 修复
      'docs',     // 文档
      'style',    // 格式调整
      'refactor', // 重构
      'perf',     // 性能优化
      'test',     // 测试
      'chore'     // 构建/工具变动
    ]],
    'subject-case': [0]  // 不限制大小写
  }
};
```

**合法的 commit message 示例:**

```bash
feat: 添加用户登录功能
fix: 修复购物车价格计算错误
docs: 更新 API 文档
```

---

### 三、实战最佳实践

#### 1. 完整工程化配置示例

```json
// package.json
{
  "scripts": {
    "prepare": "husky install",
    "lint": "eslint . --ext .js,.jsx,.ts,.tsx",
    "format": "prettier --write .",
    "test": "jest --bail --findRelatedTests"
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",
      "jest --bail --findRelatedTests"  // 只测试相关测试
    ],
    "*.{json,md}": "prettier --write"
  }
}
```

```bash
# .husky/pre-commit
npm run lint-staged

# .husky/pre-push
npm run test  # 推送前运行完整测试
npm run build # 确保能成功构建
```

#### 2. 性能优化技巧

**问题:** 大型项目中 lint 全量文件耗时过长

**解决方案:**
- 使用 `lint-staged` 只检查暂存文件
- 启用 ESLint 缓存:
  ```bash
  eslint --cache --cache-location node_modules/.cache/eslint
  ```
- 使用 `--max-warnings 0` 强制 0 警告提交

#### 3. 跳过 Hooks(紧急情况)

```bash
# 跳过 pre-commit(不推荐)
git commit --no-verify -m "hotfix: 紧急修复生产问题"

# 跳过 pre-push
git push --no-verify
```

---

### 四、Husky 版本差异

| 特性 | v4.x(旧版本) | v8.x(现代版本) |
|-----|-------------|---------------|
| 配置方式 | package.json 中配置 | 独立 `.husky/` 目录 |
| 安装命令 | `husky install` 自动 | 需手动 `husky init` |
| 文件结构 | 依赖 `yorkie` | 纯 Shell 脚本 |
| 性能 | 较慢 | 极快(无 Node.js 启动开销) |

**迁移建议:** 新项目直接使用 v8.x,旧项目参考[官方迁移指南](https://typicode.github.io/husky/migrating-from-v4-to-v8.html)。

---

### 五、常见问题排查

**1. Hooks 未触发**

```bash
# 检查 Husky 是否正确安装
ls .husky/

# 重新安装
rm -rf .git/hooks
npm run prepare
```

**2. Windows 下权限错误**

```bash
# 使用 Git Bash 或启用 WSL
# 或在脚本开头添加:
#!/bin/sh
```

**3. CI 环境跳过 Hooks**

```json
// package.json
{
  "scripts": {
    "prepare": "is-ci || husky install"
  }
}
```

```bash
npm install --save-dev is-ci
```

---

### 总结

**核心价值链:**

```
开发者提交代码 → Husky 触发 Hook → lint-staged 检查变更文件
→ ESLint/Prettier 自动修复 → commitlint 校验 message
→ 通过则提交 / 失败则阻止并提示
```

**关键收益:**
- **自动化:** 无需依赖开发者自觉,强制执行规范
- **提速 CR:** 减少低级错误,评审聚焦业务逻辑
- **统一标准:** 团队共享配置,避免"我的环境能跑"问题
- **渐进式:** 可先从 pre-commit 开始,逐步增加 pre-push、单元测试等
