---
title: 前端的组件库开发和发布
tags:
  - 前端工程化
status: robot
class: 前端工程化
slug: frontend-component-library-development-publishing
ref:
---

## 核心要点

- **目标**:创建可复用、高质量的 UI 组件库,供多个项目使用
- **核心环节**:设计规范、组件开发、文档编写、构建打包、版本发布
- **技术栈**:Storybook、Rollup/Vite、TypeScript、Semantic Release
- **发布方式**:npm registry、私有 registry、CDN、Git submodule

---

## 详细回答

### 一、组件库开发全流程

#### 1. 开发流程概览

```
设计规范 → 项目初始化 → 组件开发 → 文档编写 → 测试验证 → 构建打包 → 版本发布 → 使用维护
    ↓           ↓           ↓           ↓           ↓           ↓           ↓           ↓
 Design    项目搭建      开发组件     Storybook     Unit Test    Build       npm        消费使用
 Token      基础配置      API设计      组件文档      E2E Test     产物优化     publish    版本升级
```

#### 2. 技术选型对比

| 技术栈 | 优势 | 劣势 | 适用场景 |
|-------|------|------|---------|
| React + TypeScript | 类型安全,生态丰富 | 学习成本高 | 企业级项目 |
| Vue 3 + TypeScript | 渐进式,易上手 | 生态相对小 | 中小型项目 |
| Vanilla JS | 无框架依赖 | 开发效率低 | 通用组件库 |
| Web Components | 标准化,跨框架 | 兼容性问题 | 多技术栈场景 |

### 二、项目初始化与架构设计

#### 1. 目录结构设计

```
my-ui-library/
├── packages/                 # 组件包(Monorepo)
│   ├── components/          # 核心组件
│   │   ├── button/
│   │   ├── input/
│   │   └── index.ts
│   ├── icons/              # 图标库
│   ├── themes/             # 主题包
│   └── utils/              # 工具函数
├── docs/                   # 文档站点
├── playground/             # 组件演示
├── scripts/                # 构建脚本
│   ├── build.js
│   ├── release.js
│   └── generate-types.js
├── tools/                  # 开发工具
│   ├── storybook/
│   └── testing/
├── dist/                   # 构建产物
├── .storybook/            # Storybook 配置
├── rollup.config.js       # 打包配置
├── package.json
├── tsconfig.json
└── README.md
```

#### 2. Monorepo 配置 (Lerna + Yarn Workspaces)

```json
// package.json
{
  "name": "my-ui-library",
  "private": true,
  "workspaces": [
    "packages/*"
  ],
  "devDependencies": {
    "@lerna/version": "^6.0.0",
    "@lerna/publish": "^6.0.0",
    "lerna": "^6.0.0"
  },
  "scripts": {
    "build": "lerna run build",
    "test": "lerna run test",
    "publish": "lerna publish"
  }
}
```

```json
// lerna.json
{
  "version": "independent",
  "npmClient": "yarn",
  "useWorkspaces": true,
  "packages": ["packages/*"],
  "command": {
    "publish": {
      "conventionalCommits": true,
      "registry": "https://registry.npmjs.org/"
    }
  }
}
```

#### 3. 基础配置文件

```typescript
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "node",
    "jsx": "react-jsx",
    "declaration": true,
    "declarationMap": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "**/*.test.*"]
}
```

```javascript
// rollup.config.js
import resolve from '@rollup/plugin-node-resolve';
import typescript from '@rollup/plugin-typescript';
import commonjs from '@rollup/plugin-commonjs';
import { terser } from 'rollup-plugin-terser';
import peerDepsExternal from 'rollup-plugin-peer-deps-external';

export default {
  input: 'src/index.ts',
  output: [
    {
      file: 'dist/index.js',
      format: 'cjs',
      exports: 'named',
      sourcemap: true,
    },
    {
      file: 'dist/index.esm.js',
      format: 'esm',
      exports: 'named',
      sourcemap: true,
    },
    {
      file: 'dist/index.umd.js',
      format: 'umd',
      name: 'MyUILibrary',
      globals: {
        'react': 'React',
        'react-dom': 'ReactDOM',
      },
      sourcemap: true,
    },
  ],
  plugins: [
    peerDepsExternal(),
    resolve(),
    commonjs(),
    typescript({
      tsconfig: './tsconfig.json',
    }),
    terser(),
  ],
  external: ['react', 'react-dom'],
};
```

### 三、组件开发最佳实践

#### 1. 组件设计原则

```typescript
// 组件 API 设计原则示例
interface ButtonProps {
  // 1. 核心功能属性
  children: React.ReactNode;
  onClick?: (event: React.MouseEvent) => void;

  // 2. 外观样式属性
  variant?: 'primary' | 'secondary' | 'danger' | 'ghost';
  size?: 'small' | 'medium' | 'large';

  // 3. 状态属性
  disabled?: boolean;
  loading?: boolean;

  // 4. 扩展属性
  className?: string;
  style?: React.CSSProperties;

  // 5. 原生属性继承
} & Omit<React.ButtonHTMLAttributes<HTMLButtonElement>, 'onClick'>
```

#### 2. 组件实现模板

```typescript
// packages/components/button/Button.tsx
import React, { forwardRef } from 'react';
import classNames from 'classnames';
import { ButtonProps } from './Button.types';
import './Button.scss';

const Button = forwardRef<HTMLButtonElement, ButtonProps>(
  (
    {
      children,
      variant = 'primary',
      size = 'medium',
      disabled = false,
      loading = false,
      className,
      onClick,
      ...rest
    },
    ref
  ) => {
    const handleClick = (event: React.MouseEvent<HTMLButtonElement>) => {
      if (disabled || loading) return;
      onClick?.(event);
    };

    const classes = classNames(
      'ui-button',
      `ui-button--${variant}`,
      `ui-button--${size}`,
      {
        'ui-button--disabled': disabled,
        'ui-button--loading': loading,
      },
      className
    );

    return (
      <button
        ref={ref}
        className={classes}
        disabled={disabled}
        onClick={handleClick}
        {...rest}
      >
        {loading && <span className="ui-button__spinner" />}
        <span className="ui-button__content">{children}</span>
      </button>
    );
  }
);

Button.displayName = 'Button';

export default Button;
```

```typescript
// packages/components/button/Button.types.ts
import { ButtonHTMLAttributes, ReactNode } from 'react';

export interface ButtonProps
  extends Omit<ButtonHTMLAttributes<HTMLButtonElement>, 'onClick'> {
  children: ReactNode;
  variant?: 'primary' | 'secondary' | 'danger' | 'ghost';
  size?: 'small' | 'medium' | 'large';
  disabled?: boolean;
  loading?: boolean;
  onClick?: (event: React.MouseEvent<HTMLButtonElement>) => void;
}
```

```scss
// packages/components/button/Button.scss
.ui-button {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: none;
  border-radius: 4px;
  font-family: inherit;
  font-weight: 500;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.2s ease;

  // 尺寸变体
  &--small {
    height: 32px;
    padding: 0 12px;
    font-size: 14px;
  }

  &--medium {
    height: 40px;
    padding: 0 16px;
    font-size: 16px;
  }

  &--large {
    height: 48px;
    padding: 0 20px;
    font-size: 18px;
  }

  // 样式变体
  &--primary {
    background-color: #1890ff;
    color: white;

    &:hover:not(.ui-button--disabled) {
      background-color: #40a9ff;
    }
  }

  &--secondary {
    background-color: transparent;
    color: #1890ff;
    border: 1px solid #d9d9d9;

    &:hover:not(.ui-button--disabled) {
      border-color: #1890ff;
    }
  }

  // 状态
  &--disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  &--loading {
    cursor: wait;

    .ui-button__content {
      opacity: 0.6;
    }
  }

  &__spinner {
    width: 16px;
    height: 16px;
    margin-right: 8px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}
```

#### 3. 组件导出

```typescript
// packages/components/button/index.ts
export { default } from './Button';
export type { ButtonProps } from './Button.types';
```

```typescript
// packages/components/index.ts
export { default as Button } from './button';
export { default as Input } from './input';
export { default as Modal } from './modal';

// 导出所有类型
export type { ButtonProps } from './button';
export type { InputProps } from './input';
export type { ModalProps } from './modal';
```

### 四、Storybook 文档开发

#### 1. Storybook 配置

```javascript
// .storybook/main.js
module.exports = {
  stories: ['../packages/**/*.stories.@(js|jsx|ts|tsx)'],
  addons: [
    '@storybook/addon-docs',
    '@storybook/addon-controls',
    '@storybook/addon-viewport',
    '@storybook/addon-actions',
    '@storybook/addon-a11y',
  ],
  framework: '@storybook/react',
  core: {
    builder: '@storybook/builder-vite',
  },
  features: {
    buildStoriesJson: true,
  },
  typescript: {
    reactDocgen: 'react-docgen-typescript',
  },
};
```

#### 2. 组件 Story 编写

```typescript
// packages/components/button/Button.stories.tsx
import type { Meta, StoryObj } from '@storybook/react';
import Button from './Button';

const meta: Meta<typeof Button> = {
  title: 'Components/Button',
  component: Button,
  parameters: {
    docs: {
      description: {
        component: '通用按钮组件,支持多种样式和状态。',
      },
    },
  },
  argTypes: {
    variant: {
      control: 'select',
      options: ['primary', 'secondary', 'danger', 'ghost'],
      description: '按钮样式变体',
    },
    size: {
      control: 'select',
      options: ['small', 'medium', 'large'],
      description: '按钮尺寸',
    },
    disabled: {
      control: 'boolean',
      description: '是否禁用',
    },
    loading: {
      control: 'boolean',
      description: '是否显示加载状态',
    },
  },
  args: {
    children: 'Button',
  },
};

export default meta;
type Story = StoryObj<typeof Button>;

// 基础示例
export const Default: Story = {};

// 样式变体
export const Variants: Story = {
  render: () => (
    <div style={{ display: 'flex', gap: '8px' }}>
      <Button variant="primary">Primary</Button>
      <Button variant="secondary">Secondary</Button>
      <Button variant="danger">Danger</Button>
      <Button variant="ghost">Ghost</Button>
    </div>
  ),
};

// 尺寸示例
export const Sizes: Story = {
  render: () => (
    <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
      <Button size="small">Small</Button>
      <Button size="medium">Medium</Button>
      <Button size="large">Large</Button>
    </div>
  ),
};

// 状态示例
export const States: Story = {
  render: () => (
    <div style={{ display: 'flex', gap: '8px' }}>
      <Button>Normal</Button>
      <Button disabled>Disabled</Button>
      <Button loading>Loading</Button>
    </div>
  ),
};

// 交互示例
export const WithActions: Story = {
  args: {
    onClick: () => alert('Button clicked!'),
  },
};
```

### 五、构建与打包优化

#### 1. 多格式输出配置

```javascript
// scripts/build.js
const rollup = require('rollup');
const typescript = require('@rollup/plugin-typescript');
const resolve = require('@rollup/plugin-node-resolve');
const commonjs = require('@rollup/plugin-commonjs');
const { terser } = require('rollup-plugin-terser');
const sass = require('rollup-plugin-sass');

async function build() {
  // ESM 构建
  const esmBundle = await rollup.rollup({
    input: 'src/index.ts',
    plugins: [
      resolve(),
      commonjs(),
      typescript({
        target: 'ES2020',
        module: 'ESNext',
        declaration: true,
        outDir: 'dist/esm',
      }),
      sass({
        output: 'dist/styles.css',
      }),
    ],
    external: ['react', 'react-dom'],
  });

  await esmBundle.write({
    format: 'esm',
    dir: 'dist/esm',
    preserveModules: true,
  });

  // CJS 构建
  const cjsBundle = await rollup.rollup({
    input: 'src/index.ts',
    plugins: [
      resolve(),
      commonjs(),
      typescript({
        target: 'ES5',
        module: 'CommonJS',
        outDir: 'dist/cjs',
      }),
    ],
    external: ['react', 'react-dom'],
  });

  await cjsBundle.write({
    format: 'cjs',
    dir: 'dist/cjs',
    exports: 'named',
  });

  // UMD 构建 (浏览器)
  const umdBundle = await rollup.rollup({
    input: 'src/index.ts',
    plugins: [
      resolve(),
      commonjs(),
      typescript({
        target: 'ES5',
        module: 'ESNext',
      }),
      terser(),
    ],
    external: ['react', 'react-dom'],
  });

  await umdBundle.write({
    format: 'umd',
    file: 'dist/index.umd.js',
    name: 'MyUILibrary',
    globals: {
      react: 'React',
      'react-dom': 'ReactDOM',
    },
  });
}

build().catch(console.error);
```

#### 2. Package.json 配置

```json
{
  "name": "@my-org/ui-library",
  "version": "1.0.0",
  "description": "企业级 React 组件库",
  "main": "dist/cjs/index.js",
  "module": "dist/esm/index.js",
  "types": "dist/esm/index.d.ts",
  "files": [
    "dist",
    "README.md",
    "LICENSE"
  ],
  "exports": {
    ".": {
      "import": "./dist/esm/index.js",
      "require": "./dist/cjs/index.js",
      "types": "./dist/esm/index.d.ts"
    },
    "./styles": "./dist/styles.css"
  },
  "sideEffects": [
    "*.css",
    "*.scss"
  ],
  "scripts": {
    "build": "node scripts/build.js",
    "build:storybook": "storybook build",
    "dev": "storybook dev -p 6006",
    "test": "jest",
    "typecheck": "tsc --noEmit",
    "lint": "eslint src --ext .ts,.tsx",
    "prepublishOnly": "npm run build"
  },
  "peerDependencies": {
    "react": ">=16.8.0",
    "react-dom": ">=16.8.0"
  },
  "devDependencies": {
    "react": "^18.0.0",
    "react-dom": "^18.0.0",
    "typescript": "^4.9.0"
  },
  "keywords": [
    "react",
    "components",
    "ui",
    "design-system"
  ],
  "author": "Your Name",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/your-org/ui-library.git"
  },
  "homepage": "https://your-org.github.io/ui-library"
}
```

### 六、版本发布与管理

#### 1. 语义化版本控制

```json
// .releaserc.js (Semantic Release)
module.exports = {
  branches: ['main'],
  plugins: [
    '@semantic-release/commit-analyzer',
    '@semantic-release/release-notes-generator',
    '@semantic-release/changelog',
    '@semantic-release/npm',
    '@semantic-release/github',
    [
      '@semantic-release/git',
      {
        assets: ['CHANGELOG.md', 'package.json'],
        message: 'chore(release): ${nextRelease.version} [skip ci]\n\n${nextRelease.notes}',
      },
    ],
  ],
};
```

#### 2. 发布脚本

```javascript
// scripts/release.js
const { execSync } = require('child_process');
const fs = require('fs');

function release() {
  // 1. 检查工作区状态
  const status = execSync('git status --porcelain', { encoding: 'utf8' });
  if (status.trim()) {
    console.error('工作区不干净,请先提交所有更改');
    process.exit(1);
  }

  // 2. 运行测试
  console.log('运行测试...');
  execSync('npm test', { stdio: 'inherit' });

  // 3. 构建项目
  console.log('构建项目...');
  execSync('npm run build', { stdio: 'inherit' });

  // 4. 更新版本
  console.log('更新版本...');
  execSync('npm version patch', { stdio: 'inherit' });

  // 5. 发布到 npm
  console.log('发布到 npm...');
  execSync('npm publish', { stdio: 'inherit' });

  // 6. 推送到远程仓库
  console.log('推送到 git...');
  execSync('git push --follow-tags', { stdio: 'inherit' });

  console.log('✅ 发布成功!');
}

release();
```

#### 3. GitHub Actions 自动发布

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npx semantic-release
```

### 七、使用与集成

#### 1. 使用者安装使用

```bash
# 安装组件库
npm install @my-org/ui-library

# 安装 peer dependencies
npm install react react-dom
```

```jsx
// 在项目中使用
import React from 'react';
import { Button, Input, Modal } from '@my-org/ui-library';
import '@my-org/ui-library/styles';

function App() {
  return (
    <div>
      <Button variant="primary" onClick={() => console.log('clicked')}>
        点击我
      </Button>
      <Input placeholder="请输入内容" />
    </div>
  );
}
```

#### 2. 按需导入配置

```javascript
// babel-plugin-import 配置
{
  "plugins": [
    [
      "import",
      {
        "libraryName": "@my-org/ui-library",
        "libraryDirectory": "esm",
        "style": true
      }
    ]
  ]
}

// 使用时自动按需导入
import { Button } from '@my-org/ui-library';
// 转换为:
// import Button from '@my-org/ui-library/esm/button';
// import '@my-org/ui-library/esm/button/style';
```

### 八、质量保证

#### 1. 单元测试

```typescript
// packages/components/button/Button.test.tsx
import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react';
import Button from './Button';

describe('Button', () => {
  it('renders correctly', () => {
    render(<Button>Test Button</Button>);
    expect(screen.getByRole('button')).toHaveTextContent('Test Button');
  });

  it('handles click events', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>Click me</Button>);

    fireEvent.click(screen.getByRole('button'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('applies variant classes correctly', () => {
    render(<Button variant="danger">Danger Button</Button>);
    expect(screen.getByRole('button')).toHaveClass('ui-button--danger');
  });

  it('disables interaction when loading', () => {
    const handleClick = jest.fn();
    render(<Button loading onClick={handleClick}>Loading</Button>);

    fireEvent.click(screen.getByRole('button'));
    expect(handleClick).not.toHaveBeenCalled();
  });
});
```

#### 2. 视觉回归测试

```javascript
// .storybook/test-runner.js
module.exports = {
  async postRender(page, context) {
    // 等待加载完成
    await page.waitForLoadState('networkidle');

    // 截图对比
    const image = await page.screenshot();
    expect(image).toMatchImageSnapshot({
      customSnapshotIdentifier: context.id,
      failureThreshold: 0.2,
      failureThresholdType: 'percent',
    });
  },
};
```

### 九、常见问题与解决方案

#### 1. 样式冲突问题

**解决方案**:
- 使用 CSS-in-JS 或 CSS Modules
- 统一命名空间前缀
- 提供样式重置选项

```scss
// 命名空间前缀
.ui-component {
  // 所有样式都在此命名空间下

  &__element {
    // BEM 命名规范
  }
}
```

#### 2. TypeScript 类型定义

```typescript
// 确保类型定义完整导出
export type { ButtonProps } from './components/button';
export type { InputProps } from './components/input';

// 提供主题类型定义
export interface Theme {
  colors: {
    primary: string;
    secondary: string;
  };
  spacing: {
    small: number;
    medium: number;
    large: number;
  };
}
```

#### 3. Tree Shaking 优化

```javascript
// 确保 package.json 正确配置
{
  "sideEffects": false, // 或指定具有副作用的文件
  "module": "dist/esm/index.js"
}

// 使用 ES modules 导出
export { Button } from './button';
export { Input } from './input';
```

### 十、最佳实践总结

#### 1. 设计原则
- ✅ **一致性**:统一的设计语言和 API 风格
- ✅ **可访问性**:支持键盘导航、屏幕阅读器
- ✅ **可定制**:支持主题化、样式覆盖
- ✅ **向后兼容**:语义化版本管理

#### 2. 开发规范
- ✅ **TypeScript 优先**:完整的类型定义
- ✅ **文档完善**:Storybook + API 文档
- ✅ **测试覆盖**:单元测试 + 视觉测试
- ✅ **构建优化**:多格式输出 + Tree Shaking

#### 3. 发布流程
- ✅ **自动化**:CI/CD 自动构建发布
- ✅ **版本管理**:语义化版本 + Changelog
- ✅ **质量门禁**:测试通过才能发布
- ✅ **回滚机制**:问题版本快速回滚

组件库开发是一个系统工程,需要平衡开发效率、使用体验和维护成本。关键是建立完善的开发流程和质量保证机制,确保组件库的长期稳定发展。
