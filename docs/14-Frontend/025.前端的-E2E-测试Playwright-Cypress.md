---
title: 前端的 E2E 测试（Playwright、Cypress）
tags:
  - 前端工程化
status: robot
class: 前端工程化
slug: frontend-e2e-testing-playwright-cypress
ref:
---

## 核心要点

- **目标**:模拟真实用户操作,验证完整业务流程
- **主流工具**:Playwright(跨浏览器强)、Cypress(开发体验好)
- **测试场景**:用户注册登录、购物下单、表单提交、页面跳转
- **关键价值**:端到端验证、回归测试、用户体验保障

---

## 详细回答

### 一、什么是 E2E 测试?

E2E(End-to-End)测试是在**真实浏览器环境**中,模拟真实用户的完整操作流程,验证整个应用是否按预期工作。

**测试层次对比**:
```
单元测试 → 集成测试 → E2E 测试
   ↓          ↓         ↓
函数/组件   模块交互   完整流程
  快速      中速       慢速
 高精度    中精度     高置信度
```

**E2E 测试价值**:
- ✅ **真实性**: 在真实浏览器中运行
- ✅ **完整性**: 测试完整用户流程
- ✅ **置信度**: 最接近用户实际使用
- ✅ **回归**: 确保新功能不影响老功能

### 二、Playwright vs Cypress 对比

| 特性 | Playwright | Cypress |
|-----|-----------|---------|
| **跨浏览器** | ✅ Chrome/Firefox/Safari/Edge | ⚠️ 主要支持 Chrome 系 |
| **并行执行** | ✅ 原生支持多进程 | ⚠️ 付费版才支持 |
| **调试体验** | 良好(VS Code 集成) | 优秀(时间旅行调试) |
| **语法简洁度** | 中等 | 优秀(链式 API) |
| **性能** | 更快(真正并行) | 较慢(单线程) |
| **生态成熟度** | 新兴(微软) | 成熟(社区丰富) |
| **移动端** | ✅ 支持移动端浏览器 | ❌ 不支持 |
| **API 拦截** | 强大(可修改请求/响应) | 优秀(易用) |
| **学习曲线** | 中等 | 较低 |

**选择建议**:
- ✅ **多浏览器兼容** → Playwright
- ✅ **快速原型/开发体验** → Cypress
- ✅ **企业级/CI 效率** → Playwright
- ✅ **团队新手较多** → Cypress

### 三、Playwright 完整实战

#### 1. 安装与配置

```bash
# 安装 Playwright
npm init playwright@latest

# 或手动安装
npm install --save-dev @playwright/test
npx playwright install # 下载浏览器
```

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  // 测试目录
  testDir: './tests',

  // 并行工作线程
  workers: process.env.CI ? 2 : undefined,

  // 失败重试次数
  retries: process.env.CI ? 2 : 0,

  // 测试报告
  reporter: [
    ['html'],
    ['json', { outputFile: 'playwright-report.json' }],
    ['junit', { outputFile: 'playwright-results.xml' }],
  ],

  use: {
    // 基础 URL
    baseURL: 'http://localhost:3000',

    // 全局截图/录像
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
    trace: 'retain-on-failure',

    // 全局等待
    actionTimeout: 10000,
    navigationTimeout: 30000,
  },

  // 多浏览器配置
  projects: [
    {
      name: 'Desktop Chrome',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'Desktop Firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'Desktop Safari',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],

  // 开发服务器(自动启动)
  webServer: {
    command: 'npm run dev',
    port: 3000,
    reuseExistingServer: !process.env.CI,
  },
});
```

#### 2. 基础测试示例

```typescript
// tests/example.spec.ts
import { test, expect } from '@playwright/test';

test.describe('用户登录流程', () => {
  test('成功登录', async ({ page }) => {
    // 导航到登录页
    await page.goto('/login');

    // 填写表单
    await page.fill('[data-testid="username"]', 'testuser');
    await page.fill('[data-testid="password"]', 'password123');

    // 点击登录按钮
    await page.click('[data-testid="login-button"]');

    // 验证跳转到首页
    await expect(page).toHaveURL('/dashboard');

    // 验证用户信息显示
    await expect(page.getByText('欢迎, testuser')).toBeVisible();
  });

  test('登录失败处理', async ({ page }) => {
    await page.goto('/login');

    await page.fill('[data-testid="username"]', 'invalid');
    await page.fill('[data-testid="password"]', 'wrong');
    await page.click('[data-testid="login-button"]');

    // 验证错误信息
    await expect(page.getByText('用户名或密码错误')).toBeVisible();

    // 验证仍在登录页
    await expect(page).toHaveURL('/login');
  });
});
```

#### 3. 页面对象模式 (POM)

```typescript
// pages/LoginPage.ts
import { Page, Locator } from '@playwright/test';

export class LoginPage {
  private page: Page;

  // 元素定位器
  private usernameInput: Locator;
  private passwordInput: Locator;
  private loginButton: Locator;
  private errorMessage: Locator;

  constructor(page: Page) {
    this.page = page;
    this.usernameInput = page.getByTestId('username');
    this.passwordInput = page.getByTestId('password');
    this.loginButton = page.getByTestId('login-button');
    this.errorMessage = page.getByTestId('error-message');
  }

  // 页面操作方法
  async goto() {
    await this.page.goto('/login');
  }

  async login(username: string, password: string) {
    await this.usernameInput.fill(username);
    await this.passwordInput.fill(password);
    await this.loginButton.click();
  }

  async getErrorMessage() {
    return await this.errorMessage.textContent();
  }

  async isLoginButtonDisabled() {
    return await this.loginButton.isDisabled();
  }
}
```

```typescript
// tests/login.spec.ts
import { test, expect } from '@playwright/test';
import { LoginPage } from '../pages/LoginPage';

test('使用页面对象模式登录', async ({ page }) => {
  const loginPage = new LoginPage(page);

  await loginPage.goto();
  await loginPage.login('testuser', 'password123');

  await expect(page).toHaveURL('/dashboard');
});
```

#### 4. API 拦截与 Mock

```typescript
// tests/api-mock.spec.ts
import { test, expect } from '@playwright/test';

test('Mock API 响应', async ({ page }) => {
  // 拦截 API 请求
  await page.route('/api/user/**', async (route) => {
    // Mock 响应数据
    await route.fulfill({
      status: 200,
      contentType: 'application/json',
      body: JSON.stringify({
        id: 1,
        name: 'Test User',
        email: 'test@example.com',
      }),
    });
  });

  await page.goto('/profile');

  // 验证 Mock 数据显示
  await expect(page.getByText('Test User')).toBeVisible();
  await expect(page.getByText('test@example.com')).toBeVisible();
});

test('网络失败处理', async ({ page }) => {
  // 模拟网络错误
  await page.route('/api/users', async (route) => {
    await route.abort('failed');
  });

  await page.goto('/users');

  // 验证错误处理
  await expect(page.getByText('网络错误')).toBeVisible();
});
```

#### 5. 高级功能

```typescript
// tests/advanced.spec.ts
import { test, expect } from '@playwright/test';

test('文件上传', async ({ page }) => {
  await page.goto('/upload');

  // 设置文件选择器
  const fileInput = page.getByTestId('file-input');
  await fileInput.setInputFiles('path/to/test-file.pdf');

  // 或者创建临时文件
  await fileInput.setInputFiles({
    name: 'test.txt',
    mimeType: 'text/plain',
    buffer: Buffer.from('Hello World'),
  });

  await page.click('[data-testid="upload-button"]');
  await expect(page.getByText('上传成功')).toBeVisible();
});

test('拖拽操作', async ({ page }) => {
  await page.goto('/kanban');

  const sourceTask = page.getByTestId('task-1');
  const targetColumn = page.getByTestId('done-column');

  // 拖拽任务到完成列
  await sourceTask.dragTo(targetColumn);

  // 验证任务移动
  await expect(targetColumn.getByTestId('task-1')).toBeVisible();
});

test('地理位置', async ({ page, context }) => {
  // 设置地理位置
  await context.setGeolocation({ latitude: 51.5074, longitude: -0.1278 });
  await context.grantPermissions(['geolocation']);

  await page.goto('/location');
  await page.click('[data-testid="get-location"]');

  await expect(page.getByText('London')).toBeVisible();
});

test('多标签页操作', async ({ context }) => {
  const page1 = await context.newPage();
  const page2 = await context.newPage();

  await page1.goto('/page1');
  await page2.goto('/page2');

  // 在页面1操作
  await page1.click('[data-testid="open-popup"]');

  // 切换到新打开的页面
  const page3 = await context.waitForEvent('page');
  await expect(page3.getByText('弹窗内容')).toBeVisible();
});
```

### 四、Cypress 完整实战

#### 1. 安装与配置

```bash
# 安装 Cypress
npm install --save-dev cypress

# 打开 Cypress
npx cypress open
```

```typescript
// cypress.config.ts
import { defineConfig } from 'cypress';

export default defineConfig({
  e2e: {
    // 基础配置
    baseUrl: 'http://localhost:3000',
    viewportWidth: 1280,
    viewportHeight: 720,

    // 超时设置
    defaultCommandTimeout: 10000,
    pageLoadTimeout: 30000,
    requestTimeout: 10000,

    // 测试文件模式
    specPattern: 'cypress/e2e/**/*.cy.{js,jsx,ts,tsx}',

    // 支持文件
    supportFile: 'cypress/support/e2e.ts',

    // 截图和录像
    screenshotOnRunFailure: true,
    video: true,
    videoCompression: 32,

    // 浏览器启动选项
    chromeWebSecurity: false,

    setupNodeEvents(on, config) {
      // 插件配置
      on('task', {
        log(message) {
          console.log(message);
          return null;
        },
      });
    },
  },
});
```

#### 2. 基础测试示例

```typescript
// cypress/e2e/login.cy.ts
describe('用户登录', () => {
  beforeEach(() => {
    cy.visit('/login');
  });

  it('成功登录', () => {
    cy.get('[data-testid="username"]').type('testuser');
    cy.get('[data-testid="password"]').type('password123');
    cy.get('[data-testid="login-button"]').click();

    // 验证跳转
    cy.url().should('include', '/dashboard');
    cy.contains('欢迎, testuser').should('be.visible');
  });

  it('登录失败', () => {
    cy.get('[data-testid="username"]').type('invalid');
    cy.get('[data-testid="password"]').type('wrong');
    cy.get('[data-testid="login-button"]').click();

    cy.contains('用户名或密码错误').should('be.visible');
    cy.url().should('include', '/login');
  });

  it('表单验证', () => {
    cy.get('[data-testid="login-button"]').click();

    cy.get('[data-testid="username"]')
      .should('have.class', 'error')
      .then(($input) => {
        expect($input[0].validationMessage).to.equal('请填写此字段');
      });
  });
});
```

#### 3. 自定义命令

```typescript
// cypress/support/commands.ts
declare global {
  namespace Cypress {
    interface Chainable {
      login(username: string, password: string): Chainable<void>;
      createUser(user: User): Chainable<void>;
      getBySel(selector: string): Chainable<JQuery<HTMLElement>>;
    }
  }
}

// 登录命令
Cypress.Commands.add('login', (username: string, password: string) => {
  cy.session([username, password], () => {
    cy.visit('/login');
    cy.get('[data-testid="username"]').type(username);
    cy.get('[data-testid="password"]').type(password);
    cy.get('[data-testid="login-button"]').click();
    cy.url().should('include', '/dashboard');
  });
});

// 通过 data-testid 选择元素
Cypress.Commands.add('getBySel', (selector: string) => {
  return cy.get(`[data-testid="${selector}"]`);
});

// 创建用户
Cypress.Commands.add('createUser', (user: User) => {
  cy.request({
    method: 'POST',
    url: '/api/users',
    body: user,
  });
});
```

```typescript
// 使用自定义命令
describe('仪表板功能', () => {
  beforeEach(() => {
    cy.login('testuser', 'password123');
    cy.visit('/dashboard');
  });

  it('显示用户信息', () => {
    cy.getBySel('user-info').should('contain', 'testuser');
  });
});
```

#### 4. API 拦截

```typescript
// cypress/e2e/api-interceptor.cy.ts
describe('API 拦截', () => {
  it('Mock 用户列表', () => {
    // 设置拦截器
    cy.intercept('GET', '/api/users', {
      fixture: 'users.json',
    }).as('getUsers');

    cy.visit('/users');

    // 等待 API 调用
    cy.wait('@getUsers');

    // 验证数据显示
    cy.get('.user-item').should('have.length', 3);
  });

  it('处理 API 错误', () => {
    cy.intercept('GET', '/api/users', {
      statusCode: 500,
      body: { error: 'Server Error' },
    }).as('getUsersError');

    cy.visit('/users');
    cy.wait('@getUsersError');

    cy.contains('服务器错误').should('be.visible');
  });

  it('动态修改响应', () => {
    cy.intercept('GET', '/api/profile', (req) => {
      req.reply((res) => {
        res.body.name = 'Modified Name';
      });
    }).as('getProfile');

    cy.visit('/profile');
    cy.wait('@getProfile');

    cy.contains('Modified Name').should('be.visible');
  });
});
```

```json
// cypress/fixtures/users.json
[
  { "id": 1, "name": "Alice", "email": "alice@example.com" },
  { "id": 2, "name": "Bob", "email": "bob@example.com" },
  { "id": 3, "name": "Charlie", "email": "charlie@example.com" }
]
```

#### 5. 高级操作

```typescript
// cypress/e2e/advanced.cy.ts
describe('高级操作', () => {
  it('文件上传', () => {
    cy.visit('/upload');

    cy.get('input[type="file"]').selectFile('cypress/fixtures/test-file.pdf');
    cy.get('[data-testid="upload-button"]').click();

    cy.contains('上传成功').should('be.visible');
  });

  it('拖拽排序', () => {
    cy.visit('/sortable-list');

    // 拖拽第一个到第三个位置
    cy.get('.list-item').first().trigger('mousedown', { button: 0 });
    cy.get('.list-item').eq(2).trigger('mousemove').trigger('mouseup');

    // 验证顺序变化
    cy.get('.list-item').first().should('contain', 'Item 2');
  });

  it('多窗口操作', () => {
    cy.visit('/main');

    cy.window().then((win) => {
      cy.stub(win, 'open').as('windowOpen');
    });

    cy.get('[data-testid="open-popup"]').click();
    cy.get('@windowOpen').should('have.been.calledWith', '/popup');
  });

  it('键盘操作', () => {
    cy.visit('/keyboard-shortcuts');

    cy.get('body').type('{ctrl+s}');
    cy.contains('文档已保存').should('be.visible');

    cy.get('[data-testid="input"]').type('Hello{enter}');
    cy.get('[data-testid="output"]').should('contain', 'Hello');
  });
});
```

### 五、最佳实践

#### 1. 测试数据管理

```typescript
// 使用 Fixtures
describe('用户管理', () => {
  beforeEach(() => {
    cy.fixture('users').as('userData');
  });

  it('创建用户', function () {
    const user = this.userData.validUser;
    cy.createUser(user);
    cy.visit('/users');
    cy.contains(user.name).should('be.visible');
  });
});
```

```typescript
// 数据库种子(Playwright)
test.beforeEach(async ({ page }) => {
  // 清理数据库
  await page.request.delete('/api/test/cleanup');

  // 创建测试数据
  await page.request.post('/api/test/seed', {
    data: {
      users: [
        { name: 'Test User', email: 'test@example.com' },
      ],
    },
  });
});
```

#### 2. 等待策略

```typescript
// ❌ 硬编码等待
cy.wait(3000);

// ✅ 等待元素出现
cy.get('[data-testid="loading"]').should('not.exist');
cy.get('[data-testid="content"]').should('be.visible');

// ✅ 等待 API 完成
cy.intercept('GET', '/api/data').as('getData');
cy.wait('@getData');

// Playwright 自动等待
await page.getByText('内容加载完成').waitFor();
```

#### 3. 错误处理

```typescript
// Cypress 错误处理
Cypress.on('uncaught:exception', (err, runnable) => {
  // 忽略某些错误
  if (err.message.includes('Script error')) {
    return false;
  }
});
```

```typescript
// Playwright 错误处理
test('处理页面错误', async ({ page }) => {
  let errorMessages: string[] = [];

  page.on('pageerror', (error) => {
    errorMessages.push(error.message);
  });

  await page.goto('/problematic-page');

  expect(errorMessages).toHaveLength(0);
});
```

#### 4. 并行执行配置

```bash
# Playwright 并行
npx playwright test --workers=4

# Cypress (需要付费版)
npx cypress run --record --parallel
```

### 六、CI/CD 集成

```yaml
# .github/workflows/e2e.yml
name: E2E Tests

on: [push, pull_request]

jobs:
  playwright:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npx playwright test

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/

  cypress:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Cypress run
        uses: cypress-io/github-action@v5
        with:
          build: npm run build
          start: npm start
          wait-on: 'http://localhost:3000'
          browser: chrome
```

### 七、性能与优化

#### 1. 测试速度优化

```typescript
// 减少页面加载
test.use({
  baseURL: 'http://localhost:3000',
  // 禁用图片/CSS 加载
  javaScriptEnabled: true,
  // 使用更快的浏览器
  channel: 'chrome',
});

// 并行测试
test.describe.configure({ mode: 'parallel' });
```

#### 2. 选择器优化

```typescript
// ❌ 脆弱的选择器
cy.get('.btn.btn-primary.large');

// ✅ 稳定的选择器
cy.get('[data-testid="submit-button"]');
cy.getByRole('button', { name: '提交' });
```

#### 3. 测试独立性

```typescript
// 每个测试清理状态
test.beforeEach(async ({ page }) => {
  await page.context().clearCookies();
  await page.context().clearPermissions();
});

// 使用数据库事务
test.beforeEach(async () => {
  await db.transaction().rollback();
});
```

### 八、调试技巧

#### 1. Playwright 调试

```bash
# 调试模式
npx playwright test --debug

# 浏览器可见模式
npx playwright test --headed

# 慢动作模式
npx playwright test --headed --slowMo=1000
```

```typescript
// 代码调试
test('debug test', async ({ page }) => {
  await page.goto('/login');

  // 暂停执行
  await page.pause();

  // 截图
  await page.screenshot({ path: 'debug.png' });

  // 控制台输出
  console.log(await page.title());
});
```

#### 2. Cypress 调试

```typescript
describe('调试示例', () => {
  it('debug test', () => {
    cy.visit('/app');

    // 暂停执行
    cy.pause();

    // 调试信息
    cy.debug();

    // 截图
    cy.screenshot('debug-screenshot');
  });
});
```

### 九、常见问题解决

#### 1. 元素不可点击

```typescript
// 等待元素可点击
await page.getByRole('button').click({ force: true });

// 或等待覆盖元素消失
await page.getByTestId('loading-overlay').waitFor({ state: 'hidden' });
```

#### 2. 异步内容加载

```typescript
// 等待 API 完成
await page.waitForResponse('/api/data');

// 等待元素状态变化
await expect(page.getByText('加载中...')).toBeHidden();
await expect(page.getByText('内容已加载')).toBeVisible();
```

#### 3. 跨域问题

```typescript
// Playwright
test.use({
  extraHTTPHeaders: {
    'Access-Control-Allow-Origin': '*',
  },
});

// Cypress
cy.visit('https://example.com', {
  chromeWebSecurity: false,
});
```

### 十、总结

#### E2E 测试的价值

✅ **用户体验保障**: 确保关键流程正常工作
✅ **回归测试**: 防止新功能破坏已有功能
✅ **跨浏览器兼容**: 验证多浏览器一致性
✅ **业务流程验证**: 端到端业务逻辑验证

#### 工具选择指南

**选择 Playwright 如果**:
- 需要跨浏览器测试(Safari/Firefox)
- 追求执行速度和并行效率
- 团队有技术深度
- CI/CD 环境要求高

**选择 Cypress 如果**:
- 团队更注重开发体验
- 主要测试 Chrome 系浏览器
- 需要丰富的调试功能
- 快速上手要求高

#### 关键原则

1. **金字塔原则**: E2E 测试数量要控制,重点测关键流程
2. **独立性**: 每个测试都能独立运行
3. **稳定性**: 使用稳定的选择器,避免脆弱测试
4. **可维护性**: 使用页面对象模式,提高代码复用
5. **实用性**: 测试真实用户场景,而不是技术实现

E2E 测试是质量保障的最后一道防线,虽然成本较高,但对关键业务流程的保护价值巨大。关键是在覆盖率和维护成本间找到平衡点。
