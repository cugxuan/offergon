---
title: TCP 如何保证可靠传输？拥塞控制和流量控制的区别是什么？
tags:
  - 网络协议
  - 计算机网络
status: robot
class: 计算机网络
slug: tcp-reliable-transmission-congestion-vs-flow-control
ref:
---

## 核心要点

**TCP 可靠传输机制**：序列号与确认应答、超时重传、滑动窗口、流量控制（接收窗口）、拥塞控制（慢启动、拥塞避免、快速重传、快速恢复）。

**流量控制 vs 拥塞控制**：流量控制是端到端的接收方缓冲区管理，防止接收方溢出；拥塞控制是网络层面的整体流量管理，防止网络过载。

---

## TCP 可靠传输保证机制

### 1. 序列号与确认应答（ACK）
- **序列号（Sequence Number）**：每个字节都有唯一的序列号
- **确认应答（ACK）**：接收方收到数据后发送确认，告知发送方已收到哪些数据
- **累积确认**：ACK号表示期望收到的下一个字节序号

### 2. 超时重传机制
- **RTO（Retransmission Timeout）**：发送方发送数据后启动定时器
- 如果在 RTO 时间内没有收到 ACK，则重传该数据
- **动态 RTO 计算**：根据网络状况动态调整超时时间（RTT 测量）

### 3. 滑动窗口机制
- **发送窗口**：允许发送但未确认的数据量
- **接收窗口**：接收方能够缓存的数据量
- 窗口滑动实现流水线传输，提高效率
- 窗口大小动态调整，适应网络状况

### 4. 快速重传与快速恢复
- **快速重传**：收到 3 个重复 ACK 立即重传，无需等待超时
- **SACK（选择性确认）**：告知发送方哪些数据已收到，哪些需要重传
- **快速恢复**：检测到丢包后不回到慢启动，而是降低拥塞窗口继续传输

### 5. 校验和
- TCP 头部包含 16 位校验和字段
- 检测传输过程中的数据损坏
- 如果校验失败，丢弃该报文段，等待重传

### 6. 顺序控制
- 使用序列号保证数据按序到达应用层
- 接收方对乱序到达的数据进行重排序

## 流量控制（Flow Control）

### 定义
流量控制是**端到端的控制**，防止发送方发送速度过快导致接收方缓冲区溢出。

### 机制：滑动窗口
- **接收窗口（rwnd）**：接收方在 TCP 头部通告自己的可用缓冲区大小
- **发送窗口 = min(拥塞窗口 cwnd, 接收窗口 rwnd)**
- 接收方缓冲区满时，通告窗口为 0，发送方停止发送
- **零窗口探测**：发送方定期发送 1 字节数据探测接收方窗口是否恢复

### 目的
- 防止接收方缓冲区溢出
- 保护接收方不被淹没
- 是一种**接收方主导**的控制机制

## 拥塞控制（Congestion Control）

### 定义
拥塞控制是**网络层面的控制**，防止过多数据注入网络导致网络拥塞。

### 四个核心算法

#### 1. 慢启动（Slow Start）
- 初始拥塞窗口 **cwnd = 1 MSS**（Maximum Segment Size）
- 每收到一个 ACK，cwnd 加倍（指数增长）
- 达到慢启动阈值（ssthresh）后进入拥塞避免

#### 2. 拥塞避免（Congestion Avoidance）
- 超过 ssthresh 后，cwnd **线性增长**
- 每个 RTT，cwnd += 1 MSS
- 谨慎地增大发送窗口

#### 3. 快速重传（Fast Retransmit）
- 收到 **3 个重复 ACK** 立即重传丢失的报文段
- 不等待超时定时器
- 快速发现并恢复丢包

#### 4. 快速恢复（Fast Recovery）
- 发生快速重传后：
  - ssthresh = cwnd / 2
  - cwnd = ssthresh + 3 MSS
  - 进入拥塞避免阶段
- 避免网络完全崩溃，快速恢复传输

### 拥塞检测
- **超时**：认为网络严重拥塞，ssthresh = cwnd / 2，cwnd = 1，重新慢启动
- **3 个重复 ACK**：认为轻度拥塞，执行快速重传和快速恢复

### 目的
- 防止网络拥塞
- 保护整个网络不被淹没
- 是一种**发送方主导**的控制机制

## 流量控制 vs 拥塞控制对比

| 对比项 | 流量控制 | 拥塞控制 |
|--------|----------|----------|
| **控制范围** | 端到端（发送方-接收方） | 网络层面（全局） |
| **目的** | 防止接收方缓冲区溢出 | 防止网络拥塞 |
| **控制方** | 接收方主导 | 发送方主导 |
| **窗口** | 接收窗口 rwnd | 拥塞窗口 cwnd |
| **通知方式** | TCP 头部的窗口字段 | 通过超时和重复 ACK 推测 |
| **调整依据** | 接收方缓冲区大小 | 网络拥塞状况 |

## 实际发送窗口计算

```
发送窗口 = min(拥塞窗口 cwnd, 接收窗口 rwnd)
```

两者共同作用，既保护接收方，也保护网络。
