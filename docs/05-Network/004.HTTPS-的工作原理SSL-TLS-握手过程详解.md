---
title: HTTPS 的工作原理，SSL/TLS 握手过程详解
tags:
  - 计算机网络
  - 应用层协议
status: robot
class: 计算机网络
slug: https-ssl-tls-handshake-process
ref:
---

## 核心要点

**HTTPS = HTTP + SSL/TLS**：在 HTTP 和 TCP 之间加入 SSL/TLS 层，提供加密、身份认证和数据完整性保护。

**TLS 握手**：客户端发起握手 → 服务器返回证书 → 客户端验证证书并协商密钥 → 双方使用对称加密通信。结合非对称加密交换密钥，对称加密传输数据。

---

## HTTPS 工作原理

### 架构层次

```
应用层：HTTP
------------ SSL/TLS 层（加密层）
传输层：TCP
网络层：IP
```

### 核心功能

1. **加密**：防止中间人窃听
2. **身份认证**：验证服务器身份（证书）
3. **数据完整性**：防止数据被篡改（MAC/HMAC）

## SSL/TLS 握手过程详解

### TLS 1.2 握手（完整版）

#### 第 1 步：客户端 Hello（Client Hello）
客户端 → 服务器，发送：
- **TLS 版本**（如 TLS 1.2）
- **随机数 Client Random**（28 字节）
- **支持的加密套件列表**（如 `TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256`）
- **支持的压缩方法**
- **扩展字段**（如 SNI、支持的签名算法等）

#### 第 2 步：服务器 Hello（Server Hello）
服务器 → 客户端，发送：
- **选定的 TLS 版本**
- **随机数 Server Random**（28 字节）
- **选定的加密套件**
- **Session ID**（用于会话复用）

#### 第 3 步：服务器证书（Server Certificate）
服务器 → 客户端，发送：
- **服务器数字证书**（包含公钥、域名、有效期、CA 签名等）
- 客户端需要验证证书的合法性

#### 第 4 步：服务器密钥交换（Server Key Exchange，可选）
- 如果使用 **ECDHE** 或 **DHE** 等算法，服务器发送公钥参数
- 用于生成预主密钥（Pre-Master Secret）

#### 第 5 步：服务器 Hello 完成（Server Hello Done）
服务器 → 客户端：
- 表示服务器握手消息发送完毕

#### 第 6 步：客户端密钥交换（Client Key Exchange）
客户端 → 服务器：
- **生成预主密钥（Pre-Master Secret）**
- 使用服务器公钥加密后发送给服务器
- 或者使用 ECDHE 算法生成共享密钥

#### 第 7 步：双方计算会话密钥
- 客户端和服务器分别使用：
  - **Client Random**
  - **Server Random**
  - **Pre-Master Secret**
- 通过 **PRF（伪随机函数）** 计算出相同的 **Master Secret**
- 再从 Master Secret 派生出**对称加密密钥**、**MAC 密钥**、**IV**

#### 第 8 步：客户端通知（Change Cipher Spec）
客户端 → 服务器：
- 通知服务器后续消息将使用协商好的加密算法和密钥

#### 第 9 步：客户端握手完成（Encrypted Handshake Message - Finished）
客户端 → 服务器：
- 发送加密的握手完成消息（包含所有握手消息的哈希）
- 用于验证握手过程未被篡改

#### 第 10 步:服务器通知（Change Cipher Spec）
服务器 → 客户端：
- 通知客户端后续消息将使用加密

#### 第 11 步：服务器握手完成（Encrypted Handshake Message - Finished）
服务器 → 客户端：
- 发送加密的握手完成消息

#### 第 12 步：应用数据传输
- 双方使用**对称加密**传输 HTTP 数据
- 使用协商好的加密算法（如 AES-GCM）

### TLS 1.2 握手流程图

```
客户端                                        服务器
  |                                             |
  |--- Client Hello --------------------------->|
  |    (TLS版本, Client Random, 加密套件列表)    |
  |                                             |
  |<-- Server Hello ----------------------------|
  |    (选定TLS版本, Server Random, 加密套件)    |
  |<-- Certificate -----------------------------|
  |    (服务器证书)                               |
  |<-- Server Key Exchange (可选) --------------|
  |<-- Server Hello Done -----------------------|
  |                                             |
  | [客户端验证证书]                              |
  |                                             |
  |--- Client Key Exchange --------------------->|
  |    (加密的Pre-Master Secret)                |
  |--- Change Cipher Spec --------------------->|
  |--- Encrypted Handshake Message (Finished) -->|
  |                                             |
  |<-- Change Cipher Spec ----------------------|
  |<-- Encrypted Handshake Message (Finished) --|
  |                                             |
  |<-- Application Data (加密) ----------------->|
  |                                             |
```

### TLS 1.3 握手（简化版，1-RTT）

TLS 1.3 大幅简化握手流程，**只需 1 个往返（1-RTT）**：

```
客户端                                        服务器
  |                                             |
  |--- Client Hello --------------------------->|
  |    (TLS1.3, Client Random, 加密套件,         |
  |     支持的密钥交换参数 - Key Share)          |
  |                                             |
  |<-- Server Hello ----------------------------|
  |    (选定加密套件, Server Random,             |
  |     服务器密钥交换参数 - Key Share)          |
  |<-- {Encrypted Extensions} ------------------|
  |<-- {Certificate} ----------------------------|
  |<-- {Certificate Verify} --------------------|
  |<-- {Finished} -------------------------------|
  |                                             |
  |--- {Finished} ------------------------------>|
  |                                             |
  |<-- Application Data (加密) ----------------->|
```

**关键改进**：
- 合并消息，减少往返次数
- 移除过时算法（如 RSA 密钥交换）
- 支持 **0-RTT** 恢复（会话复用时无需握手）

## 证书验证过程

### 1. 检查证书有效期
- 确保当前时间在证书的 `Not Before` 和 `Not After` 之间

### 2. 检查证书域名
- 证书中的 `Common Name (CN)` 或 `Subject Alternative Name (SAN)` 是否匹配访问的域名

### 3. 验证证书签名链
- 证书由 **CA（证书颁发机构）** 签名
- 客户端使用 CA 的公钥验证证书签名
- 逐级验证到**根证书**（浏览器/系统内置的受信任根证书）

### 4. 检查证书是否被吊销
- 通过 **CRL（证书吊销列表）** 或 **OCSP（在线证书状态协议）** 检查

## 混合加密机制

HTTPS 使用**非对称加密 + 对称加密**的混合方案：

### 1. 握手阶段：非对称加密
- 使用 **RSA** 或 **ECDHE** 交换密钥
- 非对称加密安全但性能较差

### 2. 数据传输阶段：对称加密
- 使用 **AES**、**ChaCha20** 等对称加密算法
- 对称加密性能高，适合大量数据传输

### 3. 消息认证：MAC/HMAC
- 使用 **HMAC-SHA256** 等算法生成消息认证码
- 防止数据被篡改

## 常见加密套件解析

以 `TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256` 为例：

- **TLS**：协议版本
- **ECDHE**：密钥交换算法（椭圆曲线 Diffie-Hellman 临时密钥）
- **RSA**：身份认证算法（服务器证书使用 RSA 签名）
- **AES_128_GCM**：对称加密算法（AES 128 位，GCM 模式）
- **SHA256**：消息认证码算法

## HTTPS 优势与开销

### 优势
- **加密传输**：防止窃听
- **身份认证**：防止钓鱼网站
- **数据完整性**：防止篡改
- **SEO 优势**：搜索引擎优先排名 HTTPS 网站

### 开销
- **握手延迟**：TLS 1.2 需要 2-RTT，TLS 1.3 仅需 1-RTT
- **计算开销**：加密解密消耗 CPU
- **证书成本**：需要购买或申请 SSL 证书（Let's Encrypt 免费）

### 优化方法
- **会话复用**：Session ID / Session Ticket 复用握手结果
- **TLS 1.3**：减少握手往返
- **OCSP Stapling**：服务器预先获取证书状态，减少客户端查询
- **HTTP/2**：多路复用减少连接数
