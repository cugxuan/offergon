---
title: 什么是中间人攻击？HTTPS 如何防止？
tags:
  - 应用层协议
  - 计算机网络
status: robot
class: 计算机网络
slug: man-in-the-middle-attack-https-prevention
ref:
---

## 核心要点

**中间人攻击（MITM）**：攻击者拦截并可能篡改通信双方的数据流，双方误以为在直接通信。常见手段包括 ARP 欺骗、DNS 劫持、恶意 Wi-Fi。

**HTTPS 防御**：通过 CA 证书验证服务器身份、加密传输数据、完整性校验，有效防止中间人攻击。前提是证书链可信且用户验证证书有效性。

---

## 什么是中间人攻击（Man-in-the-Middle Attack, MITM）

### 定义
攻击者在通信双方之间**秘密中继**并可能**篡改**通信内容，而双方均认为他们正在直接通信。

### 攻击原理

```
正常通信：
客户端 <---------> 服务器

中间人攻击：
客户端 <---> 攻击者 <---> 服务器
         (伪装成服务器)  (伪装成客户端)
```

攻击者同时扮演两个角色：
- 对客户端伪装成服务器
- 对服务器伪装成客户端

### 攻击能力
1. **窃听**：获取通信内容（用户名、密码、敏感数据）
2. **篡改**：修改传输的数据
3. **注入**：插入恶意内容（如恶意脚本）
4. **重放**：重复发送截获的请求

## 常见的中间人攻击方式

### 1. ARP 欺骗（ARP Spoofing）
**攻击原理**：
- 在局域网中伪造 ARP 响应
- 将网关的 MAC 地址替换为攻击者的 MAC 地址
- 所有流量经过攻击者转发

**场景**：公共 Wi-Fi、办公网络

### 2. DNS 劫持（DNS Hijacking）
**攻击原理**：
- 篡改 DNS 解析结果
- 将合法域名解析到攻击者控制的 IP 地址
- 用户访问钓鱼网站而不自知

**手段**：
- 路由器 DNS 设置篡改
- ISP 劫持
- 恶意软件修改本地 DNS 设置

### 3. 恶意 Wi-Fi 热点（Evil Twin）
**攻击原理**：
- 创建与合法 Wi-Fi 同名的热点
- 用户连接到恶意热点
- 攻击者控制所有网络流量

**场景**：咖啡馆、机场、酒店

### 4. SSL 剥离（SSL Stripping）
**攻击原理**：
- 拦截 HTTP 到 HTTPS 的重定向
- 客户端与攻击者使用 HTTP 通信
- 攻击者与服务器使用 HTTPS 通信
- 用户以为在使用 HTTPS，实际是 HTTP

**工具**：sslstrip

### 5. 伪造证书（Fake Certificate）
**攻击原理**：
- 为目标网站生成伪造的 SSL 证书
- 需要用户忽略证书警告或设备安装了恶意根证书
- 拦截 HTTPS 流量

**场景**：
- 企业网络监控（合法使用）
- 恶意软件安装伪造根证书

### 6. 会话劫持（Session Hijacking）
**攻击原理**：
- 窃取用户的 Session ID 或 Cookie
- 使用窃取的凭证冒充用户
- 绕过登录验证

**手段**：
- 网络嗅探（HTTP）
- XSS 攻击窃取 Cookie

## HTTPS 如何防止中间人攻击

### 1. 服务器身份认证（证书验证）

#### 数字证书机制
- 服务器使用由**受信任 CA** 签发的证书
- 证书包含服务器公钥和身份信息
- CA 用私钥对证书签名

#### 客户端验证过程
1. **检查证书有效期**：确保证书未过期
2. **验证域名**：证书中的域名与访问的域名匹配
3. **验证签名链**：
   - 使用 CA 公钥验证证书签名
   - 逐级验证到受信任的根证书
4. **检查吊销状态**：通过 CRL 或 OCSP 检查证书是否被吊销

#### 防御效果
- **攻击者无法伪造合法证书**：因为没有 CA 的私钥
- 如果攻击者使用自签名证书，浏览器会**显示警告**

### 2. 加密传输

#### 非对称加密（握手阶段）
- 使用服务器的**公钥**加密会话密钥
- 只有拥有**私钥**的服务器能解密
- 攻击者无法获取会话密钥

#### 对称加密（数据传输阶段）
- 使用协商好的**会话密钥**加密所有数据
- 攻击者即使截获数据也无法解密

### 3. 完整性校验

#### HMAC（消息认证码）
- 每个消息附带 HMAC
- 使用共享密钥计算
- 接收方验证消息未被篡改

#### TLS 记录层保护
- 每个 TLS 记录包含 MAC（Message Authentication Code）
- 任何篡改都会导致 MAC 验证失败

### 4. 前向保密（Forward Secrecy）

#### ECDHE / DHE 密钥交换
- 每次会话生成**临时密钥**
- 即使服务器私钥泄露，过去的会话仍然安全
- 防止历史流量被解密

### 5. HSTS（HTTP Strict Transport Security）

#### 机制
- 服务器告诉浏览器"始终使用 HTTPS"
- 浏览器自动将 HTTP 请求升级为 HTTPS
- 防止 SSL 剥离攻击

#### 示例头部
```
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
```

### 6. 证书固定（Certificate Pinning）

#### 机制
- 客户端预先保存服务器证书或公钥指纹
- 连接时验证证书是否匹配
- 防止伪造证书攻击

#### 应用
- 移动应用（iOS、Android）
- 浏览器扩展
- 关键服务

## HTTPS 防御的局限性

### 1. 用户忽略证书警告
- 攻击者使用自签名证书
- 用户点击"继续访问"绕过警告
- HTTPS 失去保护作用

### 2. 恶意根证书
- 设备被安装恶意根证书
- 攻击者可以签发"合法"证书
- 常见于：
  - 企业网络监控
  - 恶意软件
  - 政府监控

### 3. CA 被攻破
- CA 私钥泄露或 CA 被入侵
- 攻击者可以签发伪造证书
- 历史案例：DigiNotar（2011）、Comodo（2011）

### 4. 降级攻击
- 攻击者强制使用旧版本 TLS（如 TLS 1.0）
- 利用旧版本的安全漏洞
- 防御：禁用旧版本 TLS

## 用户如何防范中间人攻击

### 1. 验证 HTTPS 锁标志
- 检查浏览器地址栏的锁图标
- 点击查看证书详情
- 确认证书颁发者和有效期

### 2. 避免使用不安全网络
- 公共 Wi-Fi 容易被攻击
- 使用 VPN 加密流量
- 避免在公共网络输入敏感信息

### 3. 不要忽略安全警告
- 浏览器显示证书错误时**不要继续访问**
- 警告通常意味着中间人攻击或配置错误

### 4. 启用双因素认证（2FA）
- 即使密码被窃取，攻击者仍无法登录
- 使用 TOTP、硬件密钥等

### 5. 保持系统和浏览器更新
- 修复已知安全漏洞
- 更新受信任的根证书列表

### 6. 使用 VPN
- 加密所有网络流量
- 防止局域网嗅探

## 开发者如何防范

### 1. 强制使用 HTTPS
- 所有页面使用 HTTPS
- HTTP 自动重定向到 HTTPS

### 2. 启用 HSTS
```
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
```

### 3. 使用强加密套件
- 禁用 SSLv3、TLS 1.0、TLS 1.1
- 使用 TLS 1.2 和 TLS 1.3
- 选择强加密算法（AES-GCM、ChaCha20）

### 4. 实施证书固定（移动应用）
```swift
// iOS 示例
let pinnedPublicKey = "sha256/AAAAAAAAAA..."
// 验证服务器证书公钥
```

### 5. 使用安全的 Cookie 设置
```
Set-Cookie: session=abc123; Secure; HttpOnly; SameSite=Strict
```

### 6. 实施 CSP（内容安全策略）
```
Content-Security-Policy: default-src https:; upgrade-insecure-requests
```

## 总结

中间人攻击是严重的安全威胁，但 HTTPS 通过**加密、身份认证、完整性校验**提供了强有力的防御。关键是：

1. **服务端**：正确配置 HTTPS、使用强加密、启用 HSTS
2. **客户端**：验证证书、避免不安全网络、不忽略警告
3. **用户教育**：理解 HTTPS 的重要性，识别安全风险
