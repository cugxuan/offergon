---
title: TCP 三次握手和四次挥手的详细过程是什么？为什么需要三次握手？
tags:
  - 计算机网络
  - 网络协议
status: robot
class: 计算机网络
slug: tcp-three-way-handshake-four-way-wave
ref:
---

## 核心要点

**三次握手**：客户端发送SYN → 服务器回复SYN+ACK → 客户端发送ACK，建立连接状态同步和序列号确认。三次是为了防止旧连接请求导致错误建立和同步双方序列号。

**四次挥手**：主动方发FIN → 被动方回ACK → 被动方发FIN → 主动方回ACK。四次是因为TCP全双工，需要独立关闭两个方向的数据流。

---

## TCP 三次握手详细过程

### 1. 第一次握手（SYN）
- **客户端** → 服务器：发送SYN=1，seq=x
- 客户端进入 `SYN_SENT` 状态
- 表示：客户端请求建立连接

### 2. 第二次握手（SYN+ACK）
- **服务器** → 客户端：发送SYN=1，ACK=1，seq=y，ack=x+1
- 服务器进入 `SYN_RCVD` 状态
- 表示：服务器确认客户端的请求，同时也请求建立连接

### 3. 第三次握手（ACK）
- **客户端** → 服务器：发送ACK=1，seq=x+1，ack=y+1
- 双方进入 `ESTABLISHED` 状态
- 表示：客户端确认服务器的响应，连接建立成功

## 为什么需要三次握手？

### 1. 防止旧的重复连接初始化
如果只有两次握手，旧的SYN请求在网络延迟后到达服务器，可能导致错误建立无用连接。三次握手时客户端可以在第三次握手时拒绝旧连接。

### 2. 同步双方的初始序列号（ISN）
TCP是可靠传输协议，需要确认双方的初始序列号。客户端和服务器都需要确认对方已经收到自己的序列号。

### 3. 避免资源浪费
两次握手时，如果客户端的连接请求在网络中滞留，服务器会认为连接已建立并分配资源，而客户端可能已经放弃，造成服务器资源浪费。

## TCP 四次挥手详细过程

### 1. 第一次挥手（FIN）
- **主动关闭方** → 被动关闭方：发送FIN=1，seq=u
- 主动方进入 `FIN_WAIT_1` 状态
- 表示：我没有数据要发送了（但仍可接收数据）

### 2. 第二次挥手（ACK）
- **被动关闭方** → 主动关闭方：发送ACK=1，seq=v，ack=u+1
- 主动方进入 `FIN_WAIT_2` 状态
- 被动方进入 `CLOSE_WAIT` 状态
- 表示：我知道你要关闭了，但我可能还有数据要发送

### 3. 第三次挥手（FIN）
- **被动关闭方** → 主动关闭方：发送FIN=1，ACK=1，seq=w，ack=u+1
- 被动方进入 `LAST_ACK` 状态
- 表示：我的数据也发送完了，可以关闭了

### 4. 第四次挥手（ACK）
- **主动关闭方** → 被动关闭方：发送ACK=1，seq=u+1，ack=w+1
- 主动方进入 `TIME_WAIT` 状态，等待2MSL后进入 `CLOSED`
- 被动方收到后直接进入 `CLOSED`
- 表示：我确认你要关闭，连接彻底关闭

## 为什么需要四次挥手？

### 1. TCP是全双工协议
连接的每一端都必须单独关闭。当一方完成数据发送任务后发送FIN来终止这个方向的连接，但另一方向的连接可能仍有数据传输。

### 2. 被动方可能还有数据要发送
当主动方发送FIN后，被动方可能还有数据没发送完，所以先发送ACK确认，等数据发送完后再发送FIN。

### 3. TIME_WAIT 状态的意义
- **确保最后的ACK能够到达**：如果最后的ACK丢失，被动方会重发FIN，主动方可以重发ACK
- **确保旧连接的数据包在网络中消失**：等待2MSL（Maximum Segment Lifetime）时间，确保本连接的所有数据包都已消失，不会影响新连接
