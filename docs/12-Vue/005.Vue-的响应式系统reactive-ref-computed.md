---
title: Vue çš„å“åº”å¼ç³»ç»Ÿï¼ˆreactiveã€refã€computedï¼‰
tags:
  - Vue
status: robot
class: å‰ç«¯Vue
slug: vue-reactive-system-ref-computed
ref:
---

## æ ¸å¿ƒè¦ç‚¹

- **reactive**ï¼šç”¨äºåŒ…è£…å¯¹è±¡/æ•°ç»„ï¼ŒåŸºäº Proxy å®ç°æ·±å±‚å“åº”å¼
- **ref**ï¼šç”¨äºåŒ…è£…åŸºæœ¬ç±»å‹å€¼ï¼Œé€šè¿‡ `.value` è®¿é—®ï¼Œå¯¹è±¡å€¼ä¼šè‡ªåŠ¨è°ƒç”¨ reactive
- **computed**ï¼šè®¡ç®—å±æ€§ï¼ŒåŸºäºä¾èµ–è‡ªåŠ¨ç¼“å­˜ï¼Œæƒ°æ€§æ±‚å€¼ï¼Œåªåœ¨ä¾èµ–å˜åŒ–æ—¶é‡æ–°è®¡ç®—
- **æ ¸å¿ƒåŸç†**ï¼šä¾èµ–æ”¶é›†ï¼ˆtrackï¼‰+ è§¦å‘æ›´æ–°ï¼ˆtriggerï¼‰+ å‰¯ä½œç”¨è°ƒåº¦ï¼ˆschedulerï¼‰

---

## è¯¦ç»†å›ç­”

### ä¸€ã€å“åº”å¼ç³»ç»Ÿçš„æ ¸å¿ƒæ¦‚å¿µ

#### 1.1 ä»€ä¹ˆæ˜¯å“åº”å¼ï¼Ÿ

```javascript
// éå“åº”å¼ï¼šæ‰‹åŠ¨æ›´æ–°è§†å›¾
let count = 0;
function increment() {
  count++;
  document.getElementById('count').textContent = count; // æ‰‹åŠ¨æ›´æ–°
}

// Vue å“åº”å¼ï¼šè‡ªåŠ¨æ›´æ–°è§†å›¾
const state = reactive({ count: 0 });
function increment() {
  state.count++; // è‡ªåŠ¨è§¦å‘è§†å›¾æ›´æ–°
}
```

**æ ¸å¿ƒæ€æƒ³**ï¼š
- æ•°æ®å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œç›¸å…³çš„å‰¯ä½œç”¨å‡½æ•°ï¼ˆæ¸²æŸ“ã€watch å›è°ƒç­‰ï¼‰
- é€šè¿‡**ä¾èµ–æ”¶é›†**å»ºç«‹æ•°æ®ä¸å‰¯ä½œç”¨çš„å…³ç³»
- é€šè¿‡**æ´¾å‘æ›´æ–°**åœ¨æ•°æ®å˜åŒ–æ—¶é€šçŸ¥æ‰€æœ‰ä¾èµ–

#### 1.2 å“åº”å¼ç³»ç»Ÿæ¶æ„

```
ğŸ“Š å“åº”å¼æ•°æ®ï¼ˆreactive/refï¼‰
    â†“
ã€ä¾èµ–æ”¶é›† - trackã€‘
    â†“
ğŸ’¾ ä¾èµ–æ˜ å°„è¡¨ï¼ˆtargetMapï¼‰
    â†“
ã€æ•°æ®å˜åŒ– - triggerã€‘
    â†“
ğŸ”„ å‰¯ä½œç”¨é˜Ÿåˆ—ï¼ˆeffectQueueï¼‰
    â†“
ã€æ‰§è¡Œå‰¯ä½œç”¨ - effectã€‘
    â†“
ğŸ¨ æ›´æ–°è§†å›¾ / æ‰§è¡Œå›è°ƒ
```

---

### äºŒã€reactiveï¼šå¯¹è±¡çš„å“åº”å¼åŒ…è£…

#### 2.1 åŸºæœ¬ç”¨æ³•

```javascript
import { reactive } from 'vue';

// åˆ›å»ºå“åº”å¼å¯¹è±¡
const state = reactive({
  count: 0,
  user: {
    name: 'Alice',
    age: 18
  },
  items: [1, 2, 3]
});

// è®¿é—®å’Œä¿®æ”¹å±æ€§
console.log(state.count); // 0
state.count++;            // è§¦å‘æ›´æ–°

// æ·±å±‚å“åº”å¼
state.user.name = 'Bob';  // è§¦å‘æ›´æ–°
state.items.push(4);      // è§¦å‘æ›´æ–°
```

#### 2.2 å®ç°åŸç†

```javascript
// Vue 3 å“åº”å¼æ ¸å¿ƒå®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
const targetMap = new WeakMap(); // å­˜å‚¨æ‰€æœ‰å“åº”å¼å¯¹è±¡çš„ä¾èµ–

function reactive(target) {
  // å¦‚æœå·²ç»æ˜¯ä»£ç†å¯¹è±¡ï¼Œç›´æ¥è¿”å›
  if (target.__v_isReactive) {
    return target;
  }

  return new Proxy(target, {
    get(target, key, receiver) {
      // ç‰¹æ®Šæ ‡è®°
      if (key === '__v_isReactive') {
        return true;
      }

      const result = Reflect.get(target, key, receiver);

      // ä¾èµ–æ”¶é›†
      track(target, key);

      // å¦‚æœå€¼æ˜¯å¯¹è±¡ï¼Œé€’å½’åŒ…è£…ä¸ºå“åº”å¼ï¼ˆæ‡’ä»£ç†ï¼‰
      if (typeof result === 'object' && result !== null) {
        return reactive(result);
      }

      return result;
    },

    set(target, key, value, receiver) {
      const oldValue = target[key];
      const result = Reflect.set(target, key, value, receiver);

      // åªæœ‰å€¼çœŸæ­£æ”¹å˜æ—¶æ‰è§¦å‘æ›´æ–°
      if (oldValue !== value) {
        trigger(target, key);
      }

      return result;
    },

    deleteProperty(target, key) {
      const hadKey = Object.hasOwnProperty.call(target, key);
      const result = Reflect.deleteProperty(target, key);

      // åˆ é™¤æˆåŠŸæ—¶è§¦å‘æ›´æ–°
      if (hadKey && result) {
        trigger(target, key);
      }

      return result;
    }
  });
}
```

#### 2.3 ä¾èµ–æ”¶é›†æœºåˆ¶

```javascript
// å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°
let activeEffect;

// å­˜å‚¨ä¾èµ–å…³ç³»ï¼šWeakMap<target, Map<key, Set<effect>>>
const targetMap = new WeakMap();

function track(target, key) {
  if (!activeEffect) return;

  // è·å– target å¯¹åº”çš„ depsMap
  let depsMap = targetMap.get(target);
  if (!depsMap) {
    targetMap.set(target, (depsMap = new Map()));
  }

  // è·å– key å¯¹åº”çš„ depï¼ˆä¾èµ–é›†åˆï¼‰
  let dep = depsMap.get(key);
  if (!dep) {
    depsMap.set(key, (dep = new Set()));
  }

  // å°†å½“å‰å‰¯ä½œç”¨å‡½æ•°æ·»åŠ åˆ°ä¾èµ–é›†åˆ
  dep.add(activeEffect);
}

// ç¤ºä¾‹ï¼šä¾èµ–å…³ç³»ç»“æ„
// targetMap = WeakMap {
//   { count: 0 } => Map {
//     'count' => Set [effect1, effect2]
//   }
// }
```

#### 2.4 è§¦å‘æ›´æ–°æœºåˆ¶

```javascript
function trigger(target, key) {
  const depsMap = targetMap.get(target);
  if (!depsMap) return;

  const dep = depsMap.get(key);
  if (!dep) return;

  // æ‰§è¡Œæ‰€æœ‰ä¾èµ–çš„å‰¯ä½œç”¨å‡½æ•°
  dep.forEach(effect => {
    if (effect.scheduler) {
      // å¦‚æœæœ‰è°ƒåº¦å™¨ï¼Œä½¿ç”¨è°ƒåº¦å™¨æ‰§è¡Œï¼ˆå¦‚å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—ï¼‰
      effect.scheduler();
    } else {
      // ç›´æ¥æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
      effect();
    }
  });
}
```

#### 2.5 å®Œæ•´ç¤ºä¾‹

```javascript
// åˆ›å»ºå‰¯ä½œç”¨å‡½æ•°
function effect(fn) {
  const effectFn = () => {
    activeEffect = effectFn;
    fn();
    activeEffect = null;
  };
  effectFn();
  return effectFn;
}

// ä½¿ç”¨
const state = reactive({ count: 0 });

effect(() => {
  console.log('Count changed:', state.count); // ä¾èµ–æ”¶é›†
});
// è¾“å‡ºï¼šCount changed: 0

state.count++; // è§¦å‘æ›´æ–°
// è¾“å‡ºï¼šCount changed: 1
```

---

### ä¸‰ã€refï¼šåŸºæœ¬ç±»å‹çš„å“åº”å¼åŒ…è£…

#### 3.1 åŸºæœ¬ç”¨æ³•

```javascript
import { ref } from 'vue';

// åˆ›å»ºå“åº”å¼å¼•ç”¨
const count = ref(0);
const message = ref('Hello');

// é€šè¿‡ .value è®¿é—®å’Œä¿®æ”¹
console.log(count.value);  // 0
count.value++;             // è§¦å‘æ›´æ–°

// å¯¹è±¡å€¼ä¼šè‡ªåŠ¨è°ƒç”¨ reactive
const user = ref({ name: 'Alice' });
user.value.name = 'Bob';   // è§¦å‘æ›´æ–°ï¼ˆæ·±å±‚å“åº”å¼ï¼‰
```

#### 3.2 å®ç°åŸç†

```javascript
class RefImpl {
  constructor(value) {
    this._rawValue = value;
    this._value = convert(value);
    this.__v_isRef = true;
  }

  get value() {
    // ä¾èµ–æ”¶é›†
    track(this, 'value');
    return this._value;
  }

  set value(newValue) {
    if (newValue !== this._rawValue) {
      this._rawValue = newValue;
      this._value = convert(newValue);
      // è§¦å‘æ›´æ–°
      trigger(this, 'value');
    }
  }
}

function convert(value) {
  // å¯¹è±¡ç±»å‹ä½¿ç”¨ reactiveï¼ŒåŸºæœ¬ç±»å‹ç›´æ¥è¿”å›
  return typeof value === 'object' && value !== null
    ? reactive(value)
    : value;
}

function ref(value) {
  return new RefImpl(value);
}
```

#### 3.3 ä¸ºä»€ä¹ˆéœ€è¦ refï¼Ÿ

```javascript
// âŒ reactive ä¸èƒ½åŒ…è£…åŸºæœ¬ç±»å‹
const count = reactive(0); // æ— æ•ˆï¼Œä¼šè¿”å› 0

// âœ… ref å¯ä»¥åŒ…è£…åŸºæœ¬ç±»å‹
const count = ref(0);
count.value++; // æœ‰æ•ˆ

// âŒ reactive åŒ…è£…çš„åŸºæœ¬ç±»å‹ä¸¢å¤±å“åº”å¼
let state = reactive({ count: 0 });
let { count } = state;  // è§£æ„å count å˜æˆæ™®é€šæ•°å­—
count++;                // ä¸ä¼šè§¦å‘æ›´æ–°

// âœ… ref ä¿æŒå“åº”å¼
const count = ref(0);
const anotherCount = count; // ä»ç„¶æ˜¯å“åº”å¼
anotherCount.value++;       // è§¦å‘æ›´æ–°
```

#### 3.4 æ¨¡æ¿ä¸­çš„è‡ªåŠ¨è§£åŒ…

```vue
<template>
  <!-- ref åœ¨æ¨¡æ¿ä¸­è‡ªåŠ¨è§£åŒ…ï¼Œä¸éœ€è¦ .value -->
  <div>{{ count }}</div>
  <button @click="count++">Increment</button>
</template>

<script setup>
import { ref } from 'vue';

const count = ref(0);

// åœ¨ JS ä¸­ä»éœ€è¦ .value
function increment() {
  count.value++;
}
</script>
```

**è§£åŒ…è§„åˆ™**ï¼š
```javascript
// 1. é¡¶å±‚ ref è‡ªåŠ¨è§£åŒ…
const count = ref(0);
// æ¨¡æ¿ï¼š{{ count }} âœ…

// 2. åµŒå¥—åœ¨ reactive å¯¹è±¡ä¸­è‡ªåŠ¨è§£åŒ…
const state = reactive({
  count: ref(0)
});
console.log(state.count); // 0 (è‡ªåŠ¨è§£åŒ…)
state.count++; // æœ‰æ•ˆ

// 3. æ•°ç»„/Map ä¸­ä¸ä¼šè‡ªåŠ¨è§£åŒ…
const list = reactive([ref(0)]);
console.log(list[0].value); // éœ€è¦ .value âŒ
```

---

### å››ã€computedï¼šè®¡ç®—å±æ€§

#### 4.1 åŸºæœ¬ç”¨æ³•

```javascript
import { ref, computed } from 'vue';

const count = ref(0);

// åªè¯»è®¡ç®—å±æ€§
const doubled = computed(() => {
  console.log('Computing...');
  return count.value * 2;
});

console.log(doubled.value); // Computing... 0
console.log(doubled.value); // 0 (ä½¿ç”¨ç¼“å­˜ï¼Œä¸é‡æ–°è®¡ç®—)

count.value++;
console.log(doubled.value); // Computing... 2 (ä¾èµ–å˜åŒ–ï¼Œé‡æ–°è®¡ç®—)

// å¯å†™è®¡ç®—å±æ€§
const fullName = computed({
  get() {
    return `${firstName.value} ${lastName.value}`;
  },
  set(newValue) {
    [firstName.value, lastName.value] = newValue.split(' ');
  }
});
```

#### 4.2 å®ç°åŸç†

```javascript
class ComputedRefImpl {
  constructor(getter, setter) {
    this._getter = getter;
    this._setter = setter;
    this._dirty = true;   // è„æ ‡è®°ï¼šæ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—
    this._value = undefined;

    // åˆ›å»ºå‰¯ä½œç”¨å‡½æ•°
    this.effect = effect(getter, {
      lazy: true,  // æ‡’æ‰§è¡Œï¼Œä¸ç«‹å³è®¡ç®—
      scheduler: () => {
        // ä¾èµ–å˜åŒ–æ—¶ï¼Œæ ‡è®°ä¸ºè„ï¼Œä¸ç«‹å³è®¡ç®—
        if (!this._dirty) {
          this._dirty = true;
          // è§¦å‘ä¾èµ–æ­¤è®¡ç®—å±æ€§çš„å‰¯ä½œç”¨
          trigger(this, 'value');
        }
      }
    });
  }

  get value() {
    // ä¾èµ–æ”¶é›†
    track(this, 'value');

    // å¦‚æœæ˜¯è„çš„ï¼Œé‡æ–°è®¡ç®—
    if (this._dirty) {
      this._value = this.effect();
      this._dirty = false;
    }

    return this._value;
  }

  set value(newValue) {
    this._setter(newValue);
  }
}

function computed(getterOrOptions) {
  let getter, setter;

  if (typeof getterOrOptions === 'function') {
    getter = getterOrOptions;
    setter = () => {
      console.warn('Computed property is readonly');
    };
  } else {
    getter = getterOrOptions.get;
    setter = getterOrOptions.set;
  }

  return new ComputedRefImpl(getter, setter);
}
```

#### 4.3 ç¼“å­˜æœºåˆ¶

```javascript
const count = ref(0);

// âŒ å‡½æ•°ï¼šæ¯æ¬¡è®¿é—®éƒ½é‡æ–°è®¡ç®—
function doubled() {
  console.log('Computing...');
  return count.value * 2;
}

console.log(doubled()); // Computing... 0
console.log(doubled()); // Computing... 0 (é‡å¤è®¡ç®—)

// âœ… computedï¼šæœ‰ç¼“å­˜ï¼Œåªåœ¨ä¾èµ–å˜åŒ–æ—¶è®¡ç®—
const doubledComputed = computed(() => {
  console.log('Computing...');
  return count.value * 2;
});

console.log(doubledComputed.value); // Computing... 0
console.log(doubledComputed.value); // 0 (ä½¿ç”¨ç¼“å­˜)
count.value++;
console.log(doubledComputed.value); // Computing... 2 (ä¾èµ–å˜åŒ–ï¼Œé‡æ–°è®¡ç®—)
```

#### 4.4 æƒ°æ€§æ±‚å€¼

```javascript
const count = ref(0);

// computed æ˜¯æƒ°æ€§çš„ï¼Œä¸è®¿é—®å°±ä¸è®¡ç®—
const expensive = computed(() => {
  console.log('Expensive computation...');
  let sum = 0;
  for (let i = 0; i < 1000000; i++) {
    sum += count.value;
  }
  return sum;
});

// æ­¤æ—¶è¿˜æ²¡æœ‰è®¡ç®—
count.value = 10;

// ç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰è®¡ç®—
console.log(expensive.value); // Expensive computation... 10000000
```

---

### äº”ã€ä¸‰è€…å¯¹æ¯”ä¸é€‰æ‹©

#### 5.1 åŠŸèƒ½å¯¹æ¯”è¡¨

| ç‰¹æ€§ | reactive | ref | computed |
|------|----------|-----|----------|
| **é€‚ç”¨ç±»å‹** | å¯¹è±¡ã€æ•°ç»„ | ä»»æ„ç±»å‹ | åŸºäºå…¶ä»–å“åº”å¼æ•°æ®è®¡ç®— |
| **è®¿é—®æ–¹å¼** | ç›´æ¥è®¿é—® | `.value` è®¿é—® | `.value` è®¿é—® |
| **æ·±å±‚å“åº”å¼** | âœ… é»˜è®¤æ·±å±‚ | âœ… å¯¹è±¡å€¼è‡ªåŠ¨ reactive | âœ… æ ¹æ®ä¾èµ– |
| **æ¨¡æ¿è§£åŒ…** | âœ… è‡ªåŠ¨ | âœ… é¡¶å±‚è‡ªåŠ¨ | âœ… è‡ªåŠ¨ |
| **è§£æ„åå“åº”å¼** | âŒ ä¸¢å¤± | âœ… ä¿æŒ | âœ… ä¿æŒ |
| **æ€§èƒ½å¼€é”€** | ä¸­ï¼ˆProxyï¼‰ | ä½ï¼ˆgetter/setterï¼‰ | ä½ï¼ˆæœ‰ç¼“å­˜ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å¤æ‚å¯¹è±¡ | å•ä¸ªå€¼ã€å‡½æ•°å‚æ•° | æ´¾ç”ŸçŠ¶æ€ |

#### 5.2 ä½¿ç”¨åœºæ™¯

```javascript
// 1ï¸âƒ£ reactiveï¼šç®¡ç†å¤æ‚å¯¹è±¡
const state = reactive({
  user: {
    name: 'Alice',
    age: 18
  },
  settings: {
    theme: 'dark',
    lang: 'zh'
  }
});

// 2ï¸âƒ£ refï¼šå•ä¸ªåŸºæœ¬ç±»å‹å€¼
const count = ref(0);
const isLoading = ref(false);
const message = ref('Hello');

// 3ï¸âƒ£ refï¼šéœ€è¦åœ¨å‡½æ•°é—´ä¼ é€’
function useCounter() {
  const count = ref(0);
  const increment = () => count.value++;
  return { count, increment }; // è§£æ„åä»ä¿æŒå“åº”å¼
}

// 4ï¸âƒ£ computedï¼šæ´¾ç”Ÿæ•°æ®
const firstName = ref('John');
const lastName = ref('Doe');
const fullName = computed(() => `${firstName.value} ${lastName.value}`);

const items = ref([1, 2, 3, 4, 5]);
const evenItems = computed(() => items.value.filter(x => x % 2 === 0));
```

#### 5.3 æœ€ä½³å®è·µ

```javascript
// âŒ ä¸å¥½çš„å®è·µ
const state = reactive({
  count: ref(0)  // åµŒå¥— ref å®¹æ˜“æ··æ·†
});

// âœ… å¥½çš„å®è·µ
const state = reactive({
  count: 0  // reactive å†…ç›´æ¥ç”¨æ™®é€šå€¼
});

// æˆ–
const count = ref(0);  // é¡¶å±‚ç”¨ ref


// âŒ é¿å…è§£æ„ reactive
const state = reactive({ count: 0 });
const { count } = state;  // ä¸¢å¤±å“åº”å¼
count++;  // æ— æ•ˆ

// âœ… ä½¿ç”¨ toRefs è§£æ„
import { toRefs } from 'vue';
const state = reactive({ count: 0 });
const { count } = toRefs(state);  // ä¿æŒå“åº”å¼
count.value++;  // æœ‰æ•ˆ


// âŒ é¿å…åœ¨ computed ä¸­æ‰§è¡Œå‰¯ä½œç”¨
const fullName = computed(() => {
  console.log('Side effect!');  // ä¸æ¨è
  return `${firstName.value} ${lastName.value}`;
});

// âœ… ä½¿ç”¨ watch æ‰§è¡Œå‰¯ä½œç”¨
watch([firstName, lastName], () => {
  console.log('Name changed!');
});
```

---

### å…­ã€é«˜çº§ API

#### 6.1 shallowReactiveï¼šæµ…å±‚å“åº”å¼

```javascript
import { shallowReactive } from 'vue';

const state = shallowReactive({
  count: 0,
  nested: {
    value: 1
  }
});

state.count++;         // âœ… è§¦å‘æ›´æ–°
state.nested.value++;  // âŒ ä¸è§¦å‘æ›´æ–°ï¼ˆåªæœ‰ç¬¬ä¸€å±‚æ˜¯å“åº”å¼çš„ï¼‰
state.nested = { value: 2 }; // âœ… è§¦å‘æ›´æ–°ï¼ˆæ›¿æ¢æ•´ä¸ªå¯¹è±¡ï¼‰
```

**é€‚ç”¨åœºæ™¯**ï¼š
- å¤§å‹ä¸å¯å˜æ•°æ®ç»“æ„ï¼ˆå¦‚å›¾è¡¨é…ç½®ï¼‰
- æ€§èƒ½ä¼˜åŒ–ï¼ˆå‡å°‘æ·±å±‚ä»£ç†çš„å¼€é”€ï¼‰

#### 6.2 toRefs / toRef

```javascript
import { reactive, toRefs, toRef } from 'vue';

const state = reactive({
  count: 0,
  message: 'Hello'
});

// toRefsï¼šè½¬æ¢æ‰€æœ‰å±æ€§ä¸º ref
const stateRefs = toRefs(state);
console.log(stateRefs.count.value); // 0
stateRefs.count.value++; // è§¦å‘æ›´æ–°

// toRefï¼šè½¬æ¢å•ä¸ªå±æ€§ä¸º ref
const count = toRef(state, 'count');
count.value++; // è§¦å‘æ›´æ–°
```

#### 6.3 isRef / isReactive / isProxy

```javascript
import { ref, reactive, isRef, isReactive, isProxy } from 'vue';

const count = ref(0);
const state = reactive({ count: 0 });

console.log(isRef(count));       // true
console.log(isReactive(state));  // true
console.log(isProxy(count));     // false (ref ä¸æ˜¯ Proxy)
console.log(isProxy(state));     // true
```

#### 6.4 markRaw / readonly

```javascript
import { reactive, markRaw, readonly } from 'vue';

// markRawï¼šæ ‡è®°å¯¹è±¡æ°¸è¿œä¸è¢«è½¬ä¸ºå“åº”å¼
const raw = markRaw({ count: 0 });
const state = reactive({ raw });
state.raw.count++; // ä¸è§¦å‘æ›´æ–°

// readonlyï¼šåˆ›å»ºåªè¯»ä»£ç†
const original = reactive({ count: 0 });
const copy = readonly(original);
copy.count++; // è­¦å‘Šï¼šåªè¯»å±æ€§
original.count++; // âœ… åŸå¯¹è±¡ä»å¯ä¿®æ”¹
```

---

### ä¸ƒã€æ€§èƒ½ä¼˜åŒ–æŠ€å·§

#### 7.1 ä½¿ç”¨ shallowRef é¿å…æ·±å±‚å“åº”å¼

```javascript
import { shallowRef } from 'vue';

// âŒ æ·±å±‚å“åº”å¼ï¼ˆæ€§èƒ½å·®ï¼‰
const largeData = ref({
  level1: { level2: { level3: { /* æ·±å±‚åµŒå¥— */ } } }
});

// âœ… æµ…å±‚å“åº”å¼ï¼ˆæ€§èƒ½å¥½ï¼‰
const largeData = shallowRef({
  level1: { level2: { level3: { /* æ·±å±‚åµŒå¥— */ } } }
});
// åªæœ‰æ•´ä½“æ›¿æ¢æ‰è§¦å‘æ›´æ–°
largeData.value = newData;
```

#### 7.2 ä½¿ç”¨ computed ç¼“å­˜å¤æ‚è®¡ç®—

```javascript
// âŒ æ¯æ¬¡è®¿é—®éƒ½è®¡ç®—
const filteredItems = items.value.filter(item => item.active);

// âœ… æœ‰ç¼“å­˜ï¼Œä¾èµ–ä¸å˜æ—¶ä¸é‡æ–°è®¡ç®—
const filteredItems = computed(() =>
  items.value.filter(item => item.active)
);
```

#### 7.3 åˆç†ä½¿ç”¨ markRaw

```javascript
// ç¬¬ä¸‰æ–¹åº“å®ä¾‹ä¸éœ€è¦å“åº”å¼
import Chart from 'chart.js';

const state = reactive({
  chart: markRaw(new Chart(...))  // é¿å…ä»£ç† Chart å®ä¾‹
});
```

---

### å…«ã€é¢è¯•å›ç­”å»ºè®®

**ç®€æ´ç‰ˆï¼ˆ1-2 åˆ†é’Ÿï¼‰**ï¼š
> Vue 3 çš„å“åº”å¼ç³»ç»ŸåŸºäº Proxy å®ç°ï¼Œæä¾›äº†ä¸‰ä¸ªæ ¸å¿ƒ APIï¼š
>
> - **reactive**ï¼šç”¨äºåŒ…è£…å¯¹è±¡å’Œæ•°ç»„ï¼Œæä¾›æ·±å±‚å“åº”å¼
> - **ref**ï¼šç”¨äºåŒ…è£…åŸºæœ¬ç±»å‹å€¼ï¼Œé€šè¿‡ `.value` è®¿é—®ï¼Œå¯¹è±¡å€¼ä¼šè‡ªåŠ¨è°ƒç”¨ reactive
> - **computed**ï¼šè®¡ç®—å±æ€§ï¼ŒåŸºäºä¾èµ–è‡ªåŠ¨ç¼“å­˜ï¼Œåªåœ¨ä¾èµ–å˜åŒ–æ—¶é‡æ–°è®¡ç®—
>
> æ ¸å¿ƒåŸç†æ˜¯ä¾èµ–æ”¶é›†å’Œæ´¾å‘æ›´æ–°ï¼šè®¿é—®å“åº”å¼æ•°æ®æ—¶æ”¶é›†ä¾èµ–ï¼ˆtrackï¼‰ï¼Œä¿®æ”¹æ•°æ®æ—¶è§¦å‘æ›´æ–°ï¼ˆtriggerï¼‰ï¼Œæ‰§è¡Œæ‰€æœ‰ç›¸å…³çš„å‰¯ä½œç”¨å‡½æ•°ã€‚

**æ·±å…¥ç‰ˆï¼ˆ3-5 åˆ†é’Ÿï¼‰**ï¼š
åœ¨ç®€æ´ç‰ˆåŸºç¡€ä¸Šï¼Œè¡¥å……ï¼š
1. **ä¾èµ–æ”¶é›†æœºåˆ¶**ï¼šWeakMap å­˜å‚¨ä¾èµ–å…³ç³»ï¼ŒSet å­˜å‚¨å‰¯ä½œç”¨å‡½æ•°
2. **computed ç¼“å­˜åŸç†**ï¼šè„æ ‡è®°ï¼ˆdirty flagï¼‰+ æƒ°æ€§æ±‚å€¼
3. **ä¸‰è€…é€‰æ‹©**ï¼šreactive ç”¨äºå¯¹è±¡ï¼Œref ç”¨äºåŸºæœ¬ç±»å‹å’Œéœ€è¦ä¼ é€’çš„åœºæ™¯ï¼Œcomputed ç”¨äºæ´¾ç”ŸçŠ¶æ€
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šshallowReactiveã€shallowRefã€markRaw çš„ä½¿ç”¨åœºæ™¯
5. **å¸¸è§é™·é˜±**ï¼šreactive è§£æ„ä¸¢å¤±å“åº”å¼ã€ref åœ¨æ•°ç»„ä¸­ä¸è‡ªåŠ¨è§£åŒ…

---

### ä¹ã€æ‰©å±•çŸ¥è¯†ç‚¹

#### 9.1 effect è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰

```javascript
const state = reactive({ count: 0 });

effect(
  () => {
    console.log('Count:', state.count);
  },
  {
    scheduler(job) {
      // è‡ªå®šä¹‰è°ƒåº¦ï¼šå¼‚æ­¥æ›´æ–°é˜Ÿåˆ—
      queueJob(job);
    }
  }
);

state.count++; // ä¸ç«‹å³æ‰§è¡Œï¼ŒåŠ å…¥é˜Ÿåˆ—
state.count++; // åˆå¹¶æ›´æ–°
state.count++; // åˆå¹¶æ›´æ–°

// ä¸‹ä¸€ä¸ª tick æ‰§è¡Œä¸€æ¬¡
// è¾“å‡ºï¼šCount: 3
```

#### 9.2 stopï¼šåœæ­¢å‰¯ä½œç”¨

```javascript
import { effect, stop } from 'vue';

const state = reactive({ count: 0 });

const runner = effect(() => {
  console.log('Count:', state.count);
});
// è¾“å‡ºï¼šCount: 0

state.count++; // è¾“å‡ºï¼šCount: 1

stop(runner); // åœæ­¢å‰¯ä½œç”¨

state.count++; // ä¸å†è¾“å‡º
```

#### 9.3 watch çš„åº•å±‚å®ç°

```javascript
import { watch, reactive } from 'vue';

const state = reactive({ count: 0 });

// watch æœ¬è´¨ä¸Šæ˜¯ effect + scheduler
watch(
  () => state.count,  // getter å‡½æ•°
  (newValue, oldValue) => {
    console.log(`${oldValue} â†’ ${newValue}`);
  }
);

// ç­‰ä»·äº
effect(
  () => {
    const value = state.count; // è§¦å‘ä¾èµ–æ”¶é›†
    return value;
  },
  {
    scheduler(job) {
      // åœ¨ scheduler ä¸­æ‰§è¡Œå›è°ƒ
      const newValue = job();
      callback(newValue, oldValue);
      oldValue = newValue;
    }
  }
);
```
