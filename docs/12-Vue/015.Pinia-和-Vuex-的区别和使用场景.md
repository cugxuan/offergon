---
title: Pinia 和 Vuex 的区别和使用场景
tags:
  - 前端Vue
status: robot
class: 前端Vue
slug: pinia-vs-vuex-difference-use-cases
ref:
---

## 核心要点

**Pinia 是 Vue 官方推荐的新一代状态管理库，相比 Vuex 更轻量、类型安全更好、API 更简洁。核心区别：Pinia 无 mutations（直接修改 state）、无嵌套模块（扁平化 store）、完美支持 TypeScript、自动代码分割、支持 Composition API。Vuex 适合大型遗留项目，Pinia 适合 Vue 3 新项目和中小型应用。**

---

## 详细回答

### 一、Pinia 和 Vuex 的核心区别

#### 对比表格

| 特性 | Pinia | Vuex |
|------|-------|------|
| **官方定位** | Vue 3 推荐方案 | Vue 2/3 都支持（逐渐淘汰） |
| **TypeScript** | 完美支持，自动类型推导 | 支持但需手动定义类型 |
| **mutations** | ❌ 无需 mutations，直接修改 state | ✅ 必须通过 mutations 修改 state |
| **模块化** | 扁平化 store，每个 store 独立 | 嵌套模块（modules） |
| **体积** | ~1KB | ~2KB |
| **代码分割** | ✅ 自动按需加载 | ⚠️ 需手动配置 |
| **DevTools** | ✅ 完整支持 | ✅ 完整支持 |
| **Composition API** | ✅ 原生支持 | ⚠️ 需适配（useStore） |
| **服务端渲染** | ✅ 更简单 | ✅ 支持但复杂 |
| **学习曲线** | 低（API 简单） | 较高（概念多） |

### 二、Pinia 详解

#### 1. 基本概念

Pinia 的核心概念非常简单，只有三个：

- **state**：状态（数据）
- **getters**：计算属性（派生状态）
- **actions**：方法（同步/异步操作）

**没有 mutations！** 这是与 Vuex 最大的区别。

#### 2. 基础用法

##### 创建 Store

```javascript
// stores/counter.js
import { defineStore } from 'pinia'

export const useCounterStore = defineStore('counter', {
  // State：返回初始状态
  state: () => ({
    count: 0,
    name: 'Counter',
    items: []
  }),

  // Getters：类似计算属性
  getters: {
    // 自动获得类型推导
    doubleCount: (state) => state.count * 2,

    // 可以访问其他 getter
    doubleCountPlusOne() {
      return this.doubleCount + 1
    },

    // 可以接受参数（返回函数）
    getItemById: (state) => {
      return (id) => state.items.find(item => item.id === id)
    }
  },

  // Actions：可以是同步或异步
  actions: {
    // 直接修改 state（无需 mutations）
    increment() {
      this.count++
    },

    // 异步操作
    async fetchItems() {
      try {
        const response = await fetch('/api/items')
        this.items = await response.json()
      } catch (error) {
        console.error('Failed to fetch items:', error)
      }
    },

    // 可以调用其他 action
    async incrementAsync() {
      await new Promise(resolve => setTimeout(resolve, 1000))
      this.increment()
    }
  }
})
```

##### 在组件中使用

```vue
<template>
  <div>
    <p>Count: {{ counter.count }}</p>
    <p>Double: {{ counter.doubleCount }}</p>
    <button @click="counter.increment()">Increment</button>
    <button @click="increment()">Increment (destructured)</button>
  </div>
</template>

<script setup>
import { useCounterStore } from '@/stores/counter'
import { storeToRefs } from 'pinia'

// 获取 store 实例
const counter = useCounterStore()

// ⚠️ 解构会失去响应性
// const { count, doubleCount } = counter  // ❌ 不推荐

// ✅ 使用 storeToRefs 保持响应性
const { count, doubleCount } = storeToRefs(counter)

// ✅ 方法可以直接解构（不需要 storeToRefs）
const { increment } = counter
</script>
```

**关键点：**
- `storeToRefs()` 仅用于解构 **state 和 getters**
- **actions** 可以直接解构，不需要 `storeToRefs`

#### 3. Composition API 风格（Setup Store）

```javascript
// stores/counter.js
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useCounterStore = defineStore('counter', () => {
  // State
  const count = ref(0)
  const name = ref('Counter')

  // Getters
  const doubleCount = computed(() => count.value * 2)

  // Actions
  function increment() {
    count.value++
  }

  async function fetchData() {
    const response = await fetch('/api/data')
    // ...
  }

  // 必须 return 暴露出去
  return {
    count,
    name,
    doubleCount,
    increment,
    fetchData
  }
})
```

**对比传统写法：**

| 传统 Options 风格 | Setup 风格 |
|------------------|-----------|
| `state` | `ref()` |
| `getters` | `computed()` |
| `actions` | `function()` |

**优势：**
- 更灵活，可以使用任何 Composition API
- 更好的 TypeScript 支持
- 代码组织更自由

#### 4. 修改 State 的方式

##### 方式1：直接修改

```javascript
const counter = useCounterStore()
counter.count++
counter.name = 'New Counter'
```

##### 方式2：$patch（批量更新）

```javascript
// 对象形式
counter.$patch({
  count: counter.count + 1,
  name: 'New Counter'
})

// 函数形式（推荐，性能更好）
counter.$patch((state) => {
  state.count++
  state.name = 'New Counter'
  state.items.push({ id: 1, name: 'Item' })
})
```

##### 方式3：$state（替换整个 state）

```javascript
// ⚠️ 会替换整个 state
counter.$state = {
  count: 10,
  name: 'Reset Counter',
  items: []
}
```

##### 方式4：在 action 中修改（推荐）

```javascript
actions: {
  updateCounter(newCount) {
    this.count = newCount
    this.name = `Counter ${newCount}`
  }
}

// 使用
counter.updateCounter(100)
```

#### 5. 订阅 State 变化

##### $subscribe - 监听整个 store

```javascript
const counter = useCounterStore()

// 监听 state 变化
counter.$subscribe((mutation, state) => {
  console.log('State changed:', state)
  console.log('Mutation type:', mutation.type)
  console.log('Mutation payload:', mutation.payload)

  // 持久化到 localStorage
  localStorage.setItem('counter', JSON.stringify(state))
})
```

##### $onAction - 监听 action 执行

```javascript
counter.$onAction(({
  name,      // action 名称
  store,     // store 实例
  args,      // 参数
  after,     // action 成功后的回调
  onError    // action 失败后的回调
}) => {
  console.log(`Action ${name} called with args:`, args)

  after((result) => {
    console.log('Action completed with result:', result)
  })

  onError((error) => {
    console.error('Action failed:', error)
  })
})
```

#### 6. 跨 Store 访问

```javascript
// stores/user.js
import { defineStore } from 'pinia'
import { useCartStore } from './cart'

export const useUserStore = defineStore('user', {
  state: () => ({
    name: 'John',
    isLoggedIn: false
  }),

  actions: {
    async logout() {
      // 访问其他 store
      const cartStore = useCartStore()

      // 清空购物车
      cartStore.clear()

      // 登出
      this.isLoggedIn = false
      this.name = ''
    }
  }
})
```

#### 7. 插件系统

```javascript
// plugins/persist.js
export function piniaPeristPlugin(context) {
  const { store } = context

  // 从 localStorage 恢复状态
  const saved = localStorage.getItem(store.$id)
  if (saved) {
    store.$patch(JSON.parse(saved))
  }

  // 监听变化并保存
  store.$subscribe((mutation, state) => {
    localStorage.setItem(store.$id, JSON.stringify(state))
  })
}

// main.js
import { createPinia } from 'pinia'
import { piniaPeristPlugin } from './plugins/persist'

const pinia = createPinia()
pinia.use(piniaPeristPlugin)

app.use(pinia)
```

### 三、Vuex 详解

#### 1. 基本概念

Vuex 有五个核心概念：

- **state**：单一状态树
- **getters**：派生状态
- **mutations**：同步修改 state 的唯一方式
- **actions**：异步操作，提交 mutations
- **modules**：模块化

#### 2. 基础用法

```javascript
// store/index.js
import { createStore } from 'vuex'

export default createStore({
  state: {
    count: 0,
    todos: []
  },

  getters: {
    doneTodos(state) {
      return state.todos.filter(todo => todo.done)
    },

    doneTodosCount(state, getters) {
      return getters.doneTodos.length
    }
  },

  mutations: {
    // ⚠️ 必须是同步函数
    INCREMENT(state) {
      state.count++
    },

    ADD_TODO(state, todo) {
      state.todos.push(todo)
    }
  },

  actions: {
    // 可以是异步
    async fetchTodos({ commit }) {
      const response = await fetch('/api/todos')
      const todos = await response.json()

      // 提交 mutation
      commit('SET_TODOS', todos)
    },

    // 可以调用其他 action
    async incrementAsync({ commit, dispatch }) {
      await new Promise(resolve => setTimeout(resolve, 1000))
      commit('INCREMENT')

      // 调用其他 action
      await dispatch('fetchTodos')
    }
  }
})
```

#### 3. 在组件中使用

```vue
<template>
  <div>
    <p>Count: {{ count }}</p>
    <p>Done todos: {{ doneTodosCount }}</p>
    <button @click="increment">Increment</button>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useStore } from 'vuex'

const store = useStore()

// State
const count = computed(() => store.state.count)

// Getters
const doneTodosCount = computed(() => store.getters.doneTodosCount)

// Mutations（不推荐直接在组件中调用）
function increment() {
  store.commit('INCREMENT')
}

// Actions（推荐）
function fetchTodos() {
  store.dispatch('fetchTodos')
}
</script>
```

**或使用辅助函数（Options API）：**

```vue
<script>
import { mapState, mapGetters, mapActions } from 'vuex'

export default {
  computed: {
    ...mapState(['count', 'todos']),
    ...mapGetters(['doneTodosCount'])
  },

  methods: {
    ...mapActions(['fetchTodos'])
  }
}
</script>
```

#### 4. 模块化

```javascript
// store/modules/user.js
export default {
  namespaced: true,  // ⚠️ 开启命名空间

  state: {
    name: 'John',
    age: 25
  },

  getters: {
    fullInfo(state) {
      return `${state.name}, ${state.age} years old`
    }
  },

  mutations: {
    SET_NAME(state, name) {
      state.name = name
    }
  },

  actions: {
    async updateName({ commit }, name) {
      // 模拟异步
      await new Promise(resolve => setTimeout(resolve, 1000))
      commit('SET_NAME', name)
    }
  }
}

// store/index.js
import { createStore } from 'vuex'
import user from './modules/user'
import cart from './modules/cart'

export default createStore({
  modules: {
    user,
    cart
  }
})

// 组件中使用
store.state.user.name  // 访问 state
store.getters['user/fullInfo']  // 访问 getter
store.commit('user/SET_NAME', 'Jane')  // 提交 mutation
store.dispatch('user/updateName', 'Jane')  // 派发 action
```

### 四、Pinia vs Vuex 实战对比

#### 场景：用户管理 Store

##### Pinia 实现

```javascript
// stores/user.js
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useUserStore = defineStore('user', () => {
  // State
  const userInfo = ref(null)
  const token = ref(localStorage.getItem('token') || '')

  // Getters
  const isLoggedIn = computed(() => !!token.value)
  const userName = computed(() => userInfo.value?.name || 'Guest')

  // Actions
  async function login(credentials) {
    try {
      const response = await fetch('/api/login', {
        method: 'POST',
        body: JSON.stringify(credentials)
      })
      const data = await response.json()

      token.value = data.token
      userInfo.value = data.user
      localStorage.setItem('token', data.token)

      return true
    } catch (error) {
      console.error('Login failed:', error)
      return false
    }
  }

  function logout() {
    token.value = ''
    userInfo.value = null
    localStorage.removeItem('token')
  }

  return {
    userInfo,
    token,
    isLoggedIn,
    userName,
    login,
    logout
  }
})
```

**使用：**

```vue
<script setup>
import { useUserStore } from '@/stores/user'

const userStore = useUserStore()

// 直接使用
console.log(userStore.isLoggedIn)
userStore.login({ username: 'admin', password: '123' })
</script>
```

##### Vuex 实现

```javascript
// store/modules/user.js
export default {
  namespaced: true,

  state: {
    userInfo: null,
    token: localStorage.getItem('token') || ''
  },

  getters: {
    isLoggedIn: state => !!state.token,
    userName: state => state.userInfo?.name || 'Guest'
  },

  mutations: {
    SET_TOKEN(state, token) {
      state.token = token
      localStorage.setItem('token', token)
    },

    SET_USER_INFO(state, userInfo) {
      state.userInfo = userInfo
    },

    CLEAR_AUTH(state) {
      state.token = ''
      state.userInfo = null
      localStorage.removeItem('token')
    }
  },

  actions: {
    async login({ commit }, credentials) {
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          body: JSON.stringify(credentials)
        })
        const data = await response.json()

        commit('SET_TOKEN', data.token)
        commit('SET_USER_INFO', data.user)

        return true
      } catch (error) {
        console.error('Login failed:', error)
        return false
      }
    },

    logout({ commit }) {
      commit('CLEAR_AUTH')
    }
  }
}
```

**使用：**

```vue
<script setup>
import { computed } from 'vue'
import { useStore } from 'vuex'

const store = useStore()

// 需要 computed 包装
const isLoggedIn = computed(() => store.getters['user/isLoggedIn'])

// 通过 dispatch 调用
store.dispatch('user/login', { username: 'admin', password: '123' })
</script>
```

**对比总结：**

| 对比项 | Pinia | Vuex |
|--------|-------|------|
| **代码量** | 更少（无 mutations） | 更多 |
| **类型推导** | 自动 | 需手动定义 |
| **直接调用** | ✅ `userStore.login()` | ❌ `store.dispatch('user/login')` |
| **响应式解构** | ✅ `storeToRefs` 简单 | ❌ 需要 `computed` 包装 |
| **模块命名空间** | 自动（每个 store 独立） | 需手动开启 `namespaced: true` |

### 五、使用场景建议

#### 何时使用 Pinia

✅ **推荐场景：**

1. **Vue 3 新项目**（官方推荐）
2. **需要良好 TypeScript 支持的项目**
3. **中小型应用**（状态管理不复杂）
4. **使用 Composition API 的项目**
5. **需要代码分割的 SPA**
6. **团队成员对 Vuex 概念不熟悉**

**示例项目：**
- 电商平台（用户、购物车、商品管理）
- 管理后台（权限、菜单、用户管理）
- 社交应用（用户信息、消息、好友列表）

#### 何时使用 Vuex

✅ **推荐场景：**

1. **Vue 2 项目**（Pinia 对 Vue 2 支持有限）
2. **大型遗留项目**（已使用 Vuex，迁移成本高）
3. **需要严格状态追踪的项目**（mutations 强制同步）
4. **团队已熟悉 Vuex 模式**
5. **复杂的嵌套模块场景**（虽然 Pinia 也能实现）

**示例项目：**
- 已运行多年的 Vue 2 项目
- 严格要求状态变更可追溯的金融系统
- 使用 Options API 且不打算迁移的项目

### 六、迁移指南：Vuex → Pinia

#### 1. 迁移步骤

```bash
# 1. 安装 Pinia
npm install pinia

# 2. （可选）保留 Vuex 共存
# 逐步迁移，无需一次性完成
```

#### 2. 转换示例

**Vuex：**

```javascript
// store/modules/cart.js
export default {
  namespaced: true,
  state: { items: [] },
  mutations: {
    ADD_ITEM(state, item) {
      state.items.push(item)
    }
  },
  actions: {
    addItem({ commit }, item) {
      commit('ADD_ITEM', item)
    }
  }
}
```

**Pinia：**

```javascript
// stores/cart.js
import { defineStore } from 'pinia'

export const useCartStore = defineStore('cart', {
  state: () => ({ items: [] }),

  actions: {
    // 直接修改 state，无需 mutations
    addItem(item) {
      this.items.push(item)
    }
  }
})
```

#### 3. 自动迁移工具

```bash
# 使用 Pinia 官方迁移脚本（实验性）
npx @pinia/migrate
```

### 七、常见问题与最佳实践

#### 1. Pinia 的 state 为什么要用函数返回？

```javascript
// ❌ 错误：多个实例会共享同一个对象
state: {
  count: 0
}

// ✅ 正确：每次返回新对象
state: () => ({
  count: 0
})
```

**原因：** 类似 Vue 组件的 `data`，确保每个 store 实例有独立的状态。

#### 2. 何时使用 $patch 而非直接修改？

```javascript
// ✅ 单个修改：直接赋值
counter.count++

// ✅ 多个修改：使用 $patch（性能更好，只触发一次响应）
counter.$patch({
  count: counter.count + 1,
  name: 'New Name',
  items: [...counter.items, newItem]
})
```

#### 3. Pinia 持久化最佳实践

使用官方插件 `pinia-plugin-persistedstate`：

```bash
npm install pinia-plugin-persistedstate
```

```javascript
// main.js
import { createPinia } from 'pinia'
import piniaPluginPersistedstate from 'pinia-plugin-persistedstate'

const pinia = createPinia()
pinia.use(piniaPluginPersistedstate)

// stores/user.js
export const useUserStore = defineStore('user', {
  state: () => ({
    token: '',
    userInfo: null
  }),

  // 开启持久化
  persist: {
    key: 'user',
    storage: localStorage,
    paths: ['token']  // 只持久化 token
  }
})
```

#### 4. TypeScript 最佳实践

```typescript
// stores/user.ts
import { defineStore } from 'pinia'

interface UserInfo {
  id: number
  name: string
  email: string
}

interface UserState {
  userInfo: UserInfo | null
  token: string
}

export const useUserStore = defineStore('user', {
  state: (): UserState => ({
    userInfo: null,
    token: ''
  }),

  getters: {
    // 自动推导返回类型
    isLoggedIn(): boolean {
      return !!this.token
    }
  },

  actions: {
    // 明确参数和返回类型
    async login(credentials: { username: string; password: string }): Promise<boolean> {
      // ...
    }
  }
})
```

### 八、面试总结

**核心要点：**

1. **Pinia 的优势**：
   - 无 mutations，直接修改 state
   - 更好的 TypeScript 支持
   - 扁平化 store 设计，无嵌套模块
   - 体积更小，自动代码分割
   - API 更简洁，学习成本低

2. **Vuex 的特点**：
   - 严格的状态管理模式（mutations 同步）
   - 嵌套模块系统（适合大型应用）
   - Vue 2/3 都支持
   - 生态成熟，社区方案多

3. **选择建议**：
   - **Vue 3 新项目 → Pinia**
   - **Vue 2 项目 → Vuex**
   - **大型遗留项目 → Vuex**
   - **追求类型安全 → Pinia**

4. **实战差异**：
   - Pinia：`userStore.login()` 直接调用
   - Vuex：`store.dispatch('user/login')` 字符串调用
   - Pinia：`storeToRefs(userStore)` 解构响应式数据
   - Vuex：`computed(() => store.state.user.name)` 包装响应式

5. **迁移要点**：
   - Vuex mutations → Pinia actions
   - Vuex modules → Pinia 独立 stores
   - 可以 Vuex 和 Pinia 共存，逐步迁移

**高级话题**：
- Pinia 插件系统的实现原理
- Vuex 的 modules 动态注册机制
- Pinia 的 HMR（热模块替换）支持
- 状态管理的性能优化（选择器缓存、批量更新）
