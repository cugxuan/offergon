---
title: Vue çš„æ¨¡æ¿ç¼–è¯‘åŸç†å’Œä¼˜åŒ–
tags:
  - Vue
status: robot
class: å‰ç«¯Vue
slug: vue-template-compilation-principle-optimization
ref:
---

## æ ¸å¿ƒè¦ç‚¹

- **ç¼–è¯‘æµç¨‹**ï¼šæ¨¡æ¿ï¼ˆTemplateï¼‰ â†’ è§£æï¼ˆParseï¼‰ â†’ ä¼˜åŒ–ï¼ˆOptimizeï¼‰ â†’ ç”Ÿæˆï¼ˆGenerateï¼‰ â†’ æ¸²æŸ“å‡½æ•°ï¼ˆRenderï¼‰
- **æ ¸å¿ƒä¼˜åŒ–**ï¼šé™æ€èŠ‚ç‚¹æ ‡è®°ã€é™æ€æå‡ã€PatchFlagã€äº‹ä»¶ç¼“å­˜ã€Block Tree
- **Vue 2 vs Vue 3**ï¼šVue 3 ç¼–è¯‘äº§ç‰©æ›´å°ã€è¿è¡Œæ—¶æ€§èƒ½æ›´é«˜ã€æ”¯æŒæŒ‰éœ€æ›´æ–°
- **å…³é”®æ”¶ç›Š**ï¼šå‡å°‘è¿è¡Œæ—¶å¼€é”€ã€ç²¾ç¡®æ›´æ–°ã€æ›´å°çš„æ‰“åŒ…ä½“ç§¯

---

## è¯¦ç»†å›ç­”

### ä¸€ã€æ¨¡æ¿ç¼–è¯‘çš„æ•´ä½“æµç¨‹

#### 1.1 å®Œæ•´æµç¨‹å›¾

```
ğŸ“„ æ¨¡æ¿å­—ç¬¦ä¸²
    â†“
ã€è§£æé˜¶æ®µ - Parseã€‘
    â†“
ğŸŒ³ AST æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼‰
    â†“
ã€ä¼˜åŒ–é˜¶æ®µ - Optimizeã€‘
    â†“
ğŸŒ³ ä¼˜åŒ–åçš„ ASTï¼ˆæ ‡è®°é™æ€èŠ‚ç‚¹ï¼‰
    â†“
ã€ç”Ÿæˆé˜¶æ®µ - Generateã€‘
    â†“
ğŸ“œ æ¸²æŸ“å‡½æ•°ä»£ç ï¼ˆRender Functionï¼‰
    â†“
ã€è¿è¡Œæ—¶ - Runtimeã€‘
    â†“
ğŸ¨ è™šæ‹Ÿ DOM â†’ çœŸå® DOM
```

#### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç¼–è¯‘ï¼Ÿ

```vue
<!-- æ¨¡æ¿ï¼šå£°æ˜å¼ã€æ˜“è¯»æ˜“å†™ -->
<template>
  <div class="container">
    <h1>{{ title }}</h1>
    <button @click="handleClick">Click</button>
  </div>
</template>

<!-- æµè§ˆå™¨æ— æ³•ç›´æ¥æ‰§è¡Œæ¨¡æ¿ï¼Œéœ€è¦ç¼–è¯‘æˆ JavaScript -->
```

**æ ¸å¿ƒåŸå› **ï¼š
1. **æµè§ˆå™¨åªè®¤è¯† JavaScript**ï¼šæ¨¡æ¿éœ€è¦è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„ JS ä»£ç 
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼–è¯‘é˜¶æ®µå¯ä»¥åšé™æ€åˆ†æï¼Œæ ‡è®°é™æ€å†…å®¹
3. **ç±»å‹æ£€æŸ¥**ï¼šTypeScript å¯ä»¥å¯¹ç¼–è¯‘åçš„ä»£ç è¿›è¡Œç±»å‹æ¨æ–­

---

### äºŒã€è§£æé˜¶æ®µï¼ˆParseï¼‰

#### 2.1 æ ¸å¿ƒä»»åŠ¡ï¼šå°†æ¨¡æ¿å­—ç¬¦ä¸²è§£æä¸º AST

```javascript
// è¾“å…¥ï¼šæ¨¡æ¿å­—ç¬¦ä¸²
const template = `
  <div id="app">
    <h1>{{ title }}</h1>
    <p>Static text</p>
  </div>
`;

// è¾“å‡ºï¼šAST æŠ½è±¡è¯­æ³•æ ‘
const ast = {
  type: 1,          // å…ƒç´ èŠ‚ç‚¹
  tag: 'div',
  attrsList: [{ name: 'id', value: 'app' }],
  attrsMap: { id: 'app' },
  children: [
    {
      type: 1,
      tag: 'h1',
      children: [
        {
          type: 2,  // è¡¨è¾¾å¼èŠ‚ç‚¹
          expression: '_s(title)',
          text: '{{ title }}'
        }
      ]
    },
    {
      type: 1,
      tag: 'p',
      children: [
        {
          type: 3,  // çº¯æ–‡æœ¬èŠ‚ç‚¹
          text: 'Static text'
        }
      ]
    }
  ]
};
```

#### 2.2 è§£æåŸç†ï¼šæ­£åˆ™åŒ¹é… + çŠ¶æ€æœº

```javascript
// Vue 2 çš„è§£æå™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
function parse(template) {
  const stack = [];
  let currentParent;
  let root;

  // è§£æå¼€å§‹æ ‡ç­¾
  const startTagMatch = template.match(/^<([a-z][^\s/>]*)/i);
  if (startTagMatch) {
    const tagName = startTagMatch[1];
    const element = {
      type: 1,
      tag: tagName,
      attrs: [],
      children: []
    };

    if (!root) {
      root = element;
    }

    if (currentParent) {
      currentParent.children.push(element);
    }

    stack.push(element);
    currentParent = element;
  }

  // è§£æå±æ€§
  const attrMatch = template.match(/\s+([a-z-:@]+)="([^"]*)"/i);
  if (attrMatch) {
    currentParent.attrs.push({
      name: attrMatch[1],
      value: attrMatch[2]
    });
  }

  // è§£ææ–‡æœ¬èŠ‚ç‚¹
  const textMatch = template.match(/^([^<]+)/);
  if (textMatch) {
    const text = textMatch[1].trim();
    if (text) {
      currentParent.children.push({
        type: 3,
        text: text
      });
    }
  }

  // è§£æç»“æŸæ ‡ç­¾
  const endTagMatch = template.match(/^<\/([a-z][^\s>]*)>/i);
  if (endTagMatch) {
    stack.pop();
    currentParent = stack[stack.length - 1];
  }

  return root;
}
```

#### 2.3 å¤„ç†æŒ‡ä»¤å’Œæ’å€¼

```javascript
// å¤„ç† v-ifã€v-forã€{{ }}ã€@click ç­‰
function parseDirectives(attrs) {
  const directives = [];

  attrs.forEach(attr => {
    if (attr.name.startsWith('v-')) {
      // v-if="condition" â†’ { name: 'if', value: 'condition' }
      directives.push({
        name: attr.name.slice(2),
        value: attr.value
      });
    } else if (attr.name.startsWith('@')) {
      // @click="handler" â†’ { name: 'on', arg: 'click', value: 'handler' }
      directives.push({
        name: 'on',
        arg: attr.name.slice(1),
        value: attr.value
      });
    } else if (attr.name.startsWith(':')) {
      // :class="dynamic" â†’ { name: 'bind', arg: 'class', value: 'dynamic' }
      directives.push({
        name: 'bind',
        arg: attr.name.slice(1),
        value: attr.value
      });
    }
  });

  return directives;
}

// å¤„ç†æ’å€¼è¡¨è¾¾å¼ {{ expression }}
function parseText(text) {
  const interpolationRegex = /\{\{((?:.|\n)+?)\}\}/g;
  const tokens = [];

  let lastIndex = 0;
  let match;

  while ((match = interpolationRegex.exec(text)) !== null) {
    // å‰é¢çš„çº¯æ–‡æœ¬
    if (match.index > lastIndex) {
      tokens.push(JSON.stringify(text.slice(lastIndex, match.index)));
    }

    // æ’å€¼è¡¨è¾¾å¼
    tokens.push(`_s(${match[1].trim()})`);

    lastIndex = match.index + match[0].length;
  }

  // å‰©ä½™çš„çº¯æ–‡æœ¬
  if (lastIndex < text.length) {
    tokens.push(JSON.stringify(text.slice(lastIndex)));
  }

  return tokens.join('+');
}
```

---

### ä¸‰ã€ä¼˜åŒ–é˜¶æ®µï¼ˆOptimizeï¼‰

#### 3.1 æ ¸å¿ƒä»»åŠ¡ï¼šæ ‡è®°é™æ€èŠ‚ç‚¹

```javascript
// Vue 2 çš„ä¼˜åŒ–å™¨
function optimize(ast) {
  // æ ‡è®°é™æ€èŠ‚ç‚¹
  markStatic(ast);
  // æ ‡è®°é™æ€æ ¹èŠ‚ç‚¹
  markStaticRoots(ast);
}

function markStatic(node) {
  node.static = isStatic(node);

  if (node.type === 1) {
    // å…ƒç´ èŠ‚ç‚¹ï¼Œéå†å­èŠ‚ç‚¹
    for (let i = 0; i < node.children.length; i++) {
      const child = node.children[i];
      markStatic(child);
      // å¦‚æœå­èŠ‚ç‚¹ä¸æ˜¯é™æ€çš„ï¼Œçˆ¶èŠ‚ç‚¹ä¹Ÿä¸æ˜¯é™æ€çš„
      if (!child.static) {
        node.static = false;
      }
    }
  }
}

function isStatic(node) {
  if (node.type === 2) {
    // è¡¨è¾¾å¼èŠ‚ç‚¹ï¼ˆå¦‚ {{ title }}ï¼‰
    return false;
  }
  if (node.type === 3) {
    // çº¯æ–‡æœ¬èŠ‚ç‚¹
    return true;
  }

  // å…ƒç´ èŠ‚ç‚¹
  return !!(
    !node.hasBindings &&           // æ²¡æœ‰åŠ¨æ€ç»‘å®šï¼ˆ:classã€@clickï¼‰
    !node.if && !node.for &&       // æ²¡æœ‰ v-ifã€v-for
    !isBuiltInTag(node.tag) &&     // ä¸æ˜¯ slotã€component
    !node.attrsMap['v-html'] &&    // æ²¡æœ‰ v-htmlã€v-text
    node.children.every(c => isStatic(c)) // æ‰€æœ‰å­èŠ‚ç‚¹éƒ½æ˜¯é™æ€çš„
  );
}

function markStaticRoots(node) {
  if (node.type === 1) {
    if (node.static && node.children.length > 0) {
      // é™æ€æ ¹èŠ‚ç‚¹ï¼šè‡ªèº«é™æ€ + æœ‰å­èŠ‚ç‚¹
      // ä½†å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡æœ¬å­èŠ‚ç‚¹ï¼Œä¼˜åŒ–æ”¶ç›Šä¸å¤§ï¼Œä¸æ ‡è®°
      if (!(node.children.length === 1 && node.children[0].type === 3)) {
        node.staticRoot = true;
        return;
      }
    }

    // é€’å½’æ ‡è®°å­èŠ‚ç‚¹
    node.children.forEach(child => markStaticRoots(child));
  }
}
```

#### 3.2 ä¼˜åŒ–çš„ä»·å€¼

```vue
<!-- æ¨¡æ¿ -->
<template>
  <div>
    <h1>Static Title</h1>          <!-- é™æ€èŠ‚ç‚¹ -->
    <p>{{ dynamicContent }}</p>    <!-- åŠ¨æ€èŠ‚ç‚¹ -->
    <footer>Static Footer</footer> <!-- é™æ€èŠ‚ç‚¹ -->
  </div>
</template>

<!-- ä¼˜åŒ–åçš„ AST -->
{
  tag: 'div',
  children: [
    { tag: 'h1', static: true, staticRoot: false },  // é™æ€ï¼Œä½†ä¸æ˜¯é™æ€æ ¹
    { tag: 'p', static: false },                     // åŠ¨æ€èŠ‚ç‚¹
    { tag: 'footer', static: true, staticRoot: false }
  ]
}
```

**è¿è¡Œæ—¶æ”¶ç›Š**ï¼š
- âœ… **è·³è¿‡é™æ€èŠ‚ç‚¹çš„ Diff**ï¼šæ›´æ–°æ—¶ç›´æ¥å¤ç”¨
- âœ… **æå‡é™æ€ VNode**ï¼šåªåˆ›å»ºä¸€æ¬¡ï¼Œåç»­æ¸²æŸ“å¤ç”¨
- âœ… **å‡å°‘å†…å­˜å ç”¨**ï¼šä¸ä¸ºé™æ€èŠ‚ç‚¹åˆ›å»ºå“åº”å¼æ•°æ®

---

### å››ã€ç”Ÿæˆé˜¶æ®µï¼ˆGenerateï¼‰

#### 4.1 æ ¸å¿ƒä»»åŠ¡ï¼šå°† AST è½¬æ¢ä¸ºæ¸²æŸ“å‡½æ•°ä»£ç 

```javascript
// Vue 2 çš„ä»£ç ç”Ÿæˆå™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
function generate(ast) {
  const code = genElement(ast);
  return {
    render: `with(this){return ${code}}`,
    staticRenderFns: []
  };
}

function genElement(el) {
  if (el.staticRoot && !el.staticProcessed) {
    // é™æ€æ ¹èŠ‚ç‚¹ï¼Œæå‡åˆ° staticRenderFns
    return genStatic(el);
  } else if (el.if && !el.ifProcessed) {
    // å¤„ç† v-if
    return genIf(el);
  } else if (el.for && !el.forProcessed) {
    // å¤„ç† v-for
    return genFor(el);
  } else {
    // æ™®é€šå…ƒç´ 
    const children = genChildren(el);
    const data = genData(el);
    return `_c('${el.tag}',${data},${children})`;
  }
}

function genData(el) {
  let data = '{';

  // å±æ€§
  if (el.attrs) {
    data += `attrs:{${el.attrs.map(a => `"${a.name}":"${a.value}"`).join(',')}},`;
  }

  // ç±»å
  if (el.staticClass) {
    data += `staticClass:"${el.staticClass}",`;
  }
  if (el.classBinding) {
    data += `class:${el.classBinding},`;
  }

  // äº‹ä»¶
  if (el.events) {
    data += `on:{${Object.keys(el.events).map(k => `"${k}":${el.events[k]}`).join(',')}},`;
  }

  data = data.replace(/,$/, '') + '}';
  return data;
}

function genChildren(el) {
  const children = el.children;
  if (children.length === 0) {
    return 'undefined';
  }

  return `[${children.map(c => genNode(c)).join(',')}]`;
}

function genNode(node) {
  if (node.type === 1) {
    // å…ƒç´ èŠ‚ç‚¹
    return genElement(node);
  } else if (node.type === 3 && node.isComment) {
    // æ³¨é‡ŠèŠ‚ç‚¹
    return `_e(${JSON.stringify(node.text)})`;
  } else {
    // æ–‡æœ¬èŠ‚ç‚¹
    return genText(node);
  }
}

function genText(node) {
  if (node.type === 2) {
    // è¡¨è¾¾å¼æ–‡æœ¬
    return node.expression;
  } else {
    // çº¯æ–‡æœ¬
    return `_v(${JSON.stringify(node.text)})`;
  }
}
```

#### 4.2 ç¼–è¯‘ç¤ºä¾‹

```vue
<!-- è¾“å…¥ï¼šæ¨¡æ¿ -->
<template>
  <div id="app" :class="dynamicClass">
    <h1>{{ title }}</h1>
    <button @click="handleClick">Click</button>
  </div>
</template>

<!-- è¾“å‡ºï¼šæ¸²æŸ“å‡½æ•° -->
<script>
export default {
  render: function() {
    with (this) {
      return _c('div', {
        attrs: { id: 'app' },
        class: dynamicClass
      }, [
        _c('h1', [_v(_s(title))]),
        _c('button', {
          on: { click: handleClick }
        }, [_v('Click')])
      ]);
    }
  }
};
</script>
```

**æ¸²æŸ“å‡½æ•°è¾…åŠ©æ–¹æ³•**ï¼š
- `_c`ï¼š`createElement`ï¼Œåˆ›å»ºå…ƒç´ èŠ‚ç‚¹
- `_v`ï¼š`createTextVNode`ï¼Œåˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹
- `_s`ï¼š`toString`ï¼Œå°†å€¼è½¬ä¸ºå­—ç¬¦ä¸²
- `_e`ï¼š`createEmptyVNode`ï¼Œåˆ›å»ºç©ºèŠ‚ç‚¹
- `_l`ï¼š`renderList`ï¼Œæ¸²æŸ“åˆ—è¡¨ï¼ˆv-forï¼‰

---

### äº”ã€Vue 3 çš„ç¼–è¯‘ä¼˜åŒ–

#### 5.1 PatchFlagï¼ˆé¶å‘æ›´æ–°ï¼‰

```javascript
// Vue 2ï¼šå…¨é‡ Diff
<div>
  <p>{{ text }}</p>
</div>

// ç¼–è¯‘å
_c('div', [
  _c('p', [_v(_s(text))])
])
// æ›´æ–°æ—¶éœ€è¦æ¯”è¾ƒæ•´ä¸ª div å’Œ p

// Vue 3ï¼šæ ‡è®°åŠ¨æ€å†…å®¹
<div>
  <p>{{ text }}</p>
</div>

// ç¼–è¯‘å
_createElementVNode('div', null, [
  _createElementVNode('p', null, text, 1 /* TEXT */)
])
// æ›´æ–°æ—¶åªæ£€æŸ¥æ ‡è®°ä¸º TEXT çš„éƒ¨åˆ†
```

**PatchFlag æšä¸¾å€¼**ï¼š

```javascript
export const enum PatchFlags {
  TEXT = 1,           // åŠ¨æ€æ–‡æœ¬å†…å®¹
  CLASS = 1 << 1,     // åŠ¨æ€ class
  STYLE = 1 << 2,     // åŠ¨æ€ style
  PROPS = 1 << 3,     // åŠ¨æ€å±æ€§ï¼ˆä¸åŒ…æ‹¬ class å’Œ styleï¼‰
  FULL_PROPS = 1 << 4, // å®Œæ•´çš„åŠ¨æ€å±æ€§ï¼ˆæœ‰ keyï¼‰
  HYDRATE_EVENTS = 1 << 5, // éœ€è¦æ³¨å†Œäº‹ä»¶
  STABLE_FRAGMENT = 1 << 6, // ç¨³å®šçš„ Fragment
  KEYED_FRAGMENT = 1 << 7,  // æœ‰ key çš„ Fragment
  UNKEYED_FRAGMENT = 1 << 8, // æ—  key çš„ Fragment
  NEED_PATCH = 1 << 9,       // éœ€è¦ patch çš„éå±æ€§
  DYNAMIC_SLOTS = 1 << 10,   // åŠ¨æ€æ’æ§½
  HOISTED = -1,              // é™æ€èŠ‚ç‚¹ï¼ˆä¸éœ€è¦æ›´æ–°ï¼‰
  BAIL = -2                  // Diff ç®—æ³•åº”è¯¥é€€å‡ºä¼˜åŒ–æ¨¡å¼
}
```

**å®é™…åº”ç”¨**ï¼š

```vue
<div>
  <p>Static</p>
  <p>{{ dynamicText }}</p>
  <p :class="dynamicClass">Text</p>
  <p :id="id" :class="cls">Multi</p>
</div>

<!-- ç¼–è¯‘å -->
<script>
const _hoisted_1 = _createElementVNode('p', null, 'Static', -1 /* HOISTED */);

return _createElementVNode('div', null, [
  _hoisted_1,
  _createElementVNode('p', null, dynamicText, 1 /* TEXT */),
  _createElementVNode('p', { class: dynamicClass }, 'Text', 2 /* CLASS */),
  _createElementVNode('p', { id: id, class: cls }, 'Multi', 10 /* CLASS | PROPS */)
]);
</script>
```

#### 5.2 é™æ€æå‡ï¼ˆHoistingï¼‰

```vue
<!-- Vue 2ï¼šæ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»º -->
<template>
  <div>
    <p>Static 1</p>
    <p>Static 2</p>
    <p>{{ dynamic }}</p>
  </div>
</template>

<script>
render() {
  return _c('div', [
    _c('p', ['Static 1']),  // æ¯æ¬¡éƒ½åˆ›å»º
    _c('p', ['Static 2']),  // æ¯æ¬¡éƒ½åˆ›å»º
    _c('p', [_v(this.dynamic)])
  ]);
}
</script>

<!-- Vue 3ï¼šé™æ€èŠ‚ç‚¹æå‡åˆ°æ¸²æŸ“å‡½æ•°å¤– -->
<script>
// åªåˆ›å»ºä¸€æ¬¡ï¼Œå¤ç”¨
const _hoisted_1 = _createElementVNode('p', null, 'Static 1', -1);
const _hoisted_2 = _createElementVNode('p', null, 'Static 2', -1);

export function render() {
  return _createElementVNode('div', null, [
    _hoisted_1,
    _hoisted_2,
    _createElementVNode('p', null, _toDisplayString(dynamic), 1 /* TEXT */)
  ]);
}
</script>
```

**é™æ€å±æ€§æå‡**ï¼š

```vue
<template>
  <div class="static-class" id="app">{{ text }}</div>
</template>

<!-- ç¼–è¯‘å -->
<script>
const _hoisted_1 = { class: 'static-class', id: 'app' };

export function render() {
  return _createElementVNode('div', _hoisted_1, _toDisplayString(text), 1 /* TEXT */);
}
</script>
```

#### 5.3 é¢„å­—ç¬¦ä¸²åŒ–ï¼ˆPre-Stringificationï¼‰

```vue
<!-- å¤§é‡è¿ç»­é™æ€èŠ‚ç‚¹ -->
<template>
  <div>
    <p>Static 1</p>
    <p>Static 2</p>
    <p>Static 3</p>
    <!-- ... 20+ ä¸ªé™æ€èŠ‚ç‚¹ -->
    <p>Static 20</p>
  </div>
</template>

<!-- Vue 3 ä¼˜åŒ–ï¼šç›´æ¥ç”Ÿæˆ HTML å­—ç¬¦ä¸² -->
<script>
const _hoisted_1 = _createStaticVNode(`
  <p>Static 1</p>
  <p>Static 2</p>
  <p>Static 3</p>
  <!-- ... -->
  <p>Static 20</p>
`, 20);

export function render() {
  return _createElementVNode('div', null, [_hoisted_1]);
}
</script>
```

**æ€§èƒ½æå‡**ï¼š
- å‡å°‘ VNode åˆ›å»ºå¼€é”€ï¼ˆä» 20 ä¸ªå‡å°‘åˆ° 1 ä¸ªï¼‰
- æ¸²æŸ“æ—¶ç›´æ¥ `innerHTML`ï¼Œæ¯”é€ä¸ªåˆ›å»ºèŠ‚ç‚¹å¿« 2-3 å€

#### 5.4 äº‹ä»¶ç¼“å­˜ï¼ˆCache Event Handlersï¼‰

```vue
<!-- Vue 2ï¼šæ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å‡½æ•° -->
<template>
  <button @click="handleClick">Click</button>
</template>

<script>
render() {
  return _c('button', {
    on: {
      click: this.handleClick  // æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯æ–°çš„å¼•ç”¨
    }
  }, ['Click']);
}
</script>

<!-- Vue 3ï¼šç¼“å­˜äº‹ä»¶å¤„ç†å™¨ -->
<script>
import { cache } from 'vue';

export function render(_ctx, _cache) {
  return _createElementVNode('button', {
    onClick: _cache[0] || (_cache[0] = (...args) => _ctx.handleClick(...args))
  }, 'Click');
}
</script>
```

**ä¼˜åŠ¿**ï¼š
- é¿å…æ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–°å‡½æ•°
- å‡å°‘å†…å­˜åˆ†é…
- é¿å…è§¦å‘å­ç»„ä»¶çš„æ— è°“æ›´æ–°ï¼ˆprops å¼•ç”¨ä¸å˜ï¼‰

#### 5.5 Block Treeï¼ˆå—æ ‘ï¼‰

```vue
<template>
  <div>
    <p>{{ text1 }}</p>
    <p>Static</p>
    <p>{{ text2 }}</p>
  </div>
</template>

<!-- Vue 3 ç¼–è¯‘å -->
<script>
export function render(_ctx) {
  return (_openBlock(), _createElementBlock('div', null, [
    _createElementVNode('p', null, _toDisplayString(_ctx.text1), 1 /* TEXT */),
    _hoisted_1,
    _createElementVNode('p', null, _toDisplayString(_ctx.text2), 1 /* TEXT */)
  ]))
}
</script>
```

**Block Tree åŸç†**ï¼š

```javascript
// åœ¨ Block å†…éƒ¨ï¼Œæ”¶é›†æ‰€æœ‰åŠ¨æ€èŠ‚ç‚¹
const block = {
  tag: 'div',
  children: [...],
  dynamicChildren: [
    { tag: 'p', patchFlag: 1 /* TEXT */ },  // text1
    { tag: 'p', patchFlag: 1 /* TEXT */ }   // text2
  ]
};

// Diff æ—¶åªéå† dynamicChildrenï¼Œè·³è¿‡é™æ€èŠ‚ç‚¹
function patchBlockChildren(oldBlock, newBlock) {
  for (let i = 0; i < newBlock.dynamicChildren.length; i++) {
    patchElement(
      oldBlock.dynamicChildren[i],
      newBlock.dynamicChildren[i]
    );
  }
}
```

**æ€§èƒ½æå‡**ï¼š
- Vue 2ï¼šéå†æ‰€æœ‰å­èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬é™æ€èŠ‚ç‚¹ï¼‰
- Vue 3ï¼šåªéå†åŠ¨æ€èŠ‚ç‚¹ï¼Œå¤æ‚åº¦ä» O(n) é™åˆ° O(m)ï¼ˆm ä¸ºåŠ¨æ€èŠ‚ç‚¹æ•°ï¼‰

---

### å…­ã€ç¼–è¯‘æ¨¡å¼å¯¹æ¯”

#### 6.1 è¿è¡Œæ—¶ vs ç¼–è¯‘æ—¶

```javascript
// è¿è¡Œæ—¶ç¼–è¯‘ï¼ˆRuntime Compilerï¼‰
new Vue({
  template: '<div>{{ msg }}</div>',
  data: { msg: 'Hello' }
});
// éœ€è¦åŒ…å«å®Œæ•´çš„ç¼–è¯‘å™¨ï¼ˆ+30kbï¼‰

// é¢„ç¼–è¯‘ï¼ˆPre-compiledï¼‰
import Component from './Component.vue';
// æ„å»ºæ—¶å·²ç¼–è¯‘å¥½ï¼Œè¿è¡Œæ—¶åªéœ€æ¸²æŸ“å‡½æ•°ï¼ˆä¸éœ€è¦ç¼–è¯‘å™¨ï¼‰
```

**ä½“ç§¯å¯¹æ¯”**ï¼š
- Vue 2 å®Œæ•´ç‰ˆï¼š32kbï¼ˆåŒ…å«ç¼–è¯‘å™¨ï¼‰
- Vue 2 è¿è¡Œæ—¶ç‰ˆï¼š22kb
- Vue 3 å®Œæ•´ç‰ˆï¼š47kb
- Vue 3 è¿è¡Œæ—¶ç‰ˆï¼š14kbï¼ˆæ”¯æŒ Tree-shakingï¼‰

#### 6.2 å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ

```javascript
// å¼€å‘ç¯å¢ƒï¼šä½¿ç”¨å®Œæ•´ç‰ˆï¼Œæ”¯æŒæ¨¡æ¿è­¦å‘Šã€æ€§èƒ½è¿½è¸ª
import Vue from 'vue/dist/vue.esm-bundler.js';

// ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨è¿è¡Œæ—¶ç‰ˆï¼Œä½“ç§¯æ›´å°
import { createApp } from 'vue';
```

---

### ä¸ƒã€å®æˆ˜ä¼˜åŒ–æŠ€å·§

#### 7.1 åˆç†ä½¿ç”¨ v-once

```vue
<!-- é™æ€å†…å®¹ï¼Œåªæ¸²æŸ“ä¸€æ¬¡ -->
<template>
  <div v-once>
    <h1>{{ staticTitle }}</h1>
    <p>This content will never change</p>
  </div>
</template>
```

#### 7.2 ä½¿ç”¨ v-memoï¼ˆVue 3.2+ï¼‰

```vue
<!-- åªæœ‰ä¾èµ–é¡¹å˜åŒ–æ—¶æ‰é‡æ–°æ¸²æŸ“ -->
<template>
  <div v-for="item in list" :key="item.id" v-memo="[item.selected]">
    <p>{{ item.name }}</p>
    <p>{{ item.description }}</p>
  </div>
</template>
```

#### 7.3 é¿å…ä¸å¿…è¦çš„å“åº”å¼

```javascript
// âŒ æ‰€æœ‰å±æ€§éƒ½æ˜¯å“åº”å¼çš„
data() {
  return {
    largeArray: new Array(10000).fill(0)
  };
}

// âœ… ä½¿ç”¨ Object.freeze è·³è¿‡å“åº”å¼
data() {
  return {
    largeArray: Object.freeze(new Array(10000).fill(0))
  };
}
```

---

### å…«ã€é¢è¯•å›ç­”å»ºè®®

**ç®€æ´ç‰ˆï¼ˆ1-2 åˆ†é’Ÿï¼‰**ï¼š
> Vue çš„æ¨¡æ¿ç¼–è¯‘åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šè§£æï¼ˆParseï¼‰å°†æ¨¡æ¿è½¬ä¸º ASTï¼Œä¼˜åŒ–ï¼ˆOptimizeï¼‰æ ‡è®°é™æ€èŠ‚ç‚¹ï¼Œç”Ÿæˆï¼ˆGenerateï¼‰è¾“å‡ºæ¸²æŸ“å‡½æ•°ã€‚
>
> Vue 3 åœ¨ç¼–è¯‘ä¼˜åŒ–ä¸Šåšäº†å¤§é‡æ”¹è¿›ï¼šé€šè¿‡ PatchFlag æ ‡è®°åŠ¨æ€å†…å®¹å®ç°é¶å‘æ›´æ–°ï¼Œé™æ€æå‡å¤ç”¨é™æ€èŠ‚ç‚¹ï¼ŒBlock Tree è·³è¿‡é™æ€å­æ ‘çš„éå†ï¼Œäº‹ä»¶ç¼“å­˜é¿å…é‡å¤åˆ›å»ºå‡½æ•°ã€‚è¿™äº›ä¼˜åŒ–è®© Vue 3 çš„è¿è¡Œæ—¶æ€§èƒ½æå‡äº† 1.3-2 å€ï¼Œæ‰“åŒ…ä½“ç§¯å‡å°‘äº† 41%ã€‚

**æ·±å…¥ç‰ˆï¼ˆ3-5 åˆ†é’Ÿï¼‰**ï¼š
åœ¨ç®€æ´ç‰ˆåŸºç¡€ä¸Šï¼Œè¡¥å……ï¼š
1. **ç¼–è¯‘æµç¨‹ç»†èŠ‚**ï¼šå±•ç¤ºæ¨¡æ¿åˆ°æ¸²æŸ“å‡½æ•°çš„å®Œæ•´è½¬æ¢è¿‡ç¨‹
2. **PatchFlag æœºåˆ¶**ï¼šè§£é‡Šå¦‚ä½•é€šè¿‡ä½è¿ç®—æ ‡è®°å¤šç§åŠ¨æ€ç±»å‹
3. **Block Tree åŸç†**ï¼šè¯´æ˜å¦‚ä½•æ”¶é›†å’Œéå†åŠ¨æ€èŠ‚ç‚¹
4. **æ€§èƒ½æ•°æ®**ï¼šVue 3 vs Vue 2 çš„å…·ä½“æ€§èƒ½å¯¹æ¯”
5. **å®é™…ä¼˜åŒ–æ¡ˆä¾‹**ï¼šv-onceã€v-memo çš„åº”ç”¨åœºæ™¯

---

### ä¹ã€æ‰©å±•çŸ¥è¯†ç‚¹

#### 9.1 æ¨¡æ¿ vs JSX vs h å‡½æ•°

```javascript
// æ¨¡æ¿ï¼ˆæ¨èï¼‰ï¼šå£°æ˜å¼ã€ç¼–è¯‘ä¼˜åŒ–
<template>
  <div>{{ msg }}</div>
</template>

// JSXï¼ˆçµæ´»ï¼‰ï¼šç¼–ç¨‹å¼ã€æ²¡æœ‰ç¼–è¯‘ä¼˜åŒ–
render() {
  return <div>{this.msg}</div>;
}

// h å‡½æ•°ï¼ˆåº•å±‚ï¼‰ï¼šæ‰‹åŠ¨ä¼˜åŒ–
render() {
  return h('div', null, this.msg);
}
```

#### 9.2 ä¸ºä»€ä¹ˆ Vue 3 ç¼–è¯‘ä¼˜åŒ–æ¯” React æ›´æ¿€è¿›ï¼Ÿ

- **Vue**ï¼šæ¨¡æ¿è¯­æ³•å—é™ï¼Œç¼–è¯‘å™¨å¯ä»¥åšé™æ€åˆ†æ
- **React**ï¼šJSX çµæ´»åº¦é«˜ï¼Œéš¾ä»¥é™æ€åˆ†æï¼ˆå¦‚åŠ¨æ€ç»„ä»¶ã€æ¡ä»¶æ¸²æŸ“ï¼‰

#### 9.3 SSR ç¼–è¯‘ä¼˜åŒ–

```javascript
// Vue 3 SSR ç¼–è¯‘
<template>
  <div>
    <p>Static</p>
    <p>{{ dynamic }}</p>
  </div>
</template>

// ç¼–è¯‘ä¸ºå­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆæ¯” VNode æ›´å¿«ï¼‰
export function ssrRender(_ctx, _push) {
  _push(`<div><p>Static</p><p>${_ssrInterpolate(_ctx.dynamic)}</p></div>`);
}
```
