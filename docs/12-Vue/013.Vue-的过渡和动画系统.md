---
title: Vue 的过渡和动画系统
tags:
  - 前端Vue
status: robot
class: 前端Vue
slug: vue-transition-animation-system
ref:
---

## 核心要点

**Vue 的过渡系统通过 `<Transition>` 和 `<TransitionGroup>` 组件，在元素插入/删除/更新时自动添加/移除 CSS 类名，实现声明式动画。核心机制：6 个过渡类名（v-enter-from/active/to, v-leave-from/active/to）、JavaScript 钩子、多元素过渡模式（in-out/out-in）、列表过渡的 FLIP 动画技术。支持 CSS Transition/Animation、JS 动画库集成。**

---

## 详细回答

### 一、Transition 组件基础

#### 1. 基本概念

`<Transition>` 是 Vue 的内置组件，用于为**单个元素或组件**的进入/离开添加过渡效果。

**核心特点：**
- 仅对**单个**元素/组件生效（包括 v-if、v-show、动态组件）
- 自动检测 CSS transition/animation
- 提供 JavaScript 钩子函数
- 支持过渡模式（mode）控制时序

#### 2. 触发过渡的场景

过渡效果会在以下情况下触发：

```vue
<template>
  <!-- 1. v-if 条件渲染 -->
  <Transition>
    <p v-if="show">Hello</p>
  </Transition>

  <!-- 2. v-show 显示/隐藏 -->
  <Transition>
    <p v-show="visible">World</p>
  </Transition>

  <!-- 3. 动态组件切换 -->
  <Transition>
    <component :is="currentComponent" />
  </Transition>

  <!-- 4. 特殊元素 <transition> 包裹的根元素变化 -->
  <Transition>
    <div :key="someKey">Content</div>
  </Transition>
</template>
```

### 二、CSS 过渡类名机制

#### 1. 六个过渡类名

Vue 在过渡过程中会自动添加/移除以下 6 个 CSS 类名：

##### 进入过渡（Enter）

```
v-enter-from  →  v-enter-active  →  v-enter-to
```

| 类名 | 生效时机 | 作用 | 示例 |
|------|---------|------|------|
| **v-enter-from** | 进入前一帧 | 定义进入的起始状态 | `opacity: 0; transform: translateX(-100px)` |
| **v-enter-active** | 整个进入过程 | 定义过渡效果（duration、easing） | `transition: all 0.3s ease` |
| **v-enter-to** | 进入完成后 | 定义进入的结束状态 | `opacity: 1; transform: translateX(0)` |

##### 离开过渡（Leave）

```
v-leave-from  →  v-leave-active  →  v-leave-to
```

| 类名 | 生效时机 | 作用 | 示例 |
|------|---------|------|------|
| **v-leave-from** | 离开前一帧 | 定义离开的起始状态 | `opacity: 1` |
| **v-leave-active** | 整个离开过程 | 定义过渡效果 | `transition: all 0.3s ease` |
| **v-leave-to** | 离开完成后 | 定义离开的结束状态 | `opacity: 0; transform: translateX(100px)` |

#### 2. 完整示例：淡入淡出

```vue
<template>
  <button @click="show = !show">Toggle</button>

  <Transition name="fade">
    <p v-if="show">Hello Vue!</p>
  </Transition>
</template>

<script setup>
import { ref } from 'vue'
const show = ref(true)
</script>

<style scoped>
/* 进入过渡 */
.fade-enter-from {
  opacity: 0;
}

.fade-enter-active {
  transition: opacity 0.3s ease;
}

.fade-enter-to {
  opacity: 1;
}

/* 离开过渡 */
.fade-leave-from {
  opacity: 1;
}

.fade-leave-active {
  transition: opacity 0.3s ease;
}

.fade-leave-to {
  opacity: 0;
}
</style>
```

**简化写法**（通常 from 和 to 可以合并）：

```css
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.3s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}
```

#### 3. 自定义过渡类名

可以通过 props 自定义类名，适合与第三方 CSS 动画库（如 Animate.css）集成：

```vue
<Transition
  enter-active-class="animate__animated animate__fadeInLeft"
  leave-active-class="animate__animated animate__fadeOutRight"
>
  <p v-if="show">Hello</p>
</Transition>
```

### 三、CSS Animation 动画

除了 Transition，还可以使用 CSS `@keyframes` 定义更复杂的动画：

```vue
<template>
  <Transition name="bounce">
    <p v-if="show">Bouncing!</p>
  </Transition>
</template>

<style scoped>
.bounce-enter-active {
  animation: bounce-in 0.5s;
}

.bounce-leave-active {
  animation: bounce-in 0.5s reverse;
}

@keyframes bounce-in {
  0% {
    transform: scale(0);
  }
  50% {
    transform: scale(1.2);
  }
  100% {
    transform: scale(1);
  }
}
</style>
```

### 四、JavaScript 钩子函数

对于复杂动画（如 GSAP、Three.js），可以使用 JavaScript 钩子：

#### 1. 钩子列表

```vue
<Transition
  @before-enter="onBeforeEnter"
  @enter="onEnter"
  @after-enter="onAfterEnter"
  @enter-cancelled="onEnterCancelled"
  @before-leave="onBeforeLeave"
  @leave="onLeave"
  @after-leave="onAfterLeave"
  @leave-cancelled="onLeaveCancelled"
  :css="false"
>
  <div v-if="show">Content</div>
</Transition>

<script setup>
// 进入前
function onBeforeEnter(el) {
  el.style.opacity = 0
  el.style.transform = 'translateX(-100px)'
}

// 进入中（必须调用 done 回调）
function onEnter(el, done) {
  // 使用 GSAP 动画库
  gsap.to(el, {
    opacity: 1,
    x: 0,
    duration: 0.5,
    onComplete: done  // 动画完成后调用 done
  })
}

// 进入后
function onAfterEnter(el) {
  console.log('Enter animation completed')
}

// 进入取消（当进入动画还在进行时，元素被移除）
function onEnterCancelled(el) {
  console.log('Enter cancelled')
}

// 离开前
function onBeforeLeave(el) {
  console.log('Before leave')
}

// 离开中
function onLeave(el, done) {
  gsap.to(el, {
    opacity: 0,
    x: 100,
    duration: 0.5,
    onComplete: done
  })
}

// 离开后
function onAfterLeave(el) {
  console.log('Leave completed')
}

// 离开取消（仅用于 v-show）
function onLeaveCancelled(el) {
  console.log('Leave cancelled')
}
</script>
```

**重要提示：**
- 使用 JavaScript 钩子时，建议添加 `:css="false"` 跳过 CSS 检测，提升性能
- `onEnter` 和 `onLeave` **必须调用 `done` 回调**，否则过渡会立即完成

#### 2. 实战示例：GSAP 动画

```vue
<template>
  <button @click="show = !show">Toggle</button>

  <Transition
    @before-enter="beforeEnter"
    @enter="enter"
    @leave="leave"
    :css="false"
  >
    <div v-if="show" class="box">Animated Box</div>
  </Transition>
</template>

<script setup>
import { ref } from 'vue'
import gsap from 'gsap'

const show = ref(false)

function beforeEnter(el) {
  gsap.set(el, {
    scaleX: 0.25,
    scaleY: 0.25,
    opacity: 0
  })
}

function enter(el, done) {
  gsap.to(el, {
    duration: 0.5,
    scaleX: 1,
    scaleY: 1,
    opacity: 1,
    ease: 'elastic.out(1, 0.5)',
    onComplete: done
  })
}

function leave(el, done) {
  gsap.to(el, {
    duration: 0.3,
    scaleX: 0,
    scaleY: 0,
    opacity: 0,
    ease: 'power2.in',
    onComplete: done
  })
}
</script>

<style scoped>
.box {
  width: 200px;
  height: 200px;
  background: #42b883;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
}
</style>
```

### 五、过渡模式（Transition Mode）

当在多个元素之间切换时，可以控制进入和离开的时序：

#### 1. 模式类型

| 模式 | 说明 | 适用场景 |
|------|------|---------|
| **默认** | 同时进行进入和离开 | 绝对定位元素 |
| **in-out** | 新元素先进入，完成后旧元素离开 | 宽度固定的元素切换 |
| **out-in** | 旧元素先离开，完成后新元素进入 | 内容替换（最常用） |

#### 2. 示例：按钮文本切换

```vue
<template>
  <Transition name="fade" mode="out-in">
    <button v-if="isEditing" key="save" @click="isEditing = false">
      Save
    </button>
    <button v-else key="edit" @click="isEditing = true">
      Edit
    </button>
  </Transition>
</template>

<script setup>
import { ref } from 'vue'
const isEditing = ref(false)
</script>

<style scoped>
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.2s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}
</style>
```

**注意**：切换的元素必须有不同的 `key`，否则 Vue 会复用元素，不会触发过渡。

### 六、列表过渡（TransitionGroup）

`<TransitionGroup>` 用于为**列表中的多个元素**添加过渡效果。

#### 1. 基础用法

```vue
<template>
  <button @click="addItem">Add</button>
  <button @click="removeItem">Remove</button>

  <TransitionGroup name="list" tag="ul">
    <li v-for="item in items" :key="item.id">
      {{ item.text }}
    </li>
  </TransitionGroup>
</template>

<script setup>
import { ref } from 'vue'

const items = ref([
  { id: 1, text: 'Item 1' },
  { id: 2, text: 'Item 2' },
  { id: 3, text: 'Item 3' }
])

let nextId = 4

function addItem() {
  items.value.push({
    id: nextId++,
    text: `Item ${nextId - 1}`
  })
}

function removeItem() {
  items.value.pop()
}
</script>

<style scoped>
/* 进入/离开动画 */
.list-enter-active,
.list-leave-active {
  transition: all 0.5s ease;
}

.list-enter-from {
  opacity: 0;
  transform: translateX(30px);
}

.list-leave-to {
  opacity: 0;
  transform: translateX(-30px);
}

/* 移动动画（FLIP） */
.list-move {
  transition: transform 0.5s ease;
}
</style>
```

#### 2. FLIP 动画技术

**FLIP** = First, Last, Invert, Play，是一种高性能的动画技术：

1. **First**：记录元素的初始位置
2. **Last**：记录元素的最终位置
3. **Invert**：计算差异并反向应用（让元素看起来还在初始位置）
4. **Play**：移除反向变换，让浏览器执行过渡

Vue 的 `TransitionGroup` 自动实现了 FLIP 动画，只需要定义 `.list-move` 类：

```css
.list-move {
  transition: transform 0.5s ease;
}
```

#### 3. 实战示例：拖拽排序列表

```vue
<template>
  <TransitionGroup name="flip-list" tag="ul">
    <li
      v-for="item in items"
      :key="item.id"
      draggable="true"
      @dragstart="dragStart($event, item)"
      @dragover.prevent
      @drop="drop($event, item)"
    >
      {{ item.text }}
    </li>
  </TransitionGroup>
</template>

<script setup>
import { ref } from 'vue'

const items = ref([
  { id: 1, text: '苹果' },
  { id: 2, text: '香蕉' },
  { id: 3, text: '橙子' },
  { id: 4, text: '葡萄' }
])

let draggedItem = null

function dragStart(e, item) {
  draggedItem = item
}

function drop(e, targetItem) {
  if (!draggedItem) return

  const draggedIndex = items.value.indexOf(draggedItem)
  const targetIndex = items.value.indexOf(targetItem)

  // 交换位置
  items.value.splice(draggedIndex, 1)
  items.value.splice(targetIndex, 0, draggedItem)

  draggedItem = null
}
</script>

<style scoped>
ul {
  list-style: none;
  padding: 0;
}

li {
  padding: 10px;
  margin: 5px 0;
  background: #f0f0f0;
  cursor: move;
}

/* FLIP 动画 */
.flip-list-move {
  transition: transform 0.5s ease;
}

/* 进入/离开动画 */
.flip-list-enter-active,
.flip-list-leave-active {
  transition: all 0.3s ease;
}

.flip-list-enter-from {
  opacity: 0;
  transform: translateY(-30px);
}

.flip-list-leave-to {
  opacity: 0;
  transform: translateY(30px);
}

/* 解决离开元素占位问题 */
.flip-list-leave-active {
  position: absolute;
}
</style>
```

**关键技巧**：
- 添加 `.list-leave-active { position: absolute; }` 让离开的元素脱离文档流，避免影响其他元素的动画

#### 4. 交错过渡（Staggered Transitions）

为列表项添加延迟，实现依次进入的效果：

```vue
<template>
  <TransitionGroup
    name="stagger"
    tag="ul"
    @before-enter="onBeforeEnter"
    @enter="onEnter"
    :css="false"
  >
    <li v-for="(item, index) in items" :key="item.id" :data-index="index">
      {{ item.text }}
    </li>
  </TransitionGroup>
</template>

<script setup>
import { ref } from 'vue'
import gsap from 'gsap'

const items = ref([
  { id: 1, text: 'Item 1' },
  { id: 2, text: 'Item 2' },
  { id: 3, text: 'Item 3' },
  { id: 4, text: 'Item 4' }
])

function onBeforeEnter(el) {
  el.style.opacity = 0
  el.style.transform = 'translateY(-30px)'
}

function onEnter(el, done) {
  gsap.to(el, {
    opacity: 1,
    y: 0,
    duration: 0.5,
    delay: el.dataset.index * 0.1,  // 根据索引延迟
    onComplete: done
  })
}
</script>
```

### 七、高级技巧与最佳实践

#### 1. 过渡与 v-show 的配合

`v-show` 不会移除元素，只是切换 `display` 属性，因此：
- **支持**进入/离开过渡
- **不支持** `out-in`/`in-out` 模式（因为元素始终存在）

```vue
<Transition name="fade">
  <div v-show="visible">Content</div>
</Transition>
```

#### 2. 初次渲染的过渡

默认情况下，首次挂载不会触发过渡。如需初次渲染动画，使用 `appear` 属性：

```vue
<Transition name="fade" appear>
  <div>This will animate on initial render</div>
</Transition>
```

自定义首次渲染类名：

```vue
<Transition
  appear
  appear-active-class="custom-appear-active"
  appear-to-class="custom-appear-to"
>
  <div>Content</div>
</Transition>
```

#### 3. 过渡持续时间

Vue 会自动检测 `transitionend` 或 `animationend` 事件。如果需要显式指定持续时间：

```vue
<!-- 单位：毫秒 -->
<Transition :duration="500">
  <div v-if="show">Content</div>
</Transition>

<!-- 分别指定进入和离开时间 -->
<Transition :duration="{ enter: 500, leave: 800 }">
  <div v-if="show">Content</div>
</Transition>
```

#### 4. 性能优化

##### 使用 CSS Transform 而非 Left/Top

```css
/* ❌ 性能差（触发布局和重绘） */
.slide-enter-active {
  transition: left 0.3s;
}

/* ✅ 性能好（仅触发合成） */
.slide-enter-active {
  transition: transform 0.3s;
}
```

##### 使用 will-change 提示浏览器

```css
.fade-enter-active,
.fade-leave-active {
  will-change: opacity, transform;
  transition: all 0.3s ease;
}
```

##### 限制过渡元素数量

对于大型列表，考虑虚拟滚动 + 过渡：

```vue
<TransitionGroup name="list" tag="div">
  <div v-for="item in visibleItems" :key="item.id">
    {{ item.text }}
  </div>
</TransitionGroup>
```

#### 5. 可复用的过渡组件

封装通用过渡组件：

```vue
<!-- FadeTransition.vue -->
<template>
  <Transition name="fade" mode="out-in" v-bind="$attrs">
    <slot />
  </Transition>
</template>

<style scoped>
.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.3s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}
</style>
```

使用：

```vue
<FadeTransition>
  <div v-if="show">Content</div>
</FadeTransition>
```

### 八、常见问题与解决方案

#### 1. 过渡不生效

**原因**：
- 没有 `key` 属性（多元素切换时）
- 过渡元素不是单个根元素
- CSS 类名拼写错误
- `transition` 属性冲突

**解决**：
```vue
<!-- ✅ 添加 key -->
<Transition name="fade">
  <div v-if="show" key="a">A</div>
  <div v-else key="b">B</div>
</Transition>
```

#### 2. 列表过渡卡顿

**原因**：大量元素同时过渡

**解决**：
- 使用虚拟滚动
- 限制可见元素数量
- 使用 `requestAnimationFrame` 分批处理

#### 3. 过渡与路由切换冲突

**问题**：路由切换时过渡不流畅

**解决**：在路由组件外包裹 `<Transition>`：

```vue
<!-- App.vue -->
<template>
  <router-view v-slot="{ Component }">
    <Transition name="fade" mode="out-in">
      <component :is="Component" />
    </Transition>
  </router-view>
</template>
```

### 九、面试总结

**核心要点：**

1. **Transition 组件**：
   - 为单个元素的进入/离开添加过渡
   - 6 个 CSS 类名：enter-from/active/to, leave-from/active/to
   - 支持 JavaScript 钩子（配合 GSAP 等库）
   - 过渡模式：out-in（最常用）、in-out

2. **TransitionGroup 组件**：
   - 为列表的多个元素添加过渡
   - 自动使用 FLIP 技术优化性能
   - 需要定义 `.list-move` 类实现移动动画
   - 交错过渡：通过 JS 钩子 + data-index 实现

3. **性能优化**：
   - 使用 `transform` 和 `opacity`（GPU 加速）
   - 添加 `will-change` 提示浏览器
   - 避免同时过渡大量元素
   - `:css="false"` 跳过 CSS 检测（JS 动画）

4. **实际应用**：
   - 路由切换动画
   - 模态框/抽屉进出
   - 列表增删改动画
   - 拖拽排序反馈

**高级话题**：
- FLIP 动画原理与手动实现
- CSS Houdini 与自定义动画
- Web Animations API 集成
- 复杂场景的动画编排（Timeline）
