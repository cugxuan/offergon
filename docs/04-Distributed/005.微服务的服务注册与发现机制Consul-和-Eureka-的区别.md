---
title: 微服务的服务注册与发现机制，Consul 和 Eureka 的区别
tags:
  - 分布式系统
status: robot
class: 分布式系统
slug: service-registry-discovery-consul-vs-eureka
ref:
---

**要点提炼:**
- 服务注册与发现解决微服务动态寻址问题
- Consul 基于 Raft,提供 CP 保证和健康检查
- Eureka 基于 AP,高可用但牺牲强一致性

## 服务注册与发现

### 核心概念

**服务注册**: 服务启动时向注册中心注册自己的地址、端口等信息

**服务发现**: 客户端从注册中心查询服务地址,实现动态调用

### 为什么需要

- 微服务数量多,IP 端口动态变化
- 实例扩缩容频繁
- 容器化部署,IP 不固定
- 负载均衡需要知道所有可用实例

### 工作流程

1. 服务提供者启动时注册到注册中心
2. 服务消费者从注册中心获取服务列表
3. 消费者通过负载均衡算法选择实例调用
4. 注册中心通过心跳检测服务健康状态
5. 服务下线或故障时从注册中心移除

## Consul

### 核心特性

- **一致性协议**: 基于 Raft,提供 CP 保证
- **健康检查**: 支持 TCP、HTTP、gRPC、Docker 等多种检查方式
- **KV 存储**: 内置键值存储,可用于配置中心
- **多数据中心**: 原生支持跨数据中心部署
- **Service Mesh**: 内置 Connect 功能,支持服务网格

### 健康检查机制

```go
// 注册服务时配置健康检查
registration := &api.AgentServiceRegistration{
    Name: "my-service",
    Port: 8080,
    Check: &api.AgentServiceCheck{
        HTTP:     "http://localhost:8080/health",
        Interval: "10s",      // 每 10 秒检查一次
        Timeout:  "3s",       // 超时时间
    },
}
```

### 优点
- 强一致性保证
- 功能丰富(DNS、健康检查、KV 存储)
- 跨数据中心支持

### 缺点
- 性能相对较低
- 网络分区时部分节点不可用(CP)

## Eureka

### 核心特性

- **一致性协议**: 基于 AP,牺牲一致性保证高可用
- **自我保护机制**: 网络故障时不剔除服务
- **客户端缓存**: 客户端本地缓存服务列表
- **Region/Zone**: 支持多区域部署

### 自我保护机制

当 Eureka Server 在短时间内丢失大量心跳(>15%):
- 认为是网络分区,进入自我保护模式
- 不再剔除任何服务实例
- 保证可用性,但可能返回已故障的实例

### 优点
- 高可用,网络分区时仍可查询
- 客户端缓存,降低注册中心压力
- 适合大规模集群

### 缺点
- 弱一致性,可能返回已下线的实例
- 功能相对单一
- Netflix 已停止维护(2.x)

## Consul vs Eureka 对比

| 特性 | Consul | Eureka |
|------|--------|--------|
| CAP | CP(一致性优先) | AP(可用性优先) |
| 一致性协议 | Raft | 无,基于复制 |
| 健康检查 | Server 主动检查 | Client 心跳 |
| 多数据中心 | 原生支持 | 不支持 |
| KV 存储 | 内置 | 无 |
| 服务网格 | 支持(Connect) | 不支持 |
| 负载均衡 | 需客户端实现 | Ribbon 集成 |
| 维护状态 | 活跃 | 停止维护 |
| 适用场景 | 强一致性要求 | 大规模高可用 |

## 其他注册中心

### Nacos

阿里开源,功能最全面:
- 支持 CP 和 AP 模式切换
- 内置配置中心
- 支持多种注册模型
- 提供控制台

### etcd

- 基于 Raft,强一致性
- Kubernetes 默认选择
- 高性能,适合大规模集群
- 功能简单,需自己实现健康检查

### Zookeeper

- 基于 ZAB 协议,CP 保证
- 功能强大但复杂
- Java 生态常用
- 性能一般

## 选型建议

1. **强一致性需求** → Consul/etcd
2. **高可用优先** → Eureka/Nacos(AP 模式)
3. **配置中心需求** → Nacos/Consul
4. **Kubernetes 环境** → etcd
5. **Spring Cloud** → Nacos(推荐)/Consul
6. **功能全面** → Nacos

## 实现建议

### 客户端缓存

即使注册中心故障,客户端仍可使用缓存调用服务:

```go
type ServiceDiscovery struct {
    consul *api.Client
    cache  map[string][]string  // 服务缓存
}

func (sd *ServiceDiscovery) GetService(name string) []string {
    // 先查注册中心
    services, err := sd.consul.Health().Service(name, "", true, nil)
    if err == nil {
        sd.cache[name] = extractAddresses(services)
        return sd.cache[name]
    }
    // 降级使用缓存
    return sd.cache[name]
}
```

### 健康检查

定期向注册中心发送心跳:

```go
func (s *Service) StartHeartbeat() {
    ticker := time.NewTicker(10 * time.Second)
    go func() {
        for range ticker.C {
            s.consul.Agent().UpdateTTL("service:"+s.ID, "", "pass")
        }
    }()
}
```
