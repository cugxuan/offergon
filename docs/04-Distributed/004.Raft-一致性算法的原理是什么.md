---
title: Raft 一致性算法的原理是什么?Leader 选举和日志复制如何实现?
tags:
  - 分布式系统
  - 一致性算法
status: robot
class: 分布式系统
slug: raft-leader-election-log-replication
ref:
---

**要点提炼:**
- Raft 是易理解的分布式一致性算法,保证多节点数据一致性
- 核心机制:Leader 选举、日志复制、安全性保证
- 任期(Term)和心跳机制保证 Leader 唯一性

## Raft 算法概述

Raft 是一种用于管理复制日志的一致性算法,相比 Paxos 更易理解和实现。

**核心特性:**
- 强一致性保证
- Leader-based 架构
- 分解为三个子问题:Leader 选举、日志复制、安全性

**三种节点状态:**
1. **Leader(领导者)**: 处理所有客户端请求,复制日志到 Follower
2. **Follower(跟随者)**: 被动接收 Leader 的请求
3. **Candidate(候选者)**: 选举过程中的临时状态

## Leader 选举

### 选举触发条件

- 集群启动时没有 Leader
- Follower 在选举超时时间内未收到 Leader 心跳

### 选举流程

1. **Follower 超时**:
   - Follower 等待随机时间(150-300ms)后超时
   - 转变为 Candidate,开启新任期(Term++)

2. **Candidate 请求投票**:
   - 给自己投票
   - 并行向所有节点发送 RequestVote RPC
   - 包含自己的任期号和日志信息

3. **节点投票规则**:
   - 每个任期每个节点只能投一票
   - 候选者日志至少和自己一样新才投票
   - 先到先得原则

4. **三种可能结果**:
   - **赢得选举**: 获得半数以上投票,成为 Leader
   - **其他节点成为 Leader**: 收到新 Leader 心跳,转为 Follower
   - **选举超时**: 没有节点获得多数票,开启新一轮选举

### 选举关键机制

**任期(Term):**
- 全局递增的逻辑时钟
- 每次选举开启新任期
- 节点通信时交换任期号,小任期的节点自动转为 Follower

**随机超时:**
- 避免多个节点同时发起选举
- 150-300ms 随机时间,先超时的更可能当选

## 日志复制

### 日志结构

每条日志包含:
- **Index**: 日志索引(位置)
- **Term**: 创建该日志的任期号
- **Command**: 状态机命令

### 复制流程

1. **客户端请求**:
   - 客户端向 Leader 发送命令
   - Leader 追加日志到本地日志

2. **Leader 复制**:
   - 并行向所有 Follower 发送 AppendEntries RPC
   - 包含日志条目和前一条日志的 Index、Term(用于一致性检查)

3. **Follower 响应**:
   - 检查前一条日志是否匹配
   - 匹配则追加日志,返回成功
   - 不匹配则拒绝,返回失败

4. **Leader 提交**:
   - 半数以上 Follower 复制成功
   - Leader 提交日志(应用到状态机)
   - 下次心跳通知 Follower 提交

5. **失败重试**:
   - Follower 拒绝时,Leader 递减 nextIndex 重试
   - 直到找到匹配点,然后覆盖后续日志

### 日志一致性保证

**日志匹配特性:**
- 如果不同节点的两个日志条目有相同的 Index 和 Term:
  - 它们存储相同的命令
  - 它们之前的所有日志条目都相同

**一致性检查:**
- AppendEntries RPC 携带前一条日志的 Index 和 Term
- Follower 检查是否匹配,不匹配则拒绝

## 安全性保证

### 选举限制

**日志新旧比较:**
1. 比较最后一条日志的 Term,Term 大的更新
2. Term 相同则比较 Index,Index 大的更新

**投票限制:**
- 只投票给日志至少和自己一样新的候选者
- 保证新 Leader 包含所有已提交的日志

### 提交限制

**只提交当前任期的日志:**
- Leader 不能直接提交之前任期的日志
- 通过提交当前任期日志,间接提交之前的日志
- 避免已提交日志被覆盖

## 性能优化

### 批量处理
- 批量发送日志条目,减少 RPC 次数

### Pipeline
- 不等待前一批响应,连续发送多批日志

### 快照(Snapshot)
- 日志过多时压缩为快照
- 新节点直接安装快照,无需重放所有日志

## Raft vs Paxos

| 特性 | Raft | Paxos |
|------|------|-------|
| 易理解性 | 易理解,分解清晰 | 难理解,数学证明 |
| Leader | 强 Leader,简化设计 | 无强 Leader |
| 日志顺序 | 严格有序 | 无序,需额外保证 |
| 工程实现 | 容易,文档完善 | 困难,变体众多 |

## 实际应用

- **etcd**: Kubernetes 服务发现和配置
- **Consul**: 服务网格和配置中心
- **TiKV**: TiDB 的存储层
- **CockroachDB**: 分布式数据库

## 常见问题

**Q: 网络分区时会怎样?**
A: 少数派分区无法选出 Leader(票数不过半),多数派分区正常运行,保证一致性但牺牲可用性(CP)。

**Q: 脑裂问题如何解决?**
A: 过半投票机制保证最多只有一个分区能选出 Leader,不会出现脑裂。

**Q: Leader 宕机恢复后会怎样?**
A: 旧 Leader 发现自己任期过期,自动转为 Follower,接受新 Leader 的日志。
