---
title: Redis 的持久化机制有哪些?RDB 和 AOF 的区别是什么?
tags:
  - 缓存
  - 缓存
  - 持久化
status: robot
class: 缓存
slug: redis-rdb-aof-persistence-difference
ref:
---

## 核心要点

Redis 提供两种持久化机制:RDB(快照)和 AOF(追加文件)。RDB 适合大规模数据恢复且性能高,AOF 数据安全性更好但文件更大。Redis 4.0+ 支持混合持久化,结合两者优点。

## 详细回答

### 1. RDB (Redis Database Backup)

**工作原理**:
- 在指定时间间隔内,将内存中的数据集快照写入磁盘
- 默认文件名 `dump.rdb`
- 采用 fork 子进程,父进程继续处理请求,子进程负责写磁盘

**触发方式**:
- 手动触发: `SAVE` (阻塞) 或 `BGSAVE` (后台)
- 自动触发: 配置 `save m n` (m 秒内至少 n 次修改)
- 主从复制、shutdown、flushall 也会触发

**优点**:
- 文件紧凑,适合备份和容灾恢复
- 恢复速度快,直接加载到内存
- 性能好,父进程不做 I/O 操作

**缺点**:
- 数据安全性较低,可能丢失最后一次快照之后的数据
- fork 子进程时可能阻塞服务器(数据集较大时)
- 不适合实时持久化场景

### 2. AOF (Append Only File)

**工作原理**:
- 记录每一个写操作命令,以日志形式追加到文件
- 默认文件名 `appendonly.aof`
- Redis 重启时重新执行 AOF 文件中的命令恢复数据

**同步策略**:
- `always`: 每个写命令都同步,最安全但最慢
- `everysec`: 每秒同步一次,折中方案(默认)
- `no`: 由操作系统决定何时同步,最快但最不安全

**AOF 重写**:
- 当 AOF 文件过大时,Redis 会自动重写(bgrewriteaof)
- 根据内存中当前数据生成最小命令集
- 配置参数: `auto-aof-rewrite-percentage` 和 `auto-aof-rewrite-min-size`

**优点**:
- 数据安全性高,最多丢失 1 秒数据(everysec 模式)
- AOF 文件可读,可手动修复
- 可通过 `redis-check-aof` 工具修复损坏文件

**缺点**:
- 文件通常比 RDB 大
- 恢复速度比 RDB 慢
- 某些命令在 AOF 重写时可能有性能问题

### 3. 混合持久化 (Redis 4.0+)

**工作原理**:
- AOF 重写时,将当前内存数据以 RDB 格式写入 AOF 文件开头
- 后续增量命令仍以 AOF 格式追加
- 配置: `aof-use-rdb-preamble yes`

**优点**:
- 结合 RDB 的快速恢复和 AOF 的数据安全性
- 减小 AOF 文件体积
- 恢复速度快于纯 AOF

### 对比总结

| 特性 | RDB | AOF |
|------|-----|-----|
| 文件大小 | 小 | 大 |
| 数据安全性 | 低(可能丢几分钟) | 高(最多丢 1 秒) |
| 恢复速度 | 快 | 慢 |
| 性能影响 | fork 时可能阻塞 | 写入频繁有一定影响 |
| 文件可读性 | 二进制,不可读 | 文本,可读可修改 |

### 选择建议

1. **只做缓存**: 可以不使用持久化
2. **数据不能丢失**: 使用 AOF (everysec)
3. **可接受几分钟数据丢失**: 使用 RDB
4. **最佳实践**: RDB + AOF 混合持久化
