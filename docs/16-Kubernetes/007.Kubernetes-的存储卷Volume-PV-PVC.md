---
title: Kubernetes 的存储卷（Volume、PV、PVC）
tags:
  - Kubernetes
status: robot
class: Kubernetes
slug: kubernetes-volume-pv-pvc
ref:
---

## 核心要点

**K8s 存储体系分三层:Volume(容器卷)、PV(持久卷,集群级存储资源)、PVC(持久卷声明,用户存储请求)。通过 PV-PVC 机制实现存储的供给与消费解耦,支持动态供给(StorageClass)和多种后端(NFS、Ceph、云盘等)。**

---

## 详细回答

### 一、为什么需要存储卷?

容器本身是无状态的,数据存储在容器的可写层中,容器删除后数据会丢失。对于数据库、日志、配置文件等需要持久化的场景,必须使用存储卷。

**Kubernetes 存储解决的问题**:

1. **数据持久化**:Pod 重启或迁移后数据不丢失
2. **数据共享**:多个容器或 Pod 共享同一份数据
3. **存储抽象**:屏蔽底层存储差异,统一管理
4. **动态供给**:按需自动创建存储资源

### 二、Volume(容器卷)

Volume 是 Pod 中所有容器可访问的共享目录,生命周期与 Pod 绑定(Pod 删除则 Volume 删除)。

#### 常见 Volume 类型

##### 1. emptyDir(临时存储)

Pod 创建时生成的空目录,Pod 删除时数据消失,适合临时数据交换。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-emptydir
spec:
  containers:
  - name: nginx
    image: nginx
    volumeMounts:
    - name: cache
      mountPath: /cache
  - name: busybox
    image: busybox
    command: ["sh", "-c", "while true; do echo $(date) >> /cache/log.txt; sleep 5; done"]
    volumeMounts:
    - name: cache
      mountPath: /cache
  volumes:
  - name: cache
    emptyDir: {}  # 默认存储在节点磁盘
    # emptyDir:
    #   medium: Memory  # 存储在内存(tmpfs),速度快但容量有限
```

**使用场景**:缓存、临时文件、容器间数据交换。

##### 2. hostPath(挂载宿主机目录)

将宿主机的文件或目录挂载到 Pod 中,数据持久化在节点上。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-hostpath
spec:
  containers:
  - name: nginx
    image: nginx
    volumeMounts:
    - name: logs
      mountPath: /var/log/nginx
  volumes:
  - name: logs
    hostPath:
      path: /data/nginx-logs  # 宿主机路径
      type: DirectoryOrCreate  # 不存在则创建
```

**type 类型**:

- `Directory`:必须存在的目录
- `DirectoryOrCreate`:不存在则自动创建
- `File`:必须存在的文件
- `FileOrCreate`:不存在则创建文件

**注意事项**:

- Pod 重新调度到其他节点后无法访问原节点数据
- 安全风险:容器可访问宿主机文件系统
- 适合 DaemonSet(如日志采集)或单节点开发环境

##### 3. configMap 和 secret(配置注入)

将 ConfigMap 或 Secret 挂载为文件或环境变量。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-configmap
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: config
      mountPath: /etc/config
      readOnly: true
  volumes:
  - name: config
    configMap:
      name: app-config
      items:  # 可选:只挂载特定 key
      - key: nginx.conf
        path: nginx.conf
```

##### 4. nfs(网络文件系统)

挂载 NFS 共享存储,支持多 Pod 同时读写。

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-nfs
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: data
      mountPath: /data
  volumes:
  - name: nfs
    nfs:
      server: 192.168.1.100  # NFS 服务器
      path: /export/data     # 共享路径
      readOnly: false
```

### 三、PV(PersistentVolume,持久卷)

**PV 是集群级别的存储资源**,由管理员预先创建或通过 StorageClass 动态创建,与 Pod 的生命周期无关。

#### PV 示例(NFS)

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs
spec:
  capacity:
    storage: 10Gi  # 容量
  accessModes:
  - ReadWriteMany  # 访问模式
  persistentVolumeReclaimPolicy: Retain  # 回收策略
  storageClassName: nfs-storage  # 存储类
  nfs:
    server: 192.168.1.100
    path: /export/data
```

#### 关键参数

##### 1. accessModes(访问模式)

- **ReadWriteOnce(RWO)**:单节点读写(最常用,如云盘)
- **ReadOnlyMany(ROX)**:多节点只读
- **ReadWriteMany(RWM)**:多节点读写(需存储支持,如 NFS、CephFS)

##### 2. persistentVolumeReclaimPolicy(回收策略)

- **Retain(保留)**:PVC 删除后 PV 保留,数据需手动清理(默认)
- **Delete(删除)**:PVC 删除时自动删除 PV 和底层存储(云盘常用)
- **Recycle(回收)**:已废弃,删除数据后 PV 可被重新绑定

##### 3. storageClassName(存储类)

标识 PV 的类型,用于与 PVC 匹配。设置为 `""` 表示不使用 StorageClass(静态绑定)。

### 四、PVC(PersistentVolumeClaim,持久卷声明)

**PVC 是用户对存储的请求**,类似 Pod 消费节点资源,PVC 消费 PV 资源。

#### PVC 示例

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-nfs
spec:
  accessModes:
  - ReadWriteMany  # 必须与 PV 匹配
  resources:
    requests:
      storage: 5Gi  # 申请容量(≤ PV 容量)
  storageClassName: nfs-storage  # 指定存储类
```

#### 绑定规则

PVC 与 PV 的绑定条件:

1. **accessModes 兼容**:PVC 的访问模式必须是 PV 的子集
2. **容量满足**:PV 容量 ≥ PVC 请求容量
3. **storageClassName 一致**:两者的 storageClassName 必须相同
4. **selector 匹配**(可选):通过标签选择器精确绑定

绑定后 PV 状态变为 `Bound`,独占给该 PVC 使用。

#### Pod 使用 PVC

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pvc
spec:
  containers:
  - name: nginx
    image: nginx
    volumeMounts:
    - name: data
      mountPath: /usr/share/nginx/html
  volumes:
  - name: data
    persistentVolumeClaim:
      claimName: pvc-nfs  # 引用 PVC
```

### 五、StorageClass(存储类)与动态供给

#### 静态供给 vs 动态供给

| 模式         | 流程                                       | 缺点                         |
| ------------ | ------------------------------------------ | ---------------------------- |
| **静态供给** | 管理员预先创建 PV → 用户创建 PVC → 自动绑定 | 需提前规划,容量浪费          |
| **动态供给** | 用户创建 PVC → StorageClass 自动创建 PV    | 按需分配,灵活高效            |

#### StorageClass 示例(阿里云盘)

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: alicloud-disk
provisioner: diskplugin.csi.alibabacloud.com  # 存储驱动(CSI)
parameters:
  type: cloud_ssd  # 云盘类型
  regionId: cn-hangzhou
  zoneId: cn-hangzhou-b
reclaimPolicy: Delete  # 回收策略
allowVolumeExpansion: true  # 允许扩容
volumeBindingMode: WaitForFirstConsumer  # 延迟绑定(等待 Pod 调度)
```

**关键字段**:

- **provisioner**:存储插件,负责创建底层存储
- **volumeBindingMode**:
  - `Immediate`:PVC 创建时立即创建 PV(默认)
  - `WaitForFirstConsumer`:等待 Pod 调度后再创建(拓扑感知,如云盘需在同可用区)

#### 使用动态供给

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-dynamic
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
  storageClassName: alicloud-disk  # 指定 StorageClass
```

创建 PVC 后,StorageClass 的 provisioner 会自动调用云厂商 API 创建云盘,并生成对应的 PV。

### 六、常见存储方案对比

| 存储类型      | 访问模式 | 性能   | 适用场景                         | 备注                   |
| ------------- | -------- | ------ | -------------------------------- | ---------------------- |
| **本地盘**    | RWO      | 极高   | 数据库(高 IOPS 需求)             | 节点故障数据丢失       |
| **云盘**      | RWO      | 高     | 通用持久化存储                   | 支持快照、备份         |
| **NFS**       | RWM      | 中     | 共享文件、日志聚合               | 单点故障,性能瓶颈      |
| **CephFS**    | RWM      | 中高   | 大规模分布式文件存储             | 部署复杂,运维成本高    |
| **GlusterFS** | RWM      | 中     | 中小规模文件共享                 | 易用性好               |
| **对象存储**  | -        | 中     | 非结构化数据(图片、视频、备份)   | 需应用层对接 S3 API    |

### 七、生产环境最佳实践

#### 1. 存储规划

- **按需分类**:区分临时数据(emptyDir)、配置(ConfigMap)、持久化数据(PVC)
- **容量预估**:避免 PV 容量不足或过度浪费
- **备份策略**:关键数据定期快照或备份到对象存储

#### 2. 性能优化

- **选择合适存储类型**:IOPS 密集型用本地盘/云盘 SSD,共享文件用 NFS/CephFS
- **SSD vs HDD**:数据库、缓存用 SSD,日志归档用 HDD
- **本地存储**:对于高性能需求,使用 Local PV(需处理节点亲和性)

#### 3. 安全加固

- **加密**:敏感数据使用加密的云盘或 Secret
- **权限控制**:Pod SecurityContext 限制容器对卷的访问权限
- **PVC 命名空间隔离**:PVC 只能在同一命名空间使用

#### 4. 监控与告警

- **容量监控**:监控 PV 使用率,设置阈值告警
- **I/O 性能**:监控磁盘 IOPS、吞吐量
- **故障检测**:存储不可用时自动告警

#### 5. 扩容与迁移

**扩容 PVC**:

```yaml
# 修改 PVC 的 resources.requests.storage
kubectl edit pvc pvc-nfs
# 或使用 kubectl patch
kubectl patch pvc pvc-nfs -p '{"spec":{"resources":{"requests":{"storage":"20Gi"}}}}'
```

前提:StorageClass 需设置 `allowVolumeExpansion: true`。

### 八、常见问题排查

| 问题                  | 原因                                   | 解决方法                             |
| --------------------- | -------------------------------------- | ------------------------------------ |
| PVC 一直 Pending      | 无匹配的 PV,或 StorageClass 不存在     | 检查 accessModes、容量、storageClassName |
| Pod 启动失败挂载卷    | PVC 未绑定,或节点无权限访问存储        | 查看 `kubectl describe pod`,检查存储驱动 |
| 性能差                | 存储类型不匹配,或网络延迟高            | 更换存储类型,检查网络               |
| 数据丢失              | 使用 emptyDir 或 PV 被删除             | 检查回收策略,改用 Retain            |

**调试命令**:

```bash
# 查看 PV 状态
kubectl get pv

# 查看 PVC 绑定情况
kubectl get pvc -n <namespace>

# 查看 Pod 挂载详情
kubectl describe pod <pod-name>

# 进入容器检查挂载点
kubectl exec -it <pod-name> -- df -h
```

### 九、总结

**K8s 存储架构的核心思想是"存储供给与消费解耦"**:

- **Volume**:Pod 级临时或挂载存储
- **PV**:集群级存储资源池,管理员管理
- **PVC**:用户存储请求,与 PV 自动绑定
- **StorageClass**:存储模板,实现动态供给

**选型建议**:

- **云环境**:优先使用云厂商提供的 CSI 插件(云盘、文件存储)
- **私有云**:Ceph(大规模)、NFS(中小规模)、Local PV(高性能)
- **混合云**:考虑跨云存储方案(如 Rook、Longhorn)

在生产环境中,建议使用动态供给(StorageClass)简化运维,结合监控、备份、灾备机制保障数据安全。
