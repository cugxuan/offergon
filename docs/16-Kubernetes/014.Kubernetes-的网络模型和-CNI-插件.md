---
title: Kubernetes 的网络模型和 CNI 插件
tags:
  - Kubernetes
status: robot
class: Kubernetes
slug: kubernetes-network-model-and-cni-plugins
ref:
---

## 核心要点

- **K8s 网络模型三大原则**：所有 Pod 间直接通信、Pod 与 Node 间直接通信、Pod 看到的 IP 就是其他人看到的 IP
- **CNI（Container Network Interface）**：容器网络标准接口，插件负责实现 Pod 网络配置
- **主流 CNI 插件**：Flannel（简单易用）、Calico（性能优秀、支持网络策略）、Cilium（eBPF 高性能）、Weave（自动加密）
- **网络类型**：Overlay（隧道封装，如 VXLAN）、Underlay（路由直连，性能最优）、混合模式

## 详细解答

### 一、Kubernetes 网络模型深度解析

#### 1. Kubernetes 网络模型的三大基本原则

Kubernetes 定义了**平坦网络模型**（Flat Network Model），核心原则如下：

**原则 1：所有 Pod 之间可以直接通信，无需 NAT**
```
Pod A (10.244.1.5) ──直接通信──> Pod B (10.244.2.8)
无论是否在同一节点，都能通过 Pod IP 直接访问
```

**原则 2：所有 Node 与 Pod 之间可以直接通信，无需 NAT**
```
Node (192.168.1.10) ──直接通信──> Pod (10.244.1.5)
节点可以直接访问任何 Pod 的 IP 地址
```

**原则 3：Pod 看到的自己的 IP 地址与其他 Pod 看到的它的 IP 地址相同**
```
Pod A 内部执行: ip addr show  → 10.244.1.5
Pod B 访问 Pod A 时使用: curl 10.244.1.5  ✓ 相同 IP
```

**与传统 Docker 网络的区别：**

| 维度 | Docker 默认网络 | Kubernetes 网络 |
|------|----------------|----------------|
| **容器间通信** | 需要端口映射或 --link | 直接通过 Pod IP 通信 |
| **NAT** | 宿主机 NAT 转换 | 无 NAT，保持 IP 一致性 |
| **跨主机通信** | 需手动配置（overlay/macvlan） | CNI 插件自动实现 |
| **IP 地址** | 容器内外 IP 不同 | Pod 内外 IP 相同 |

#### 2. Kubernetes 网络通信场景

**场景 1：同节点 Pod 间通信**
```
┌────────────── Node ──────────────┐
│  Pod A (10.244.1.5)              │
│      ↓ veth pair                 │
│  cni0 网桥 (10.244.1.1)          │
│      ↑ veth pair                 │
│  Pod B (10.244.1.8)              │
└──────────────────────────────────┘
```
通过**虚拟网桥**（cni0/cbr0）转发，类似虚拟交换机。

**场景 2：跨节点 Pod 间通信**
```
┌─── Node1 ───┐       ┌─── Node2 ───┐
│ Pod A       │       │ Pod B       │
│ 10.244.1.5  │       │ 10.244.2.8  │
└──────┬──────┘       └──────┬──────┘
       │                     │
       └─────── 路由/隧道 ────┘
```
CNI 插件负责实现：
- **Overlay 模式**：通过 VXLAN/IPIP 隧道封装
- **Underlay 模式**：通过 BGP 路由直连

**场景 3：Pod 访问外部网络**
```
Pod (10.244.1.5) → cni0 → Node eth0 (SNAT) → Internet
返回时: Internet → Node eth0 (DNAT) → cni0 → Pod
```
通过节点的 **iptables/IPVS SNAT** 规则实现。

**场景 4：外部访问 Pod（通过 Service）**
```
External Client
    ↓
LoadBalancer IP (1.2.3.4:80)
    ↓
NodePort (32000)
    ↓
ClusterIP (10.96.0.10:80) ← iptables/IPVS 规则
    ↓
Pod A (10.244.1.5:8080)
Pod B (10.244.2.8:8080)
```

### 二、CNI（Container Network Interface）深度解析

#### 1. CNI 是什么

CNI 是 **CNCF 标准的容器网络接口规范**，定义了：
- 容器运行时如何调用网络插件
- 网络插件如何为容器配置网络

**CNI 工作流程：**
```
kubelet 创建 Pod
    ↓
调用 CRI (Container Runtime Interface)
    ↓
容器运行时 (containerd/CRI-O) 创建容器
    ↓
调用 CNI 插件: ADD 命令
    ↓
CNI 插件执行:
  1. 创建 veth pair (虚拟网卡对)
  2. 一端接入 Pod netns (网络命名空间)
  3. 另一端接入网桥/宿主机
  4. 为 Pod 分配 IP 地址
  5. 配置路由规则
  6. 返回结果给容器运行时
    ↓
Pod 网络配置完成
```

**CNI 配置文件示例（/etc/cni/net.d/）：**
```json
{
  "cniVersion": "0.4.0",
  "name": "k8s-pod-network",
  "type": "calico",
  "datastore_type": "kubernetes",
  "ipam": {
    "type": "calico-ipam",
    "assign_ipv4": "true"
  },
  "policy": {
    "type": "k8s"
  },
  "kubernetes": {
    "kubeconfig": "/etc/cni/net.d/calico-kubeconfig"
  }
}
```

#### 2. CNI 插件分类

**按网络实现方式分类：**

| 类型 | 实现方式 | 代表插件 | 特点 |
|------|---------|---------|------|
| **Overlay** | 隧道封装（VXLAN/IPIP） | Flannel、Weave | 兼容性好，性能一般 |
| **Underlay** | 路由直连（BGP） | Calico、Cilium | 性能最优，需网络支持 |
| **混合模式** | Overlay + Underlay | Calico、Cilium | 灵活配置 |

**按功能分类：**

| 插件类型 | 功能 | 示例 |
|---------|------|------|
| **主插件** | 实现核心网络功能 | Calico、Flannel、Cilium |
| **IPAM 插件** | IP 地址管理 | host-local、dhcp |
| **Meta 插件** | 辅助功能 | bandwidth（限速）、portmap（端口映射） |

### 三、主流 CNI 插件对比

#### 1. Flannel：最简单的 CNI 插件

**核心特性：**
- **实现方式**：主要使用 VXLAN 隧道（默认）
- **IP 分配**：为每个节点分配一个子网（如 10.244.1.0/24）
- **路由传播**：通过 etcd/Kubernetes API 存储路由信息

**网络拓扑（VXLAN 模式）：**
```
Node1 (10.244.1.0/24)          Node2 (10.244.2.0/24)
    Pod A                          Pod B
    10.244.1.5                     10.244.2.8
       ↓                              ↓
    flannel.1 (VXLAN 接口)         flannel.1
       ↓                              ↓
    eth0: 192.168.1.10 ←─ VXLAN 隧道 ─→ eth0: 192.168.1.20

数据包封装:
原始数据: Pod A IP → Pod B IP | TCP Data
VXLAN 封装: Node1 IP → Node2 IP | VXLAN Header | 原始数据
```

**优点：**
- 配置简单，开箱即用
- 支持多种后端（VXLAN、host-gw、UDP）
- 对底层网络要求低

**缺点：**
- 不支持网络策略（NetworkPolicy）
- VXLAN 模式性能有损耗（~10-20%）
- 功能较少，不适合复杂场景

**部署示例：**
```bash
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
```

#### 2. Calico：企业级首选 CNI 插件

**核心特性：**
- **实现方式**：默认使用 BGP 路由（Underlay），可选 IPIP/VXLAN（Overlay）
- **网络策略**：原生支持 Kubernetes NetworkPolicy 和 Calico 扩展策略
- **性能优秀**：BGP 模式无封装开销，接近原生网络性能

**网络拓扑（BGP 模式）：**
```
Node1 (10.244.1.0/24)          Node2 (10.244.2.0/24)
    Pod A                          Pod B
    10.244.1.5                     10.244.2.8
       ↓                              ↓
    cali123abc (veth)              cali456def
       ↓                              ↓
   路由表:                         路由表:
   10.244.2.0/24 via 192.168.1.20  10.244.1.0/24 via 192.168.1.10
       ↓                              ↓
    eth0: 192.168.1.10 ←─── BGP 路由 ───→ eth0: 192.168.1.20

数据包传输:
Pod A IP → Pod B IP | TCP Data (无封装，直接路由)
```

**三种网络模式对比：**

| 模式 | 封装方式 | 性能 | 网络要求 | 适用场景 |
|------|---------|------|---------|---------|
| **BGP** | 无封装 | 最优（100%） | 支持 BGP 的网络 | 私有云、IDC |
| **IPIP** | IP-in-IP 隧道 | 中等（85%） | 允许 IP 协议 | 跨子网通信 |
| **VXLAN** | VXLAN 封装 | 较低（80%） | 仅需 UDP | 公有云、跨数据中心 |

**网络策略示例：**
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all-ingress
  namespace: production
spec:
  podSelector: {}  # 应用到命名空间所有 Pod
  policyTypes:
  - Ingress
  ingress: []      # 空规则 = 拒绝所有入流量
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-frontend
spec:
  podSelector:
    matchLabels:
      app: backend
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 8080
```

**优点：**
- 性能优秀（BGP 模式接近原生）
- 强大的网络策略（L3/L4/L7）
- 支持多种网络模式
- 可与 Istio 集成

**缺点：**
- 配置相对复杂
- BGP 模式对网络有要求
- 资源占用较高

**部署示例（BGP 模式）：**
```bash
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
# 配置 BGP
calicoctl node status  # 查看 BGP 邻居
```

#### 3. Cilium：基于 eBPF 的下一代 CNI

**核心技术：**
- **eBPF（Extended Berkeley Packet Filter）**：Linux 内核可编程数据路径
- **绕过 iptables**：直接在内核层处理网络，性能提升 30-50%
- **L7 可观测性**：应用层协议感知（HTTP、gRPC、Kafka）

**架构优势：**
```
传统 CNI (iptables):
应用 → 内核协议栈 → iptables 规则链(几千条) → 网卡
                    ↑ 性能瓶颈

Cilium (eBPF):
应用 → eBPF 程序(内核层高效处理) → 网卡
     ↑ 直接转发，跳过 iptables
```

**特色功能：**
1. **Hubble**：内置可观测性平台，可视化网络流量
2. **ClusterMesh**：多集群 Pod 直接通信
3. **透明加密**：自动 IPSec/WireGuard 加密
4. **服务网格集成**：无需 Sidecar 的 Service Mesh

**部署示例：**
```bash
helm repo add cilium https://helm.cilium.io/
helm install cilium cilium/cilium --version 1.14.5 \
  --namespace kube-system \
  --set kubeProxyReplacement=strict  # 替换 kube-proxy
```

**优点：**
- 性能最优（eBPF 加速）
- L7 感知和网络策略
- 丰富的可观测性
- 技术先进

**缺点：**
- 需要较新的 Linux 内核（≥ 4.19）
- 学习曲线陡峭
- 社区相对较新

#### 4. Weave：自动加密的 CNI

**核心特性：**
- **自动网状网络**：节点间自动建立连接
- **内置加密**：自动 NaCl 加密，无需配置
- **多播支持**：支持容器多播通信

**适用场景：**
- 安全要求高的环境
- 需要跨云/跨数据中心通信
- 简单部署即可用加密

**缺点：**
- 性能一般（Overlay + 加密开销）
- 项目活跃度下降

### 四、CNI 插件选型建议

**决策树：**

```
是否需要网络策略？
├─ 否 → Flannel（最简单）
└─ 是 → 是否在公有云？
        ├─ 是 → 使用云厂商 CNI（AWS VPC CNI、Azure CNI）
        └─ 否 → 是否需要高性能？
                ├─ 是 → Cilium（eBPF）或 Calico（BGP）
                └─ 否 → Calico（VXLAN 模式，兼容性最好）
```

**生产环境推荐配置：**

| 场景 | 推荐插件 | 配置要点 |
|------|---------|---------|
| **企业私有云** | Calico（BGP 模式） | 配置交换机支持 BGP |
| **公有云** | Calico（VXLAN） / Cilium | 兼容云网络限制 |
| **高性能计算** | Cilium（eBPF） | 升级内核至 5.x |
| **小规模集群** | Flannel（VXLAN） | 快速部署 |
| **跨云/多集群** | Cilium（ClusterMesh） | 配置跨集群路由 |
| **安全合规** | Calico + 加密 / Weave | 启用 WireGuard |

### 五、网络策略（NetworkPolicy）实战

#### 1. 默认拒绝所有流量（安全基线）

```yaml
# 拒绝所有入流量
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
---
# 拒绝所有出流量
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Egress
```

#### 2. 三层应用隔离（前端-后端-数据库）

```yaml
# 允许前端访问后端
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-allow-frontend
spec:
  podSelector:
    matchLabels:
      tier: backend
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: frontend
    ports:
    - protocol: TCP
      port: 8080
---
# 允许后端访问数据库
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: db-allow-backend
spec:
  podSelector:
    matchLabels:
      tier: database
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: backend
    ports:
    - protocol: TCP
      port: 3306
  egress: []  # 数据库不允许主动外连
```

#### 3. 命名空间级别隔离

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-same-namespace
  namespace: team-a
spec:
  podSelector: {}
  ingress:
  - from:
    - podSelector: {}  # 同命名空间所有 Pod
  egress:
  - to:
    - podSelector: {}
```

### 六、常见问题与排查

#### Q1：Pod 无法跨节点通信？

**排查步骤：**
```bash
# 1. 检查 CNI 插件是否正常
kubectl get pods -n kube-system | grep -E 'calico|flannel|cilium'

# 2. 检查节点路由
ip route | grep 10.244  # 查看 Pod 网段路由

# 3. 测试跨节点 Pod 连通性
kubectl run test --rm -it --image=busybox -- sh
# 在容器内: ping <另一节点的Pod IP>

# 4. 检查 iptables 规则
iptables-save | grep KUBE

# 5. 检查 CNI 配置
cat /etc/cni/net.d/*.conf
```

**常见原因：**
- CNI 插件 Pod 未运行
- 防火墙阻止 VXLAN（UDP 8472）或 IPIP 流量
- 节点间网络不通
- IP 地址冲突

#### Q2：网络策略不生效？

**排查步骤：**
```bash
# 1. 确认 CNI 插件支持网络策略
# Flannel 不支持！需换用 Calico/Cilium

# 2. 查看 NetworkPolicy 是否创建成功
kubectl get networkpolicy -A

# 3. 查看 Pod 标签是否匹配
kubectl get pods --show-labels

# 4. 测试网络连通性
kubectl exec <pod> -- curl <target-pod-ip>:8080
```

#### Q3：如何排查网络性能问题？

**工具链：**
```bash
# 1. Pod 间带宽测试
kubectl run iperf-server --image=networkstatic/iperf3 -- -s
kubectl run iperf-client --rm -it --image=networkstatic/iperf3 -- \
  -c <server-pod-ip> -t 30

# 2. 延迟测试
kubectl exec <pod> -- ping -c 100 <target-ip>

# 3. 查看网络接口统计
kubectl exec <pod> -- ip -s link

# 4. 使用 Hubble（Cilium）可视化
hubble observe --pod <pod-name>
```

### 七、高级主题

#### 1. 多网卡/多网络

使用 **Multus CNI** 为 Pod 提供多个网络接口：

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: multi-network-pod
  annotations:
    k8s.v1.cni.cncf.io/networks: macvlan-net, sriov-net
spec:
  containers:
  - name: app
    image: nginx
# 结果：Pod 有 3 个网卡（eth0: 默认CNI, net1: macvlan, net2: SR-IOV）
```

#### 2. Service Mesh 集成

Cilium 可替代 Istio 的 Sidecar 模式，提供更轻量的 Service Mesh：

```bash
helm install cilium cilium/cilium \
  --set kubeProxyReplacement=strict \
  --set l7Proxy=true  # 启用 L7 代理
```

#### 3. 跨集群网络（ClusterMesh）

Cilium ClusterMesh 实现多集群 Pod 直接通信：

```bash
cilium clustermesh enable
cilium clustermesh connect --destination-context cluster2
```

**应用场景：**
- 多集群灾备
- 跨区域低延迟通信
- 混合云架构
