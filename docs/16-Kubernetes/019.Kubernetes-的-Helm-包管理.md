---
title: Kubernetes 的 Helm 包管理
tags:
  - Kubernetes
status: robot
class: Kubernetes
slug: kubernetes-helm-package-management
ref:
---

## 核心要点

- **Helm 定位**: Kubernetes 的包管理器,类似 yum/apt/npm
- **三大概念**: Chart(应用包) + Release(部署实例) + Repository(Chart 仓库)
- **模板引擎**: 使用 Go Template 实现参数化配置,解决重复 YAML 编写问题
- **版本管理**: 支持应用升级、回滚、历史记录查询
- **生态优势**: 丰富的官方和社区 Chart,开箱即用

---

## 详细回答

### 一、为什么需要 Helm

#### 1. 原生 K8s 部署的痛点

**问题场景**:部署一个 WordPress 应用

```bash
# 需要手动管理多个 YAML 文件
kubectl apply -f wordpress-deployment.yaml
kubectl apply -f wordpress-service.yaml
kubectl apply -f mysql-deployment.yaml
kubectl apply -f mysql-service.yaml
kubectl apply -f mysql-pvc.yaml
kubectl apply -f mysql-secret.yaml
kubectl apply -f ingress.yaml
# ... 还有更多
```

**痛点总结**:

| 问题 | 影响 |
|------|------|
| **配置分散** | 数十个 YAML 文件难以管理 |
| **参数硬编码** | 镜像版本、副本数等写死在文件中 |
| **环境差异** | dev/staging/prod 需要维护多套配置 |
| **依赖管理** | 应用间依赖关系(如 WordPress 依赖 MySQL)难以表达 |
| **版本控制** | 无法追踪部署历史,回滚困难 |
| **复用性差** | 无法像安装软件包一样一键部署 |

#### 2. Helm 的解决方案

```bash
# 一行命令部署 WordPress
helm install my-wordpress bitnami/wordpress \
  --set wordpressUsername=admin \
  --set wordpressPassword=secret \
  --set persistence.size=20Gi

# 升级应用
helm upgrade my-wordpress bitnami/wordpress --set replicaCount=3

# 回滚到上一个版本
helm rollback my-wordpress 1
```

**核心优势**:
- **打包**: 将应用的所有 K8s 资源打包成 Chart
- **模板化**: 通过变量实现配置参数化
- **依赖管理**: 自动处理应用依赖(如数据库、缓存)
- **版本控制**: 记录每次部署,支持回滚
- **仓库分发**: 通过 Chart 仓库共享应用

---

### 二、Helm 核心概念

#### 1. 三大核心对象

```
┌─────────────────────────────────────────────────────┐
│                  Helm 架构                           │
│                                                      │
│  ┌──────────────────┐                               │
│  │   Chart Repo     │  ← 存储 Chart 包              │
│  │  (仓库)          │                               │
│  │                  │                               │
│  │  - stable/       │                               │
│  │  - bitnami/      │                               │
│  │  - custom/       │                               │
│  └─────────┬────────┘                               │
│            │                                         │
│            │ helm pull / helm install                │
│            ▼                                         │
│  ┌──────────────────┐                               │
│  │      Chart       │  ← 应用包(YAML + 模板)       │
│  │  (应用包)        │                               │
│  │                  │                               │
│  │  mychart/        │                               │
│  │  ├─ Chart.yaml   │  ← 元数据(名称、版本)        │
│  │  ├─ values.yaml  │  ← 默认配置                  │
│  │  └─ templates/   │  ← K8s 资源模板              │
│  │     ├─ deploy.yaml                               │
│  │     ├─ svc.yaml  │                               │
│  │     └─ ingress.yaml                              │
│  └─────────┬────────┘                               │
│            │                                         │
│            │ helm install my-app mychart             │
│            ▼                                         │
│  ┌──────────────────┐                               │
│  │     Release      │  ← 部署实例                   │
│  │  (部署实例)      │                               │
│  │                  │                               │
│  │  my-app          │  ← Release 名称               │
│  │  Revision: 3     │  ← 版本号                     │
│  │  Status: deployed│                               │
│  │  Namespace: prod │                               │
│  └──────────────────┘                               │
│            │                                         │
│            ▼                                         │
│  ┌──────────────────┐                               │
│  │   Kubernetes     │                               │
│  │   Cluster        │                               │
│  │                  │                               │
│  │  - Deployment    │                               │
│  │  - Service       │                               │
│  │  - Ingress       │                               │
│  └──────────────────┘                               │
└─────────────────────────────────────────────────────┘
```

**① Chart(应用包)**
- 定义:一组 K8s 资源的描述文件集合
- 类比:类似 npm package、Docker image
- 内容:包含所有部署应用所需的模板、配置和元数据

**② Release(部署实例)**
- 定义:Chart 在 K8s 集群中的一次部署
- 特点:同一个 Chart 可以安装多次,每次是独立的 Release
- 示例:`helm install mysql-dev bitnami/mysql` 和 `helm install mysql-prod bitnami/mysql` 是两个不同的 Release

**③ Repository(Chart 仓库)**
- 定义:存储和分发 Chart 的服务器
- 常用仓库:
  - `bitnami`: https://charts.bitnami.com/bitnami
  - `stable`: https://charts.helm.sh/stable (已废弃)
  - `prometheus-community`: https://prometheus-community.github.io/helm-charts

---

### 三、Chart 目录结构详解

#### 1. 标准 Chart 结构

```
mychart/
├── Chart.yaml          # Chart 元数据
├── values.yaml         # 默认配置值
├── charts/             # 依赖的子 Chart
├── templates/          # K8s 资源模板
│   ├── NOTES.txt       # 安装后提示信息
│   ├── deployment.yaml
│   ├── service.yaml
│   ├── ingress.yaml
│   ├── _helpers.tpl    # 模板辅助函数
│   └── tests/          # 测试文件
│       └── test-connection.yaml
├── .helmignore         # 忽略文件列表
└── README.md           # 使用说明
```

#### 2. Chart.yaml 详解

```yaml
apiVersion: v2            # Chart API 版本(v2 for Helm 3)
name: mychart             # Chart 名称
description: A Helm chart for my application
type: application         # 类型: application 或 library

version: 1.2.3            # Chart 版本(遵循 SemVer)
appVersion: "2.0.1"       # 应用版本(可选)

# 维护者信息
maintainers:
- name: Alice
  email: alice@example.com
  url: https://github.com/alice

# 依赖的 Chart
dependencies:
- name: mysql
  version: 9.3.4
  repository: https://charts.bitnami.com/bitnami
  condition: mysql.enabled  # 可选依赖
  tags:
    - database

# 关键字(用于搜索)
keywords:
- web
- application

# Chart 主页
home: https://example.com
sources:
- https://github.com/example/mychart

# 图标(显示在 UI 中)
icon: https://example.com/logo.png
```

#### 3. values.yaml 详解

**默认配置值**(可被覆盖)

```yaml
# 镜像配置
image:
  repository: nginx
  tag: "1.21.0"
  pullPolicy: IfNotPresent

# 副本数
replicaCount: 2

# 服务配置
service:
  type: ClusterIP
  port: 80
  annotations: {}

# Ingress 配置
ingress:
  enabled: false
  className: nginx
  hosts:
    - host: example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []

# 资源限制
resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

# 自动扩缩容
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80

# 环境变量
env:
  - name: LOG_LEVEL
    value: "info"
```

---

### 四、模板语法与实战

#### 1. 基础模板示例

**templates/deployment.yaml**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mychart.fullname" . }}
  labels:
    {{- include "mychart.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "mychart.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "mychart.selectorLabels" . | nindent 8 }}
    spec:
      containers:
      - name: {{ .Chart.Name }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - name: http
          containerPort: 80
          protocol: TCP
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
        {{- with .Values.env }}
        env:
          {{- toYaml . | nindent 10 }}
        {{- end }}
```

#### 2. 内置对象

| 对象 | 说明 | 示例 |
|------|------|------|
| `.Release.Name` | Release 名称 | `my-app` |
| `.Release.Namespace` | 部署的命名空间 | `production` |
| `.Release.IsInstall` | 是否为首次安装 | `true/false` |
| `.Chart.Name` | Chart 名称 | `mychart` |
| `.Chart.Version` | Chart 版本 | `1.2.3` |
| `.Values` | values.yaml 的值 | `.Values.replicaCount` |
| `.Files` | 访问 Chart 中的文件 | `.Files.Get "config.json"` |
| `.Capabilities` | K8s 集群能力 | `.Capabilities.APIVersions` |

#### 3. 常用模板函数

**条件判断**
```yaml
{{- if .Values.ingress.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Release.Name }}-ingress
{{- end }}
```

**循环**
```yaml
{{- range .Values.env }}
- name: {{ .name }}
  value: {{ .value | quote }}
{{- end }}
```

**默认值**
```yaml
image: {{ .Values.image.repository }}:{{ .Values.image.tag | default "latest" }}
```

**字符串处理**
```yaml
name: {{ .Release.Name | upper | quote }}  # "MY-APP"
labels:
  app: {{ .Chart.Name | trunc 63 | trimSuffix "-" }}
```

**YAML 处理**
```yaml
# 将对象转为 YAML 并缩进
resources:
  {{- toYaml .Values.resources | nindent 2 }}
```

#### 4. _helpers.tpl(辅助模板)

**定义可复用的模板片段**

```yaml
{{/*
生成完整名称
*/}}
{{- define "mychart.fullname" -}}
{{- printf "%s-%s" .Release.Name .Chart.Name | trunc 63 | trimSuffix "-" -}}
{{- end }}

{{/*
通用标签
*/}}
{{- define "mychart.labels" -}}
helm.sh/chart: {{ include "mychart.chart" . }}
app.kubernetes.io/name: {{ include "mychart.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{/*
选择器标签
*/}}
{{- define "mychart.selectorLabels" -}}
app.kubernetes.io/name: {{ include "mychart.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}
```

**使用辅助模板**
```yaml
labels:
  {{- include "mychart.labels" . | nindent 4 }}
```

---

### 五、Helm 常用命令

#### 1. Chart 仓库管理

```bash
# 添加仓库
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

# 更新仓库索引
helm repo update

# 列出仓库
helm repo list

# 搜索 Chart
helm search repo mysql
helm search hub wordpress  # 搜索 Artifact Hub

# 查看 Chart 详情
helm show chart bitnami/mysql
helm show values bitnami/mysql  # 查看可配置参数
helm show readme bitnami/mysql
```

#### 2. Chart 安装与管理

```bash
# 安装 Chart
helm install my-release bitnami/mysql

# 指定命名空间
helm install my-release bitnami/mysql -n production --create-namespace

# 覆盖默认值(方式1:命令行)
helm install my-release bitnami/mysql \
  --set auth.rootPassword=secret \
  --set primary.persistence.size=50Gi

# 覆盖默认值(方式2:YAML 文件)
helm install my-release bitnami/mysql -f custom-values.yaml

# 调试模式(不实际安装,查看渲染结果)
helm install my-release bitnami/mysql --dry-run --debug

# 列出 Release
helm list
helm list -n production
helm list --all-namespaces

# 查看 Release 状态
helm status my-release

# 查看 Release 详细信息
helm get all my-release
helm get values my-release  # 查看实际使用的值
helm get manifest my-release  # 查看生成的 K8s 资源
```

#### 3. 升级与回滚

```bash
# 升级 Release
helm upgrade my-release bitnami/mysql \
  --set replicaCount=3

# 升级并重用之前的值
helm upgrade my-release bitnami/mysql --reuse-values

# 如果 Release 不存在则安装
helm upgrade --install my-release bitnami/mysql

# 查看历史版本
helm history my-release

# 输出示例:
# REVISION  UPDATED                   STATUS      CHART         DESCRIPTION
# 1         2025-01-15 10:00:00       superseded  mysql-9.3.4   Install complete
# 2         2025-01-15 11:00:00       superseded  mysql-9.3.5   Upgrade complete
# 3         2025-01-15 12:00:00       deployed    mysql-9.3.6   Upgrade complete

# 回滚到上一个版本
helm rollback my-release

# 回滚到指定版本
helm rollback my-release 1

# 回滚并等待完成
helm rollback my-release 1 --wait
```

#### 4. 卸载

```bash
# 卸载 Release
helm uninstall my-release

# 卸载但保留历史记录(可回滚)
helm uninstall my-release --keep-history

# 卸载指定命名空间的 Release
helm uninstall my-release -n production
```

---

### 六、创建自定义 Chart

#### 1. 创建 Chart 骨架

```bash
# 创建新 Chart
helm create myapp

# 生成的目录结构:
# myapp/
# ├── Chart.yaml
# ├── values.yaml
# ├── charts/
# └── templates/
#     ├── deployment.yaml
#     ├── service.yaml
#     ├── ingress.yaml
#     └── ...
```

#### 2. 自定义 values.yaml

```yaml
# myapp/values.yaml
replicaCount: 2

image:
  repository: myregistry.com/myapp
  tag: "v1.0.0"
  pullPolicy: IfNotPresent

service:
  type: LoadBalancer
  port: 8080

ingress:
  enabled: true
  className: nginx
  hosts:
    - host: myapp.example.com
      paths:
        - path: /
          pathType: Prefix

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

# 自定义环境变量
env:
  - name: DATABASE_URL
    value: "postgres://db:5432/mydb"
  - name: REDIS_URL
    value: "redis://redis:6379"

# 自定义配置
config:
  logLevel: info
  debug: false
```

#### 3. 验证与测试

```bash
# 验证 Chart 语法
helm lint myapp

# 模板渲染测试
helm template myapp ./myapp

# 指定值进行测试
helm template myapp ./myapp \
  --set replicaCount=5 \
  --set image.tag=v2.0.0

# 安装到本地测试
helm install myapp-test ./myapp --dry-run --debug
```

#### 4. 打包与分发

```bash
# 打包 Chart
helm package myapp
# 生成: myapp-0.1.0.tgz

# 生成索引文件(用于 Chart 仓库)
helm repo index .

# 安装本地 Chart
helm install my-release ./myapp-0.1.0.tgz
helm install my-release ./myapp  # 或直接使用目录
```

---

### 七、依赖管理

#### 1. 添加依赖

**Chart.yaml**
```yaml
dependencies:
- name: mysql
  version: 9.3.4
  repository: https://charts.bitnami.com/bitnami
  condition: mysql.enabled  # 通过 values.yaml 控制是否启用

- name: redis
  version: 17.3.7
  repository: https://charts.bitnami.com/bitnami
  condition: redis.enabled
```

**values.yaml**
```yaml
# 控制依赖是否启用
mysql:
  enabled: true
  auth:
    rootPassword: my-secret-password
    database: myapp
  primary:
    persistence:
      size: 20Gi

redis:
  enabled: true
  auth:
    password: redis-password
  master:
    persistence:
      size: 5Gi
```

#### 2. 更新依赖

```bash
# 下载依赖到 charts/ 目录
helm dependency update myapp

# 查看依赖
helm dependency list myapp

# 输出示例:
# NAME   VERSION  REPOSITORY                            STATUS
# mysql  9.3.4    https://charts.bitnami.com/bitnami    ok
# redis  17.3.7   https://charts.bitnami.com/bitnami    ok
```

#### 3. 子 Chart 值覆盖

```yaml
# 父 Chart 的 values.yaml
mysql:
  enabled: true
  auth:
    rootPassword: parent-override-password
  # 覆盖子 Chart 的任何值
  primary:
    persistence:
      size: 100Gi
```

---

### 八、最佳实践

#### 1. 配置分层管理

**目录结构**:
```
myapp/
├── values.yaml              # 默认值
├── values-dev.yaml          # 开发环境
├── values-staging.yaml      # 测试环境
└── values-production.yaml   # 生产环境
```

**部署不同环境**:
```bash
# 开发环境
helm install myapp ./myapp -f values-dev.yaml

# 生产环境
helm install myapp ./myapp -f values-production.yaml

# 多文件合并(后面的覆盖前面的)
helm install myapp ./myapp \
  -f values.yaml \
  -f values-production.yaml \
  --set image.tag=v2.1.0
```

#### 2. 敏感信息管理

**使用 Helm Secrets 插件**

```bash
# 安装插件
helm plugin install https://github.com/jkroepke/helm-secrets

# 加密 values 文件
helm secrets enc values-secrets.yaml

# 使用加密文件部署
helm secrets install myapp ./myapp -f values-secrets.yaml
```

**或使用 Kubernetes Secret**
```yaml
# templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "myapp.fullname" . }}-secret
type: Opaque
data:
  database-password: {{ .Values.secrets.dbPassword | b64enc | quote }}
```

#### 3. 版本控制策略

```yaml
# Chart.yaml
version: 1.2.3      # Chart 版本(每次修改必须更新)
appVersion: "2.0.1" # 应用版本(跟随实际应用版本)
```

**语义化版本(SemVer)**:
- **MAJOR**(1.x.x): 不兼容的 API 变更
- **MINOR**(x.2.x): 向后兼容的功能新增
- **PATCH**(x.x.3): 向后兼容的 Bug 修复

#### 4. 资源命名规范

```yaml
# _helpers.tpl
{{- define "myapp.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name .Chart.Name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
```

**标签标准化**:
```yaml
labels:
  app.kubernetes.io/name: {{ include "myapp.name" . }}
  app.kubernetes.io/instance: {{ .Release.Name }}
  app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
  app.kubernetes.io/component: backend
  app.kubernetes.io/part-of: myapp
  app.kubernetes.io/managed-by: {{ .Release.Service }}
```

#### 5. 文档化

**README.md**
```markdown
# MyApp Helm Chart

## 安装
```bash
helm install myapp ./myapp
```

## 配置参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `replicaCount` | Pod 副本数 | `2` |
| `image.repository` | 镜像仓库 | `myapp` |
| `image.tag` | 镜像标签 | `v1.0.0` |
| `service.type` | Service 类型 | `ClusterIP` |

## 示例
```bash
# 生产环境部署
helm install myapp ./myapp \
  --set replicaCount=5 \
  --set image.tag=v2.0.0
```
```

---

### 九、高级特性

#### 1. Hooks(生命周期钩子)

**templates/job-pre-install.yaml**
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "myapp.fullname" . }}-db-migration
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade  # Hook 类型
    "helm.sh/hook-weight": "-5"               # 执行顺序(数值越小越先执行)
    "helm.sh/hook-delete-policy": hook-succeeded  # 成功后删除
spec:
  template:
    spec:
      containers:
      - name: db-migrate
        image: myapp-migrator:v1
        command: ["./migrate.sh"]
      restartPolicy: Never
```

**Hook 类型**:
- `pre-install`: 安装前执行
- `post-install`: 安装后执行
- `pre-upgrade`: 升级前执行
- `post-upgrade`: 升级后执行
- `pre-delete`: 删除前执行
- `post-delete`: 删除后执行
- `pre-rollback`: 回滚前执行
- `post-rollback`: 回滚后执行

#### 2. Chart 测试

**templates/tests/test-connection.yaml**
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "myapp.fullname" . }}-test-connection
  annotations:
    "helm.sh/hook": test
spec:
  containers:
  - name: wget
    image: busybox
    command: ['wget']
    args: ['{{ include "myapp.fullname" . }}:{{ .Values.service.port }}']
  restartPolicy: Never
```

**运行测试**:
```bash
helm test my-release
```

#### 3. Library Charts(库 Chart)

**用于共享模板和辅助函数**

```yaml
# Chart.yaml
apiVersion: v2
name: common-library
type: library  # 标记为库 Chart
version: 1.0.0
```

**在其他 Chart 中使用**:
```yaml
# Chart.yaml
dependencies:
- name: common-library
  version: 1.0.0
  repository: https://my-repo.com/charts
```

---

### 十、常见问题与排查

#### 1. 模板渲染错误

**问题**: `Error: template: mychart/templates/deployment.yaml:10:23: executing...`

**排查**:
```bash
# 使用 --debug 查看详细错误
helm install myapp ./myapp --debug --dry-run

# 检查模板语法
helm lint myapp

# 单独渲染模板
helm template myapp ./myapp > output.yaml
```

#### 2. Release 卡在 pending-install 状态

**问题**: `helm list` 显示 `STATUS: pending-install`

**原因**: 安装过程中断(如网络问题)

**解决**:
```bash
# 强制删除
helm uninstall myapp --no-hooks

# 或删除 Secret(Helm 3 使用 Secret 存储状态)
kubectl delete secret -l owner=helm,name=myapp
```

#### 3. 值未生效

**问题**: 修改了 values.yaml 但未生效

**排查**:
```bash
# 查看实际使用的值
helm get values my-release

# 检查是否被命令行参数覆盖
helm history my-release

# 升级时确保使用新值
helm upgrade my-release ./myapp -f values.yaml
```

---

### 十一、总结

Helm 是 K8s 生态的核心工具,核心要点:

1. **包管理**: 通过 Chart 实现应用打包和分发
2. **模板化**: Go Template 实现配置参数化
3. **版本控制**: 支持升级、回滚、历史记录
4. **依赖管理**: 自动处理应用依赖关系
5. **生态丰富**: 数千个社区 Chart 开箱即用

面试建议关注:
- 理解 Chart、Release、Repository 三大概念
- 掌握模板语法(内置对象、函数、条件、循环)
- 熟悉常用命令(install、upgrade、rollback、uninstall)
- 了解 Chart 目录结构和依赖管理
- 能解释 Helm 2 vs Helm 3 的主要差异(Tiller 移除、CRD 改进、Library Charts)
