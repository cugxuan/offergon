---
title: Kubernetes 的 Ingress 控制器
tags:
  - Kubernetes
status: robot
class: Kubernetes
slug: kubernetes-ingress-controller
ref:
---

## 核心要点

**Ingress 是 K8s 的 7 层流量入口,提供基于域名/路径的路由、TLS 终止、负载均衡等功能。Ingress Controller 是实现 Ingress 规则的控制器,常见的有 Nginx Ingress、Traefik、Istio Gateway 等。**

---

## 详细回答

### 一、Ingress 是什么?为什么需要它?

在 Kubernetes 中,Service 可以通过 ClusterIP、NodePort 或 LoadBalancer 方式暴露服务:

- **ClusterIP**:只能在集群内部访问
- **NodePort**:通过节点端口暴露,每个服务占用一个端口,不便管理
- **LoadBalancer**:需要云厂商支持,每个服务需要一个外部 IP,成本高

**Ingress 解决的核心问题**:

- **统一入口**:一个外部 IP/域名管理多个服务
- **7 层路由**:基于 HTTP/HTTPS 的域名、路径、Header 等规则路由
- **TLS 终止**:在 Ingress 层统一处理 HTTPS 证书
- **减少 LoadBalancer 成本**:多个服务共享一个负载均衡器

### 二、Ingress 的组成部分

#### 1. Ingress 资源(API 对象)

定义路由规则的 YAML 配置:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: example-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx  # 指定使用哪个 Ingress Controller
  rules:
  - host: example.com  # 域名路由
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 8080
      - path: /web
        pathType: Prefix
        backend:
          service:
            name: web-service
            port:
              number: 80
  tls:  # TLS 配置
  - hosts:
    - example.com
    secretName: example-tls  # 证书存储在 Secret 中
```

**关键字段说明**:

- **host**:域名匹配,支持通配符(如 `*.example.com`)
- **path**:路径匹配,`pathType` 有三种:
  - `Exact`:精确匹配
  - `Prefix`:前缀匹配(最常用)
  - `ImplementationSpecific`:由 Ingress Controller 自行定义
- **backend**:指向后端的 Service 和端口
- **tls**:配置 HTTPS 证书

#### 2. Ingress Controller(控制器)

**Ingress 资源本身不会生效,必须有 Ingress Controller 来实现路由规则**。

Ingress Controller 的工作原理:

1. **监听 Ingress 资源**:通过 Watch API 实时监听 Ingress、Service、Endpoint 的变化
2. **生成配置**:根据 Ingress 规则生成反向代理配置(如 Nginx 配置文件)
3. **动态加载**:自动 reload 配置,无需重启
4. **流量转发**:接收外部流量,按规则转发到后端 Pod

### 三、常见 Ingress Controller 对比

| Controller         | 优点                                     | 缺点                   | 适用场景             |
| ------------------ | ---------------------------------------- | ---------------------- | -------------------- |
| **Nginx Ingress**  | 最流行,生态成熟,性能高,功能丰富          | 配置复杂,调试困难      | 通用场景,生产环境    |
| **Traefik**        | 配置简单,原生支持服务发现,UI 友好        | 性能略逊于 Nginx       | 中小型项目,微服务    |
| **HAProxy Ingress**| 高性能,精细化流量控制                    | 社区较小               | 高性能需求           |
| **Istio Gateway**  | 服务网格能力,灰度发布,熔断限流           | 复杂度高,资源消耗大    | 大型微服务,服务治理  |
| **Kong Ingress**   | API 网关功能,插件丰富(限流、鉴权、日志等)| 商业版功能更全         | API 网关场景         |

### 四、Nginx Ingress Controller 部署与工作流程

#### 1. 部署方式

```bash
# 使用官方 Helm Chart 部署
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm install nginx-ingress ingress-nginx/ingress-nginx \
  --set controller.service.type=LoadBalancer \
  --namespace ingress-nginx --create-namespace

# 或使用 YAML 部署
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml
```

部署后会创建:

- **Deployment/DaemonSet**:运行 Nginx Ingress Controller Pod
- **Service(LoadBalancer/NodePort)**:暴露 Ingress Controller 给外部访问
- **ConfigMap**:存储全局配置
- **RBAC 权限**:允许 Controller 访问 K8s API

#### 2. 流量路径

```
用户请求(example.com/api)
    ↓
DNS 解析 → LoadBalancer/NodePort
    ↓
Ingress Controller Pod(Nginx)
    ↓(根据 Ingress 规则匹配 host 和 path)
Service(api-service:8080)
    ↓(iptables/ipvs 负载均衡)
后端 Pod(192.168.1.10:8080)
```

**关键点**:

- Ingress Controller 运行在 Pod 中,通过 Service 暴露
- Controller 直接转发到 Pod IP(跳过 Service ClusterIP),减少一层网络跳转
- 使用 Endpoint 资源实时感知 Pod 变化,动态更新 upstream

### 五、高级特性与最佳实践

#### 1. 多租户隔离:IngressClass

K8s 1.18+ 引入 `IngressClass`,允许集群中运行多个 Ingress Controller:

```yaml
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: nginx
spec:
  controller: k8s.io/ingress-nginx

---
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: traefik
spec:
  controller: traefik.io/ingress-controller
```

在 Ingress 中通过 `ingressClassName: nginx` 指定使用哪个 Controller。

#### 2. 常用 Annotations(以 Nginx 为例)

```yaml
annotations:
  # 路径重写
  nginx.ingress.kubernetes.io/rewrite-target: /$2

  # 速率限制
  nginx.ingress.kubernetes.io/limit-rps: "10"

  # 跨域配置
  nginx.ingress.kubernetes.io/enable-cors: "true"
  nginx.ingress.kubernetes.io/cors-allow-origin: "*"

  # WebSocket 支持
  nginx.ingress.kubernetes.io/websocket-services: "ws-service"

  # 自定义超时
  nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
  nginx.ingress.kubernetes.io/proxy-send-timeout: "60"

  # 灰度发布(Canary)
  nginx.ingress.kubernetes.io/canary: "true"
  nginx.ingress.kubernetes.io/canary-weight: "30"  # 30% 流量到新版本
```

#### 3. TLS 证书管理

**手动创建 Secret**:

```bash
kubectl create secret tls example-tls \
  --cert=example.crt \
  --key=example.key \
  -n default
```

**自动化方案(cert-manager)**:

```yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: example-cert
spec:
  secretName: example-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - example.com
  - "*.example.com"
```

cert-manager 会自动从 Let's Encrypt 申请证书并续期。

#### 4. 生产环境注意事项

**性能优化**:

- **增加副本数**:根据流量设置多个 Ingress Controller Pod
- **启用连接池**:减少到后端的连接开销
- **调整 worker 进程**:匹配 CPU 核心数

**高可用**:

- **多副本 + 反亲和性**:确保 Pod 分布在不同节点
- **健康检查**:配置 livenessProbe 和 readinessProbe
- **监控告警**:集成 Prometheus 监控 Nginx 指标

**安全加固**:

- **限制访问来源**:使用 `nginx.ingress.kubernetes.io/whitelist-source-range`
- **ModSecurity WAF**:启用 Web 应用防火墙
- **限流与熔断**:防止 DDoS 攻击

### 六、常见问题排查

| 问题                       | 排查方法                                                     |
| -------------------------- | ------------------------------------------------------------ |
| 404 Not Found              | 检查 Ingress 规则是否匹配 host/path,查看 Controller 日志    |
| 502 Bad Gateway            | 检查后端 Service 和 Pod 是否正常,端口是否正确                |
| TLS 证书错误               | 验证 Secret 是否存在,证书是否过期                            |
| 规则不生效                 | 检查 IngressClass 是否正确,Controller 是否运行               |
| 高延迟                     | 查看 Controller 资源使用,检查到后端的网络延迟                |

**调试命令**:

```bash
# 查看 Ingress 状态
kubectl describe ingress example-ingress

# 查看 Controller 日志
kubectl logs -n ingress-nginx deployment/nginx-ingress-controller

# 进入 Controller Pod 查看 Nginx 配置
kubectl exec -it -n ingress-nginx <pod-name> -- cat /etc/nginx/nginx.conf

# 测试后端连通性
kubectl run -it --rm debug --image=busybox -- wget -O- http://api-service:8080
```

### 七、总结

**Ingress 是 Kubernetes 实现 7 层流量管理的核心机制**,通过声明式配置统一管理 HTTP/HTTPS 路由,结合 Ingress Controller 提供灵活的流量控制能力。

**选型建议**:

- **通用场景**:Nginx Ingress(性能、功能、生态成熟度最佳)
- **简单易用**:Traefik(配置简单,适合小团队)
- **服务网格**:Istio Gateway(需要高级流量治理能力)
- **API 网关**:Kong Ingress(需要丰富的 API 管理插件)

在生产环境中,建议结合 cert-manager 自动化证书管理、Prometheus 监控、HPA 自动扩缩容等机制,构建完整的流量入口解决方案。
