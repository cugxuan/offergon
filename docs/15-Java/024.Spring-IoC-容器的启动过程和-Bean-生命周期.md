---
title: Spring IoC 容器的启动过程和 Bean 生命周期
tags:
  - Java
status: robot
class: Java
slug: spring-ioc-container-startup-bean-lifecycle
ref:
---

## 核心要点

**Spring IoC 容器启动** 经历 **BeanDefinition 加载、注册、实例化、属性注入、初始化** 等阶段；**Bean 生命周期** 包含 **实例化、属性赋值、Aware 接口回调、BeanPostProcessor 处理、初始化方法、使用、销毁** 等完整流程，通过多个扩展点实现精细化控制。

## 详细解答

### 1. Spring IoC 容器启动流程

#### 1.1 容器启动时序图

```
ApplicationContext 启动过程：
    ↓
1. 创建容器实例
    ↓
2. 加载配置信息
    ↓
3. BeanDefinition 注册
    ↓
4. BeanFactoryPostProcessor 执行
    ↓
5. Bean 实例化
    ↓
6. BeanPostProcessor 注册
    ↓
7. 特殊 Bean 初始化
    ↓
8. 容器启动完成
```

#### 1.2 AbstractApplicationContext.refresh() 方法详解

**refresh() 是容器启动的核心方法：**
```java
@Override
public void refresh() throws BeansException, IllegalStateException {
    synchronized (this.startupShutdownMonitor) {
        // 1. 准备刷新上下文环境
        prepareRefresh();

        // 2. 初始化 BeanFactory，加载 BeanDefinition
        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();

        // 3. 配置 BeanFactory 的标准上下文特性
        prepareBeanFactory(beanFactory);

        try {
            // 4. 后置处理 BeanFactory（子类扩展点）
            postProcessBeanFactory(beanFactory);

            // 5. 执行 BeanFactoryPostProcessor
            invokeBeanFactoryPostProcessors(beanFactory);

            // 6. 注册 BeanPostProcessor
            registerBeanPostProcessors(beanFactory);

            // 7. 初始化消息源（国际化）
            initMessageSource();

            // 8. 初始化事件广播器
            initApplicationEventMulticaster();

            // 9. 初始化其他特殊 Bean（子类扩展点）
            onRefresh();

            // 10. 注册监听器
            registerListeners();

            // 11. 完成 BeanFactory 初始化，实例化所有非延迟加载的单例 Bean
            finishBeanFactoryInitialization(beanFactory);

            // 12. 完成刷新，发布相应事件
            finishRefresh();
        }
        catch (BeansException ex) {
            // 销毁已创建的单例 Bean，避免资源悬挂
            destroyBeans();
            cancelRefresh(ex);
            throw ex;
        }
        finally {
            // 重置 Spring 核心的内省缓存
            resetCommonCaches();
        }
    }
}
```

#### 1.3 关键步骤详细分析

**步骤 1：prepareRefresh() - 准备刷新**
```java
protected void prepareRefresh() {
    // 记录启动时间
    this.startupDate = System.currentTimeMillis();
    this.closed.set(false);
    this.active.set(true);

    // 日志记录
    if (logger.isDebugEnabled()) {
        logger.debug("Refreshing " + this);
    }

    // 初始化属性源（子类实现）
    initPropertySources();

    // 验证必需的属性
    getEnvironment().validateRequiredProperties();

    // 准备早期事件集合
    if (this.earlyApplicationEvents == null) {
        this.earlyApplicationEvents = new LinkedHashSet<>();
    } else {
        this.earlyApplicationEvents.clear();
        this.earlyApplicationEvents.addAll(this.applicationEvents);
    }
}
```

**步骤 2：obtainFreshBeanFactory() - 获取 BeanFactory**
```java
protected ConfigurableListableBeanFactory obtainFreshBeanFactory() {
    // 刷新 BeanFactory
    refreshBeanFactory();

    // 返回刷新后的 BeanFactory
    return getBeanFactory();
}

// AbstractRefreshableApplicationContext 实现
@Override
protected final void refreshBeanFactory() throws BeansException {
    // 如果已存在 BeanFactory，则销毁所有 Bean 并关闭 BeanFactory
    if (hasBeanFactory()) {
        destroyBeans();
        closeBeanFactory();
    }

    try {
        // 创建新的 BeanFactory
        DefaultListableBeanFactory beanFactory = createBeanFactory();

        // 设置序列化 ID
        beanFactory.setSerializationId(getId());

        // 定制 BeanFactory（是否允许循环依赖等）
        customizeBeanFactory(beanFactory);

        // 加载 BeanDefinition
        loadBeanDefinitions(beanFactory);

        this.beanFactory = beanFactory;
    }
    catch (IOException ex) {
        throw new ApplicationContextException("I/O error parsing bean definition source for " + getDisplayName(), ex);
    }
}
```

**步骤 5：invokeBeanFactoryPostProcessors() - 执行 BeanFactory 后置处理器**
```java
protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) {
    // 执行 BeanFactoryPostProcessor
    PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());

    // 检测 LoadTimeWeaver
    if (beanFactory.getTempClassLoader() == null && beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) {
        beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));
        beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));
    }
}

// PostProcessorRegistrationDelegate 中的具体执行逻辑
public static void invokeBeanFactoryPostProcessors(
        ConfigurableListableBeanFactory beanFactory, List<BeanFactoryPostProcessor> beanFactoryPostProcessors) {

    Set<String> processedBeans = new HashSet<>();

    // 1. 处理 BeanDefinitionRegistryPostProcessor
    if (beanFactory instanceof BeanDefinitionRegistry) {
        BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;
        List<BeanFactoryPostProcessor> regularPostProcessors = new ArrayList<>();
        List<BeanDefinitionRegistryPostProcessor> registryProcessors = new ArrayList<>();

        // 分离 BeanDefinitionRegistryPostProcessor 和普通的 BeanFactoryPostProcessor
        for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) {
            if (postProcessor instanceof BeanDefinitionRegistryPostProcessor) {
                BeanDefinitionRegistryPostProcessor registryProcessor =
                        (BeanDefinitionRegistryPostProcessor) postProcessor;
                registryProcessor.postProcessBeanDefinitionRegistry(registry);
                registryProcessors.add(registryProcessor);
            } else {
                regularPostProcessors.add(postProcessor);
            }
        }

        // 2. 按优先级执行 BeanDefinitionRegistryPostProcessor
        List<BeanDefinitionRegistryPostProcessor> currentRegistryProcessors = new ArrayList<>();

        // 首先执行实现 PriorityOrdered 的 BeanDefinitionRegistryPostProcessor
        String[] postProcessorNames =
                beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);
        for (String ppName : postProcessorNames) {
            if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {
                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));
                processedBeans.add(ppName);
            }
        }
        sortPostProcessors(currentRegistryProcessors, beanFactory);
        registryProcessors.addAll(currentRegistryProcessors);
        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);
        currentRegistryProcessors.clear();

        // 接着执行实现 Ordered 的 BeanDefinitionRegistryPostProcessor
        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);
        for (String ppName : postProcessorNames) {
            if (!processedBeans.contains(ppName) && beanFactory.isTypeMatch(ppName, Ordered.class)) {
                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));
                processedBeans.add(ppName);
            }
        }
        sortPostProcessors(currentRegistryProcessors, beanFactory);
        registryProcessors.addAll(currentRegistryProcessors);
        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);
        currentRegistryProcessors.clear();

        // 最后执行其他 BeanDefinitionRegistryPostProcessor
        boolean reiterate = true;
        while (reiterate) {
            reiterate = false;
            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false);
            for (String ppName : postProcessorNames) {
                if (!processedBeans.contains(ppName)) {
                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));
                    processedBeans.add(ppName);
                    reiterate = true;
                }
            }
            sortPostProcessors(currentRegistryProcessors, beanFactory);
            registryProcessors.addAll(currentRegistryProcessors);
            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);
            currentRegistryProcessors.clear();
        }

        // 3. 执行普通的 BeanFactoryPostProcessor
        invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);
        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);
    }
    else {
        // 直接执行 BeanFactoryPostProcessor
        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);
    }

    // 4. 处理容器中的 BeanFactoryPostProcessor Bean
    String[] postProcessorNames =
            beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false);

    List<BeanFactoryPostProcessor> priorityOrderedPostProcessors = new ArrayList<>();
    List<String> orderedPostProcessorNames = new ArrayList<>();
    List<String> nonOrderedPostProcessorNames = new ArrayList<>();

    for (String ppName : postProcessorNames) {
        if (processedBeans.contains(ppName)) {
            // 已处理的跳过
        }
        else if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {
            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));
        }
        else if (beanFactory.isTypeMatch(ppName, Ordered.class)) {
            orderedPostProcessorNames.add(ppName);
        }
        else {
            nonOrderedPostProcessorNames.add(ppName);
        }
    }

    // 按优先级排序并执行
    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);
    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);

    List<BeanFactoryPostProcessor> orderedPostProcessors = new ArrayList<>(orderedPostProcessorNames.size());
    for (String postProcessorName : orderedPostProcessorNames) {
        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));
    }
    sortPostProcessors(orderedPostProcessors, beanFactory);
    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);

    List<BeanFactoryPostProcessor> nonOrderedPostProcessors = new ArrayList<>(nonOrderedPostProcessorNames.size());
    for (String postProcessorName : nonOrderedPostProcessorNames) {
        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));
    }
    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);

    beanFactory.clearMetadataCache();
}
```

**步骤 11：finishBeanFactoryInitialization() - 完成 Bean 初始化**
```java
protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) {
    // 初始化转换服务
    if (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &&
            beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) {
        beanFactory.setConversionService(
                beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));
    }

    // 注册默认的嵌入值解析器
    if (!beanFactory.hasEmbeddedValueResolver()) {
        beanFactory.addEmbeddedValueResolver(strVal -> getEnvironment().resolvePlaceholders(strVal));
    }

    // 初始化 LoadTimeWeaverAware Bean
    String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, false, false);
    for (String weaverAwareName : weaverAwareNames) {
        getBean(weaverAwareName);
    }

    // 停止使用临时 ClassLoader
    beanFactory.setTempClassLoader(null);

    // 冻结所有 Bean 定义，说明注册的 Bean 定义不会被修改或进一步后处理
    beanFactory.freezeConfiguration();

    // 实例化所有剩余的（非延迟初始化）单例 Bean
    beanFactory.preInstantiateSingletons();
}
```

### 2. Bean 生命周期详解

#### 2.1 Bean 生命周期流程图

```
Bean 生命周期：
    ↓
1. 实例化 (Instantiation)
    ↓
2. 属性赋值 (Populate Properties)
    ↓
3. Aware 接口回调
    ↓
4. BeanPostProcessor.postProcessBeforeInitialization()
    ↓
5. 初始化方法
    - @PostConstruct
    - InitializingBean.afterPropertiesSet()
    - init-method
    ↓
6. BeanPostProcessor.postProcessAfterInitialization()
    ↓
7. Bean 可用状态
    ↓
8. 销毁过程
    - @PreDestroy
    - DisposableBean.destroy()
    - destroy-method
```

#### 2.2 AbstractAutowireCapableBeanFactory.doCreateBean() 方法

**Bean 创建的核心方法：**
```java
protected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)
        throws BeanCreationException {

    // 1. 实例化 Bean
    BeanWrapper instanceWrapper = null;
    if (mbd.isSingleton()) {
        instanceWrapper = this.factoryBeanInstanceCache.remove(beanName);
    }
    if (instanceWrapper == null) {
        instanceWrapper = createBeanInstance(beanName, mbd, args);
    }

    Object bean = instanceWrapper.getWrappedInstance();
    Class<?> beanType = instanceWrapper.getWrappedClass();
    if (beanType != NullBean.class) {
        mbd.resolvedTargetType = beanType;
    }

    // 2. 允许 MergedBeanDefinitionPostProcessor 修改合并的 Bean 定义
    synchronized (mbd.postProcessingLock) {
        if (!mbd.postProcessed) {
            try {
                applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);
            }
            catch (Throwable ex) {
                throw new BeanCreationException(mbd.getResourceDescription(), beanName,
                        "Post-processing of merged bean definition failed", ex);
            }
            mbd.postProcessed = true;
        }
    }

    // 3. 解决循环依赖：提前暴露单例 Bean
    boolean earlySingletonExposure = (mbd.isSingleton() && this.allowCircularReferences &&
            isSingletonCurrentlyInCreation(beanName));
    if (earlySingletonExposure) {
        if (logger.isTraceEnabled()) {
            logger.trace("Eagerly caching bean '" + beanName +
                    "' to allow for resolving potential circular references");
        }
        addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));
    }

    // 4. 初始化 Bean 实例
    Object exposedObject = bean;
    try {
        // 4.1 属性赋值
        populateBean(beanName, mbd, instanceWrapper);

        // 4.2 初始化 Bean
        exposedObject = initializeBean(beanName, exposedObject, mbd);
    }
    catch (Throwable ex) {
        if (ex instanceof BeanCreationException && beanName.equals(((BeanCreationException) ex).getBeanName())) {
            throw (BeanCreationException) ex;
        }
        else {
            throw new BeanCreationException(
                    mbd.getResourceDescription(), beanName, "Initialization of bean failed", ex);
        }
    }

    // 5. 处理循环依赖
    if (earlySingletonExposure) {
        Object earlySingletonReference = getSingleton(beanName, false);
        if (earlySingletonReference != null) {
            if (exposedObject == bean) {
                exposedObject = earlySingletonReference;
            }
            else if (!this.allowRawInjectionDespiteWrapping && hasDependentBean(beanName)) {
                String[] dependentBeans = getDependentBeans(beanName);
                Set<String> actualDependentBeans = new LinkedHashSet<>(dependentBeans.length);
                for (String dependentBean : dependentBeans) {
                    if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) {
                        actualDependentBeans.add(dependentBean);
                    }
                }
                if (!actualDependentBeans.isEmpty()) {
                    throw new BeanCurrentlyInCreationException(beanName,
                            "Bean with name '" + beanName + "' has been injected into other beans [" +
                            StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +
                            "] in its raw version as part of a circular reference, but has eventually been " +
                            "wrapped. This means that said other beans do not use the final version of the " +
                            "bean. This is often the result of over-eager type matching - consider using " +
                            "'getBeanNamesForType' with the 'allowEagerInit' flag turned off, for example.");
                }
            }
        }
    }

    // 6. 注册销毁方法
    try {
        registerDisposableBeanIfNecessary(beanName, bean, mbd);
    }
    catch (BeanDefinitionValidationException ex) {
        throw new BeanCreationException(
                mbd.getResourceDescription(), beanName, "Invalid destruction signature", ex);
    }

    return exposedObject;
}
```

#### 2.3 属性赋值过程：populateBean()

```java
protected void populateBean(String beanName, RootBeanDefinition mbd, @Nullable BeanWrapper bw) {
    if (bw == null) {
        if (mbd.hasPropertyValues()) {
            throw new BeanCreationException(
                    mbd.getResourceDescription(), beanName, "Cannot apply property values to null instance");
        }
        else {
            return;
        }
    }

    // 1. InstantiationAwareBeanPostProcessor 可以控制是否继续属性赋值
    if (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {
        for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) {
            if (!bp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) {
                return;
            }
        }
    }

    PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null);

    int resolvedAutowireMode = mbd.getResolvedAutowireMode();
    if (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) {
        MutablePropertyValues newPvs = new MutablePropertyValues(pvs);

        // 2. 按名称自动装配
        if (resolvedAutowireMode == AUTOWIRE_BY_NAME) {
            autowireByName(beanName, mbd, bw, newPvs);
        }

        // 3. 按类型自动装配
        if (resolvedAutowireMode == AUTOWIRE_BY_TYPE) {
            autowireByType(beanName, mbd, bw, newPvs);
        }
        pvs = newPvs;
    }

    boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();
    boolean needsDepCheck = (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE);

    PropertyDescriptor[] filteredPds = null;
    if (hasInstAwareBpps) {
        if (pvs == null) {
            pvs = mbd.getPropertyValues();
        }

        // 4. InstantiationAwareBeanPostProcessor 处理属性值
        for (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) {
            PropertyValues pvsToUse = bp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);
            if (pvsToUse == null) {
                if (filteredPds == null) {
                    filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);
                }
                pvsToUse = bp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);
                if (pvsToUse == null) {
                    return;
                }
            }
            pvs = pvsToUse;
        }
    }

    if (needsDepCheck) {
        if (filteredPds == null) {
            filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);
        }
        checkDependencies(beanName, mbd, filteredPds, pvs);
    }

    // 5. 应用属性值
    if (pvs != null) {
        applyPropertyValues(beanName, mbd, bw, pvs);
    }
}
```

#### 2.4 Bean 初始化过程：initializeBean()

```java
protected Object initializeBean(String beanName, Object bean, @Nullable RootBeanDefinition mbd) {
    // 1. 处理 Aware 接口回调
    if (System.getSecurityManager() != null) {
        AccessController.doPrivileged((PrivilegedAction<Object>) () -> {
            invokeAwareMethods(beanName, bean);
            return null;
        }, getAccessControlContext());
    }
    else {
        invokeAwareMethods(beanName, bean);
    }

    Object wrappedBean = bean;
    if (mbd == null || !mbd.isSynthetic()) {
        // 2. BeanPostProcessor 前置处理
        wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);
    }

    try {
        // 3. 调用初始化方法
        invokeInitMethods(beanName, wrappedBean, mbd);
    }
    catch (Throwable ex) {
        throw new BeanCreationException(
                (mbd != null ? mbd.getResourceDescription() : null),
                beanName, "Invocation of init method failed", ex);
    }

    if (mbd == null || !mbd.isSynthetic()) {
        // 4. BeanPostProcessor 后置处理
        wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);
    }

    return wrappedBean;
}

// Aware 接口回调
private void invokeAwareMethods(String beanName, Object bean) {
    if (bean instanceof Aware) {
        if (bean instanceof BeanNameAware) {
            ((BeanNameAware) bean).setBeanName(beanName);
        }
        if (bean instanceof BeanClassLoaderAware) {
            ClassLoader bcl = getBeanClassLoader();
            if (bcl != null) {
                ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);
            }
        }
        if (bean instanceof BeanFactoryAware) {
            ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.this);
        }
    }
}

// 初始化方法调用
protected void invokeInitMethods(String beanName, Object bean, @Nullable RootBeanDefinition mbd)
        throws Throwable {

    // 1. 处理 InitializingBean 接口
    boolean isInitializingBean = (bean instanceof InitializingBean);
    if (isInitializingBean && (mbd == null || !mbd.isExternallyManagedInitMethod("afterPropertiesSet"))) {
        if (logger.isTraceEnabled()) {
            logger.trace("Invoking afterPropertiesSet() on bean with name '" + beanName + "'");
        }
        if (System.getSecurityManager() != null) {
            try {
                AccessController.doPrivileged((PrivilegedExceptionAction<Object>) () -> {
                    ((InitializingBean) bean).afterPropertiesSet();
                    return null;
                }, getAccessControlContext());
            }
            catch (PrivilegedActionException pae) {
                throw pae.getException();
            }
        }
        else {
            ((InitializingBean) bean).afterPropertiesSet();
        }
    }

    // 2. 处理自定义初始化方法
    if (mbd != null && bean.getClass() != NullBean.class) {
        String initMethodName = mbd.getInitMethodName();
        if (StringUtils.hasLength(initMethodName) &&
                !(isInitializingBean && "afterPropertiesSet".equals(initMethodName)) &&
                !mbd.isExternallyManagedInitMethod(initMethodName)) {
            invokeCustomInitMethod(beanName, bean, mbd);
        }
    }
}
```

### 3. BeanPostProcessor 扩展机制

#### 3.1 BeanPostProcessor 接口层次

```java
// 基础 BeanPostProcessor 接口
public interface BeanPostProcessor {

    @Nullable
    default Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        return bean;
    }

    @Nullable
    default Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        return bean;
    }
}

// 实例化感知的 BeanPostProcessor
public interface InstantiationAwareBeanPostProcessor extends BeanPostProcessor {

    @Nullable
    default Object postProcessBeforeInstantiation(Class<?> beanClass, String beanName) throws BeansException {
        return null;
    }

    default boolean postProcessAfterInstantiation(Object bean, String beanName) throws BeansException {
        return true;
    }

    @Nullable
    default PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName)
            throws BeansException {
        return null;
    }

    @Deprecated
    @Nullable
    default PropertyValues postProcessPropertyValues(
            PropertyValues pvs, PropertyDescriptor[] pds, Object bean, String beanName) throws BeansException {
        return pvs;
    }
}

// 合并 Bean 定义后置处理器
public interface MergedBeanDefinitionPostProcessor extends BeanPostProcessor {

    void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class<?> beanType, String beanName);

    default void resetBeanDefinition(String beanName) {
    }
}
```

#### 3.2 常见的 BeanPostProcessor 实现

**AutowiredAnnotationBeanPostProcessor：处理 @Autowired 注解**
```java
public class AutowiredAnnotationBeanPostProcessor implements SmartInstantiationAwareBeanPostProcessor,
        MergedBeanDefinitionPostProcessor, PriorityOrdered, BeanFactoryAware {

    @Override
    public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class<?> beanType, String beanName) {
        // 查找注入元数据
        InjectionMetadata metadata = findAutowiringMetadata(beanName, beanType, null);
        metadata.checkConfigMembers(beanDefinition);
    }

    @Override
    public PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName) {
        // 获取注入元数据
        InjectionMetadata metadata = findAutowiringMetadata(beanName, bean.getClass(), pvs);
        try {
            // 执行注入
            metadata.inject(bean, beanName, pvs);
        }
        catch (BeanCreationException ex) {
            throw ex;
        }
        catch (Throwable ex) {
            throw new BeanCreationException(beanName, "Injection of autowired dependencies failed", ex);
        }
        return pvs;
    }

    private InjectionMetadata findAutowiringMetadata(String beanName, Class<?> clazz, @Nullable PropertyValues pvs) {
        // 构建缓存键
        String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());

        // 从缓存获取
        InjectionMetadata metadata = this.injectionMetadataCache.get(cacheKey);
        if (InjectionMetadata.needsRefresh(metadata, clazz)) {
            synchronized (this.injectionMetadataCache) {
                metadata = this.injectionMetadataCache.get(cacheKey);
                if (InjectionMetadata.needsRefresh(metadata, clazz)) {
                    if (metadata != null) {
                        metadata.clear(pvs);
                    }
                    // 构建注入元数据
                    metadata = buildAutowiringMetadata(clazz);
                    this.injectionMetadataCache.put(cacheKey, metadata);
                }
            }
        }
        return metadata;
    }

    private InjectionMetadata buildAutowiringMetadata(Class<?> clazz) {
        List<InjectionMetadata.InjectedElement> elements = new ArrayList<>();
        Class<?> targetClass = clazz;

        do {
            final List<InjectionMetadata.InjectedElement> currElements = new ArrayList<>();

            // 处理字段注入
            ReflectionUtils.doWithLocalFields(targetClass, field -> {
                MergedAnnotation<?> ann = findAutowiredAnnotation(field);
                if (ann != null) {
                    if (Modifier.isStatic(field.getModifiers())) {
                        if (logger.isInfoEnabled()) {
                            logger.info("Autowired annotation is not supported on static fields: " + field);
                        }
                        return;
                    }
                    boolean required = determineRequiredStatus(ann);
                    currElements.add(new AutowiredFieldElement(field, required));
                }
            });

            // 处理方法注入
            ReflectionUtils.doWithLocalMethods(targetClass, method -> {
                Method bridgedMethod = BridgeMethodResolver.findBridgedMethod(method);
                if (!BridgeMethodResolver.isVisibilityBridgeMethodPair(method, bridgedMethod)) {
                    return;
                }
                MergedAnnotation<?> ann = findAutowiredAnnotation(bridgedMethod);
                if (ann != null && method.equals(ClassUtils.getMostSpecificMethod(method, clazz))) {
                    if (Modifier.isStatic(method.getModifiers())) {
                        if (logger.isInfoEnabled()) {
                            logger.info("Autowired annotation is not supported on static methods: " + method);
                        }
                        return;
                    }
                    if (method.getParameterCount() == 0) {
                        if (logger.isInfoEnabled()) {
                            logger.info("Autowired annotation should only be used on methods with parameters: " + method);
                        }
                    }
                    boolean required = determineRequiredStatus(ann);
                    PropertyDescriptor pd = BeanUtils.findPropertyForMethod(bridgedMethod, clazz);
                    currElements.add(new AutowiredMethodElement(method, required, pd));
                }
            });

            elements.addAll(0, currElements);
            targetClass = targetClass.getSuperclass();
        }
        while (targetClass != null && targetClass != Object.class);

        return InjectionMetadata.forElements(elements, clazz);
    }
}
```

**CommonAnnotationBeanPostProcessor：处理 @Resource、@PostConstruct、@PreDestroy**
```java
public class CommonAnnotationBeanPostProcessor extends InitDestroyAnnotationBeanPostProcessor
        implements InstantiationAwareBeanPostProcessor, BeanFactoryAware, Serializable {

    public CommonAnnotationBeanPostProcessor() {
        setOrder(Ordered.LOWEST_PRECEDENCE - 3);
        setInitAnnotationType(PostConstruct.class);
        setDestroyAnnotationType(PreDestroy.class);
        ignoreResourceType("javax.xml.ws.WebServiceContext");
    }

    @Override
    public PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName) {
        InjectionMetadata metadata = findResourceMetadata(beanName, bean.getClass(), pvs);
        try {
            metadata.inject(bean, beanName, pvs);
        }
        catch (Throwable ex) {
            throw new BeanCreationException(beanName, "Injection of resource dependencies failed", ex);
        }
        return pvs;
    }

    private InjectionMetadata findResourceMetadata(String beanName, Class<?> clazz, @Nullable PropertyValues pvs) {
        String cacheKey = (StringUtils.hasLength(beanName) ? beanName : clazz.getName());
        InjectionMetadata metadata = this.injectionMetadataCache.get(cacheKey);
        if (InjectionMetadata.needsRefresh(metadata, clazz)) {
            synchronized (this.injectionMetadataCache) {
                metadata = this.injectionMetadataCache.get(cacheKey);
                if (InjectionMetadata.needsRefresh(metadata, clazz)) {
                    if (metadata != null) {
                        metadata.clear(pvs);
                    }
                    metadata = buildResourceMetadata(clazz);
                    this.injectionMetadataCache.put(cacheKey, metadata);
                }
            }
        }
        return metadata;
    }
}
```

### 4. 实际应用案例

#### 4.1 自定义 BeanPostProcessor

**日志监控 BeanPostProcessor：**
```java
@Component
public class LoggingBeanPostProcessor implements BeanPostProcessor, PriorityOrdered {

    private static final Logger logger = LoggerFactory.getLogger(LoggingBeanPostProcessor.class);

    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        if (logger.isDebugEnabled()) {
            logger.debug("Bean [{}] before initialization", beanName);
        }

        // 为包含 @Service 注解的 Bean 添加性能监控
        if (bean.getClass().isAnnotationPresent(Service.class)) {
            return createLoggingProxy(bean, beanName);
        }

        return bean;
    }

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        if (logger.isDebugEnabled()) {
            logger.debug("Bean [{}] after initialization", beanName);
        }
        return bean;
    }

    private Object createLoggingProxy(Object target, String beanName) {
        return Proxy.newProxyInstance(
            target.getClass().getClassLoader(),
            target.getClass().getInterfaces(),
            (proxy, method, args) -> {
                long startTime = System.currentTimeMillis();
                logger.info("Method [{}] started on bean [{}]", method.getName(), beanName);

                try {
                    Object result = method.invoke(target, args);
                    long endTime = System.currentTimeMillis();
                    logger.info("Method [{}] completed on bean [{}] in {}ms",
                               method.getName(), beanName, endTime - startTime);
                    return result;
                } catch (Exception e) {
                    logger.error("Method [{}] failed on bean [{}]", method.getName(), beanName, e);
                    throw e;
                }
            }
        );
    }

    @Override
    public int getOrder() {
        return Ordered.HIGHEST_PRECEDENCE + 100;
    }
}
```

#### 4.2 Bean 生命周期完整示例

**完整生命周期演示 Bean：**
```java
@Component
public class LifecycleDemoBean implements BeanNameAware, BeanFactoryAware,
        ApplicationContextAware, InitializingBean, DisposableBean {

    private static final Logger logger = LoggerFactory.getLogger(LifecycleDemoBean.class);

    private String beanName;
    private BeanFactory beanFactory;
    private ApplicationContext applicationContext;

    @Value("${demo.message:Hello World}")
    private String message;

    public LifecycleDemoBean() {
        logger.info("1. Constructor called");
    }

    // 属性注入后（通过 @Value）
    @PostConstruct
    public void postConstruct() {
        logger.info("5. @PostConstruct called, message: {}", message);
    }

    // Aware 接口回调
    @Override
    public void setBeanName(String name) {
        this.beanName = name;
        logger.info("3. BeanNameAware.setBeanName() called: {}", name);
    }

    @Override
    public void setBeanFactory(BeanFactory beanFactory) throws BeansException {
        this.beanFactory = beanFactory;
        logger.info("3. BeanFactoryAware.setBeanFactory() called");
    }

    @Override
    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
        this.applicationContext = applicationContext;
        logger.info("3. ApplicationContextAware.setApplicationContext() called");
    }

    // InitializingBean 接口
    @Override
    public void afterPropertiesSet() throws Exception {
        logger.info("6. InitializingBean.afterPropertiesSet() called");
    }

    // 自定义初始化方法
    @Bean(initMethod = "customInit")
    public void customInit() {
        logger.info("7. Custom init method called");
    }

    // 业务方法
    public void doSomething() {
        logger.info("Business method called with message: {}", message);
    }

    // 销毁方法
    @PreDestroy
    public void preDestroy() {
        logger.info("9. @PreDestroy called");
    }

    @Override
    public void destroy() throws Exception {
        logger.info("10. DisposableBean.destroy() called");
    }

    // 自定义销毁方法
    public void customDestroy() {
        logger.info("11. Custom destroy method called");
    }
}

// 配置类
@Configuration
public class LifecycleConfig {

    @Bean(initMethod = "customInit", destroyMethod = "customDestroy")
    public LifecycleDemoBean lifecycleDemoBean() {
        return new LifecycleDemoBean();
    }
}
```

**自定义 BeanPostProcessor 监控生命周期：**
```java
@Component
public class LifecycleMonitoringBeanPostProcessor implements BeanPostProcessor {

    private static final Logger logger = LoggerFactory.getLogger(LifecycleMonitoringBeanPostProcessor.class);

    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        if (bean instanceof LifecycleDemoBean) {
            logger.info("4. BeanPostProcessor.postProcessBeforeInitialization() called for: {}", beanName);
        }
        return bean;
    }

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        if (bean instanceof LifecycleDemoBean) {
            logger.info("8. BeanPostProcessor.postProcessAfterInitialization() called for: {}", beanName);
            logger.info("Bean {} is ready for use", beanName);
        }
        return bean;
    }
}
```

### 5. 高级特性和优化

#### 5.1 循环依赖解决机制

**三级缓存机制：**
```java
public class DefaultSingletonBeanRegistry extends SimpleAliasRegistry implements SingletonBeanRegistry {

    // 一级缓存：完成初始化的单例对象
    private final Map<String, Object> singletonObjects = new ConcurrentHashMap<>(256);

    // 二级缓存：完成实例化但未初始化的对象
    private final Map<String, Object> earlySingletonObjects = new ConcurrentHashMap<>(16);

    // 三级缓存：工厂对象
    private final Map<String, ObjectFactory<?>> singletonFactories = new HashMap<>(16);

    @Nullable
    protected Object getSingleton(String beanName, boolean allowEarlyReference) {
        // 1. 从一级缓存获取
        Object singletonObject = this.singletonObjects.get(beanName);
        if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {
            // 2. 从二级缓存获取
            singletonObject = this.earlySingletonObjects.get(beanName);
            if (singletonObject == null && allowEarlyReference) {
                synchronized (this.singletonObjects) {
                    singletonObject = this.singletonObjects.get(beanName);
                    if (singletonObject == null) {
                        singletonObject = this.earlySingletonObjects.get(beanName);
                        if (singletonObject == null) {
                            // 3. 从三级缓存获取
                            ObjectFactory<?> singletonFactory = this.singletonFactories.get(beanName);
                            if (singletonFactory != null) {
                                singletonObject = singletonFactory.getObject();
                                // 提升到二级缓存
                                this.earlySingletonObjects.put(beanName, singletonObject);
                                this.singletonFactories.remove(beanName);
                            }
                        }
                    }
                }
            }
        }
        return singletonObject;
    }

    protected void addSingletonFactory(String beanName, ObjectFactory<?> singletonFactory) {
        Assert.notNull(singletonFactory, "Singleton factory must not be null");
        synchronized (this.singletonObjects) {
            if (!this.singletonObjects.containsKey(beanName)) {
                this.singletonFactories.put(beanName, singletonFactory);
                this.earlySingletonObjects.remove(beanName);
                this.registeredSingletons.add(beanName);
            }
        }
    }
}
```

#### 5.2 性能优化策略

**Bean 定义缓存优化：**
```java
@Configuration
public class BeanCacheOptimizationConfig {

    @Bean
    @Scope(ConfigurableBeanFactory.SCOPE_SINGLETON)
    public CacheManager cacheManager() {
        ConcurrentMapCacheManager cacheManager = new ConcurrentMapCacheManager();
        // 预创建常用缓存
        cacheManager.setCacheNames(Arrays.asList("beanDefinitions", "beanInstances"));
        return cacheManager;
    }

    @Bean
    public BeanDefinitionRegistryPostProcessor beanDefinitionCacheProcessor() {
        return new BeanDefinitionRegistryPostProcessor() {
            @Override
            public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException {
                // 预处理 BeanDefinition
                String[] beanNames = registry.getBeanDefinitionNames();
                logger.info("Pre-processing {} bean definitions", beanNames.length);

                for (String beanName : beanNames) {
                    BeanDefinition bd = registry.getBeanDefinition(beanName);
                    // 预解析依赖关系
                    resolveDependencies(bd);
                }
            }

            @Override
            public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {
                // BeanFactory 后处理
            }

            private void resolveDependencies(BeanDefinition bd) {
                // 依赖解析逻辑
            }
        };
    }
}
```

**延迟初始化配置：**
```java
@Configuration
@EnableAutoConfiguration
public class LazyInitializationConfig {

    @Bean
    @Lazy
    public ExpensiveResource expensiveResource() {
        return new ExpensiveResource();
    }

    @Bean
    public static LazyInitializationBeanFactoryPostProcessor lazyInitProcessor() {
        return new LazyInitializationBeanFactoryPostProcessor();
    }
}

public class LazyInitializationBeanFactoryPostProcessor implements BeanFactoryPostProcessor {

    @Override
    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {
        // 为符合条件的 Bean 设置延迟初始化
        String[] beanNames = beanFactory.getBeanDefinitionNames();
        for (String beanName : beanNames) {
            BeanDefinition bd = beanFactory.getBeanDefinition(beanName);
            if (shouldSetLazy(bd)) {
                bd.setLazyInit(true);
            }
        }
    }

    private boolean shouldSetLazy(BeanDefinition bd) {
        // 判断是否应该延迟初始化
        return bd.getBeanClassName() != null &&
               bd.getBeanClassName().contains("Heavy");
    }
}
```

### 6. 故障排查和调试

#### 6.1 容器启动问题诊断

**启动失败诊断工具：**
```java
@Component
public class ContainerDiagnostics implements ApplicationListener<ContextRefreshedEvent> {

    private static final Logger logger = LoggerFactory.getLogger(ContainerDiagnostics.class);

    @Override
    public void onApplicationEvent(ContextRefreshedEvent event) {
        ApplicationContext context = event.getApplicationContext();

        logger.info("=== Container Startup Diagnostics ===");

        // 1. 统计 Bean 数量
        String[] beanNames = context.getBeanDefinitionNames();
        logger.info("Total beans: {}", beanNames.length);

        // 2. 按类型分组统计
        Map<Class<?>, Long> beanTypeCount = Arrays.stream(beanNames)
            .collect(Collectors.groupingBy(
                name -> context.getBean(name).getClass(),
                Collectors.counting()
            ));

        logger.info("Bean types: {}", beanTypeCount.size());

        // 3. 查找重复的 Bean
        Map<Class<?>, List<String>> duplicateBeans = beanTypeCount.entrySet().stream()
            .filter(entry -> entry.getValue() > 1)
            .collect(Collectors.toMap(
                Map.Entry::getKey,
                entry -> Arrays.stream(beanNames)
                    .filter(name -> context.getBean(name).getClass().equals(entry.getKey()))
                    .collect(Collectors.toList())
            ));

        if (!duplicateBeans.isEmpty()) {
            logger.warn("Duplicate beans found: {}", duplicateBeans);
        }

        // 4. 检查循环依赖
        checkCircularDependencies(context);

        logger.info("=== Diagnostics Complete ===");
    }

    private void checkCircularDependencies(ApplicationContext context) {
        if (context instanceof ConfigurableApplicationContext) {
            ConfigurableListableBeanFactory beanFactory =
                ((ConfigurableApplicationContext) context).getBeanFactory();

            if (beanFactory instanceof DefaultListableBeanFactory) {
                DefaultListableBeanFactory factory = (DefaultListableBeanFactory) beanFactory;
                // 检查是否允许循环依赖
                logger.info("Allow circular references: {}", factory.isAllowCircularReferences());
                logger.info("Allow raw injection despite wrapping: {}", factory.isAllowRawInjectionDespiteWrapping());
            }
        }
    }
}
```

#### 6.2 Bean 生命周期追踪

**生命周期事件发布器：**
```java
public class BeanLifecycleEventPublisher implements BeanPostProcessor,
        InstantiationAwareBeanPostProcessor, ApplicationEventPublisherAware {

    private ApplicationEventPublisher eventPublisher;

    @Override
    public void setApplicationEventPublisher(ApplicationEventPublisher applicationEventPublisher) {
        this.eventPublisher = applicationEventPublisher;
    }

    @Override
    public Object postProcessBeforeInstantiation(Class<?> beanClass, String beanName) throws BeansException {
        publishEvent(new BeanLifecycleEvent(beanName, BeanLifecycleEvent.Phase.BEFORE_INSTANTIATION));
        return null;
    }

    @Override
    public boolean postProcessAfterInstantiation(Object bean, String beanName) throws BeansException {
        publishEvent(new BeanLifecycleEvent(beanName, BeanLifecycleEvent.Phase.AFTER_INSTANTIATION));
        return true;
    }

    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        publishEvent(new BeanLifecycleEvent(beanName, BeanLifecycleEvent.Phase.BEFORE_INITIALIZATION));
        return bean;
    }

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        publishEvent(new BeanLifecycleEvent(beanName, BeanLifecycleEvent.Phase.AFTER_INITIALIZATION));
        return bean;
    }

    private void publishEvent(BeanLifecycleEvent event) {
        if (eventPublisher != null) {
            eventPublisher.publishEvent(event);
        }
    }
}

// 生命周期事件
public class BeanLifecycleEvent extends ApplicationEvent {

    public enum Phase {
        BEFORE_INSTANTIATION,
        AFTER_INSTANTIATION,
        BEFORE_INITIALIZATION,
        AFTER_INITIALIZATION,
        DESTRUCTION
    }

    private final String beanName;
    private final Phase phase;

    public BeanLifecycleEvent(String beanName, Phase phase) {
        super(beanName);
        this.beanName = beanName;
        this.phase = phase;
    }

    // getters...
}
```

### 总结

Spring IoC 容器的启动过程和 Bean 生命周期体现了 Spring 框架的精心设计：

**容器启动要点：**
1. **阶段化处理**：refresh() 方法将启动过程分为 12 个明确的步骤
2. **扩展机制**：BeanFactoryPostProcessor 和 BeanPostProcessor 提供强大的扩展能力
3. **依赖管理**：通过三级缓存机制优雅解决循环依赖问题
4. **性能优化**：延迟初始化、缓存机制等提升启动性能

**Bean 生命周期要点：**
1. **完整流程**：从实例化到销毁的完整生命周期管理
2. **多重扩展点**：Aware 接口、各种后置处理器提供精细控制
3. **注解支持**：@PostConstruct、@PreDestroy 等注解简化配置
4. **资源管理**：自动处理资源的创建和清理

掌握这些机制对于 Spring 应用的开发、调优和问题排查都具有重要价值。
