---
title: JavaScript çš„äºŒè¿›åˆ¶æ•°æ®å¤„ç†ï¼ˆArrayBufferã€TypedArrayï¼‰
tags:
  - å‰ç«¯JavaScript
status: robot
class: å‰ç«¯JavaScript
slug: javascript-binary-data-arraybuffer-typedarray
ref:
---

## æ ¸å¿ƒè¦ç‚¹

JavaScript äºŒè¿›åˆ¶æ•°æ®å¤„ç†åŸºäºä¸‰å¤§æ ¸å¿ƒ APIï¼š**ArrayBuffer**ï¼ˆå›ºå®šé•¿åº¦åŸå§‹äºŒè¿›åˆ¶ç¼“å†²åŒºï¼‰ã€**TypedArray**ï¼ˆç±»å‹åŒ–æ•°ç»„è§†å›¾ï¼Œå¦‚ Uint8Arrayã€Float32Arrayï¼‰ã€**DataView**ï¼ˆçµæ´»çš„å¤šç±»å‹è§†å›¾ï¼‰ã€‚å…¸å‹åº”ç”¨åœºæ™¯ï¼š**æ–‡ä»¶æ“ä½œ**ï¼ˆFile APIï¼‰ã€**ç½‘ç»œé€šä¿¡**ï¼ˆWebSocket äºŒè¿›åˆ¶ï¼‰ã€**Canvas å›¾åƒå¤„ç†**ã€**éŸ³è§†é¢‘ç¼–è§£ç **ã€**WebAssembly å†…å­˜äº¤äº’**ã€‚å…³é”®ç‰¹æ€§ï¼š**é›¶æ‹·è´è§†å›¾**ã€**å­—èŠ‚åºæ§åˆ¶**ã€**é«˜æ€§èƒ½**ã€**Transferable Objects æ”¯æŒ**ã€‚

---

## è¯¦ç»†è§£ç­”

### ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦äºŒè¿›åˆ¶æ•°æ®å¤„ç†

JavaScript æœ€åˆæ˜¯ä¸º Web è®¾è®¡çš„è„šæœ¬è¯­è¨€ï¼Œä¸»è¦å¤„ç†æ–‡æœ¬æ•°æ®ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€‚ä½†éšç€ Web åº”ç”¨çš„å‘å±•ï¼Œå‡ºç°äº†å¤§é‡äºŒè¿›åˆ¶æ•°æ®å¤„ç†éœ€æ±‚ï¼š

**å…¸å‹åœºæ™¯ï¼š**
- ğŸ“ **æ–‡ä»¶æ“ä½œ**ï¼šè¯»å–/ä¸Šä¼ å›¾ç‰‡ã€è§†é¢‘ã€PDF ç­‰äºŒè¿›åˆ¶æ–‡ä»¶
- ğŸŒ **ç½‘ç»œé€šä¿¡**ï¼šWebSocket å‘é€/æ¥æ”¶äºŒè¿›åˆ¶æ•°æ®
- ğŸ–¼ï¸ **å›¾åƒå¤„ç†**ï¼šCanvas åƒç´ æ“ä½œã€å›¾åƒæ»¤é•œ
- ğŸµ **éŸ³è§†é¢‘**ï¼šWeb Audio APIã€è§†é¢‘ç¼–è§£ç 
- ğŸ” **åŠ å¯†**ï¼šCrypto API å¤„ç†å¯†é’¥å’ŒåŠ å¯†æ•°æ®
- âš™ï¸ **WebAssembly**ï¼šä¸ WASM æ¨¡å—å…±äº«å†…å­˜

**ä¼ ç»Ÿå­—ç¬¦ä¸²æ–¹å¼çš„é—®é¢˜ï¼š**
```javascript
// ä¸è‰¯å®è·µï¼šç”¨å­—ç¬¦ä¸²å¤„ç†äºŒè¿›åˆ¶æ•°æ®
const binaryString = '\x89PNG\r\n\x1a\n'; // å®¹æ˜“å‡ºé”™ï¼Œæ€§èƒ½å·®
```

**äºŒè¿›åˆ¶ API çš„ä¼˜åŠ¿ï¼š**
- âœ… æ€§èƒ½é«˜ï¼ˆç›´æ¥æ“ä½œå†…å­˜ï¼Œæ— éœ€ç¼–ç è½¬æ¢ï¼‰
- âœ… ç±»å‹å®‰å…¨ï¼ˆå¼ºåˆ¶ç±»å‹ï¼Œé¿å…æ•°æ®æŸåï¼‰
- âœ… å†…å­˜é«˜æ•ˆï¼ˆé›¶æ‹·è´è§†å›¾ï¼‰
- âœ… ä¸åº•å±‚ API å…¼å®¹ï¼ˆWebGLã€WebAssemblyã€File APIï¼‰

### äºŒã€ArrayBufferï¼ˆæ•°ç»„ç¼“å†²åŒºï¼‰

#### 2.1 ä»€ä¹ˆæ˜¯ ArrayBuffer

**ArrayBuffer** æ˜¯å›ºå®šé•¿åº¦çš„**åŸå§‹äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒº**ã€‚å®ƒæœ¬èº«æ— æ³•ç›´æ¥è¯»å†™ï¼Œå¿…é¡»é€šè¿‡"è§†å›¾"ï¼ˆTypedArray æˆ– DataViewï¼‰è®¿é—®ã€‚

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**
- å›ºå®šé•¿åº¦ï¼ˆåˆ›å»ºåä¸å¯æ”¹å˜å¤§å°ï¼‰
- è¿ç»­å†…å­˜å—
- æ— æ³•ç›´æ¥è®¿é—®å†…å®¹
- å¯ä»¥åœ¨ Web Workers é—´è½¬ç§»ï¼ˆTransferableï¼‰

```javascript
// åˆ›å»º 16 å­—èŠ‚çš„ ArrayBuffer
const buffer = new ArrayBuffer(16);
console.log(buffer.byteLength); // 16

// æ— æ³•ç›´æ¥è¯»å†™
console.log(buffer[0]); // undefined - å¿…é¡»é€šè¿‡è§†å›¾è®¿é—®
```

#### 2.2 åˆ›å»ºå’ŒåŸºæœ¬æ“ä½œ

```javascript
// åˆ›å»º ArrayBuffer
const buffer = new ArrayBuffer(8); // 8 å­—èŠ‚

// å±æ€§
console.log(buffer.byteLength); // 8

// åˆ‡ç‰‡ï¼ˆåˆ›å»ºå‰¯æœ¬ï¼‰
const slice = buffer.slice(0, 4); // å¤åˆ¶å‰ 4 å­—èŠ‚
console.log(slice.byteLength); // 4

// åˆ¤æ–­æ˜¯å¦æ˜¯ ArrayBuffer
console.log(ArrayBuffer.isView(buffer)); // false - ArrayBuffer æœ¬èº«ä¸æ˜¯è§†å›¾
```

### ä¸‰ã€TypedArrayï¼ˆç±»å‹åŒ–æ•°ç»„ï¼‰

#### 3.1 ä»€ä¹ˆæ˜¯ TypedArray

**TypedArray** æ˜¯ä¸€ç»„ç±»å‹åŒ–æ•°ç»„è§†å›¾ï¼Œç”¨äºè¯»å†™ ArrayBuffer ä¸­çš„æ•°æ®ã€‚å®ƒä¸æ˜¯æ„é€ å‡½æ•°ï¼Œè€Œæ˜¯ 9 ç§å…·ä½“ç±»å‹çš„ç»Ÿç§°ã€‚

**æ‰€æœ‰ TypedArray ç±»å‹ï¼š**

| ç±»å‹ | å­—èŠ‚æ•° | æè¿° | å–å€¼èŒƒå›´ |
|------|--------|------|---------|
| `Int8Array` | 1 | 8 ä½æœ‰ç¬¦å·æ•´æ•° | -128 ~ 127 |
| `Uint8Array` | 1 | 8 ä½æ— ç¬¦å·æ•´æ•° | 0 ~ 255 |
| `Uint8ClampedArray` | 1 | 8 ä½æ— ç¬¦å·æ•´æ•°ï¼ˆæº¢å‡ºæˆªæ–­ï¼‰ | 0 ~ 255 |
| `Int16Array` | 2 | 16 ä½æœ‰ç¬¦å·æ•´æ•° | -32768 ~ 32767 |
| `Uint16Array` | 2 | 16 ä½æ— ç¬¦å·æ•´æ•° | 0 ~ 65535 |
| `Int32Array` | 4 | 32 ä½æœ‰ç¬¦å·æ•´æ•° | -2Â³Â¹ ~ 2Â³Â¹-1 |
| `Uint32Array` | 4 | 32 ä½æ— ç¬¦å·æ•´æ•° | 0 ~ 2Â³Â²-1 |
| `Float32Array` | 4 | 32 ä½æµ®ç‚¹æ•° | IEEE 754 å•ç²¾åº¦ |
| `Float64Array` | 8 | 64 ä½æµ®ç‚¹æ•° | IEEE 754 åŒç²¾åº¦ |
| `BigInt64Array` | 8 | 64 ä½æœ‰ç¬¦å·æ•´æ•°ï¼ˆBigIntï¼‰ | -2â¶Â³ ~ 2â¶Â³-1 |
| `BigUint64Array` | 8 | 64 ä½æ— ç¬¦å·æ•´æ•°ï¼ˆBigIntï¼‰ | 0 ~ 2â¶â´-1 |

#### 3.2 åˆ›å»º TypedArray

**æ–¹å¼ä¸€ï¼šä» ArrayBuffer åˆ›å»ºï¼ˆè§†å›¾ï¼‰**

```javascript
const buffer = new ArrayBuffer(16);

// åˆ›å»º Int32Array è§†å›¾ï¼ˆ4 å­—èŠ‚æ•´æ•°ï¼‰
const int32View = new Int32Array(buffer);
console.log(int32View.length); // 4ï¼ˆ16 å­—èŠ‚ / 4 å­—èŠ‚ï¼‰

// åˆ›å»º Uint8Array è§†å›¾ï¼ˆ1 å­—èŠ‚æ•´æ•°ï¼‰
const uint8View = new Uint8Array(buffer);
console.log(uint8View.length); // 16ï¼ˆ16 å­—èŠ‚ / 1 å­—èŠ‚ï¼‰

// åŒä¸€ä¸ª buffer å¯ä»¥æœ‰å¤šä¸ªè§†å›¾
int32View[0] = 305419896; // 0x12345678
console.log(uint8View[0]); // 120ï¼ˆ0x78ï¼Œå°ç«¯åºï¼‰
console.log(uint8View[1]); // 86ï¼ˆ0x56ï¼‰
```

**æ–¹å¼äºŒï¼šæŒ‡å®šåç§»å’Œé•¿åº¦**

```javascript
const buffer = new ArrayBuffer(16);

// ä»å­—èŠ‚ 4 å¼€å§‹ï¼Œé•¿åº¦ä¸º 8 å­—èŠ‚çš„è§†å›¾
const view = new Uint8Array(buffer, 4, 8);
console.log(view.byteOffset); // 4
console.log(view.byteLength); // 8
console.log(view.length); // 8
```

**æ–¹å¼ä¸‰ï¼šç›´æ¥åˆ›å»ºï¼ˆè‡ªåŠ¨åˆ†é… ArrayBufferï¼‰**

```javascript
// åˆ›å»ºé•¿åº¦ä¸º 8 çš„ Uint8Array
const uint8 = new Uint8Array(8);
console.log(uint8.buffer); // ArrayBuffer { byteLength: 8 }
console.log(uint8.byteLength); // 8

// ä»æ•°ç»„åˆ›å»º
const arr = new Uint8Array([1, 2, 3, 4]);
console.log(arr); // Uint8Array(4) [1, 2, 3, 4]

// ä»å¦ä¸€ä¸ª TypedArray åˆ›å»ºï¼ˆå¤åˆ¶æ•°æ®ï¼‰
const copy = new Uint8Array(arr);
copy[0] = 100;
console.log(arr[0]); // 1ï¼ˆåŸæ•°ç»„ä¸å˜ï¼‰
```

#### 3.3 TypedArray æ“ä½œ

```javascript
const arr = new Uint8Array([10, 20, 30, 40, 50]);

// 1. ç´¢å¼•è®¿é—®
console.log(arr[2]); // 30
arr[2] = 35;

// 2. æ•°ç»„æ–¹æ³•ï¼ˆç±»ä¼¼æ™®é€šæ•°ç»„ï¼‰
arr.forEach((val, idx) => console.log(idx, val));
const doubled = arr.map(x => x * 2);
const filtered = arr.filter(x => x > 25);
const sum = arr.reduce((acc, x) => acc + x, 0);

// 3. åˆ‡ç‰‡ï¼ˆåˆ›å»ºæ–° TypedArrayï¼‰
const slice = arr.slice(1, 4); // Uint8Array(3) [20, 30, 40]

// 4. å­æ•°ç»„ï¼ˆå…±äº« bufferï¼‰
const subarray = arr.subarray(1, 4);
subarray[0] = 99;
console.log(arr[1]); // 99ï¼ˆå…±äº«åº•å±‚ bufferï¼‰

// 5. å¡«å……
arr.fill(0); // å…¨éƒ¨å¡«å……ä¸º 0
arr.fill(255, 2, 4); // ç´¢å¼• 2-4 å¡«å…… 255

// 6. å¤åˆ¶
const target = new Uint8Array(5);
target.set([1, 2, 3]); // ä»ç´¢å¼• 0 å¼€å§‹å¤åˆ¶
target.set([4, 5], 3); // ä»ç´¢å¼• 3 å¼€å§‹å¤åˆ¶
console.log(target); // Uint8Array(5) [1, 2, 3, 4, 5]

// 7. åè½¬
arr.reverse();

// 8. æ’åº
arr.sort((a, b) => a - b);
```

#### 3.4 Uint8ClampedArray çš„ç‰¹æ®Šè¡Œä¸º

```javascript
// æ™®é€š Uint8Arrayï¼šæº¢å‡ºå›ç»•
const normal = new Uint8Array(2);
normal[0] = 256; // 256 % 256 = 0
normal[1] = -1;  // 256 + (-1) = 255
console.log(normal); // Uint8Array(2) [0, 255]

// Uint8ClampedArrayï¼šæº¢å‡ºæˆªæ–­
const clamped = new Uint8ClampedArray(2);
clamped[0] = 256; // æˆªæ–­ä¸º 255
clamped[1] = -1;  // æˆªæ–­ä¸º 0
console.log(clamped); // Uint8ClampedArray(2) [255, 0]

// Canvas ImageData ä½¿ç”¨ Uint8ClampedArray
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
const imageData = ctx.createImageData(100, 100);
console.log(imageData.data); // Uint8ClampedArray(40000)
```

### å››ã€DataViewï¼ˆæ•°æ®è§†å›¾ï¼‰

#### 4.1 ä»€ä¹ˆæ˜¯ DataView

**DataView** æä¾›æ›´çµæ´»çš„è§†å›¾ï¼Œæ”¯æŒï¼š
- è¯»å†™ä»»æ„ä½ç½®çš„ä»»æ„ç±»å‹æ•°æ®
- æ§åˆ¶å­—èŠ‚åºï¼ˆå¤§ç«¯/å°ç«¯ï¼‰
- ä¸å¯¹é½è®¿é—®

**vs TypedArrayï¼š**
- TypedArrayï¼šå›ºå®šç±»å‹ã€è‡ªåŠ¨å¯¹é½ã€æ“ä½œç®€å•
- DataViewï¼šå¤šç±»å‹æ··åˆã€å¯æ§å­—èŠ‚åºã€æ“ä½œçµæ´»

```javascript
const buffer = new ArrayBuffer(16);
const view = new DataView(buffer);

// åœ¨åŒä¸€ä¸ª buffer ä¸­æ··åˆå­˜å‚¨ä¸åŒç±»å‹
view.setInt8(0, 127);        // åç§» 0ï¼š1 å­—èŠ‚æ•´æ•°
view.setUint16(1, 65535);    // åç§» 1ï¼š2 å­—èŠ‚æ•´æ•°
view.setFloat32(3, 3.14);    // åç§» 3ï¼š4 å­—èŠ‚æµ®ç‚¹æ•°

// è¯»å–æ•°æ®
console.log(view.getInt8(0));      // 127
console.log(view.getUint16(1));    // 65535
console.log(view.getFloat32(3));   // 3.140000104904175
```

#### 4.2 DataView æ–¹æ³•

**è¯»å–æ–¹æ³•ï¼š**
```javascript
const buffer = new ArrayBuffer(8);
const view = new DataView(buffer);

// è®¾ç½®æ•°æ®
view.setUint32(0, 0x12345678);

// è¯»å–ï¼ˆé»˜è®¤å¤§ç«¯åºï¼‰
console.log(view.getUint32(0).toString(16)); // 12345678

// è¯»å–ï¼ˆå°ç«¯åºï¼‰
console.log(view.getUint32(0, true).toString(16)); // 78563412
```

**æ‰€æœ‰è¯»å†™æ–¹æ³•ï¼š**
| æ–¹æ³• | å­—èŠ‚æ•° | è¯´æ˜ |
|------|--------|------|
| `getInt8() / setInt8()` | 1 | æœ‰ç¬¦å· 8 ä½æ•´æ•° |
| `getUint8() / setUint8()` | 1 | æ— ç¬¦å· 8 ä½æ•´æ•° |
| `getInt16() / setInt16()` | 2 | æœ‰ç¬¦å· 16 ä½æ•´æ•° |
| `getUint16() / setUint16()` | 2 | æ— ç¬¦å· 16 ä½æ•´æ•° |
| `getInt32() / setInt32()` | 4 | æœ‰ç¬¦å· 32 ä½æ•´æ•° |
| `getUint32() / setUint32()` | 4 | æ— ç¬¦å· 32 ä½æ•´æ•° |
| `getFloat32() / setFloat32()` | 4 | 32 ä½æµ®ç‚¹æ•° |
| `getFloat64() / setFloat64()` | 8 | 64 ä½æµ®ç‚¹æ•° |
| `getBigInt64() / setBigInt64()` | 8 | æœ‰ç¬¦å· 64 ä½æ•´æ•°ï¼ˆBigIntï¼‰ |
| `getBigUint64() / setBigUint64()` | 8 | æ— ç¬¦å· 64 ä½æ•´æ•°ï¼ˆBigIntï¼‰ |

#### 4.3 å­—èŠ‚åºï¼ˆEndiannessï¼‰

**å¤§ç«¯åºï¼ˆBig-Endianï¼‰ï¼š** é«˜ä½å­—èŠ‚å­˜å‚¨åœ¨ä½åœ°å€
**å°ç«¯åºï¼ˆLittle-Endianï¼‰ï¼š** ä½ä½å­—èŠ‚å­˜å‚¨åœ¨ä½åœ°å€

```javascript
const buffer = new ArrayBuffer(4);
const view = new DataView(buffer);

// å­˜å‚¨ 0x12345678
view.setUint32(0, 0x12345678, false); // å¤§ç«¯åº

const uint8 = new Uint8Array(buffer);
console.log([...uint8].map(b => b.toString(16)));
// ['12', '34', '56', '78'] - å¤§ç«¯åº

// å­˜å‚¨ä¸ºå°ç«¯åº
view.setUint32(0, 0x12345678, true);
console.log([...uint8].map(b => b.toString(16)));
// ['78', '56', '34', '12'] - å°ç«¯åº

// æ£€æµ‹ç³»ç»Ÿå­—èŠ‚åº
function isLittleEndian() {
  const buffer = new ArrayBuffer(2);
  new DataView(buffer).setUint16(0, 256, true);
  return new Uint16Array(buffer)[0] === 256;
}
console.log('ç³»ç»Ÿæ˜¯å°ç«¯åº:', isLittleEndian()); // å¤§å¤šæ•°ç°ä»£ç³»ç»Ÿï¼štrue
```

### äº”ã€å®æˆ˜æ¡ˆä¾‹

#### 5.1 æ¡ˆä¾‹ä¸€ï¼šè¯»å–æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®

```javascript
// è¯»å–æ–‡ä»¶ä¸º ArrayBuffer
async function readFileAsArrayBuffer(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

// åˆ†æ PNG æ–‡ä»¶å¤´
async function parsePNG(file) {
  const buffer = await readFileAsArrayBuffer(file);
  const view = new DataView(buffer);

  // PNG æ–‡ä»¶ç­¾åï¼š89 50 4E 47 0D 0A 1A 0A
  const signature = [
    view.getUint8(0).toString(16),
    view.getUint8(1).toString(16),
    view.getUint8(2).toString(16),
    view.getUint8(3).toString(16)
  ].join(' ');

  console.log('æ–‡ä»¶ç­¾å:', signature); // 89 50 4e 47

  // è¯»å–ç¬¬ä¸€ä¸ª chunkï¼ˆIHDRï¼‰
  const chunkLength = view.getUint32(8); // å¤§ç«¯åº
  const chunkType = String.fromCharCode(
    view.getUint8(12),
    view.getUint8(13),
    view.getUint8(14),
    view.getUint8(15)
  );

  console.log('ç¬¬ä¸€ä¸ª chunk:', chunkType); // 'IHDR'
  console.log('chunk é•¿åº¦:', chunkLength);

  // è¯»å–å›¾åƒå®½é«˜
  const width = view.getUint32(16);
  const height = view.getUint32(20);
  console.log('å›¾åƒå°ºå¯¸:', `${width}x${height}`);
}

// ä½¿ç”¨
document.getElementById('file-input').addEventListener('change', e => {
  const file = e.target.files[0];
  if (file.type === 'image/png') {
    parsePNG(file);
  }
});
```

#### 5.2 æ¡ˆä¾‹äºŒï¼šCanvas å›¾åƒå¤„ç†

```javascript
// å›¾åƒç°åº¦åŒ–
function grayscaleImage(canvas) {
  const ctx = canvas.getContext('2d');
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data; // Uint8ClampedArray

  // RGBA æ ¼å¼ï¼šæ¯ 4 å­—èŠ‚è¡¨ç¤ºä¸€ä¸ªåƒç´ 
  for (let i = 0; i < data.length; i += 4) {
    const r = data[i];
    const g = data[i + 1];
    const b = data[i + 2];

    // ç°åº¦å…¬å¼
    const gray = 0.299 * r + 0.587 * g + 0.114 * b;

    data[i] = data[i + 1] = data[i + 2] = gray;
    // data[i + 3] æ˜¯ alpha é€šé“ï¼Œä¸ä¿®æ”¹
  }

  ctx.putImageData(imageData, 0, 0);
}

// å›¾åƒåè‰²
function invertImage(canvas) {
  const ctx = canvas.getContext('2d');
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;

  for (let i = 0; i < data.length; i += 4) {
    data[i] = 255 - data[i];       // R
    data[i + 1] = 255 - data[i + 1]; // G
    data[i + 2] = 255 - data[i + 2]; // B
  }

  ctx.putImageData(imageData, 0, 0);
}
```

#### 5.3 æ¡ˆä¾‹ä¸‰ï¼šWebSocket äºŒè¿›åˆ¶é€šä¿¡

```javascript
// å‘é€äºŒè¿›åˆ¶æ•°æ®
const socket = new WebSocket('wss://example.com');
socket.binaryType = 'arraybuffer'; // è®¾ç½®æ¥æ”¶ç±»å‹

// å‘é€ Float32Array
socket.addEventListener('open', () => {
  const data = new Float32Array([1.5, 2.7, 3.9]);
  socket.send(data.buffer);
});

// æ¥æ”¶äºŒè¿›åˆ¶æ•°æ®
socket.addEventListener('message', event => {
  if (event.data instanceof ArrayBuffer) {
    const view = new DataView(event.data);

    // åè®®ç¤ºä¾‹ï¼šå‰ 4 å­—èŠ‚æ˜¯æ¶ˆæ¯ç±»å‹ï¼Œåç»­æ˜¯æ•°æ®
    const messageType = view.getUint32(0);

    switch (messageType) {
      case 1: // æ–‡æœ¬æ¶ˆæ¯
        const text = new TextDecoder().decode(event.data.slice(4));
        console.log('æ–‡æœ¬:', text);
        break;
      case 2: // æµ®ç‚¹æ•°ç»„
        const floats = new Float32Array(event.data, 4);
        console.log('æµ®ç‚¹æ•°ç»„:', floats);
        break;
    }
  }
});
```

#### 5.4 æ¡ˆä¾‹å››ï¼šè‡ªå®šä¹‰äºŒè¿›åˆ¶åè®®

```javascript
// å®šä¹‰åè®®ï¼šæ¶ˆæ¯å¤´ï¼ˆ8 å­—èŠ‚ï¼‰+ æ•°æ®
// [0-3]: æ¶ˆæ¯ç±»å‹ï¼ˆUint32ï¼‰
// [4-7]: æ•°æ®é•¿åº¦ï¼ˆUint32ï¼‰
// [8-n]: å®é™…æ•°æ®

class BinaryProtocol {
  static HEADER_SIZE = 8;

  // ç¼–ç æ¶ˆæ¯
  static encode(type, data) {
    const dataBytes = new TextEncoder().encode(data);
    const buffer = new ArrayBuffer(this.HEADER_SIZE + dataBytes.length);
    const view = new DataView(buffer);

    // å†™å…¥å¤´éƒ¨
    view.setUint32(0, type);
    view.setUint32(4, dataBytes.length);

    // å†™å…¥æ•°æ®
    const uint8 = new Uint8Array(buffer);
    uint8.set(dataBytes, this.HEADER_SIZE);

    return buffer;
  }

  // è§£ç æ¶ˆæ¯
  static decode(buffer) {
    const view = new DataView(buffer);

    // è¯»å–å¤´éƒ¨
    const type = view.getUint32(0);
    const length = view.getUint32(4);

    // è¯»å–æ•°æ®
    const dataBytes = new Uint8Array(buffer, this.HEADER_SIZE, length);
    const data = new TextDecoder().decode(dataBytes);

    return { type, data };
  }
}

// ä½¿ç”¨
const encoded = BinaryProtocol.encode(1, 'Hello World');
console.log('ç¼–ç å:', new Uint8Array(encoded));

const decoded = BinaryProtocol.decode(encoded);
console.log('è§£ç å:', decoded); // { type: 1, data: 'Hello World' }
```

#### 5.5 æ¡ˆä¾‹äº”ï¼šé«˜æ€§èƒ½æ•°æ®ä¼ è¾“ï¼ˆTransferable Objectsï¼‰

```javascript
// ä¸»çº¿ç¨‹
const worker = new Worker('worker.js');

// åˆ›å»ºå¤§æ•°ç»„
const buffer = new ArrayBuffer(1024 * 1024 * 100); // 100MB
const data = new Uint8Array(buffer);
data[0] = 255;

console.log('ä¼ è¾“å‰ buffer å¤§å°:', buffer.byteLength); // 104857600

// è½¬ç§»æ‰€æœ‰æƒï¼ˆé›¶æ‹·è´ï¼‰
worker.postMessage({ buffer }, [buffer]);

console.log('ä¼ è¾“å buffer å¤§å°:', buffer.byteLength); // 0ï¼ˆå·²å¤±å»æ‰€æœ‰æƒï¼‰

// Worker çº¿ç¨‹ï¼ˆworker.jsï¼‰
self.addEventListener('message', e => {
  const buffer = e.data.buffer;
  console.log('Worker æ”¶åˆ° buffer:', buffer.byteLength); // 104857600

  const data = new Uint8Array(buffer);
  console.log('ç¬¬ä¸€ä¸ªå­—èŠ‚:', data[0]); // 255

  // å¤„ç†æ•°æ®...
  for (let i = 0; i < data.length; i++) {
    data[i] = (data[i] + 1) % 256;
  }

  // è½¬ç§»å›ä¸»çº¿ç¨‹
  self.postMessage({ buffer }, [buffer]);
});
```

### å…­ã€æ–‡æœ¬ç¼–è§£ç 

#### 6.1 TextEncoder / TextDecoder

```javascript
// å­—ç¬¦ä¸² â†’ Uint8Array
const encoder = new TextEncoder();
const encoded = encoder.encode('Hello ä¸–ç•Œ');
console.log(encoded); // Uint8Array(12) [72, 101, 108, 108, 111, 32, 228, 184, 150, 231, 149, 140]

// Uint8Array â†’ å­—ç¬¦ä¸²
const decoder = new TextDecoder('utf-8');
const decoded = decoder.decode(encoded);
console.log(decoded); // 'Hello ä¸–ç•Œ'

// åˆ†å—è§£ç ï¼ˆæµå¼å¤„ç†ï¼‰
const decoder2 = new TextDecoder();
const chunk1 = new Uint8Array([72, 101]); // 'He'
const chunk2 = new Uint8Array([108, 108, 111]); // 'llo'

console.log(decoder2.decode(chunk1, { stream: true })); // 'He'
console.log(decoder2.decode(chunk2)); // 'llo'

// ä¸åŒç¼–ç 
const decoder3 = new TextDecoder('gbk');
// æ³¨æ„ï¼šæµè§ˆå™¨å¯¹æŸäº›ç¼–ç æ”¯æŒæœ‰é™
```

#### 6.2 Base64 ç¼–è§£ç 

```javascript
// ArrayBuffer â†’ Base64
function arrayBufferToBase64(buffer) {
  const bytes = new Uint8Array(buffer);
  let binary = '';
  for (let i = 0; i < bytes.length; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

// Base64 â†’ ArrayBuffer
function base64ToArrayBuffer(base64) {
  const binary = atob(base64);
  const buffer = new ArrayBuffer(binary.length);
  const bytes = new Uint8Array(buffer);
  for (let i = 0; i < binary.length; i++) {
    bytes[i] = binary.charCodeAt(i);
  }
  return buffer;
}

// ä½¿ç”¨
const buffer = new Uint8Array([72, 101, 108, 108, 111]).buffer;
const base64 = arrayBufferToBase64(buffer);
console.log(base64); // 'SGVsbG8='

const restored = base64ToArrayBuffer(base64);
console.log(new Uint8Array(restored)); // Uint8Array(5) [72, 101, 108, 108, 111]
```

### ä¸ƒã€æ€§èƒ½ä¼˜åŒ–

#### 7.1 TypedArray vs æ™®é€šæ•°ç»„

```javascript
// æ€§èƒ½å¯¹æ¯”
const SIZE = 1000000;

// æ™®é€šæ•°ç»„
console.time('æ™®é€šæ•°ç»„');
const normalArray = new Array(SIZE);
for (let i = 0; i < SIZE; i++) {
  normalArray[i] = i * 2;
}
console.timeEnd('æ™®é€šæ•°ç»„'); // ~15ms

// TypedArray
console.time('TypedArray');
const typedArray = new Uint32Array(SIZE);
for (let i = 0; i < SIZE; i++) {
  typedArray[i] = i * 2;
}
console.timeEnd('TypedArray'); // ~5msï¼ˆå¿« 3 å€ï¼‰
```

#### 7.2 é›¶æ‹·è´è§†å›¾

```javascript
// ä¸å¥½ï¼šåˆ›å»ºæ–°æ•°ç»„ï¼ˆå¤åˆ¶æ•°æ®ï¼‰
const buffer = new ArrayBuffer(1000000);
const copy = new Uint8Array(buffer).slice(); // å¤åˆ¶

// å¥½ï¼šä½¿ç”¨ subarrayï¼ˆå…±äº« bufferï¼‰
const view = new Uint8Array(buffer).subarray(0, 100); // é›¶æ‹·è´
```

#### 7.3 æ‰¹é‡æ“ä½œ

```javascript
// ä¸å¥½ï¼šé€ä¸ªèµ‹å€¼
const arr = new Uint8Array(1000);
for (let i = 0; i < 1000; i++) {
  arr[i] = i % 256;
}

// å¥½ï¼šæ‰¹é‡æ“ä½œ
const arr2 = new Uint8Array(1000);
const source = new Uint8Array(Array.from({ length: 1000 }, (_, i) => i % 256));
arr2.set(source); // æ‰¹é‡å¤åˆ¶ï¼Œæ›´å¿«
```

### å…«ã€æ³¨æ„äº‹é¡¹ä¸å¸¸è§é™·é˜±

#### 8.1 TypedArray æº¢å‡º

```javascript
const arr = new Uint8Array(2);
arr[0] = 256; // æº¢å‡ºï¼š256 % 256 = 0
arr[1] = -1;  // è´Ÿæ•°ï¼š256 + (-1) = 255
console.log(arr); // Uint8Array(2) [0, 255]
```

#### 8.2 å­—èŠ‚å¯¹é½

```javascript
// Int32Array è¦æ±‚ 4 å­—èŠ‚å¯¹é½
const buffer = new ArrayBuffer(16);

// æ­£ç¡®ï¼šåç§»é‡æ˜¯ 4 çš„å€æ•°
const aligned = new Int32Array(buffer, 4, 2); // OK

// é”™è¯¯ï¼šåç§»é‡ä¸å¯¹é½
try {
  const unaligned = new Int32Array(buffer, 1, 2); // RangeError
} catch (e) {
  console.error(e.message); // åç§»é‡å¿…é¡»æ˜¯ 4 çš„å€æ•°
}
```

#### 8.3 æµè§ˆå™¨å…¼å®¹æ€§

```javascript
// æ£€æµ‹æ”¯æŒ
if (typeof ArrayBuffer !== 'undefined') {
  console.log('æ”¯æŒ ArrayBuffer');
}

if (typeof BigInt64Array !== 'undefined') {
  console.log('æ”¯æŒ BigInt TypedArray');
}
```

### ä¹ã€é¢è¯•é«˜é¢‘é—®é¢˜

**Q1: ArrayBuffer å’Œ TypedArray çš„å…³ç³»ï¼Ÿ**

A: ArrayBuffer æ˜¯åŸå§‹äºŒè¿›åˆ¶ç¼“å†²åŒºï¼Œæ— æ³•ç›´æ¥è®¿é—®ã€‚TypedArray æ˜¯ ArrayBuffer çš„"è§†å›¾"ï¼Œæä¾›ç±»å‹åŒ–çš„è®¿é—®æ¥å£ã€‚å¯ä»¥åœ¨åŒä¸€ä¸ª ArrayBuffer ä¸Šåˆ›å»ºå¤šä¸ªä¸åŒç±»å‹çš„è§†å›¾ï¼š

```javascript
const buffer = new ArrayBuffer(8);
const int32View = new Int32Array(buffer); // 2 ä¸ªå…ƒç´ 
const uint8View = new Uint8Array(buffer); // 8 ä¸ªå…ƒç´ 
```

**Q2: TypedArray å’Œæ™®é€šæ•°ç»„çš„åŒºåˆ«ï¼Ÿ**

| ç‰¹æ€§ | TypedArray | æ™®é€šæ•°ç»„ |
|------|-----------|---------|
| ç±»å‹ | å›ºå®šç±»å‹ | ä»»æ„ç±»å‹ |
| é•¿åº¦ | å›ºå®šï¼ˆåˆ›å»ºåä¸å¯å˜ï¼‰ | åŠ¨æ€ |
| æ€§èƒ½ | æ›´å¿«ï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼‰ | è¾ƒæ…¢ |
| æ–¹æ³• | éƒ¨åˆ†æ•°ç»„æ–¹æ³• | å…¨éƒ¨æ•°ç»„æ–¹æ³• |
| åº•å±‚å­˜å‚¨ | ArrayBuffer | JavaScript å¯¹è±¡ |

**Q3: ä½•æ—¶ä½¿ç”¨ DataView è€Œä¸æ˜¯ TypedArrayï¼Ÿ**

A: éœ€è¦ä»¥ä¸‹åŠŸèƒ½æ—¶ä½¿ç”¨ DataViewï¼š
- åœ¨åŒä¸€ buffer ä¸­æ··åˆå­˜å‚¨å¤šç§ç±»å‹
- æ§åˆ¶å­—èŠ‚åºï¼ˆå¤§ç«¯/å°ç«¯ï¼‰
- ä¸å¯¹é½çš„å†…å­˜è®¿é—®
- è§£æå¤æ‚äºŒè¿›åˆ¶åè®®

```javascript
// ç¤ºä¾‹ï¼šè§£ææ··åˆç±»å‹åè®®
const buffer = new ArrayBuffer(10);
const view = new DataView(buffer);
view.setUint16(0, 300);      // åç§» 0ï¼šUint16
view.setFloat32(2, 3.14);    // åç§» 2ï¼šFloat32
view.setInt8(6, -10);        // åç§» 6ï¼šInt8
```

**Q4: Transferable Objects çš„åŸç†ï¼Ÿ**

A: é€šè¿‡è½¬ç§» ArrayBuffer æ‰€æœ‰æƒè€Œéå¤åˆ¶æ•°æ®ï¼Œå®ç°é›¶æ‹·è´ä¼ è¾“ã€‚ä¼ è¾“ååŸçº¿ç¨‹å¤±å»è®¿é—®æƒï¼Œé€‚åˆ Web Workers é—´ä¼ é€’å¤§æ•°æ®ï¼š

```javascript
worker.postMessage({ buffer }, [buffer]); // ç¬¬äºŒä¸ªå‚æ•°æ˜¯è½¬ç§»åˆ—è¡¨
console.log(buffer.byteLength); // 0ï¼ˆå·²å¤±å»æ‰€æœ‰æƒï¼‰
```

### åã€æ€»ç»“

JavaScript äºŒè¿›åˆ¶æ•°æ®å¤„ç†çš„æ ¸å¿ƒè¦ç‚¹ï¼š

1. **ArrayBuffer**ï¼šåŸå§‹äºŒè¿›åˆ¶ç¼“å†²åŒºï¼Œå›ºå®šé•¿åº¦ï¼Œå¿…é¡»é€šè¿‡è§†å›¾è®¿é—®
2. **TypedArray**ï¼šç±»å‹åŒ–æ•°ç»„è§†å›¾ï¼Œ9 ç§ç±»å‹è¦†ç›–å¸¸è§åœºæ™¯
3. **DataView**ï¼šçµæ´»çš„å¤šç±»å‹è§†å›¾ï¼Œæ”¯æŒå­—èŠ‚åºæ§åˆ¶
4. **æ€§èƒ½ä¼˜åŠ¿**ï¼šç›´æ¥å†…å­˜æ“ä½œï¼Œæ¯”å­—ç¬¦ä¸²/æ™®é€šæ•°ç»„å¿« 3-10 å€
5. **åº”ç”¨åœºæ™¯**ï¼šæ–‡ä»¶æ“ä½œã€ç½‘ç»œé€šä¿¡ã€å›¾åƒå¤„ç†ã€WebAssembly
6. **é›¶æ‹·è´**ï¼šsubarrayã€Transferable Objects é¿å…æ•°æ®å¤åˆ¶
7. **æ³¨æ„äº‹é¡¹**ï¼šç±»å‹æº¢å‡ºã€å­—èŠ‚å¯¹é½ã€å­—èŠ‚åº

---

**å‚è€ƒèµ„æ–™ï¼š**
- MDN: ArrayBuffer - https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer
- MDN: TypedArray - https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray
- MDN: DataView - https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView
- ECMAScript è§„èŒƒï¼šStructured Data - https://tc39.es/ecma262/#sec-structured-data
