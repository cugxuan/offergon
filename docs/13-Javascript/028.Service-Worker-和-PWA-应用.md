---
title: Service Worker å’Œ PWA åº”ç”¨
tags:
  - JavaScript
status: robot
class: å‰ç«¯JavaScript
slug: service-worker-and-pwa
ref:
---

## æ ¸å¿ƒè¦ç‚¹

Service Worker æ˜¯ç‹¬ç«‹äºç½‘é¡µè¿è¡Œçš„**åå°è„šæœ¬ä»£ç†**ï¼Œæ˜¯ PWAï¼ˆæ¸è¿›å¼ Web åº”ç”¨ï¼‰çš„æ ¸å¿ƒæŠ€æœ¯ã€‚ä¸»è¦åŠŸèƒ½ï¼š**ç¦»çº¿ç¼“å­˜**ï¼ˆCache APIï¼‰ã€**ç½‘ç»œè¯·æ±‚æ‹¦æˆª**ï¼ˆfetch äº‹ä»¶ï¼‰ã€**æ¨é€é€šçŸ¥**ã€**åå°åŒæ­¥**ã€‚ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ï¼š**æ³¨å†Œ â†’ å®‰è£… â†’ æ¿€æ´» â†’ ç©ºé—²/ç»ˆæ­¢ â†’ æ›´æ–°**ã€‚PWA ç‰¹æ€§éœ€æ»¡è¶³ï¼š**HTTPS**ã€**manifest.json**ã€**æ³¨å†Œ Service Worker**ï¼Œå®ç°ç±»åŸç”Ÿåº”ç”¨ä½“éªŒï¼ˆå¯å®‰è£…ã€ç¦»çº¿å¯ç”¨ã€æ¨é€é€šçŸ¥ï¼‰ã€‚

---

## è¯¦ç»†è§£ç­”

### ä¸€ã€Service Worker æ¦‚è¿°

#### 1.1 ä»€ä¹ˆæ˜¯ Service Worker

**Service Worker** æ˜¯ä¸€ç§ç‰¹æ®Šçš„ Web Workerï¼Œå……å½“ Web åº”ç”¨ã€æµè§ˆå™¨å’Œç½‘ç»œä¹‹é—´çš„**ä»£ç†æœåŠ¡å™¨**ã€‚å®ƒè¿è¡Œåœ¨ç‹¬ç«‹çš„åå°çº¿ç¨‹ï¼Œå¯ä»¥æ‹¦æˆªå’Œå¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œå®ç°ç¦»çº¿è®¿é—®ã€èµ„æºç¼“å­˜ã€æ¨é€é€šçŸ¥ç­‰åŠŸèƒ½ã€‚

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**
- **ç‹¬ç«‹çº¿ç¨‹**ï¼šä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œæ— æ³•è®¿é—® DOM
- **äº‹ä»¶é©±åŠ¨**ï¼šå“åº” installã€activateã€fetchã€push ç­‰äº‹ä»¶
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šè‡ªåŠ¨ä¼‘çœ å’Œå”¤é†’ï¼ŒèŠ‚çœèµ„æº
- **HTTPS å¿…éœ€**ï¼šç¡®ä¿å®‰å…¨ï¼ˆlocalhost ä¾‹å¤–ï¼‰
- **ä½œç”¨åŸŸæ§åˆ¶**ï¼šåŸºäºè·¯å¾„çš„ä½œç”¨åŸŸè§„åˆ™

#### 1.2 Service Worker vs Web Worker

| ç‰¹æ€§ | Service Worker | Web Worker |
|------|---------------|-----------|
| **ç”¨é€”** | ç½‘ç»œä»£ç†ã€ç¦»çº¿ç¼“å­˜ã€æ¨é€ | åå°è®¡ç®— |
| **ç”Ÿå‘½å‘¨æœŸ** | ç‹¬ç«‹äºé¡µé¢ï¼ˆåå°å¸¸é©»ï¼‰ | ä¸é¡µé¢ç»‘å®š |
| **ä½œç”¨åŸŸ** | å¤šä¸ªé¡µé¢å…±äº« | å•ä¸ªé¡µé¢ |
| **ç½‘ç»œæ‹¦æˆª** | âœ… æ”¯æŒï¼ˆfetch äº‹ä»¶ï¼‰ | âŒ ä¸æ”¯æŒ |
| **æŒä¹…åŒ–** | å¯æŒä¹…åŒ–çŠ¶æ€ | é¡µé¢å…³é—­å³é”€æ¯ |
| **åè®®è¦æ±‚** | å¿…é¡» HTTPS | æ— è¦æ±‚ |

### äºŒã€Service Worker ç”Ÿå‘½å‘¨æœŸ

#### 2.1 å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

```
   æ³¨å†Œï¼ˆRegisterï¼‰
         â†“
   å®‰è£…ï¼ˆInstallingï¼‰
         â†“
   ç­‰å¾…ï¼ˆWaitingï¼‰â† æ—§ç‰ˆæœ¬ Service Worker ä»åœ¨ä½¿ç”¨
         â†“
   æ¿€æ´»ï¼ˆActivatingï¼‰
         â†“
   å·²æ¿€æ´»ï¼ˆActivatedï¼‰
         â†“
   ç©ºé—²/ç»ˆæ­¢ï¼ˆIdle/Terminatedï¼‰
         â†“
   äº‹ä»¶è§¦å‘æ—¶å”¤é†’
```

#### 2.2 ç”Ÿå‘½å‘¨æœŸäº‹ä»¶è¯¦è§£

**1. æ³¨å†Œé˜¶æ®µï¼ˆRegisterï¼‰**

åœ¨ä¸»çº¿ç¨‹ä¸­æ³¨å†Œ Service Workerï¼š

```javascript
// ä¸»é¡µé¢ main.js
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js', {
    scope: '/' // ä½œç”¨åŸŸï¼Œé»˜è®¤ä¸º sw.js æ‰€åœ¨ç›®å½•
  })
  .then(registration => {
    console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
  })
  .catch(error => {
    console.error('Service Worker æ³¨å†Œå¤±è´¥:', error);
  });
}
```

**2. å®‰è£…é˜¶æ®µï¼ˆInstallï¼‰**

é¦–æ¬¡æ³¨å†Œæˆ– Service Worker æ–‡ä»¶æ›´æ–°æ—¶è§¦å‘ï¼š

```javascript
// sw.js
const CACHE_NAME = 'my-app-v1';
const CACHE_URLS = [
  '/',
  '/index.html',
  '/styles.css',
  '/script.js',
  '/logo.png'
];

self.addEventListener('install', event => {
  console.log('Service Worker å®‰è£…ä¸­...');

  // é¢„ç¼“å­˜èµ„æº
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => {
      console.log('ç¼“å­˜æ–‡ä»¶...');
      return cache.addAll(CACHE_URLS);
    })
  );

  // è·³è¿‡ç­‰å¾…ï¼Œç«‹å³æ¿€æ´»ï¼ˆå¯é€‰ï¼‰
  // self.skipWaiting();
});
```

**3. æ¿€æ´»é˜¶æ®µï¼ˆActivateï¼‰**

å®‰è£…æˆåŠŸåï¼Œç­‰å¾…æ—§ç‰ˆæœ¬å¤±æ•ˆåæ¿€æ´»ï¼š

```javascript
self.addEventListener('activate', event => {
  console.log('Service Worker æ¿€æ´»ä¸­...');

  // æ¸…ç†æ—§ç¼“å­˜
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheName !== CACHE_NAME) {
            console.log('åˆ é™¤æ—§ç¼“å­˜:', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
  );

  // ç«‹å³æ§åˆ¶æ‰€æœ‰é¡µé¢ï¼ˆå¯é€‰ï¼‰
  // return self.clients.claim();
});
```

**4. æ‹¦æˆªè¯·æ±‚ï¼ˆFetchï¼‰**

æ¿€æ´»åæ‹¦æˆªæ‰€æœ‰ç½‘ç»œè¯·æ±‚ï¼š

```javascript
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request).then(cachedResponse => {
      // ç¼“å­˜å‘½ä¸­åˆ™è¿”å›ï¼Œå¦åˆ™è¯·æ±‚ç½‘ç»œ
      return cachedResponse || fetch(event.request);
    })
  );
});
```

#### 2.3 æ›´æ–°æœºåˆ¶

```javascript
// æ£€æµ‹åˆ°æ–° Service Worker æ—¶
navigator.serviceWorker.register('/sw.js').then(registration => {
  registration.addEventListener('updatefound', () => {
    const newWorker = registration.installing;
    console.log('å‘ç°æ–° Service Worker');

    newWorker.addEventListener('statechange', () => {
      if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
        // æ–°ç‰ˆæœ¬å·²å®‰è£…ï¼Œä½†æ—§ç‰ˆæœ¬ä»åœ¨æ§åˆ¶é¡µé¢
        console.log('æ–°å†…å®¹å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢');
        // å¯ä»¥æç¤ºç”¨æˆ·åˆ·æ–°
      }
    });
  });
});
```

### ä¸‰ã€ç¼“å­˜ç­–ç•¥

#### 3.1 ç¼“å­˜ä¼˜å…ˆï¼ˆCache Firstï¼‰

ä¼˜å…ˆä»ç¼“å­˜è¯»å–ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶è¯·æ±‚ç½‘ç»œã€‚é€‚åˆé™æ€èµ„æºã€‚

```javascript
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request).then(cachedResponse => {
      return cachedResponse || fetch(event.request);
    })
  );
});
```

#### 3.2 ç½‘ç»œä¼˜å…ˆï¼ˆNetwork Firstï¼‰

ä¼˜å…ˆè¯·æ±‚ç½‘ç»œï¼Œå¤±è´¥æ—¶å›é€€åˆ°ç¼“å­˜ã€‚é€‚åˆåŠ¨æ€å†…å®¹ã€‚

```javascript
self.addEventListener('fetch', event => {
  event.respondWith(
    fetch(event.request)
      .then(networkResponse => {
        // ç½‘ç»œè¯·æ±‚æˆåŠŸï¼Œæ›´æ–°ç¼“å­˜
        const responseClone = networkResponse.clone();
        caches.open(CACHE_NAME).then(cache => {
          cache.put(event.request, responseClone);
        });
        return networkResponse;
      })
      .catch(() => {
        // ç½‘ç»œå¤±è´¥ï¼Œè¿”å›ç¼“å­˜
        return caches.match(event.request);
      })
  );
});
```

#### 3.3 ä»…ç¼“å­˜ï¼ˆCache Onlyï¼‰

åªè¿”å›ç¼“å­˜ï¼Œä¸è¯·æ±‚ç½‘ç»œã€‚é€‚åˆå®Œå…¨ç¦»çº¿åœºæ™¯ã€‚

```javascript
self.addEventListener('fetch', event => {
  event.respondWith(caches.match(event.request));
});
```

#### 3.4 ä»…ç½‘ç»œï¼ˆNetwork Onlyï¼‰

åªè¯·æ±‚ç½‘ç»œï¼Œä¸ä½¿ç”¨ç¼“å­˜ã€‚é€‚åˆå®æ—¶æ€§è¦æ±‚é«˜çš„ APIã€‚

```javascript
self.addEventListener('fetch', event => {
  event.respondWith(fetch(event.request));
});
```

#### 3.5 Stale-While-Revalidateï¼ˆé™ˆæ—§å†…å®¹åŒæ—¶é‡æ–°éªŒè¯ï¼‰

è¿”å›ç¼“å­˜ï¼ˆå³ä½¿è¿‡æœŸï¼‰ï¼ŒåŒæ—¶åœ¨åå°æ›´æ–°ç¼“å­˜ã€‚é€‚åˆéœ€è¦å¿«é€Ÿå“åº”çš„èµ„æºã€‚

```javascript
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.open(CACHE_NAME).then(cache => {
      return cache.match(event.request).then(cachedResponse => {
        // åå°æ›´æ–°ç¼“å­˜
        const fetchPromise = fetch(event.request).then(networkResponse => {
          cache.put(event.request, networkResponse.clone());
          return networkResponse;
        });

        // ä¼˜å…ˆè¿”å›ç¼“å­˜
        return cachedResponse || fetchPromise;
      });
    })
  );
});
```

#### 3.6 ç»¼åˆç­–ç•¥ï¼ˆæŒ‰èµ„æºç±»å‹åŒºåˆ†ï¼‰

```javascript
self.addEventListener('fetch', event => {
  const { request } = event;
  const url = new URL(request.url);

  // API è¯·æ±‚ï¼šç½‘ç»œä¼˜å…ˆ
  if (url.pathname.startsWith('/api/')) {
    event.respondWith(networkFirst(request));
  }
  // é™æ€èµ„æºï¼šç¼“å­˜ä¼˜å…ˆ
  else if (request.destination === 'image' || request.destination === 'style') {
    event.respondWith(cacheFirst(request));
  }
  // HTML é¡µé¢ï¼šStale-While-Revalidate
  else if (request.destination === 'document') {
    event.respondWith(staleWhileRevalidate(request));
  }
  // é»˜è®¤ï¼šç½‘ç»œä¼˜å…ˆ
  else {
    event.respondWith(networkFirst(request));
  }
});

// ç¼“å­˜ä¼˜å…ˆ
function cacheFirst(request) {
  return caches.match(request).then(cached => cached || fetch(request));
}

// ç½‘ç»œä¼˜å…ˆ
function networkFirst(request) {
  return fetch(request).catch(() => caches.match(request));
}

// Stale-While-Revalidate
function staleWhileRevalidate(request) {
  return caches.open(CACHE_NAME).then(cache => {
    return cache.match(request).then(cached => {
      const fetchPromise = fetch(request).then(response => {
        cache.put(request, response.clone());
        return response;
      });
      return cached || fetchPromise;
    });
  });
}
```

### å››ã€PWAï¼ˆæ¸è¿›å¼ Web åº”ç”¨ï¼‰

#### 4.1 ä»€ä¹ˆæ˜¯ PWA

**PWAï¼ˆProgressive Web Appï¼‰** æ˜¯ä¸€ç§ Web åº”ç”¨å¼€å‘æ–¹æ³•è®ºï¼Œåˆ©ç”¨ç°ä»£ Web æŠ€æœ¯æä¾›ç±»ä¼¼åŸç”Ÿåº”ç”¨çš„ç”¨æˆ·ä½“éªŒã€‚

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- âœ… **æ¸è¿›å¼**ï¼šå…¼å®¹æ‰€æœ‰æµè§ˆå™¨ï¼Œé€æ­¥å¢å¼º
- âœ… **å“åº”å¼**ï¼šé€‚é…å„ç§å±å¹•å°ºå¯¸
- âœ… **ç¦»çº¿å¯ç”¨**ï¼šService Worker ç¼“å­˜å®ç°ç¦»çº¿è®¿é—®
- âœ… **ç±»åº”ç”¨ä½“éªŒ**ï¼šå…¨å±è¿è¡Œï¼Œæ— æµè§ˆå™¨åœ°å€æ 
- âœ… **å¯å®‰è£…**ï¼šæ·»åŠ åˆ°ä¸»å±å¹•ï¼Œç”Ÿæˆæ¡Œé¢å›¾æ ‡
- âœ… **æ¨é€é€šçŸ¥**ï¼šæ”¯æŒæ¶ˆæ¯æ¨é€
- âœ… **å®‰å…¨**ï¼šå¿…é¡» HTTPS
- âœ… **å¯å‘ç°**ï¼šæœç´¢å¼•æ“å¯ç´¢å¼•

#### 4.2 PWA å¿…å¤‡è¦ç´ 

**1. manifest.jsonï¼ˆåº”ç”¨æ¸…å•ï¼‰**

å®šä¹‰åº”ç”¨å…ƒæ•°æ®å’Œå®‰è£…è¡Œä¸ºï¼š

```json
{
  "name": "æˆ‘çš„ PWA åº”ç”¨",
  "short_name": "PWA åº”ç”¨",
  "description": "ä¸€ä¸ªæ¸è¿›å¼ Web åº”ç”¨ç¤ºä¾‹",
  "start_url": "/",
  "display": "standalone", // fullscreen, standalone, minimal-ui, browser
  "background_color": "#ffffff",
  "theme_color": "#4285f4",
  "orientation": "portrait", // portrait, landscape, any
  "icons": [
    {
      "src": "/icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable" // æ”¯æŒé®ç½©å›¾æ ‡
    }
  ]
}
```

**åœ¨ HTML ä¸­å¼•ç”¨ï¼š**

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWA åº”ç”¨</title>

  <!-- å¼•ç”¨ manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- iOS æ”¯æŒ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

  <!-- ä¸»é¢˜é¢œè‰² -->
  <meta name="theme-color" content="#4285f4">
</head>
<body>
  <h1>æ¬¢è¿ä½¿ç”¨ PWA</h1>

  <script>
    // æ³¨å†Œ Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>
```

**2. Service Workerï¼ˆæœåŠ¡å·¥ä½œè€…ï¼‰**

å‰é¢å·²è¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œå±•ç¤ºå®Œæ•´ç¤ºä¾‹ï¼š

```javascript
// sw.js
const CACHE_NAME = 'pwa-v1';
const CACHE_URLS = [
  '/',
  '/index.html',
  '/styles.css',
  '/script.js',
  '/manifest.json',
  '/icons/icon-192x192.png'
];

// å®‰è£…ï¼šé¢„ç¼“å­˜æ ¸å¿ƒèµ„æº
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => cache.addAll(CACHE_URLS))
  );
  self.skipWaiting(); // ç«‹å³æ¿€æ´»
});

// æ¿€æ´»ï¼šæ¸…ç†æ—§ç¼“å­˜
self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(keys => {
      return Promise.all(
        keys.filter(key => key !== CACHE_NAME).map(key => caches.delete(key))
      );
    })
  );
  return self.clients.claim(); // ç«‹å³æ§åˆ¶æ‰€æœ‰é¡µé¢
});

// æ‹¦æˆªè¯·æ±‚ï¼šç¼“å­˜ç­–ç•¥
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request).then(cached => {
      return cached || fetch(event.request).then(response => {
        // åŠ¨æ€ç¼“å­˜æ–°èµ„æº
        return caches.open(CACHE_NAME).then(cache => {
          cache.put(event.request, response.clone());
          return response;
        });
      });
    }).catch(() => {
      // ç¦»çº¿é¡µé¢å…œåº•
      if (event.request.destination === 'document') {
        return caches.match('/offline.html');
      }
    })
  );
});
```

**3. HTTPS**

PWA å¿…é¡»åœ¨ HTTPS ç¯å¢ƒä¸‹è¿è¡Œï¼ˆlocalhost é™¤å¤–ï¼‰ï¼š

```bash
# æœ¬åœ°å¼€å‘å¯ä½¿ç”¨ mkcert ç”Ÿæˆè¯ä¹¦
mkcert -install
mkcert localhost
```

#### 4.3 åº”ç”¨å®‰è£…æç¤º

```javascript
// ç›‘å¬å®‰è£…æç¤ºäº‹ä»¶
let deferredPrompt;

window.addEventListener('beforeinstallprompt', event => {
  // é˜»æ­¢é»˜è®¤æç¤º
  event.preventDefault();
  deferredPrompt = event;

  // æ˜¾ç¤ºè‡ªå®šä¹‰å®‰è£…æŒ‰é’®
  const installButton = document.getElementById('install-button');
  installButton.style.display = 'block';

  installButton.addEventListener('click', async () => {
    // æ˜¾ç¤ºå®‰è£…æç¤º
    deferredPrompt.prompt();

    // ç­‰å¾…ç”¨æˆ·é€‰æ‹©
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`ç”¨æˆ·é€‰æ‹©: ${outcome}`); // 'accepted' æˆ– 'dismissed'

    deferredPrompt = null;
    installButton.style.display = 'none';
  });
});

// ç›‘å¬å®‰è£…æˆåŠŸäº‹ä»¶
window.addEventListener('appinstalled', () => {
  console.log('PWA å®‰è£…æˆåŠŸ');
  deferredPrompt = null;
});
```

### äº”ã€æ¨é€é€šçŸ¥

#### 5.1 è¯·æ±‚é€šçŸ¥æƒé™

```javascript
// è¯·æ±‚é€šçŸ¥æƒé™
async function requestNotificationPermission() {
  const permission = await Notification.requestPermission();

  if (permission === 'granted') {
    console.log('é€šçŸ¥æƒé™å·²æˆäºˆ');
    return true;
  } else if (permission === 'denied') {
    console.log('é€šçŸ¥æƒé™è¢«æ‹’ç»');
    return false;
  } else {
    console.log('ç”¨æˆ·æœªå†³å®š');
    return false;
  }
}

// æ˜¾ç¤ºæœ¬åœ°é€šçŸ¥ï¼ˆä¸»çº¿ç¨‹ï¼‰
function showNotification() {
  if (Notification.permission === 'granted') {
    new Notification('PWA é€šçŸ¥', {
      body: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥',
      icon: '/icons/icon-192x192.png',
      badge: '/icons/badge-72x72.png',
      tag: 'test-notification', // ç›¸åŒ tag ä¼šè¦†ç›–æ—§é€šçŸ¥
      requireInteraction: false, // æ˜¯å¦éœ€è¦ç”¨æˆ·äº¤äº’æ‰å…³é—­
      data: { url: '/page' } // è‡ªå®šä¹‰æ•°æ®
    });
  }
}
```

#### 5.2 Service Worker æ¨é€é€šçŸ¥

```javascript
// sw.js
self.addEventListener('push', event => {
  const data = event.data ? event.data.json() : {};
  const title = data.title || 'æ–°æ¶ˆæ¯';
  const options = {
    body: data.body || 'æ‚¨æœ‰æ–°çš„æ¶ˆæ¯',
    icon: '/icons/icon-192x192.png',
    badge: '/icons/badge-72x72.png',
    data: data.url
  };

  event.waitUntil(
    self.registration.showNotification(title, options)
  );
});

// ç‚¹å‡»é€šçŸ¥äº‹ä»¶
self.addEventListener('notificationclick', event => {
  event.notification.close();

  // æ‰“å¼€å…³è”é¡µé¢
  const url = event.notification.data || '/';
  event.waitUntil(
    clients.openWindow(url)
  );
});
```

#### 5.3 è®¢é˜…æ¨é€æœåŠ¡ï¼ˆä½¿ç”¨ VAPIDï¼‰

```javascript
// ä¸»çº¿ç¨‹è®¢é˜…æ¨é€
async function subscribeToPush() {
  const registration = await navigator.serviceWorker.ready;

  // VAPID å…¬é’¥ï¼ˆéœ€è¦ä»æœåŠ¡å™¨è·å–ï¼‰
  const vapidPublicKey = 'YOUR_PUBLIC_KEY';
  const convertedKey = urlBase64ToUint8Array(vapidPublicKey);

  // è®¢é˜…æ¨é€
  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true, // æ‰€æœ‰æ¨é€å¿…é¡»æ˜¾ç¤ºé€šçŸ¥
    applicationServerKey: convertedKey
  });

  // å°†è®¢é˜…ä¿¡æ¯å‘é€åˆ°æœåŠ¡å™¨
  await fetch('/api/subscribe', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(subscription)
  });

  console.log('æ¨é€è®¢é˜…æˆåŠŸ:', subscription);
}

// Base64 è½¬ Uint8Array
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
}
```

### å…­ã€åå°åŒæ­¥

```javascript
// æ³¨å†Œåå°åŒæ­¥
async function registerSync() {
  const registration = await navigator.serviceWorker.ready;
  await registration.sync.register('sync-tag');
  console.log('åå°åŒæ­¥å·²æ³¨å†Œ');
}

// sw.js å¤„ç†åå°åŒæ­¥
self.addEventListener('sync', event => {
  if (event.tag === 'sync-tag') {
    event.waitUntil(
      // æ‰§è¡ŒåŒæ­¥ä»»åŠ¡ï¼ˆå¦‚ä¸Šä¼ ç¦»çº¿æ•°æ®ï¼‰
      syncData()
    );
  }
});

async function syncData() {
  // ä» IndexedDB è¯»å–ç¦»çº¿æ•°æ®
  const data = await getOfflineData();

  // ä¸Šä¼ åˆ°æœåŠ¡å™¨
  await fetch('/api/sync', {
    method: 'POST',
    body: JSON.stringify(data)
  });

  console.log('æ•°æ®åŒæ­¥å®Œæˆ');
}
```

### ä¸ƒã€å®æˆ˜ï¼šå®Œæ•´ PWA ç¤ºä¾‹

#### é¡¹ç›®ç»“æ„

```
pwa-demo/
â”œâ”€â”€ index.html
â”œâ”€â”€ manifest.json
â”œâ”€â”€ sw.js
â”œâ”€â”€ app.js
â”œâ”€â”€ styles.css
â”œâ”€â”€ offline.html
â””â”€â”€ icons/
    â”œâ”€â”€ icon-72x72.png
    â”œâ”€â”€ icon-192x192.png
    â””â”€â”€ icon-512x512.png
```

#### app.jsï¼ˆä¸»åº”ç”¨é€»è¾‘ï¼‰

```javascript
// æ³¨å†Œ Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(reg => console.log('SW æ³¨å†ŒæˆåŠŸ', reg))
    .catch(err => console.error('SW æ³¨å†Œå¤±è´¥', err));
}

// ç›‘å¬ SW æ›´æ–°
navigator.serviceWorker.addEventListener('controllerchange', () => {
  console.log('Service Worker å·²æ›´æ–°ï¼Œåˆ·æ–°é¡µé¢ç”Ÿæ•ˆ');
  // å¯ä»¥æç¤ºç”¨æˆ·åˆ·æ–°
});

// å®‰è£…æç¤º
let deferredPrompt;
const installBtn = document.getElementById('install-btn');

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'block';
});

installBtn?.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`å®‰è£…ç»“æœ: ${outcome}`);
    deferredPrompt = null;
    installBtn.style.display = 'none';
  }
});

// è¯·æ±‚é€šçŸ¥æƒé™
document.getElementById('notify-btn')?.addEventListener('click', async () => {
  const permission = await Notification.requestPermission();
  if (permission === 'granted') {
    new Notification('PWA é€šçŸ¥æµ‹è¯•', {
      body: 'é€šçŸ¥åŠŸèƒ½æ­£å¸¸å·¥ä½œ',
      icon: '/icons/icon-192x192.png'
    });
  }
});
```

### å…«ã€è°ƒè¯•ä¸æµ‹è¯•

#### 8.1 Chrome DevTools

1. **Application é¢æ¿**
   - Service Workersï¼šæŸ¥çœ‹çŠ¶æ€ã€æ‰‹åŠ¨æ›´æ–°ã€å¸è½½
   - Cache Storageï¼šæŸ¥çœ‹ç¼“å­˜å†…å®¹
   - Manifestï¼šéªŒè¯ manifest.json

2. **Lighthouse å®¡è®¡**
   - è‡ªåŠ¨æ£€æµ‹ PWA åˆè§„æ€§
   - æä¾›ä¼˜åŒ–å»ºè®®

#### 8.2 æµ‹è¯•æ¸…å•

- âœ… HTTPS æˆ– localhost
- âœ… manifest.json é…ç½®æ­£ç¡®
- âœ… Service Worker æ³¨å†ŒæˆåŠŸ
- âœ… ç¦»çº¿æ—¶é¡µé¢å¯è®¿é—®
- âœ… æ·»åŠ åˆ°ä¸»å±å¹•åŠŸèƒ½æ­£å¸¸
- âœ… æ¨é€é€šçŸ¥å·¥ä½œ
- âœ… æ€§èƒ½è¾¾æ ‡ï¼ˆLighthouse PWA åˆ†æ•° > 90ï¼‰

### ä¹ã€å¸¸è§é—®é¢˜ä¸æœ€ä½³å®è·µ

#### 9.1 Service Worker ä¸æ›´æ–°ï¼Ÿ

**åŸå› ï¼š** æµè§ˆå™¨ç¼“å­˜ Service Worker æ–‡ä»¶ï¼ˆ24 å°æ—¶ï¼‰

**è§£å†³ï¼š**
```javascript
// å¼€å‘ç¯å¢ƒç¦ç”¨ç¼“å­˜
navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' });

// æˆ–åœ¨ SW æ–‡ä»¶æ·»åŠ  HTTP å¤´
Cache-Control: max-age=0
```

#### 9.2 å¦‚ä½•å¼ºåˆ¶æ›´æ–°ï¼Ÿ

```javascript
// æ£€æŸ¥æ›´æ–°
navigator.serviceWorker.register('/sw.js').then(registration => {
  setInterval(() => {
    registration.update(); // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  }, 3600000);
});
```

#### 9.3 ç¼“å­˜ç­–ç•¥é€‰æ‹©

- ğŸ“„ **HTML æ–‡æ¡£**ï¼šNetwork First æˆ– Stale-While-Revalidate
- ğŸ–¼ï¸ **å›¾ç‰‡/å­—ä½“**ï¼šCache First
- ğŸ“¦ **JS/CSS**ï¼šStale-While-Revalidate
- ğŸŒ **API æ•°æ®**ï¼šNetwork First
- ğŸ“± **ç¦»çº¿é¡µé¢**ï¼šä»…ç¼“å­˜

#### 9.4 ç¼“å­˜ç®¡ç†

```javascript
// é™åˆ¶ç¼“å­˜æ•°é‡
async function limitCacheSize(cacheName, maxItems) {
  const cache = await caches.open(cacheName);
  const keys = await cache.keys();
  if (keys.length > maxItems) {
    await cache.delete(keys[0]); // åˆ é™¤æœ€æ—§çš„
    limitCacheSize(cacheName, maxItems); // é€’å½’
  }
}

// åœ¨ fetch äº‹ä»¶ä¸­è°ƒç”¨
self.addEventListener('fetch', event => {
  event.respondWith(
    caches.open('dynamic-cache').then(async cache => {
      const response = await fetch(event.request);
      cache.put(event.request, response.clone());
      await limitCacheSize('dynamic-cache', 50); // é™åˆ¶ 50 é¡¹
      return response;
    })
  );
});
```

### åã€é¢è¯•é«˜é¢‘é—®é¢˜

**Q1: PWA å’ŒåŸç”Ÿåº”ç”¨çš„åŒºåˆ«ï¼Ÿ**

| ç‰¹æ€§ | PWA | åŸç”Ÿåº”ç”¨ |
|------|-----|---------|
| å®‰è£… | æ— éœ€åº”ç”¨å•†åº— | éœ€è¦å•†åº—å®¡æ ¸ |
| æ›´æ–° | è‡ªåŠ¨æ›´æ–°ï¼ˆè®¿é—®æ—¶ï¼‰ | éœ€ç”¨æˆ·æ‰‹åŠ¨æ›´æ–° |
| æ€§èƒ½ | æ¥è¿‘åŸç”Ÿ | æœ€ä¼˜ |
| ç¦»çº¿èƒ½åŠ› | ä¾èµ–ç¼“å­˜ | å®Œæ•´ç¦»çº¿ |
| ç³»ç»Ÿé›†æˆ | æœ‰é™ï¼ˆé€šçŸ¥ã€ä¼ æ„Ÿå™¨ï¼‰ | å®Œæ•´é›†æˆ |
| å¼€å‘æˆæœ¬ | ä½ï¼ˆä¸€å¥—ä»£ç ï¼‰ | é«˜ï¼ˆå¤šå¹³å°å¼€å‘ï¼‰ |

**Q2: Service Worker èƒ½è®¿é—® DOM å—ï¼Ÿ**

A: ä¸èƒ½ã€‚Service Worker è¿è¡Œåœ¨ç‹¬ç«‹çº¿ç¨‹ï¼Œæ— æ³•è®¿é—® DOMã€‚éœ€è¦é€šè¿‡ `postMessage` ä¸ä¸»çº¿ç¨‹é€šä¿¡ï¼š

```javascript
// SW å‘é€æ¶ˆæ¯ç»™ä¸»çº¿ç¨‹
self.clients.matchAll().then(clients => {
  clients.forEach(client => client.postMessage({ type: 'update' }));
});

// ä¸»çº¿ç¨‹æ¥æ”¶æ¶ˆæ¯
navigator.serviceWorker.addEventListener('message', event => {
  console.log('æ”¶åˆ° SW æ¶ˆæ¯:', event.data);
});
```

**Q3: å¦‚ä½•ä¿è¯ Service Worker æ›´æ–°åç«‹å³ç”Ÿæ•ˆï¼Ÿ**

A: åœ¨ install äº‹ä»¶ä¸­è°ƒç”¨ `skipWaiting()`ï¼Œåœ¨ activate äº‹ä»¶ä¸­è°ƒç”¨ `clients.claim()`ï¼š

```javascript
self.addEventListener('install', () => {
  self.skipWaiting(); // è·³è¿‡ç­‰å¾…ï¼Œç«‹å³æ¿€æ´»
});

self.addEventListener('activate', () => {
  self.clients.claim(); // ç«‹å³æ§åˆ¶æ‰€æœ‰é¡µé¢
});
```

**Q4: PWA èƒ½å¦è®¿é—®è®¾å¤‡ç¡¬ä»¶ï¼Ÿ**

A: å¯ä»¥éƒ¨åˆ†è®¿é—®ï¼ˆé€šè¿‡ Web APIï¼‰ï¼š
- âœ… åœ°ç†ä½ç½®ï¼ˆGeolocation APIï¼‰
- âœ… ç›¸æœº/éº¦å…‹é£ï¼ˆMediaDevices APIï¼‰
- âœ… ä¼ æ„Ÿå™¨ï¼ˆåŠ é€Ÿåº¦è®¡ã€é™€èºä»ªç­‰ï¼‰
- âœ… è“ç‰™ï¼ˆWeb Bluetooth APIï¼Œå®éªŒæ€§ï¼‰
- âŒ NFCã€æŒ‡çº¹è¯†åˆ«ç­‰é«˜çº§åŠŸèƒ½æ”¯æŒæœ‰é™

### åä¸€ã€æ€»ç»“

Service Worker å’Œ PWA ä»£è¡¨äº† Web åº”ç”¨çš„æœªæ¥æ–¹å‘ï¼Œæ ¸å¿ƒè¦ç‚¹ï¼š

1. **Service Worker**ï¼šåå°è„šæœ¬ä»£ç†ï¼Œå®ç°ç¦»çº¿ç¼“å­˜å’Œè¯·æ±‚æ‹¦æˆª
2. **ç”Ÿå‘½å‘¨æœŸ**ï¼šæ³¨å†Œ â†’ å®‰è£… â†’ æ¿€æ´» â†’ æ‹¦æˆªè¯·æ±‚
3. **ç¼“å­˜ç­–ç•¥**ï¼šCache Firstã€Network Firstã€Stale-While-Revalidate
4. **PWA ä¸‰è¦ç´ **ï¼šHTTPS + manifest.json + Service Worker
5. **æ ¸å¿ƒèƒ½åŠ›**ï¼šç¦»çº¿è®¿é—®ã€åº”ç”¨å®‰è£…ã€æ¨é€é€šçŸ¥ã€åå°åŒæ­¥
6. **å¼€å‘å»ºè®®**ï¼šåˆç†é€‰æ‹©ç¼“å­˜ç­–ç•¥ã€æ³¨æ„æ›´æ–°æœºåˆ¶ã€é™åˆ¶ç¼“å­˜å¤§å°

---

**å‚è€ƒèµ„æ–™ï¼š**
- MDN: Service Worker API - https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API
- Google Developers: Progressive Web Apps - https://web.dev/progressive-web-apps/
- Service Worker Cookbook - https://serviceworke.rs/
- Workboxï¼ˆGoogle PWA å·¥å…·åº“ï¼‰- https://developers.google.com/web/tools/workbox
