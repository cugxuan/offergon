---
title: async/await çš„åº•å±‚å®ç°å’Œé”™è¯¯å¤„ç†
tags:
  - JavaScript
  - åŒæ­¥åŸè¯­
status: robot
class: å‰ç«¯JavaScript
slug: async-await-implementation-error-handling
ref:
---

## æ ¸å¿ƒè¦ç‚¹

- **è¯­æ³•ç³–æœ¬è´¨**ï¼šasync/awaitæ˜¯Promise + Generatorçš„è¯­æ³•ç³–ï¼Œåº•å±‚åŸºäºè¿­ä»£å™¨åè®®
- **çŠ¶æ€è½¬æ¢**ï¼šasyncå‡½æ•°æ€»æ˜¯è¿”å›Promiseï¼Œawaitæš‚åœå‡½æ•°æ‰§è¡Œç­‰å¾…Promise resolve
- **é”™è¯¯ä¼ æ’­**ï¼šthrow/rejectä¼šè¢«è½¬æ¢ä¸ºPromise rejectionï¼Œæ”¯æŒtry/catchåŒæ­¥å†™æ³•
- **æ‰§è¡Œæ—¶æœº**ï¼šawaitåçš„ä»£ç ç›¸å½“äºPromise.thenä¸­çš„å¾®ä»»åŠ¡

## è¯¦ç»†å›ç­”

### 1. async/awaitåº•å±‚åŸç†

#### asyncå‡½æ•°çš„æœ¬è´¨
```javascript
// asyncå‡½æ•°å£°æ˜
async function fetchData() {
    return 'data';
}

// ç­‰ä»·äº
function fetchData() {
    return Promise.resolve('data');
}

// éªŒè¯
console.log(fetchData()); // Promise {<fulfilled>: 'data'}
console.log(fetchData() instanceof Promise); // true
```

#### awaitçš„æ‰§è¡Œæœºåˆ¶
```javascript
async function example() {
    console.log('1');
    const result = await Promise.resolve('2');
    console.log(result);
    console.log('3');
}

// ç­‰ä»·çš„Promiseå†™æ³•
function example() {
    return new Promise(resolve => {
        console.log('1');

        Promise.resolve('2').then(result => {
            console.log(result);
            console.log('3');
            resolve(undefined);
        });
    });
}
```

### 2. Generator + Promiseå®ç°async/await

#### æ‰‹å†™async/await
```javascript
// æ¨¡æ‹Ÿasync/awaitçš„å®ç°
function asyncToGenerator(generatorFunc) {
    return function (...args) {
        const generator = generatorFunc.apply(this, args);

        return new Promise((resolve, reject) => {
            function step(key, arg) {
                let result;
                try {
                    result = generator[key](arg);
                } catch (error) {
                    reject(error);
                    return;
                }

                const { value, done } = result;

                if (done) {
                    // Generatoræ‰§è¡Œå®Œæˆ
                    resolve(value);
                } else {
                    // å°†valueè½¬æ¢ä¸ºPromise
                    return Promise.resolve(value).then(
                        val => step('next', val),    // æˆåŠŸæ—¶ç»§ç»­æ‰§è¡Œ
                        err => step('throw', err)    // å¤±è´¥æ—¶æŠ›å‡ºé”™è¯¯
                    );
                }
            }

            step('next');
        });
    };
}

// ä½¿ç”¨Generatorå®ç°asyncå‡½æ•°
function* fetchDataGenerator() {
    try {
        console.log('å¼€å§‹è¯·æ±‚');
        const result1 = yield fetch('/api/data1');
        console.log('ç¬¬ä¸€ä¸ªè¯·æ±‚ç»“æœ:', result1);

        const result2 = yield fetch('/api/data2');
        console.log('ç¬¬äºŒä¸ªè¯·æ±‚ç»“æœ:', result2);

        return { result1, result2 };
    } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        throw error;
    }
}

// è½¬æ¢ä¸ºasyncå‡½æ•°
const fetchData = asyncToGenerator(fetchDataGenerator);

// ä½¿ç”¨
fetchData().then(result => {
    console.log('æœ€ç»ˆç»“æœ:', result);
}).catch(error => {
    console.error('æ•è·é”™è¯¯:', error);
});
```

#### æ›´å®Œæ•´çš„å®ç°
```javascript
function spawn(generatorFunc) {
    return function (...args) {
        const generator = generatorFunc.apply(this, args);

        return new Promise((resolve, reject) => {
            function step(key, arg) {
                let result;

                try {
                    result = generator[key](arg);
                } catch (error) {
                    reject(error);
                    return;
                }

                const { value, done } = result;

                if (done) {
                    resolve(value);
                } else {
                    // æ”¯æŒå„ç§ç±»å‹çš„å€¼
                    Promise.resolve(value).then(
                        val => step('next', val),
                        err => step('throw', err)
                    );
                }
            }

            step('next');
        });
    };
}

// ç¤ºä¾‹ï¼šå¤æ‚çš„å¼‚æ­¥æµç¨‹
function* complexAsyncFlow() {
    try {
        // ä¸²è¡Œè¯·æ±‚
        const user = yield fetchUser();
        const posts = yield fetchUserPosts(user.id);

        // å¹¶è¡Œè¯·æ±‚
        const [comments, likes] = yield Promise.all([
            fetchComments(posts.map(p => p.id)),
            fetchLikes(posts.map(p => p.id))
        ]);

        return {
            user,
            posts: posts.map(post => ({
                ...post,
                comments: comments[post.id],
                likes: likes[post.id]
            }))
        };
    } catch (error) {
        console.error('æµç¨‹æ‰§è¡Œå¤±è´¥:', error);
        throw new Error(`æ•°æ®è·å–å¤±è´¥: ${error.message}`);
    }
}

const executeComplexFlow = spawn(complexAsyncFlow);
```

### 3. é”™è¯¯å¤„ç†æœºåˆ¶

#### try/catchä¸Promiseé”™è¯¯å¤„ç†çš„å¯¹åº”
```javascript
// async/awaité”™è¯¯å¤„ç†
async function handleErrors() {
    try {
        const result1 = await riskyOperation1();
        const result2 = await riskyOperation2(result1);
        return result2;
    } catch (error) {
        console.error('æ“ä½œå¤±è´¥:', error);
        throw new Error('å¤„ç†å¤±è´¥');
    }
}

// ç­‰ä»·çš„Promiseå†™æ³•
function handleErrors() {
    return riskyOperation1()
        .then(result1 => riskyOperation2(result1))
        .catch(error => {
            console.error('æ“ä½œå¤±è´¥:', error);
            throw new Error('å¤„ç†å¤±è´¥');
        });
}
```

#### é”™è¯¯ç±»å‹å¤„ç†
```javascript
async function advancedErrorHandling() {
    try {
        const data = await fetchData();
        return data;
    } catch (error) {
        // æ ¹æ®é”™è¯¯ç±»å‹è¿›è¡Œä¸åŒå¤„ç†
        if (error.name === 'NetworkError') {
            console.error('ç½‘ç»œé”™è¯¯:', error.message);
            // é‡è¯•é€»è¾‘
            return await retryFetch();
        } else if (error.name === 'ValidationError') {
            console.error('æ•°æ®éªŒè¯é”™è¯¯:', error.message);
            throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
        } else {
            console.error('æœªçŸ¥é”™è¯¯:', error);
            throw error;
        }
    }
}

// é‡è¯•æœºåˆ¶å®ç°
async function retryFetch(maxRetries = 3) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            return await fetchData();
        } catch (error) {
            if (i === maxRetries - 1) {
                throw error;
            }
            console.log(`é‡è¯•ç¬¬${i + 1}æ¬¡...`);
            await delay(1000 * Math.pow(2, i)); // æŒ‡æ•°é€€é¿
        }
    }
}
```

#### éƒ¨åˆ†é”™è¯¯å¤„ç†
```javascript
async function partialErrorHandling() {
    const results = [];
    const errors = [];

    // å¤„ç†å¤šä¸ªå¼‚æ­¥æ“ä½œï¼Œéƒ¨åˆ†å¤±è´¥ä¸å½±å“æ•´ä½“
    const tasks = [
        { name: 'task1', fn: () => fetchData1() },
        { name: 'task2', fn: () => fetchData2() },
        { name: 'task3', fn: () => fetchData3() }
    ];

    for (const task of tasks) {
        try {
            const result = await task.fn();
            results.push({ name: task.name, result });
        } catch (error) {
            errors.push({ name: task.name, error });
            console.warn(`${task.name} æ‰§è¡Œå¤±è´¥:`, error.message);
        }
    }

    return { results, errors };
}

// ä½¿ç”¨Promise.allSettledçš„æ–¹å¼
async function allSettledApproach() {
    const tasks = [fetchData1(), fetchData2(), fetchData3()];
    const results = await Promise.allSettled(tasks);

    const successes = results
        .filter(result => result.status === 'fulfilled')
        .map(result => result.value);

    const failures = results
        .filter(result => result.status === 'rejected')
        .map(result => result.reason);

    return { successes, failures };
}
```

### 4. æ‰§è¡Œæ—¶æœºä¸å¾®ä»»åŠ¡

#### awaitçš„æ‰§è¡Œé¡ºåº
```javascript
async function asyncOrder() {
    console.log('1');

    const result = await new Promise(resolve => {
        console.log('2'); // Promiseæ„é€ å‡½æ•°åŒæ­¥æ‰§è¡Œ
        resolve('3');
    });

    console.log(result); // å¾®ä»»åŠ¡ä¸­æ‰§è¡Œ
    console.log('4');
}

console.log('start');
asyncOrder();
console.log('end');

// è¾“å‡ºé¡ºåºï¼šstart â†’ 1 â†’ 2 â†’ end â†’ 3 â†’ 4
```

#### å¤æ‚çš„æ‰§è¡Œé¡ºåºåˆ†æ
```javascript
async function complex() {
    console.log('async start');

    await new Promise(resolve => {
        console.log('promise start');
        resolve();
    });

    console.log('async middle');

    await Promise.resolve();

    console.log('async end');
}

console.log('script start');

setTimeout(() => console.log('setTimeout'), 0);

complex();

new Promise(resolve => {
    console.log('promise1');
    resolve();
}).then(() => {
    console.log('promise1 then');
});

console.log('script end');

// è¾“å‡ºé¡ºåºï¼š
// script start
// async start
// promise start
// promise1
// script end
// async middle
// promise1 then
// async end
// setTimeout
```

### 5. æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

#### å¹¶è¡Œvsä¸²è¡Œæ‰§è¡Œ
```javascript
// âŒ ä¸²è¡Œæ‰§è¡Œï¼ˆæ€§èƒ½å·®ï¼‰
async function sequential() {
    const result1 = await fetch('/api/data1'); // ç­‰å¾…1ç§’
    const result2 = await fetch('/api/data2'); // å†ç­‰å¾…1ç§’
    const result3 = await fetch('/api/data3'); // å†ç­‰å¾…1ç§’
    // æ€»è®¡ï¼š3ç§’
    return [result1, result2, result3];
}

// âœ… å¹¶è¡Œæ‰§è¡Œï¼ˆæ€§èƒ½å¥½ï¼‰
async function parallel() {
    const [result1, result2, result3] = await Promise.all([
        fetch('/api/data1'), // åŒæ—¶å¼€å§‹
        fetch('/api/data2'), // åŒæ—¶å¼€å§‹
        fetch('/api/data3')  // åŒæ—¶å¼€å§‹
    ]);
    // æ€»è®¡ï¼š1ç§’ï¼ˆæœ€æ…¢çš„é‚£ä¸ªï¼‰
    return [result1, result2, result3];
}

// ğŸ”§ æ··åˆæ¨¡å¼ï¼ˆéƒ¨åˆ†ä¾èµ–ï¼‰
async function hybrid() {
    // ç¬¬ä¸€æ­¥ï¼šå¹¶è¡Œè·å–ç‹¬ç«‹æ•°æ®
    const [userData, configData] = await Promise.all([
        fetchUser(),
        fetchConfig()
    ]);

    // ç¬¬äºŒæ­¥ï¼šåŸºäºç¬¬ä¸€æ­¥ç»“æœç»§ç»­å¤„ç†
    const [posts, permissions] = await Promise.all([
        fetchUserPosts(userData.id),
        fetchPermissions(userData.role)
    ]);

    return { userData, configData, posts, permissions };
}
```

#### é”™è¯¯è¾¹ç•Œå’Œèµ„æºæ¸…ç†
```javascript
async function withResourceCleanup() {
    const resource = await acquireResource();

    try {
        const result = await processWithResource(resource);
        return result;
    } finally {
        // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥éƒ½ä¼šæ‰§è¡Œæ¸…ç†
        await releaseResource(resource);
    }
}

// è¶…æ—¶æ§åˆ¶
async function withTimeout(asyncFn, timeoutMs) {
    const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('æ“ä½œè¶…æ—¶')), timeoutMs);
    });

    return Promise.race([
        asyncFn(),
        timeoutPromise
    ]);
}

// ä½¿ç”¨ç¤ºä¾‹
async function fetchWithTimeout() {
    try {
        const data = await withTimeout(
            () => fetch('/api/slow-endpoint'),
            5000 // 5ç§’è¶…æ—¶
        );
        return data;
    } catch (error) {
        if (error.message === 'æ“ä½œè¶…æ—¶') {
            console.warn('è¯·æ±‚è¶…æ—¶ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®');
            return getCachedData();
        }
        throw error;
    }
}
```

### 6. è°ƒè¯•æŠ€å·§

#### é”™è¯¯æ ˆè¿½è¸ª
```javascript
// åŸå§‹é”™è¯¯æ ˆå¯èƒ½ä¸¢å¤±ä¸Šä¸‹æ–‡
async function badErrorHandling() {
    try {
        await riskyOperation();
    } catch (error) {
        throw error; // ä¸¢å¤±äº†å½“å‰å‡½æ•°çš„ä¸Šä¸‹æ–‡
    }
}

// ä¿æŒé”™è¯¯æ ˆçš„æœ€ä½³å®è·µ
async function goodErrorHandling() {
    try {
        return await riskyOperation();
    } catch (error) {
        // æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
        error.context = 'goodErrorHandling function';
        throw error;
    }
}

// åˆ›å»ºè‡ªå®šä¹‰é”™è¯¯ç±»
class AsyncOperationError extends Error {
    constructor(message, originalError, context) {
        super(message);
        this.name = 'AsyncOperationError';
        this.originalError = originalError;
        this.context = context;
        this.stack = originalError.stack;
    }
}

async function enhancedErrorHandling() {
    try {
        return await riskyOperation();
    } catch (error) {
        throw new AsyncOperationError(
            'å¼‚æ­¥æ“ä½œå¤±è´¥',
            error,
            { function: 'enhancedErrorHandling', timestamp: Date.now() }
        );
    }
}
```

#### æ€§èƒ½ç›‘æ§
```javascript
async function monitoredAsyncFunction() {
    const startTime = performance.now();

    try {
        const result = await expensiveOperation();

        const endTime = performance.now();
        console.log(`æ“ä½œè€—æ—¶: ${endTime - startTime}ms`);

        return result;
    } catch (error) {
        const endTime = performance.now();
        console.error(`æ“ä½œå¤±è´¥ï¼Œè€—æ—¶: ${endTime - startTime}ms`, error);
        throw error;
    }
}
```

### 7. å…¼å®¹æ€§å¤„ç†

#### Babelè½¬æ¢åŸç†
```javascript
// åŸå§‹async/awaitä»£ç 
async function originalFunction() {
    const result = await fetch('/api/data');
    return result.json();
}

// Babelè½¬æ¢åçš„ä»£ç ï¼ˆç®€åŒ–ç‰ˆï¼‰
function originalFunction() {
    return _asyncToGenerator(function* () {
        const result = yield fetch('/api/data');
        return result.json();
    })();
}

function _asyncToGenerator(fn) {
    return function () {
        const gen = fn.apply(this, arguments);
        return new Promise((resolve, reject) => {
            function step(key, arg) {
                try {
                    const { value, done } = gen[key](arg);
                    if (done) {
                        resolve(value);
                    } else {
                        Promise.resolve(value).then(
                            val => step('next', val),
                            err => step('throw', err)
                        );
                    }
                } catch (error) {
                    reject(error);
                }
            }
            step('next');
        });
    };
}
```

### 8. å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

#### é™·é˜±1ï¼šå¾ªç¯ä¸­çš„async/await
```javascript
// âŒ é”™è¯¯ï¼šä¸²è¡Œæ‰§è¡Œ
async function processItemsSerial(items) {
    const results = [];
    for (const item of items) {
        const result = await processItem(item); // é€ä¸ªç­‰å¾…
        results.push(result);
    }
    return results;
}

// âœ… æ­£ç¡®ï¼šå¹¶è¡Œæ‰§è¡Œ
async function processItemsParallel(items) {
    const promises = items.map(item => processItem(item));
    return Promise.all(promises);
}

// ğŸ”§ é™åˆ¶å¹¶å‘æ•°é‡
async function processItemsWithConcurrency(items, concurrency = 3) {
    const results = [];
    for (let i = 0; i < items.length; i += concurrency) {
        const chunk = items.slice(i, i + concurrency);
        const chunkResults = await Promise.all(
            chunk.map(item => processItem(item))
        );
        results.push(...chunkResults);
    }
    return results;
}
```

#### é™·é˜±2ï¼šå¿˜è®°await
```javascript
// âŒ é”™è¯¯ï¼šå¿˜è®°await
async function forgotAwait() {
    const result = asyncOperation(); // è¿”å›Promiseè€Œä¸æ˜¯å€¼
    console.log(result); // [object Promise]
    return result;
}

// âœ… æ­£ç¡®ï¼šè®°å¾—await
async function rememberedAwait() {
    const result = await asyncOperation();
    console.log(result); // å®é™…çš„å€¼
    return result;
}
```

### 9. æ€»ç»“

async/awaitçš„æ ¸å¿ƒç‰¹æ€§ï¼š

**åº•å±‚å®ç°ï¼š**
- åŸºäºPromise + Generatorçš„è¯­æ³•ç³–
- é€šè¿‡è¿­ä»£å™¨åè®®å®ç°æš‚åœå’Œæ¢å¤
- ç¼–è¯‘æ—¶è½¬æ¢ä¸ºçŠ¶æ€æœº

**é”™è¯¯å¤„ç†ï¼š**
- try/catchå¯ä»¥æ•è·å¼‚æ­¥é”™è¯¯
- é”™è¯¯ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºPromise rejection
- æ”¯æŒç²¾ç»†åŒ–çš„é”™è¯¯å¤„ç†ç­–ç•¥

**æ€§èƒ½ä¼˜åŒ–ï¼š**
- åˆç†ä½¿ç”¨å¹¶è¡Œvsä¸²è¡Œæ‰§è¡Œ
- é¿å…ä¸å¿…è¦çš„await
- å®ç°è¶…æ—¶å’Œé‡è¯•æœºåˆ¶

**æœ€ä½³å®è·µï¼š**
- ä¿æŒé”™è¯¯æ ˆçš„å®Œæ•´æ€§
- åˆç†å¤„ç†èµ„æºæ¸…ç†
- ç›‘æ§å¼‚æ­¥æ“ä½œçš„æ€§èƒ½

æŒæ¡async/awaitä¸ä»…è¦ç†è§£å…¶è¯­æ³•ï¼Œæ›´è¦æ·±å…¥ç†è§£å…¶åº•å±‚åŸç†å’Œæ‰§è¡Œæœºåˆ¶ï¼Œè¿™æ ·æ‰èƒ½å†™å‡ºé«˜æ•ˆã€å¯é çš„å¼‚æ­¥ä»£ç ã€‚
