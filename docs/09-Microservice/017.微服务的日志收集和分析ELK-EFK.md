---
title: å¾®æœåŠ¡çš„æ—¥å¿—æ”¶é›†å’Œåˆ†æï¼ˆELK/EFKï¼‰
tags:
  - å¾®æœåŠ¡
status: robot
class: å¾®æœåŠ¡
slug: microservice-log-collection-analysis-elk-efk
ref:
---

## æ ¸å¿ƒè¦ç‚¹

**ELKæ¶æ„**:Elasticsearch(å­˜å‚¨æ£€ç´¢) + Logstash(é‡‡é›†å¤„ç†) + Kibana(å¯è§†åŒ–),ç»å…¸çš„é›†ä¸­å¼æ—¥å¿—æ–¹æ¡ˆ
**EFKæ¶æ„**:ç”¨Fluentdæ›¿ä»£Logstash,æ›´è½»é‡ã€äº‘åŸç”Ÿ,é€‚åˆKubernetesç¯å¢ƒ
**å…³é”®æŠ€æœ¯**:ç»“æ„åŒ–æ—¥å¿—ã€TraceIDå…³è”ã€æ—¥å¿—åˆ†çº§é‡‡é›†ã€ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†

---

## è¯¦ç»†å›ç­”

### ä¸€ã€å¾®æœåŠ¡æ—¥å¿—çš„æŒ‘æˆ˜

åœ¨å•ä½“åº”ç”¨æ—¶ä»£,æ—¥å¿—æ–‡ä»¶å­˜å‚¨åœ¨å•ä¸€æœåŠ¡å™¨ä¸Š,é€šè¿‡`tail -f`æˆ–`grep`å³å¯æŸ¥çœ‹åˆ†æã€‚ä½†åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹é¢ä¸´æ–°çš„æŒ‘æˆ˜:

#### 1. åˆ†å¸ƒå¼ç¯å¢ƒçš„ç—›ç‚¹

```
âŒ æ—¥å¿—åˆ†æ•£åœ¨å‡ åç”šè‡³ä¸Šç™¾ä¸ªæœåŠ¡å®ä¾‹
âŒ ä¸€æ¬¡è¯·æ±‚é“¾è·¯è·¨è¶Šå¤šä¸ªæœåŠ¡,æ—¥å¿—æ•£è½å„å¤„
âŒ å®¹å™¨åŒ–å,Podé‡å¯æ—¥å¿—ä¸¢å¤±
âŒ æ‰‹å·¥ç™»å½•æ¯å°æœºå™¨æŸ¥æ—¥å¿—æ•ˆç‡æä½
âŒ ç¼ºä¹ç»Ÿä¸€çš„æ£€ç´¢å’Œåˆ†æèƒ½åŠ›
```

#### 2. æ—¥å¿—æ”¶é›†çš„éœ€æ±‚

```
âœ… é›†ä¸­å­˜å‚¨: æ‰€æœ‰æœåŠ¡æ—¥å¿—æ±‡èšåˆ°ç»Ÿä¸€å¹³å°
âœ… å®æ—¶æ£€ç´¢: ç§’çº§æŸ¥è¯¢ä»»æ„æ—¶é—´æ®µçš„æ—¥å¿—
âœ… é“¾è·¯è¿½è¸ª: é€šè¿‡TraceIDä¸²è”åˆ†å¸ƒå¼è¯·æ±‚é“¾è·¯
âœ… å¯è§†åŒ–åˆ†æ: å›¾è¡¨å±•ç¤ºé”™è¯¯ç‡ã€QPSç­‰æŒ‡æ ‡
âœ… å‘Šè­¦èƒ½åŠ›: å¼‚å¸¸æ—¥å¿—è‡ªåŠ¨è§¦å‘å‘Šè­¦
```

---

### äºŒã€ELKæ¶æ„è¯¦è§£

ELKæ˜¯Elasticå…¬å¸æ¨å‡ºçš„æ—¥å¿—è§£å†³æ–¹æ¡ˆ,ç”±ä¸‰ä¸ªç»„ä»¶ç»„æˆ:

#### 1. æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾®æœåŠ¡å®ä¾‹                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Service Aâ”‚  â”‚ Service Bâ”‚  â”‚ Service Câ”‚          â”‚
â”‚  â”‚  (Pod)   â”‚  â”‚  (Pod)   â”‚  â”‚  (Pod)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚
â”‚       â”‚ JSON log    â”‚ JSON log    â”‚ JSON log       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚
        â–¼             â–¼             â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Logstash / Fluentd               â”‚  â† æ—¥å¿—é‡‡é›†
   â”‚  - æ”¶é›†æ—¥å¿—                        â”‚
   â”‚  - è§£ææ ¼å¼(JSON/å¤šè¡Œæ—¥å¿—)         â”‚
   â”‚  - è¿‡æ»¤å’Œè½¬æ¢                      â”‚
   â”‚  - æ·»åŠ æ ‡ç­¾(serviceã€env)          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ Bulk API
                  â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Elasticsearch Cluster              â”‚  â† æ—¥å¿—å­˜å‚¨
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”      â”‚
   â”‚  â”‚ Node1â”‚  â”‚ Node2â”‚  â”‚ Node3â”‚      â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜      â”‚
   â”‚  - åˆ†å¸ƒå¼å­˜å‚¨                        â”‚
   â”‚  - å…¨æ–‡æ£€ç´¢                          â”‚
   â”‚  - èšåˆåˆ†æ                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ REST API
                  â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Kibana                             â”‚  â† å¯è§†åŒ–
   â”‚  - æ—¥å¿—æ£€ç´¢ç•Œé¢                      â”‚
   â”‚  - ä»ªè¡¨ç›˜(Dashboard)                 â”‚
   â”‚  - å‘Šè­¦è§„åˆ™é…ç½®                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. å„ç»„ä»¶èŒè´£

**Elasticsearch**:
- åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“
- åŸºäºLucene,æ”¯æŒå…¨æ–‡æ£€ç´¢
- é€šè¿‡å€’æ’ç´¢å¼•å®ç°ç§’çº§æŸ¥è¯¢
- æ°´å¹³æ‰©å±•,æ”¯æŒPBçº§æ•°æ®

**Logstash**:
- æ•°æ®æ”¶é›†å’Œå¤„ç†ç®¡é“
- æ”¯æŒ200+è¾“å…¥æ’ä»¶(file, syslog, kafkaç­‰)
- å¼ºå¤§çš„è¿‡æ»¤å™¨(grok, mutate, dateç­‰)
- è¾“å‡ºåˆ°Elasticsearchã€Kafkaç­‰

**Kibana**:
- ESçš„å¯è§†åŒ–ç•Œé¢
- Discover: æ—¥å¿—æ£€ç´¢
- Dashboard: è‡ªå®šä¹‰ä»ªè¡¨ç›˜
- Alerting: å‘Šè­¦è§„åˆ™

#### 3. Logstashé…ç½®ç¤ºä¾‹

```ruby
# /etc/logstash/conf.d/microservice.conf
input {
  # ä»Filebeatæ¥æ”¶æ—¥å¿—
  beats {
    port => 5044
  }

  # æˆ–ç›´æ¥è¯»å–æ—¥å¿—æ–‡ä»¶
  file {
    path => "/var/log/app/*.log"
    start_position => "beginning"
    codec => "json"  # å¦‚æœæ—¥å¿—æ˜¯JSONæ ¼å¼
  }
}

filter {
  # è§£æJSONæ—¥å¿—
  json {
    source => "message"
  }

  # æå–TraceIDåˆ°ç‹¬ç«‹å­—æ®µ
  if [trace_id] {
    mutate {
      add_field => { "[@metadata][trace_id]" => "%{trace_id}" }
    }
  }

  # æ·»åŠ æœåŠ¡åæ ‡ç­¾
  mutate {
    add_field => { "service" => "%{[kubernetes][labels][app]}" }
    add_field => { "env" => "${ENV:prod}" }
  }

  # è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
  mutate {
    remove_field => ["password", "credit_card"]
  }

  # è§£ææ—¶é—´æˆ³
  date {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
  }
}

output {
  # è¾“å‡ºåˆ°Elasticsearch
  elasticsearch {
    hosts => ["es-node1:9200", "es-node2:9200"]
    index => "microservice-logs-%{+YYYY.MM.dd}"  # æŒ‰æ—¥æœŸåˆ†ç´¢å¼•
    user => "elastic"
    password => "${ES_PASSWORD}"
  }

  # åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°(è°ƒè¯•ç”¨)
  # stdout { codec => rubydebug }
}
```

---

### ä¸‰ã€EFKæ¶æ„(Kubernetesæ¨è)

EFKç”¨**Fluentd**æ›¿ä»£Logstash,æ›´é€‚åˆäº‘åŸç”Ÿç¯å¢ƒ:

#### 1. Fluentd vs Logstash

| ç‰¹æ€§ | Fluentd | Logstash |
|------|---------|----------|
| **å†…å­˜å ç”¨** | ~40MB | ~200MB |
| **è¯­è¨€** | C + Ruby | JRuby (JVM) |
| **é…ç½®** | ç®€æ´ | åŠŸèƒ½ä¸°å¯Œä½†å¤æ‚ |
| **æ’ä»¶ç”Ÿæ€** | 500+ | 200+ |
| **Kubernetesé›†æˆ** | åŸç”Ÿæ”¯æŒ(DaemonSet) | éœ€é¢å¤–é…ç½® |
| **æ€§èƒ½** | é«˜åå | åŠŸèƒ½å¼ºå¤§ä½†é‡ |

#### 2. Fluentd DaemonSetéƒ¨ç½²

```yaml
# fluentd-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: fluentd
  template:
    metadata:
      labels:
        app: fluentd
    spec:
      serviceAccountName: fluentd
      tolerations:
      - key: node-role.kubernetes.io/master
        effect: NoSchedule
      containers:
      - name: fluentd
        image: fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch
        env:
        - name: FLUENT_ELASTICSEARCH_HOST
          value: "elasticsearch.logging.svc.cluster.local"
        - name: FLUENT_ELASTICSEARCH_PORT
          value: "9200"
        - name: FLUENT_ELASTICSEARCH_SCHEME
          value: "http"
        - name: FLUENT_ELASTICSEARCH_LOGSTASH_PREFIX
          value: "k8s-logs"
        volumeMounts:
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: config
          mountPath: /fluentd/etc/fluent.conf
          subPath: fluent.conf
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: config
        configMap:
          name: fluentd-config
```

#### 3. Fluentdé…ç½®

```ruby
# fluent.conf
<source>
  @type tail
  path /var/log/containers/*.log
  pos_file /var/log/fluentd-containers.log.pos
  tag kubernetes.*
  read_from_head true
  <parse>
    @type json
    time_format %Y-%m-%dT%H:%M:%S.%NZ
  </parse>
</source>

# æ·»åŠ Kuberneteså…ƒæ•°æ®
<filter kubernetes.**>
  @type kubernetes_metadata
  @id filter_kube_metadata
</filter>

# åªæ”¶é›†ç‰¹å®šæœåŠ¡çš„æ—¥å¿—
<filter kubernetes.var.log.containers.**user-service**.log>
  @type record_transformer
  <record>
    service "user-service"
    env "#{ENV['CLUSTER_ENV']}"
  </record>
</filter>

# è¾“å‡ºåˆ°Elasticsearch
<match kubernetes.**>
  @type elasticsearch
  @id out_es
  @log_level info
  include_tag_key true
  host "#{ENV['FLUENT_ELASTICSEARCH_HOST']}"
  port "#{ENV['FLUENT_ELASTICSEARCH_PORT']}"
  scheme "#{ENV['FLUENT_ELASTICSEARCH_SCHEME']}"
  logstash_format true
  logstash_prefix k8s-logs
  <buffer>
    @type file
    path /var/log/fluentd-buffers/kubernetes.system.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_interval 5s
    retry_max_interval 30s
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>
```

---

### å››ã€Goå¾®æœåŠ¡æ—¥å¿—æœ€ä½³å®è·µ

#### 1. ç»“æ„åŒ–æ—¥å¿—è¾“å‡º

```go
package main

import (
    "context"
    "github.com/sirupsen/logrus"
    "github.com/google/uuid"
)

// åˆå§‹åŒ–JSONæ ¼å¼æ—¥å¿—
func init() {
    logrus.SetFormatter(&logrus.JSONFormatter{
        TimestampFormat: "2006-01-02T15:04:05.000Z07:00",
        FieldMap: logrus.FieldMap{
            logrus.FieldKeyTime:  "timestamp",
            logrus.FieldKeyLevel: "level",
            logrus.FieldKeyMsg:   "message",
        },
    })
    logrus.SetLevel(logrus.InfoLevel)
}

// æ—¥å¿—ä¸Šä¸‹æ–‡,åŒ…å«TraceIDç­‰å…³é”®ä¿¡æ¯
type LogContext struct {
    TraceID   string
    UserID    int64
    Service   string
    RequestID string
}

func NewLogContext(ctx context.Context) *logrus.Entry {
    traceID := getTraceID(ctx)
    userID := getUserID(ctx)

    return logrus.WithFields(logrus.Fields{
        "trace_id":   traceID,
        "user_id":    userID,
        "service":    "user-service",
        "request_id": uuid.New().String(),
    })
}

// ä½¿ç”¨ç¤ºä¾‹
func HandleRequest(ctx context.Context, req *Request) error {
    logger := NewLogContext(ctx)

    logger.WithFields(logrus.Fields{
        "method": "HandleRequest",
        "input":  req,
    }).Info("å¤„ç†ç”¨æˆ·è¯·æ±‚")

    // ä¸šåŠ¡é€»è¾‘
    user, err := getUserFromDB(ctx, req.UserID)
    if err != nil {
        logger.WithError(err).Error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥")
        return err
    }

    logger.WithFields(logrus.Fields{
        "user_id":   user.ID,
        "user_name": user.Name,
        "duration":  "45ms",
    }).Info("è¯·æ±‚å¤„ç†å®Œæˆ")

    return nil
}
```

**è¾“å‡ºç¤ºä¾‹**:
```json
{
  "timestamp": "2025-10-10T14:23:45.123Z",
  "level": "info",
  "message": "å¤„ç†ç”¨æˆ·è¯·æ±‚",
  "trace_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "user_id": 12345,
  "service": "user-service",
  "request_id": "f1e2d3c4-b5a6-7890-1234-567890abcdef",
  "method": "HandleRequest"
}
```

#### 2. TraceIDä¼ é€’æœºåˆ¶

```go
package tracing

import (
    "context"
    "github.com/google/uuid"
)

type contextKey string

const TraceIDKey contextKey = "trace_id"

// ç”Ÿæˆæˆ–ä¼ é€’TraceID
func WithTraceID(ctx context.Context, traceID string) context.Context {
    if traceID == "" {
        traceID = uuid.New().String()
    }
    return context.WithValue(ctx, TraceIDKey, traceID)
}

func GetTraceID(ctx context.Context) string {
    if traceID, ok := ctx.Value(TraceIDKey).(string); ok {
        return traceID
    }
    return ""
}

// HTTPä¸­é—´ä»¶:ä»Headerè·å–æˆ–ç”ŸæˆTraceID
func TraceIDMiddleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        traceID := r.Header.Get("X-Trace-ID")
        if traceID == "" {
            traceID = uuid.New().String()
        }

        ctx := WithTraceID(r.Context(), traceID)

        // å°†TraceIDè¿”å›ç»™å®¢æˆ·ç«¯
        w.Header().Set("X-Trace-ID", traceID)

        next.ServeHTTP(w, r.WithContext(ctx))
    })
}

// gRPCæ‹¦æˆªå™¨:ä¼ é€’TraceID
func UnaryServerInterceptor() grpc.UnaryServerInterceptor {
    return func(ctx context.Context, req interface{}, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (interface{}, error) {
        // ä»metadataè·å–TraceID
        md, _ := metadata.FromIncomingContext(ctx)
        traceIDs := md.Get("x-trace-id")

        var traceID string
        if len(traceIDs) > 0 {
            traceID = traceIDs[0]
        } else {
            traceID = uuid.New().String()
        }

        ctx = WithTraceID(ctx, traceID)

        // å°†TraceIDä¼ é€’åˆ°ä¸‹æ¸¸æœåŠ¡
        ctx = metadata.AppendToOutgoingContext(ctx, "x-trace-id", traceID)

        return handler(ctx, req)
    }
}
```

---

### äº”ã€Elasticsearchç´¢å¼•ä¼˜åŒ–

#### 1. ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†(ILM)

æ—¥å¿—æ•°æ®æœ‰æ—¶æ•ˆæ€§,é‡‡ç”¨**æ»šåŠ¨ç´¢å¼•**ç­–ç•¥:

```json
// åˆ›å»ºç´¢å¼•æ¨¡æ¿
PUT _index_template/microservice-logs
{
  "index_patterns": ["microservice-logs-*"],
  "template": {
    "settings": {
      "number_of_shards": 3,
      "number_of_replicas": 1,
      "index.lifecycle.name": "microservice-policy",
      "index.lifecycle.rollover_alias": "microservice-logs"
    },
    "mappings": {
      "properties": {
        "@timestamp": { "type": "date" },
        "level": { "type": "keyword" },
        "message": { "type": "text" },
        "trace_id": { "type": "keyword" },
        "service": { "type": "keyword" },
        "user_id": { "type": "long" },
        "duration": { "type": "float" }
      }
    }
  }
}

// å®šä¹‰ç”Ÿå‘½å‘¨æœŸç­–ç•¥
PUT _ilm/policy/microservice-policy
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_size": "50GB",      // ç´¢å¼•å¤§å°è¶…è¿‡50GBæ»šåŠ¨
            "max_age": "1d"          // æˆ–è¶…è¿‡1å¤©æ»šåŠ¨
          }
        }
      },
      "warm": {
        "min_age": "7d",             // 7å¤©åè¿›å…¥warmé˜¶æ®µ
        "actions": {
          "shrink": {
            "number_of_shards": 1    // å‡å°‘åˆ†ç‰‡æ•°
          },
          "forcemerge": {
            "max_num_segments": 1    // åˆå¹¶æ®µ,ä¼˜åŒ–æŸ¥è¯¢
          }
        }
      },
      "delete": {
        "min_age": "30d",            // 30å¤©ååˆ é™¤
        "actions": {
          "delete": {}
        }
      }
    }
  }
}
```

#### 2. æŸ¥è¯¢ä¼˜åŒ–

```json
// ä½¿ç”¨TraceIDæŸ¥è¯¢å®Œæ•´é“¾è·¯æ—¥å¿—
GET microservice-logs-*/_search
{
  "query": {
    "bool": {
      "must": [
        { "term": { "trace_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890" } }
      ]
    }
  },
  "sort": [
    { "@timestamp": "asc" }
  ],
  "size": 1000
}

// æŸ¥è¯¢é”™è¯¯ç‡è¶‹åŠ¿
GET microservice-logs-*/_search
{
  "size": 0,
  "query": {
    "bool": {
      "must": [
        { "term": { "service": "user-service" } },
        { "range": { "@timestamp": { "gte": "now-1h" } } }
      ]
    }
  },
  "aggs": {
    "errors_over_time": {
      "date_histogram": {
        "field": "@timestamp",
        "fixed_interval": "1m"
      },
      "aggs": {
        "error_count": {
          "filter": { "term": { "level": "error" } }
        }
      }
    }
  }
}
```

---

### å…­ã€Kibanaå¯è§†åŒ–å®è·µ

#### 1. åˆ›å»ºç´¢å¼•æ¨¡å¼

```
Kibana â†’ Stack Management â†’ Index Patterns
â†’ Create index pattern: "microservice-logs-*"
â†’ Time field: @timestamp
```

#### 2. DiscoveræŸ¥è¯¢æŠ€å·§

```
# æŸ¥è¯¢ç‰¹å®šæœåŠ¡çš„é”™è¯¯æ—¥å¿—
service:"user-service" AND level:"error"

# æŸ¥è¯¢æ…¢è¯·æ±‚(è€—æ—¶>1000ms)
duration:>1000

# æŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚
user_id:12345

# ç»„åˆæŸ¥è¯¢
service:"order-service" AND (level:"error" OR level:"warn") AND @timestamp:[now-1h TO now]
```

#### 3. Dashboardä»ªè¡¨ç›˜é…ç½®

åˆ›å»ºå…³é”®æŒ‡æ ‡ä»ªè¡¨ç›˜:

```
ğŸ“Š æ—¥å¿—é‡è¶‹åŠ¿å›¾ (Line Chart)
   - Yè½´: Count
   - Xè½´: @timestamp (æŒ‰åˆ†é’Ÿèšåˆ)
   - æ‹†åˆ†: service

ğŸ“Š é”™è¯¯ç‡é¥¼å›¾ (Pie Chart)
   - Slice: level (error/warn/info)
   - Metric: Count

ğŸ“Š Top10æ…¢è¯·æ±‚ (Data Table)
   - Metric: Max(duration)
   - Bucket: Top 10 trace_id
   - æ’åº: durationé™åº

ğŸ“Š æœåŠ¡é”™è¯¯çƒ­åŠ›å›¾ (Heat Map)
   - Yè½´: service
   - Xè½´: @timestamp
   - é¢œè‰²å¼ºåº¦: error count
```

---

### ä¸ƒã€å‘Šè­¦é…ç½®

#### 1. ElastAlertå‘Šè­¦è§„åˆ™

```yaml
# /etc/elastalert/rules/error_rate_alert.yaml
name: "å¾®æœåŠ¡é”™è¯¯ç‡å‘Šè­¦"
type: frequency
index: microservice-logs-*

# è§¦å‘æ¡ä»¶: 5åˆ†é’Ÿå†…é”™è¯¯æ•°>50
num_events: 50
timeframe:
  minutes: 5

filter:
- query:
    bool:
      must:
        - term:
            level: "error"
        - term:
            service: "user-service"

# å‘Šè­¦è¾“å‡º
alert:
  - "slack"
  - "email"

slack_webhook_url: "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
slack_channel_override: "#alerts"

email:
  - "oncall@example.com"
```

#### 2. Kibana Watcherå‘Šè­¦

```json
PUT _watcher/watch/error_spike
{
  "trigger": {
    "schedule": {
      "interval": "5m"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": ["microservice-logs-*"],
        "body": {
          "query": {
            "bool": {
              "must": [
                { "term": { "level": "error" } },
                { "range": { "@timestamp": { "gte": "now-5m" } } }
              ]
            }
          },
          "aggs": {
            "error_count": { "value_count": { "field": "_id" } }
          }
        }
      }
    }
  },
  "condition": {
    "compare": {
      "ctx.payload.aggregations.error_count.value": { "gt": 50 }
    }
  },
  "actions": {
    "send_slack": {
      "webhook": {
        "method": "POST",
        "url": "https://hooks.slack.com/services/YOUR/WEBHOOK/URL",
        "body": "{\"text\": \"ğŸš¨é”™è¯¯æ•°è¶…è¿‡é˜ˆå€¼: {{ctx.payload.aggregations.error_count.value}}æ¡\"}"
      }
    }
  }
}
```

---

### å…«ã€æœ€ä½³å®è·µæ€»ç»“

#### 1. æ—¥å¿—è§„èŒƒ

```
âœ… ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—(JSONæ ¼å¼)
âœ… å¿…é¡»åŒ…å«: timestampã€levelã€messageã€serviceã€trace_id
âœ… æ•æ„Ÿä¿¡æ¯è„±æ•(å¯†ç ã€Tokenã€èº«ä»½è¯å·ç­‰)
âœ… æ—¥å¿—åˆ†çº§: DEBUG/INFO/WARN/ERROR/FATAL
âœ… é¿å…æ‰“å°å¤§å¯¹è±¡,è¶…è¿‡1KBåº”æˆªæ–­
```

#### 2. æ€§èƒ½ä¼˜åŒ–

```
âœ… å¼‚æ­¥å†™æ—¥å¿—,é¿å…é˜»å¡ä¸»æµç¨‹
âœ… ä½¿ç”¨Filebeatè€ŒéLogstashç›´é‡‡(å‡å°‘èµ„æºæ¶ˆè€—)
âœ… ESè®¾ç½®åˆç†çš„åˆ†ç‰‡æ•°(å»ºè®®å•åˆ†ç‰‡30-50GB)
âœ… å¼€å¯ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†,å®šæœŸæ¸…ç†æ—§æ•°æ®
âœ… é«˜é¢‘æ—¥å¿—é‡‡æ ·(å¦‚DEBUGæ—¥å¿—é‡‡æ ·1%)
```

#### 3. æˆæœ¬æ§åˆ¶

```
ğŸ’° æŒ‰æ—¥æœŸæ»šåŠ¨ç´¢å¼•,è¿‡æœŸæ•°æ®è‡ªåŠ¨åˆ é™¤
ğŸ’° å†·çƒ­æ•°æ®åˆ†ç¦»(hot-warm-coldæ¶æ„)
ğŸ’° å‹ç¼©å†å²ç´¢å¼•
ğŸ’° åªç´¢å¼•å¿…è¦å­—æ®µ,messageå­—æ®µå¯é€‰æ‹©ä¸ç´¢å¼•
ğŸ’° ä½¿ç”¨ESçš„å¿«ç…§åŠŸèƒ½å¤‡ä»½åˆ°å¯¹è±¡å­˜å‚¨(S3/OSS)
```

#### 4. å·¥å…·å¯¹æ¯”

| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|---------|------|------|
| **ELK** | ä¼ ç»Ÿè™šæ‹Ÿæœºéƒ¨ç½² | åŠŸèƒ½å¼ºå¤§,ç”Ÿæ€å®Œå–„ | èµ„æºæ¶ˆè€—å¤§ |
| **EFK** | Kubernetesç¯å¢ƒ | è½»é‡çº§,äº‘åŸç”Ÿ | é…ç½®ç›¸å¯¹å¤æ‚ |
| **Loki** | æˆæœ¬æ•æ„Ÿåœºæ™¯ | æˆæœ¬ä½,ä¸Grafanaé›†æˆå¥½ | æŸ¥è¯¢èƒ½åŠ›å¼±äºES |
| **ClickHouse** | æµ·é‡æ—¥å¿—åˆ†æ | æ€§èƒ½æé«˜,æˆæœ¬ä½ | è¿ç»´å¤æ‚åº¦é«˜ |
| **äº‘å‚å•†æ–¹æ¡ˆ** | å¿«é€Ÿä¸Šçº¿ | å¼€ç®±å³ç”¨,æ— éœ€è¿ç»´ | æˆæœ¬é«˜,å‚å•†é”å®š |
