---
title: è“ç»¿éƒ¨ç½²å’Œé‡‘ä¸é›€å‘å¸ƒ
tags:
  - å¾®æœåŠ¡
status: robot
class: å¾®æœåŠ¡
slug: blue-green-vs-canary-deployment
ref:
---

## æ ¸å¿ƒè¦ç‚¹

**è“ç»¿éƒ¨ç½²**:ç»´æŠ¤ä¸¤å¥—å®Œå…¨ç›¸åŒçš„ç¯å¢ƒ,é€šè¿‡åˆ‡æ¢æµé‡å®ç°ç§’çº§å›æ»š,é›¶åœæœºå‘å¸ƒ
**é‡‘ä¸é›€å‘å¸ƒ**:é€æ­¥å¢åŠ æ–°ç‰ˆæœ¬æµé‡æ¯”ä¾‹,å°èŒƒå›´éªŒè¯åå†æ‰©å¤§èŒƒå›´,é™ä½å½±å“é¢
**ä¸»è¦åŒºåˆ«**:è“ç»¿æ˜¯ç¬æ—¶åˆ‡æ¢,é‡‘ä¸é›€æ˜¯æ¸è¿›å¼æ”¾é‡;è“ç»¿éœ€åŒå€èµ„æº,é‡‘ä¸é›€èµ„æºåˆ©ç”¨æ›´é«˜æ•ˆ

---

## è¯¦ç»†å›ç­”

### ä¸€ã€è“ç»¿éƒ¨ç½² (Blue-Green Deployment)

#### 1. æ ¸å¿ƒåŸç†

è“ç»¿éƒ¨ç½²ç»´æŠ¤**ä¸¤å¥—å®Œå…¨ç›¸åŒçš„ç”Ÿäº§ç¯å¢ƒ**:
- **è“ç¯å¢ƒ**: å½“å‰æ­£åœ¨è¿è¡Œçš„ç”Ÿäº§ç¯å¢ƒ (v1)
- **ç»¿ç¯å¢ƒ**: æ–°ç‰ˆæœ¬éƒ¨ç½²çš„ç¯å¢ƒ (v2)

éƒ¨ç½²æµç¨‹:
```
1. è“ç¯å¢ƒæä¾›æœåŠ¡ (100% æµé‡)
2. åœ¨ç»¿ç¯å¢ƒéƒ¨ç½²æ–°ç‰ˆæœ¬ (0% æµé‡)
3. åœ¨ç»¿ç¯å¢ƒè¿›è¡Œæµ‹è¯•éªŒè¯
4. åˆ‡æ¢æµé‡åˆ°ç»¿ç¯å¢ƒ (100% æµé‡)
5. è“ç¯å¢ƒä¿ç•™ä½œä¸ºå›æ»šå¤‡ä»½
```

#### 2. æµé‡åˆ‡æ¢æœºåˆ¶

**æ–¹å¼ä¸€: è´Ÿè½½å‡è¡¡å™¨åˆ‡æ¢**
```yaml
# åˆå§‹çŠ¶æ€: æµé‡æŒ‡å‘è“ç¯å¢ƒ
apiVersion: v1
kind: Service
metadata:
  name: user-service
spec:
  selector:
    app: user-service
    version: blue  # æµé‡åˆ°è“ç¯å¢ƒ
  ports:
  - port: 8080
    targetPort: 8080

---
# åˆ‡æ¢å: æµé‡æŒ‡å‘ç»¿ç¯å¢ƒ
spec:
  selector:
    app: user-service
    version: green  # æµé‡åˆ‡æ¢åˆ°ç»¿ç¯å¢ƒ
```

**æ–¹å¼äºŒ: DNS åˆ‡æ¢**
```bash
# ä¿®æ”¹ DNS è®°å½•,å°†åŸŸåæŒ‡å‘æ–° IP
# ç¼ºç‚¹: DNS ç¼“å­˜å¯¼è‡´åˆ‡æ¢ä¸å¤Ÿå¿«
user-service.example.com â†’ 10.0.1.100 (è“ç¯å¢ƒ)
user-service.example.com â†’ 10.0.1.200 (ç»¿ç¯å¢ƒ)
```

**æ–¹å¼ä¸‰: Istio VirtualService åˆ‡æ¢**
```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: user-service
spec:
  hosts:
  - user-service
  http:
  - route:
    - destination:
        host: user-service
        subset: green  # ä¸€é”®åˆ‡æ¢åˆ°ç»¿ç¯å¢ƒ
      weight: 100
```

#### 3. Go è¯­è¨€å®ç°è“ç»¿éƒ¨ç½²æ§åˆ¶å™¨

```go
package deployment

import (
    "context"
    "fmt"
    metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
    "k8s.io/client-go/kubernetes"
)

// BlueGreenDeployer è“ç»¿éƒ¨ç½²æ§åˆ¶å™¨
type BlueGreenDeployer struct {
    client    *kubernetes.Clientset
    namespace string
}

// SwitchTraffic åˆ‡æ¢æµé‡åˆ°ç›®æ ‡ç¯å¢ƒ
func (d *BlueGreenDeployer) SwitchTraffic(ctx context.Context, serviceName, targetEnv string) error {
    // 1. éªŒè¯ç›®æ ‡ç¯å¢ƒå¥åº·çŠ¶æ€
    healthy, err := d.checkHealthStatus(ctx, serviceName, targetEnv)
    if err != nil || !healthy {
        return fmt.Errorf("target environment %s is not healthy", targetEnv)
    }

    // 2. æ›´æ–° Service selector åˆ‡æ¢æµé‡
    service, err := d.client.CoreV1().Services(d.namespace).Get(ctx, serviceName, metav1.GetOptions{})
    if err != nil {
        return err
    }

    // ä¿®æ”¹ selector æŒ‡å‘ç›®æ ‡ç¯å¢ƒ
    service.Spec.Selector["version"] = targetEnv

    _, err = d.client.CoreV1().Services(d.namespace).Update(ctx, service, metav1.UpdateOptions{})
    if err != nil {
        return err
    }

    // 3. éªŒè¯åˆ‡æ¢åçš„æµé‡çŠ¶æ€
    return d.verifyTrafficSwitch(ctx, serviceName, targetEnv)
}

// Rollback å›æ»šåˆ°ä¸Šä¸€ä¸ªç¯å¢ƒ
func (d *BlueGreenDeployer) Rollback(ctx context.Context, serviceName, previousEnv string) error {
    fmt.Printf("Rolling back to %s environment\n", previousEnv)
    return d.SwitchTraffic(ctx, serviceName, previousEnv)
}

// checkHealthStatus æ£€æŸ¥ç›®æ ‡ç¯å¢ƒå¥åº·çŠ¶æ€
func (d *BlueGreenDeployer) checkHealthStatus(ctx context.Context, serviceName, env string) (bool, error) {
    // æ£€æŸ¥ Deployment çš„ Ready å‰¯æœ¬æ•°
    deployment, err := d.client.AppsV1().Deployments(d.namespace).Get(
        ctx,
        fmt.Sprintf("%s-%s", serviceName, env),
        metav1.GetOptions{},
    )
    if err != nil {
        return false, err
    }

    // æ‰€æœ‰å‰¯æœ¬éƒ½ Ready æ‰è®¤ä¸ºå¥åº·
    return deployment.Status.ReadyReplicas == deployment.Status.Replicas, nil
}
```

#### 4. è“ç»¿éƒ¨ç½²ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**:
- **å¿«é€Ÿå›æ»š**: ç§’çº§åˆ‡å›æ—§ç‰ˆæœ¬,åªéœ€ä¿®æ”¹è·¯ç”±
- **é›¶åœæœº**: ç”¨æˆ·æ— æ„ŸçŸ¥çš„æ— ç¼åˆ‡æ¢
- **å®Œæ•´æµ‹è¯•**: å¯ä»¥åœ¨ç»¿ç¯å¢ƒè¿›è¡Œå……åˆ†çš„ç”Ÿäº§ç¯å¢ƒæµ‹è¯•

**ç¼ºç‚¹**:
- **èµ„æºæˆæœ¬é«˜**: éœ€è¦ 2 å€çš„æœåŠ¡å™¨èµ„æº
- **æ•°æ®åº“è¿ç§»å¤æ‚**: éœ€è¦ä¿è¯æ–°æ—§ç‰ˆæœ¬å¯¹æ•°æ®åº“ Schema å…¼å®¹
- **ç¬æ—¶åˆ‡æ¢é£é™©**: å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜,ä¼šç¬é—´å½±å“æ‰€æœ‰ç”¨æˆ·

---

### äºŒã€é‡‘ä¸é›€å‘å¸ƒ (Canary Deployment)

#### 1. æ ¸å¿ƒåŸç†

é‡‘ä¸é›€å‘å¸ƒæ˜¯**æ¸è¿›å¼**çš„å‘å¸ƒç­–ç•¥,é€æ­¥å°†æµé‡ä»æ—§ç‰ˆæœ¬è¿ç§»åˆ°æ–°ç‰ˆæœ¬:

```
é˜¶æ®µ 1: 95% v1 + 5%  v2  (è§‚å¯Ÿ 30 åˆ†é’Ÿ)
é˜¶æ®µ 2: 80% v1 + 20% v2  (è§‚å¯Ÿ 1 å°æ—¶)
é˜¶æ®µ 3: 50% v1 + 50% v2  (è§‚å¯Ÿ 2 å°æ—¶)
é˜¶æ®µ 4: 20% v1 + 80% v2  (è§‚å¯Ÿ 1 å°æ—¶)
é˜¶æ®µ 5: 0%  v1 + 100% v2 (å…¨é‡å‘å¸ƒ)
```

**å‘½åç”±æ¥**: çŸ¿å·¥ä¸‹äº•å‰ä¼šå¸¦é‡‘ä¸é›€,å› ä¸ºé‡‘ä¸é›€å¯¹æœ‰æ¯’æ°”ä½“æ•æ„Ÿ,å¦‚æœé‡‘ä¸é›€æ­»äº¡åˆ™è¯´æ˜ç¯å¢ƒå±é™©ã€‚ç±»æ¯”åˆ°è½¯ä»¶å‘å¸ƒ,å…ˆè®©å°éƒ¨åˆ†ç”¨æˆ·"è¯•æ¯’"ã€‚

#### 2. Kubernetes + Istio å®ç°é‡‘ä¸é›€å‘å¸ƒ

```yaml
# éƒ¨ç½² v1 å’Œ v2 ä¸¤ä¸ªç‰ˆæœ¬
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service-v1
spec:
  replicas: 9  # 90% æµé‡
  selector:
    matchLabels:
      app: user-service
      version: v1
  template:
    metadata:
      labels:
        app: user-service
        version: v1
    spec:
      containers:
      - name: user-service
        image: user-service:v1.0.0

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service-v2
spec:
  replicas: 1  # 10% æµé‡
  selector:
    matchLabels:
      app: user-service
      version: v2
  template:
    metadata:
      labels:
        app: user-service
        version: v2
    spec:
      containers:
      - name: user-service
        image: user-service:v2.0.0

---
# Istio VirtualService æ§åˆ¶æµé‡åˆ†é…
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: user-service
spec:
  hosts:
  - user-service
  http:
  - match:
    - headers:
        x-canary:
          exact: "true"
    route:
    - destination:
        host: user-service
        subset: v2  # å¸¦ç‰¹æ®Š header çš„è¯·æ±‚å¼ºåˆ¶è·¯ç”±åˆ° v2
  - route:
    - destination:
        host: user-service
        subset: v1
      weight: 90  # 90% æµé‡åˆ° v1
    - destination:
        host: user-service
        subset: v2
      weight: 10  # 10% æµé‡åˆ° v2

---
# DestinationRule å®šä¹‰ subset
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: user-service
spec:
  host: user-service
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

#### 3. Go è¯­è¨€å®ç°è‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒ

```go
package deployment

import (
    "context"
    "fmt"
    "time"
)

// CanaryDeployer é‡‘ä¸é›€å‘å¸ƒæ§åˆ¶å™¨
type CanaryDeployer struct {
    client          K8sClient
    monitoring      MonitoringService
    notifier        NotificationService
}

// CanaryStage é‡‘ä¸é›€å‘å¸ƒé˜¶æ®µ
type CanaryStage struct {
    Weight          int           // æ–°ç‰ˆæœ¬æµé‡ç™¾åˆ†æ¯”
    Duration        time.Duration // è§‚å¯Ÿæ—¶é•¿
    SuccessCriteria Criteria      // æˆåŠŸæ ‡å‡†
}

// Criteria æˆåŠŸæ ‡å‡†
type Criteria struct {
    MaxErrorRate     float64 // æœ€å¤§é”™è¯¯ç‡ (å¦‚ 0.05 = 5%)
    MaxLatencyP99    int     // P99 å»¶è¿Ÿä¸Šé™ (ms)
    MinSuccessRate   float64 // æœ€å°æˆåŠŸç‡
}

// ExecuteCanaryRelease æ‰§è¡Œé‡‘ä¸é›€å‘å¸ƒ
func (d *CanaryDeployer) ExecuteCanaryRelease(ctx context.Context, serviceName string) error {
    // å®šä¹‰å‘å¸ƒé˜¶æ®µ
    stages := []CanaryStage{
        {Weight: 5, Duration: 30 * time.Minute, SuccessCriteria: defaultCriteria()},
        {Weight: 20, Duration: 1 * time.Hour, SuccessCriteria: defaultCriteria()},
        {Weight: 50, Duration: 2 * time.Hour, SuccessCriteria: defaultCriteria()},
        {Weight: 80, Duration: 1 * time.Hour, SuccessCriteria: defaultCriteria()},
        {Weight: 100, Duration: 24 * time.Hour, SuccessCriteria: defaultCriteria()},
    }

    // æ‰§è¡Œæ¯ä¸ªé˜¶æ®µ
    for i, stage := range stages {
        fmt.Printf("Starting canary stage %d: %d%% traffic\n", i+1, stage.Weight)

        // 1. è°ƒæ•´æµé‡æƒé‡
        if err := d.updateTrafficWeight(ctx, serviceName, stage.Weight); err != nil {
            return d.rollback(ctx, serviceName, err)
        }

        // 2. è§‚å¯ŸæœŸ: ç›‘æ§æŒ‡æ ‡
        if err := d.observeAndValidate(ctx, serviceName, stage); err != nil {
            return d.rollback(ctx, serviceName, err)
        }

        d.notifier.SendNotification(fmt.Sprintf(
            "âœ… Canary stage %d completed successfully (%d%% traffic)",
            i+1, stage.Weight,
        ))
    }

    fmt.Println("ğŸ‰ Canary release completed successfully!")
    return nil
}

// observeAndValidate è§‚å¯Ÿå¹¶éªŒè¯é˜¶æ®µæŒ‡æ ‡
func (d *CanaryDeployer) observeAndValidate(
    ctx context.Context,
    serviceName string,
    stage CanaryStage,
) error {
    ticker := time.NewTicker(1 * time.Minute)
    defer ticker.Stop()

    deadline := time.Now().Add(stage.Duration)

    for time.Now().Before(deadline) {
        select {
        case <-ctx.Done():
            return ctx.Err()
        case <-ticker.C:
            // è·å–æ–°ç‰ˆæœ¬çš„ç›‘æ§æŒ‡æ ‡
            metrics, err := d.monitoring.GetMetrics(ctx, serviceName, "v2")
            if err != nil {
                return fmt.Errorf("failed to get metrics: %w", err)
            }

            // éªŒè¯æŒ‡æ ‡æ˜¯å¦æ»¡è¶³æˆåŠŸæ ‡å‡†
            if !d.validateMetrics(metrics, stage.SuccessCriteria) {
                return fmt.Errorf("metrics validation failed: error_rate=%.2f%%, p99=%dms",
                    metrics.ErrorRate*100, metrics.LatencyP99)
            }
        }
    }

    return nil
}

// validateMetrics éªŒè¯æŒ‡æ ‡
func (d *CanaryDeployer) validateMetrics(metrics *Metrics, criteria Criteria) bool {
    if metrics.ErrorRate > criteria.MaxErrorRate {
        return false
    }
    if metrics.LatencyP99 > criteria.MaxLatencyP99 {
        return false
    }
    if metrics.SuccessRate < criteria.MinSuccessRate {
        return false
    }
    return true
}

// rollback è‡ªåŠ¨å›æ»š
func (d *CanaryDeployer) rollback(ctx context.Context, serviceName string, reason error) error {
    fmt.Printf("ğŸš¨ Canary release failed, rolling back: %v\n", reason)

    // å°†æµé‡å…¨éƒ¨åˆ‡å› v1
    if err := d.updateTrafficWeight(ctx, serviceName, 0); err != nil {
        return fmt.Errorf("rollback failed: %w", err)
    }

    d.notifier.SendAlert(fmt.Sprintf("âŒ Canary release rolled back: %v", reason))
    return reason
}

func defaultCriteria() Criteria {
    return Criteria{
        MaxErrorRate:   0.05,  // 5%
        MaxLatencyP99:  1000,  // 1000ms
        MinSuccessRate: 0.95,  // 95%
    }
}
```

#### 4. åŸºäºç”¨æˆ·ç‰¹å¾çš„é‡‘ä¸é›€å‘å¸ƒ

é™¤äº†æµé‡æ¯”ä¾‹,è¿˜å¯ä»¥åŸºäºç”¨æˆ·ç‰¹å¾å®šå‘å‘å¸ƒ:

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: user-service
spec:
  hosts:
  - user-service
  http:
  # è§„åˆ™ 1: å†…éƒ¨å‘˜å·¥ä½¿ç”¨æ–°ç‰ˆæœ¬
  - match:
    - headers:
        x-user-type:
          exact: "internal"
    route:
    - destination:
        host: user-service
        subset: v2

  # è§„åˆ™ 2: VIP ç”¨æˆ·ä½¿ç”¨æ–°ç‰ˆæœ¬
  - match:
    - headers:
        x-user-tier:
          exact: "vip"
    route:
    - destination:
        host: user-service
        subset: v2

  # è§„åˆ™ 3: åŒ—äº¬åœ°åŒºç”¨æˆ·ä½¿ç”¨æ–°ç‰ˆæœ¬
  - match:
    - headers:
        x-region:
          exact: "beijing"
    route:
    - destination:
        host: user-service
        subset: v2

  # é»˜è®¤è§„åˆ™: å…¶ä»–ç”¨æˆ·ä½¿ç”¨æ—§ç‰ˆæœ¬
  - route:
    - destination:
        host: user-service
        subset: v1
```

#### 5. é‡‘ä¸é›€å‘å¸ƒä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**:
- **é£é™©å¯æ§**: é€æ­¥æ”¾é‡,é—®é¢˜å½±å“èŒƒå›´å°
- **èµ„æºé«˜æ•ˆ**: ä¸éœ€è¦åŒå€èµ„æº,æŒ‰éœ€å¢åŠ å‰¯æœ¬
- **çµæ´»**: å¯ä»¥åŸºäºç”¨æˆ·ç‰¹å¾ã€åœ°åŸŸç­‰ç»´åº¦ç²¾ç»†åŒ–å‘å¸ƒ

**ç¼ºç‚¹**:
- **å‘å¸ƒå‘¨æœŸé•¿**: å®Œæ•´å‘å¸ƒå¯èƒ½éœ€è¦å‡ å°æ—¶åˆ°å‡ å¤©
- **ç›‘æ§è¦æ±‚é«˜**: éœ€è¦å®æ—¶ç›‘æ§å„é¡¹æŒ‡æ ‡
- **å¤æ‚åº¦é«˜**: éœ€è¦è‡ªåŠ¨åŒ–å·¥å…·æ”¯æŒ

---

### ä¸‰ã€è“ç»¿éƒ¨ç½² vs é‡‘ä¸é›€å‘å¸ƒå¯¹æ¯”

| ç»´åº¦ | è“ç»¿éƒ¨ç½² | é‡‘ä¸é›€å‘å¸ƒ |
|------|---------|-----------|
| **åˆ‡æ¢æ–¹å¼** | ç¬æ—¶åˆ‡æ¢ (0% â†’ 100%) | æ¸è¿›å¼åˆ‡æ¢ (5% â†’ 20% â†’ 50% â†’ 100%) |
| **å›æ»šé€Ÿåº¦** | ç§’çº§ (ä¿®æ”¹è·¯ç”±å³å¯) | ç§’çº§ (è°ƒæ•´æµé‡æƒé‡) |
| **èµ„æºæˆæœ¬** | é«˜ (éœ€è¦ 2 å€èµ„æº) | ä½ (é€æ­¥å¢åŠ å‰¯æœ¬) |
| **é£é™©ç¨‹åº¦** | ä¸­ç­‰ (ç¬æ—¶å½±å“æ‰€æœ‰ç”¨æˆ·) | ä½ (é€æ­¥éªŒè¯,å½±å“é¢å°) |
| **å‘å¸ƒæ—¶é•¿** | å¿« (å‡ åˆ†é’Ÿ) | æ…¢ (å‡ å°æ—¶åˆ°å‡ å¤©) |
| **æµ‹è¯•ç¯å¢ƒ** | å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒå‰¯æœ¬ | ç”Ÿäº§ç¯å¢ƒçš„ä¸€éƒ¨åˆ†æµé‡ |
| **é€‚ç”¨åœºæ™¯** | éœ€è¦å¿«é€Ÿå›æ»šçš„åœºæ™¯ | éœ€è¦é€æ­¥éªŒè¯çš„åœºæ™¯ |
| **æŠ€æœ¯å¤æ‚åº¦** | ä½ | ä¸­ç­‰ |
| **æ•°æ®åº“å…¼å®¹** | éœ€è¦æ–°æ—§ç‰ˆæœ¬å…¼å®¹åŒä¸€ Schema | éœ€è¦æ–°æ—§ç‰ˆæœ¬å…¼å®¹åŒä¸€ Schema |

---

### å››ã€å®é™…åº”ç”¨åœºæ™¯é€‰æ‹©

#### 1. é€‚åˆè“ç»¿éƒ¨ç½²çš„åœºæ™¯

```
âœ… å¤§ç‰ˆæœ¬å‡çº§,éœ€è¦å¿«é€Ÿå›æ»šèƒ½åŠ›
âœ… æœ‰å……è¶³çš„åŸºç¡€è®¾æ–½èµ„æº
âœ… éœ€è¦åœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå®Œæ•´æµ‹è¯•
âœ… ç”¨æˆ·é‡ä¸å¤§,ç¬æ—¶åˆ‡æ¢é£é™©å¯æ§
âœ… æ•°æ®åº“å˜æ›´è¾ƒå°‘
```

**æ¡ˆä¾‹**: ç”µå•†å¹³å°å¤§ä¿ƒå‰çš„ç³»ç»Ÿå‡çº§,éœ€è¦å¿«é€Ÿå›æ»šä¿éšœã€‚

#### 2. é€‚åˆé‡‘ä¸é›€å‘å¸ƒçš„åœºæ™¯

```
âœ… ç”¨æˆ·é‡å¤§,éœ€è¦é™ä½å‘å¸ƒé£é™©
âœ… èµ„æºå—é™,æ— æ³•æ”¯æ’‘åŒå€ç¯å¢ƒ
âœ… æ–°åŠŸèƒ½éœ€è¦é€æ­¥éªŒè¯æ•ˆæœ
âœ… å¯¹ä¸åŒç”¨æˆ·ç¾¤ä½“è¿›è¡Œ A/B æµ‹è¯•
âœ… å¤æ‚ç³»ç»Ÿ,éœ€è¦é•¿æ—¶é—´è§‚å¯Ÿ
```

**æ¡ˆä¾‹**: æ¨èç®—æ³•å‡çº§,éœ€è¦é€æ­¥éªŒè¯ç”¨æˆ·è½¬åŒ–ç‡å’Œç•™å­˜ç‡ã€‚

#### 3. æ··åˆç­–ç•¥

åœ¨å®é™…ç”Ÿäº§ä¸­,å¯ä»¥ç»“åˆä¸¤ç§ç­–ç•¥:

```
é˜¶æ®µ 1: åœ¨é¢„å‘ç¯å¢ƒä½¿ç”¨è“ç»¿éƒ¨ç½²è¿›è¡ŒéªŒè¯
é˜¶æ®µ 2: åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨é‡‘ä¸é›€å‘å¸ƒé€æ­¥æ”¾é‡
é˜¶æ®µ 3: å…¨é‡åä¿ç•™æ—§ç‰ˆæœ¬ç¯å¢ƒ,ä½œä¸ºè“ç»¿å›æ»šå¤‡ä»½
```

---

### äº”ã€æœ€ä½³å®è·µ

#### 1. è‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹

```go
// å®Œæ•´çš„å‘å¸ƒæµç¨‹ç¼–æ’
type ReleaseOrchestrator struct {
    blueGreen *BlueGreenDeployer
    canary    *CanaryDeployer
}

func (o *ReleaseOrchestrator) SmartRelease(ctx context.Context, config ReleaseConfig) error {
    // 1. æ ¹æ®é…ç½®é€‰æ‹©å‘å¸ƒç­–ç•¥
    if config.Strategy == "blue-green" {
        return o.blueGreen.Deploy(ctx, config)
    }

    // 2. é‡‘ä¸é›€å‘å¸ƒ
    if err := o.canary.ExecuteCanaryRelease(ctx, config.ServiceName); err != nil {
        // å¤±è´¥è‡ªåŠ¨å›æ»š
        return err
    }

    // 3. å…¨é‡åæ¸…ç†æ—§ç‰ˆæœ¬èµ„æº
    return o.cleanupOldVersion(ctx, config.ServiceName)
}
```

#### 2. ç›‘æ§å’Œå‘Šè­¦

å…³é”®æŒ‡æ ‡:
```
- é”™è¯¯ç‡ (2xx/4xx/5xx)
- å“åº”å»¶è¿Ÿ (P50/P90/P95/P99)
- QPS/TPS
- èµ„æºä½¿ç”¨ç‡ (CPU/Memory)
- ä¸šåŠ¡æŒ‡æ ‡ (è½¬åŒ–ç‡ã€æˆåŠŸç‡)
```

è‡ªåŠ¨å›æ»šè§¦å‘æ¡ä»¶:
```
- é”™è¯¯ç‡ > æ—§ç‰ˆæœ¬ 1.5 å€
- P99 å»¶è¿Ÿ > æ—§ç‰ˆæœ¬ 1.2 å€
- ä¸šåŠ¡æŒ‡æ ‡ä¸‹é™ > 10%
- å‡ºç°è‡´å‘½é”™è¯¯
```

#### 3. æ•°æ®åº“ç‰ˆæœ¬å…¼å®¹

```sql
-- ä½¿ç”¨æ¸è¿›å¼ Schema å˜æ›´
-- é˜¶æ®µ 1: æ·»åŠ æ–°å­—æ®µ (å…¼å®¹æ—§ç‰ˆæœ¬)
ALTER TABLE users ADD COLUMN email VARCHAR(255);

-- é˜¶æ®µ 2: æ•°æ®è¿ç§» (åå°ä»»åŠ¡)
UPDATE users SET email = CONCAT(username, '@example.com') WHERE email IS NULL;

-- é˜¶æ®µ 3: æ—§ç‰ˆæœ¬ä¸‹çº¿å,åˆ é™¤æ—§å­—æ®µ
ALTER TABLE users DROP COLUMN old_email;
```

#### 4. å·¥å…·æ¨è

- **Kubernetes**: åŸç”Ÿæ”¯æŒ Deployment æ»šåŠ¨æ›´æ–°
- **Istio**: æµé‡ç®¡ç†å’Œé‡‘ä¸é›€å‘å¸ƒ
- **Flagger**: è‡ªåŠ¨åŒ–é‡‘ä¸é›€å‘å¸ƒ (æ”¯æŒ Istio/Linkerd/NGINX)
- **ArgoCD**: GitOps è“ç»¿/é‡‘ä¸é›€å‘å¸ƒ
- **Spinnaker**: Netflix å¼€æºçš„æŒç»­äº¤ä»˜å¹³å°
